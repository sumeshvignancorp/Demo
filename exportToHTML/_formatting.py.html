<html>
<head>
<title>_formatting.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_formatting.py</font>
</center></td></tr></table>
<pre><span class="s0"># traceback_exception_init() adapted from trio</span>
<span class="s0">#</span>
<span class="s0"># _ExceptionPrintContext and traceback_exception_format() copied from the standard</span>
<span class="s0"># library</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">import </span><span class="s1">traceback</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">singledispatch</span>
<span class="s2">from </span><span class="s1">types </span><span class="s2">import </span><span class="s1">TracebackType</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Optional</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">_exceptions </span><span class="s2">import </span><span class="s1">BaseExceptionGroup</span>

<span class="s1">max_group_width </span><span class="s3">= </span><span class="s4">15</span>
<span class="s1">max_group_depth </span><span class="s3">= </span><span class="s4">10</span>
<span class="s1">_cause_message </span><span class="s3">= (</span>
    <span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">The above exception was the direct cause of the following exception:</span><span class="s2">\n\n</span><span class="s5">&quot;</span>
<span class="s3">)</span>

<span class="s1">_context_message </span><span class="s3">= (</span>
    <span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">During handling of the above exception, another exception occurred:</span><span class="s2">\n\n</span><span class="s5">&quot;</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">_format_final_exc_line</span><span class="s3">(</span><span class="s1">etype</span><span class="s3">, </span><span class="s1">value</span><span class="s3">):</span>
    <span class="s1">valuestr </span><span class="s3">= </span><span class="s1">_safe_string</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s5">&quot;exception&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">value </span><span class="s2">is None or not </span><span class="s1">valuestr</span><span class="s3">:</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">etype</span><span class="s2">}\n</span><span class="s5">&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">etype</span><span class="s2">}</span><span class="s5">: </span><span class="s2">{</span><span class="s1">valuestr</span><span class="s2">}\n</span><span class="s5">&quot;</span>

    <span class="s2">return </span><span class="s1">line</span>


<span class="s2">def </span><span class="s1">_safe_string</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">what</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">str</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">func</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">BaseException</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">f&quot;&lt;</span><span class="s2">{</span><span class="s1">what</span><span class="s2">} {</span><span class="s1">func</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s5">() failed&gt;&quot;</span>


<span class="s2">class </span><span class="s1">_ExceptionPrintContext</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">seen </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">need_close </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">indent</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot; &quot; </span><span class="s3">* (</span><span class="s4">2 </span><span class="s3">* </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exception_group_depth</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">emit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">text_gen</span><span class="s3">, </span><span class="s1">margin_char</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">margin_char </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">margin_char </span><span class="s3">= </span><span class="s5">&quot;|&quot;</span>
        <span class="s1">indent_str </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exception_group_depth</span><span class="s3">:</span>
            <span class="s1">indent_str </span><span class="s3">+= </span><span class="s1">margin_char </span><span class="s3">+ </span><span class="s5">&quot; &quot;</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">text_gen</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s1">text_gen</span><span class="s3">, </span><span class="s1">indent_str</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">line</span><span class="s3">: </span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">text </span><span class="s2">in </span><span class="s1">text_gen</span><span class="s3">:</span>
                <span class="s2">yield </span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">indent_str</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">line</span><span class="s3">: </span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">exceptiongroup_excepthook</span><span class="s3">(</span>
    <span class="s1">etype</span><span class="s3">: </span><span class="s1">type</span><span class="s3">[</span><span class="s1">BaseException</span><span class="s3">], </span><span class="s1">value</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">, </span><span class="s1">tb</span><span class="s3">: </span><span class="s1">TracebackType </span><span class="s3">| </span><span class="s2">None</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">format_exception</span><span class="s3">(</span><span class="s1">etype</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">tb</span><span class="s3">)))</span>


<span class="s2">class </span><span class="s1">PatchedTracebackException</span><span class="s3">(</span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">exc_type</span><span class="s3">: </span><span class="s1">type</span><span class="s3">[</span><span class="s1">BaseException</span><span class="s3">],</span>
        <span class="s1">exc_value</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">,</span>
        <span class="s1">exc_traceback</span><span class="s3">: </span><span class="s1">TracebackType </span><span class="s3">| </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">limit</span><span class="s3">: </span><span class="s1">int </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">lookup_lines</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">capture_locals</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">compact</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">_seen</span><span class="s3">: </span><span class="s1">set</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">kwargs</span><span class="s3">: </span><span class="s1">dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">] = {}</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">):</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s5">&quot;compact&quot;</span><span class="s3">] = </span><span class="s1">compact</span>

        <span class="s1">is_recursive_call </span><span class="s3">= </span><span class="s1">_seen </span><span class="s2">is not None</span>
        <span class="s2">if </span><span class="s1">_seen </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">_seen </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">_seen</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">))</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">stack </span><span class="s3">= </span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">StackSummary</span><span class="s3">.</span><span class="s1">extract</span><span class="s3">(</span>
            <span class="s1">traceback</span><span class="s3">.</span><span class="s1">walk_tb</span><span class="s3">(</span><span class="s1">exc_traceback</span><span class="s3">),</span>
            <span class="s1">limit</span><span class="s3">=</span><span class="s1">limit</span><span class="s3">,</span>
            <span class="s1">lookup_lines</span><span class="s3">=</span><span class="s1">lookup_lines</span><span class="s3">,</span>
            <span class="s1">capture_locals</span><span class="s3">=</span><span class="s1">capture_locals</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">exc_type </span><span class="s3">= </span><span class="s1">exc_type</span>
        <span class="s0"># Capture now to permit freeing resources: only complication is in the</span>
        <span class="s0"># unofficial API _format_final_exc_line</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_str </span><span class="s3">= </span><span class="s1">_safe_string</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s5">&quot;exception&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__ </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s5">&quot;__notes__&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s0"># Workaround for https://github.com/python/cpython/issues/98778 on Python</span>
            <span class="s0"># &lt;= 3.9, and some 3.10 and 3.11 patch versions.</span>
            <span class="s1">HTTPError </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;urllib.error&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), </span><span class="s5">&quot;HTTPError&quot;</span><span class="s3">, ())</span>
            <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">] &lt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s3">) </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s1">HTTPError</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__ </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise</span>

        <span class="s2">if </span><span class="s1">exc_type </span><span class="s2">and </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">exc_type</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
            <span class="s0"># Handle SyntaxError's specially</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">filename </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">filename</span>
            <span class="s1">lno </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">lineno</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">lineno </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">lno</span><span class="s3">) </span><span class="s2">if </span><span class="s1">lno </span><span class="s2">is not None else None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">text </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">text</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">offset </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">offset</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">msg </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">msg</span>
            <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">):</span>
                <span class="s1">end_lno </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">end_lineno</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">end_lineno </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">end_lno</span><span class="s3">) </span><span class="s2">if </span><span class="s1">end_lno </span><span class="s2">is not None else None</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">end_offset </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">end_offset</span>
        <span class="s2">elif </span><span class="s3">(</span>
            <span class="s1">exc_type</span>
            <span class="s2">and </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">exc_type</span><span class="s3">, (</span><span class="s1">NameError</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">))</span>
            <span class="s2">and </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s5">&quot;name&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is not None</span>
        <span class="s3">):</span>
            <span class="s1">suggestion </span><span class="s3">= </span><span class="s1">_compute_suggestion_error</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s1">exc_traceback</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">suggestion</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_str </span><span class="s3">+= </span><span class="s5">f&quot;. Did you mean: '</span><span class="s2">{</span><span class="s1">suggestion</span><span class="s2">}</span><span class="s5">'?&quot;</span>

        <span class="s2">if </span><span class="s1">lookup_lines</span><span class="s3">:</span>
            <span class="s0"># Force all lines in the stack to be loaded</span>
            <span class="s2">for </span><span class="s1">frame </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">:</span>
                <span class="s1">frame</span><span class="s3">.</span><span class="s1">line</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">__suppress_context__ </span><span class="s3">= (</span>
            <span class="s1">exc_value</span><span class="s3">.</span><span class="s1">__suppress_context__ </span><span class="s2">if </span><span class="s1">exc_value </span><span class="s2">is not None else False</span>
        <span class="s3">)</span>

        <span class="s0"># Convert __cause__ and __context__ to `TracebackExceptions`s, use a</span>
        <span class="s0"># queue to avoid recursion (only the top-level call gets _seen == None)</span>
        <span class="s2">if not </span><span class="s1">is_recursive_call</span><span class="s3">:</span>
            <span class="s1">queue </span><span class="s3">= [(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">exc_value</span><span class="s3">)]</span>
            <span class="s2">while </span><span class="s1">queue</span><span class="s3">:</span>
                <span class="s1">te</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s1">queue</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>

                <span class="s2">if </span><span class="s1">e </span><span class="s2">and </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__ </span><span class="s2">is not None and </span><span class="s1">id</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">) </span><span class="s2">not in </span><span class="s1">_seen</span><span class="s3">:</span>
                    <span class="s1">cause </span><span class="s3">= </span><span class="s1">PatchedTracebackException</span><span class="s3">(</span>
                        <span class="s1">type</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">),</span>
                        <span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">,</span>
                        <span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">,</span>
                        <span class="s1">limit</span><span class="s3">=</span><span class="s1">limit</span><span class="s3">,</span>
                        <span class="s1">lookup_lines</span><span class="s3">=</span><span class="s1">lookup_lines</span><span class="s3">,</span>
                        <span class="s1">capture_locals</span><span class="s3">=</span><span class="s1">capture_locals</span><span class="s3">,</span>
                        <span class="s1">_seen</span><span class="s3">=</span><span class="s1">_seen</span><span class="s3">,</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">cause </span><span class="s3">= </span><span class="s2">None</span>

                <span class="s2">if </span><span class="s1">compact</span><span class="s3">:</span>
                    <span class="s1">need_context </span><span class="s3">= (</span>
                        <span class="s1">cause </span><span class="s2">is None and </span><span class="s1">e </span><span class="s2">is not None and not </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__suppress_context__</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">need_context </span><span class="s3">= </span><span class="s2">True</span>
                <span class="s2">if </span><span class="s3">(</span>
                    <span class="s1">e</span>
                    <span class="s2">and </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__context__ </span><span class="s2">is not None</span>
                    <span class="s2">and </span><span class="s1">need_context</span>
                    <span class="s2">and </span><span class="s1">id</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">) </span><span class="s2">not in </span><span class="s1">_seen</span>
                <span class="s3">):</span>
                    <span class="s1">context </span><span class="s3">= </span><span class="s1">PatchedTracebackException</span><span class="s3">(</span>
                        <span class="s1">type</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">),</span>
                        <span class="s1">e</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">,</span>
                        <span class="s1">e</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">,</span>
                        <span class="s1">limit</span><span class="s3">=</span><span class="s1">limit</span><span class="s3">,</span>
                        <span class="s1">lookup_lines</span><span class="s3">=</span><span class="s1">lookup_lines</span><span class="s3">,</span>
                        <span class="s1">capture_locals</span><span class="s3">=</span><span class="s1">capture_locals</span><span class="s3">,</span>
                        <span class="s1">_seen</span><span class="s3">=</span><span class="s1">_seen</span><span class="s3">,</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">context </span><span class="s3">= </span><span class="s2">None</span>

                <span class="s0"># Capture each of the exceptions in the ExceptionGroup along with each</span>
                <span class="s0"># of their causes and contexts</span>
                <span class="s2">if </span><span class="s1">e </span><span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">BaseExceptionGroup</span><span class="s3">):</span>
                    <span class="s1">exceptions </span><span class="s3">= []</span>
                    <span class="s2">for </span><span class="s1">exc </span><span class="s2">in </span><span class="s1">e</span><span class="s3">.</span><span class="s1">exceptions</span><span class="s3">:</span>
                        <span class="s1">texc </span><span class="s3">= </span><span class="s1">PatchedTracebackException</span><span class="s3">(</span>
                            <span class="s1">type</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">),</span>
                            <span class="s1">exc</span><span class="s3">,</span>
                            <span class="s1">exc</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">,</span>
                            <span class="s1">lookup_lines</span><span class="s3">=</span><span class="s1">lookup_lines</span><span class="s3">,</span>
                            <span class="s1">capture_locals</span><span class="s3">=</span><span class="s1">capture_locals</span><span class="s3">,</span>
                            <span class="s1">_seen</span><span class="s3">=</span><span class="s1">_seen</span><span class="s3">,</span>
                        <span class="s3">)</span>
                        <span class="s1">exceptions</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">texc</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">exceptions </span><span class="s3">= </span><span class="s2">None</span>

                <span class="s1">te</span><span class="s3">.</span><span class="s1">__cause__ </span><span class="s3">= </span><span class="s1">cause</span>
                <span class="s1">te</span><span class="s3">.</span><span class="s1">__context__ </span><span class="s3">= </span><span class="s1">context</span>
                <span class="s1">te</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s3">= </span><span class="s1">exceptions</span>
                <span class="s2">if </span><span class="s1">cause</span><span class="s3">:</span>
                    <span class="s1">queue</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">te</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">context</span><span class="s3">:</span>
                    <span class="s1">queue</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">te</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__context__</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">exceptions</span><span class="s3">:</span>
                    <span class="s1">queue</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">te</span><span class="s3">.</span><span class="s1">exceptions</span><span class="s3">, </span><span class="s1">e</span><span class="s3">.</span><span class="s1">exceptions</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">format</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *, </span><span class="s1">chain</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">_ctx</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">_ctx </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">_ctx </span><span class="s3">= </span><span class="s1">_ExceptionPrintContext</span><span class="s3">()</span>

        <span class="s1">output </span><span class="s3">= []</span>
        <span class="s1">exc </span><span class="s3">= </span><span class="s1">self</span>
        <span class="s2">if </span><span class="s1">chain</span><span class="s3">:</span>
            <span class="s2">while </span><span class="s1">exc</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">__cause__ </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">chained_msg </span><span class="s3">= </span><span class="s1">_cause_message</span>
                    <span class="s1">chained_exc </span><span class="s3">= </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">__cause__</span>
                <span class="s2">elif </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">__context__ </span><span class="s2">is not None and not </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">__suppress_context__</span><span class="s3">:</span>
                    <span class="s1">chained_msg </span><span class="s3">= </span><span class="s1">_context_message</span>
                    <span class="s1">chained_exc </span><span class="s3">= </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">__context__</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">chained_msg </span><span class="s3">= </span><span class="s2">None</span>
                    <span class="s1">chained_exc </span><span class="s3">= </span><span class="s2">None</span>

                <span class="s1">output</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">chained_msg</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">))</span>
                <span class="s1">exc </span><span class="s3">= </span><span class="s1">chained_exc</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">output</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s2">None</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">exc </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">output</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">msg </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">:</span>
                    <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s5">&quot;Traceback (most recent call last):</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
                    <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">.</span><span class="s1">format</span><span class="s3">())</span>
                <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">format_exception_only</span><span class="s3">())</span>
            <span class="s2">elif </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">&gt; </span><span class="s1">max_group_depth</span><span class="s3">:</span>
                <span class="s0"># exception group, but depth exceeds limit</span>
                <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s5">f&quot;... (max_group_depth is </span><span class="s2">{</span><span class="s1">max_group_depth</span><span class="s2">}</span><span class="s5">)</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># format exception group</span>
                <span class="s1">is_toplevel </span><span class="s3">= </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">== </span><span class="s4">0</span>
                <span class="s2">if </span><span class="s1">is_toplevel</span><span class="s3">:</span>
                    <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">+= </span><span class="s4">1</span>

                <span class="s2">if </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">:</span>
                    <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
                        <span class="s5">&quot;Exception Group Traceback (most recent call last):</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">,</span>
                        <span class="s1">margin_char</span><span class="s3">=</span><span class="s5">&quot;+&quot; </span><span class="s2">if </span><span class="s1">is_toplevel </span><span class="s2">else None</span><span class="s3">,</span>
                    <span class="s3">)</span>
                    <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">stack</span><span class="s3">.</span><span class="s1">format</span><span class="s3">())</span>

                <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">format_exception_only</span><span class="s3">())</span>
                <span class="s1">num_excs </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">.</span><span class="s1">exceptions</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">num_excs </span><span class="s3">&lt;= </span><span class="s1">max_group_width</span><span class="s3">:</span>
                    <span class="s1">n </span><span class="s3">= </span><span class="s1">num_excs</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">n </span><span class="s3">= </span><span class="s1">max_group_width </span><span class="s3">+ </span><span class="s4">1</span>
                <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">need_close </span><span class="s3">= </span><span class="s2">False</span>
                <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
                    <span class="s1">last_exc </span><span class="s3">= </span><span class="s1">i </span><span class="s3">== </span><span class="s1">n </span><span class="s3">- </span><span class="s4">1</span>
                    <span class="s2">if </span><span class="s1">last_exc</span><span class="s3">:</span>
                        <span class="s0"># The closing frame may be added by a recursive call</span>
                        <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">need_close </span><span class="s3">= </span><span class="s2">True</span>

                    <span class="s2">if </span><span class="s1">max_group_width </span><span class="s2">is not None</span><span class="s3">:</span>
                        <span class="s1">truncated </span><span class="s3">= </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s1">max_group_width</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">truncated </span><span class="s3">= </span><span class="s2">False</span>
                    <span class="s1">title </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">if not </span><span class="s1">truncated </span><span class="s2">else </span><span class="s5">&quot;...&quot;</span>
                    <span class="s2">yield </span><span class="s3">(</span>
                        <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">()</span>
                        <span class="s3">+ (</span><span class="s5">&quot;+-&quot; </span><span class="s2">if </span><span class="s1">i </span><span class="s3">== </span><span class="s4">0 </span><span class="s2">else </span><span class="s5">&quot;  &quot;</span><span class="s3">)</span>
                        <span class="s3">+ </span><span class="s5">f&quot;+---------------- </span><span class="s2">{</span><span class="s1">title</span><span class="s2">} </span><span class="s5">----------------</span><span class="s2">\n</span><span class="s5">&quot;</span>
                    <span class="s3">)</span>
                    <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">+= </span><span class="s4">1</span>
                    <span class="s2">if not </span><span class="s1">truncated</span><span class="s3">:</span>
                        <span class="s2">yield from </span><span class="s1">exc</span><span class="s3">.</span><span class="s1">exceptions</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">format</span><span class="s3">(</span><span class="s1">chain</span><span class="s3">=</span><span class="s1">chain</span><span class="s3">, </span><span class="s1">_ctx</span><span class="s3">=</span><span class="s1">_ctx</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">remaining </span><span class="s3">= </span><span class="s1">num_excs </span><span class="s3">- </span><span class="s1">max_group_width</span>
                        <span class="s1">plural </span><span class="s3">= </span><span class="s5">&quot;s&quot; </span><span class="s2">if </span><span class="s1">remaining </span><span class="s3">&gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s5">&quot;&quot;</span>
                        <span class="s2">yield from </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
                            <span class="s5">f&quot;and </span><span class="s2">{</span><span class="s1">remaining</span><span class="s2">} </span><span class="s5">more exception</span><span class="s2">{</span><span class="s1">plural</span><span class="s2">}\n</span><span class="s5">&quot;</span>
                        <span class="s3">)</span>

                    <span class="s2">if </span><span class="s1">last_exc </span><span class="s2">and </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">need_close</span><span class="s3">:</span>
                        <span class="s2">yield </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">() + </span><span class="s5">&quot;+------------------------------------</span><span class="s2">\n</span><span class="s5">&quot;</span>
                        <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">need_close </span><span class="s3">= </span><span class="s2">False</span>
                    <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">-= </span><span class="s4">1</span>

                <span class="s2">if </span><span class="s1">is_toplevel</span><span class="s3">:</span>
                    <span class="s2">assert </span><span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">== </span><span class="s4">1</span>
                    <span class="s1">_ctx</span><span class="s3">.</span><span class="s1">exception_group_depth </span><span class="s3">= </span><span class="s4">0</span>

    <span class="s2">def </span><span class="s1">format_exception_only</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Format the exception part of the traceback. 
        The return value is a generator of strings, each ending in a newline. 
        Normally, the generator emits a single string; however, for 
        SyntaxError exceptions, it emits several lines that (when 
        printed) display detailed information about where the syntax 
        error occurred. 
        The message indicating which exception occurred is always the last 
        string in the output. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exc_type </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">_format_final_exc_line</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_str</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s1">stype </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exc_type</span><span class="s3">.</span><span class="s1">__qualname__</span>
        <span class="s1">smod </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">exc_type</span><span class="s3">.</span><span class="s1">__module__</span>
        <span class="s2">if </span><span class="s1">smod </span><span class="s2">not in </span><span class="s3">(</span><span class="s5">&quot;__main__&quot;</span><span class="s3">, </span><span class="s5">&quot;builtins&quot;</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">smod</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">smod </span><span class="s3">= </span><span class="s5">&quot;&lt;unknown&gt;&quot;</span>
            <span class="s1">stype </span><span class="s3">= </span><span class="s1">smod </span><span class="s3">+ </span><span class="s5">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">stype</span>

        <span class="s2">if not </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">exc_type</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
            <span class="s2">yield </span><span class="s1">_format_final_exc_line</span><span class="s3">(</span><span class="s1">stype</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_str</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">traceback_exception_format_syntax_error </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">yield from </span><span class="s1">traceback_exception_format_syntax_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">stype</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">yield from </span><span class="s1">traceback_exception_original_format_exception_only</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__</span><span class="s3">, </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">abc</span><span class="s3">.</span><span class="s1">Sequence</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">note </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__</span><span class="s3">:</span>
                <span class="s1">note </span><span class="s3">= </span><span class="s1">_safe_string</span><span class="s3">(</span><span class="s1">note</span><span class="s3">, </span><span class="s5">&quot;note&quot;</span><span class="s3">)</span>
                <span class="s2">yield from </span><span class="s3">[</span><span class="s1">line </span><span class="s3">+ </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">note</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)]</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__ </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s1">_safe_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__notes__</span><span class="s3">, </span><span class="s5">&quot;__notes__&quot;</span><span class="s3">, </span><span class="s1">func</span><span class="s3">=</span><span class="s1">repr</span><span class="s3">)</span>


<span class="s1">traceback_exception_original_format </span><span class="s3">= </span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">.</span><span class="s1">format</span>
<span class="s1">traceback_exception_original_format_exception_only </span><span class="s3">= (</span>
    <span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">.</span><span class="s1">format_exception_only</span>
<span class="s3">)</span>
<span class="s1">traceback_exception_format_syntax_error </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span>
    <span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">, </span><span class="s5">&quot;_format_syntax_error&quot;</span><span class="s3">, </span><span class="s2">None</span>
<span class="s3">)</span>
<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">excepthook </span><span class="s2">is </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">__excepthook__</span><span class="s3">:</span>
    <span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">.</span><span class="s1">__init__ </span><span class="s3">= (  </span><span class="s0"># type: ignore[assignment]</span>
        <span class="s1">PatchedTracebackException</span><span class="s3">.</span><span class="s1">__init__</span>
    <span class="s3">)</span>
    <span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">.</span><span class="s1">format </span><span class="s3">= (  </span><span class="s0"># type: ignore[assignment]</span>
        <span class="s1">PatchedTracebackException</span><span class="s3">.</span><span class="s1">format</span>
    <span class="s3">)</span>
    <span class="s1">traceback</span><span class="s3">.</span><span class="s1">TracebackException</span><span class="s3">.</span><span class="s1">format_exception_only </span><span class="s3">= (  </span><span class="s0"># type: ignore[assignment]</span>
        <span class="s1">PatchedTracebackException</span><span class="s3">.</span><span class="s1">format_exception_only</span>
    <span class="s3">)</span>
    <span class="s1">sys</span><span class="s3">.</span><span class="s1">excepthook </span><span class="s3">= </span><span class="s1">exceptiongroup_excepthook</span>


<span class="s3">@</span><span class="s1">singledispatch</span>
<span class="s2">def </span><span class="s1">format_exception_only</span><span class="s3">(</span><span class="s1">__exc</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span>
        <span class="s1">PatchedTracebackException</span><span class="s3">(</span>
            <span class="s1">type</span><span class="s3">(</span><span class="s1">__exc</span><span class="s3">), </span><span class="s1">__exc</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">compact</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">).</span><span class="s1">format_exception_only</span><span class="s3">()</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">format_exception_only</span><span class="s3">.</span><span class="s1">register</span>
<span class="s2">def </span><span class="s1">_</span><span class="s3">(</span><span class="s1">__exc</span><span class="s3">: </span><span class="s1">type</span><span class="s3">, </span><span class="s1">value</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s2">return </span><span class="s1">format_exception_only</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">singledispatch</span>
<span class="s2">def </span><span class="s1">format_exception</span><span class="s3">(</span>
    <span class="s1">__exc</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">,</span>
    <span class="s1">limit</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">chain</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span>
        <span class="s1">PatchedTracebackException</span><span class="s3">(</span>
            <span class="s1">type</span><span class="s3">(</span><span class="s1">__exc</span><span class="s3">), </span><span class="s1">__exc</span><span class="s3">, </span><span class="s1">__exc</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">=</span><span class="s1">limit</span><span class="s3">, </span><span class="s1">compact</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">).</span><span class="s1">format</span><span class="s3">(</span><span class="s1">chain</span><span class="s3">=</span><span class="s1">chain</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">format_exception</span><span class="s3">.</span><span class="s1">register</span>
<span class="s2">def </span><span class="s1">_</span><span class="s3">(</span>
    <span class="s1">__exc</span><span class="s3">: </span><span class="s1">type</span><span class="s3">,</span>
    <span class="s1">value</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">,</span>
    <span class="s1">tb</span><span class="s3">: </span><span class="s1">TracebackType</span><span class="s3">,</span>
    <span class="s1">limit</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">chain</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s2">return </span><span class="s1">format_exception</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">, </span><span class="s1">chain</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">singledispatch</span>
<span class="s2">def </span><span class="s1">print_exception</span><span class="s3">(</span>
    <span class="s1">__exc</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">,</span>
    <span class="s1">limit</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">file</span><span class="s3">: </span><span class="s1">Any </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">chain</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s2">if </span><span class="s1">file </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">file </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stderr</span>

    <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">PatchedTracebackException</span><span class="s3">(</span>
        <span class="s1">type</span><span class="s3">(</span><span class="s1">__exc</span><span class="s3">), </span><span class="s1">__exc</span><span class="s3">, </span><span class="s1">__exc</span><span class="s3">.</span><span class="s1">__traceback__</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">=</span><span class="s1">limit</span>
    <span class="s3">).</span><span class="s1">format</span><span class="s3">(</span><span class="s1">chain</span><span class="s3">=</span><span class="s1">chain</span><span class="s3">):</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">file</span><span class="s3">=</span><span class="s1">file</span><span class="s3">, </span><span class="s1">end</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">print_exception</span><span class="s3">.</span><span class="s1">register</span>
<span class="s2">def </span><span class="s1">_</span><span class="s3">(</span>
    <span class="s1">__exc</span><span class="s3">: </span><span class="s1">type</span><span class="s3">,</span>
    <span class="s1">value</span><span class="s3">: </span><span class="s1">BaseException</span><span class="s3">,</span>
    <span class="s1">tb</span><span class="s3">: </span><span class="s1">TracebackType</span><span class="s3">,</span>
    <span class="s1">limit</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">file</span><span class="s3">: </span><span class="s1">Any </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">chain</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">print_exception</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">, </span><span class="s1">file</span><span class="s3">, </span><span class="s1">chain</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">print_exc</span><span class="s3">(</span>
    <span class="s1">limit</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">file</span><span class="s3">: </span><span class="s1">Any </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">chain</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
<span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">value </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">exc_info</span><span class="s3">()[</span><span class="s4">1</span><span class="s3">]</span>
    <span class="s1">print_exception</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">limit</span><span class="s3">, </span><span class="s1">file</span><span class="s3">, </span><span class="s1">chain</span><span class="s3">)</span>


<span class="s0"># Python levenshtein edit distance code for NameError/AttributeError</span>
<span class="s0"># suggestions, backported from 3.12</span>

<span class="s1">_MAX_CANDIDATE_ITEMS </span><span class="s3">= </span><span class="s4">750</span>
<span class="s1">_MAX_STRING_SIZE </span><span class="s3">= </span><span class="s4">40</span>
<span class="s1">_MOVE_COST </span><span class="s3">= </span><span class="s4">2</span>
<span class="s1">_CASE_COST </span><span class="s3">= </span><span class="s4">1</span>
<span class="s1">_SENTINEL </span><span class="s3">= </span><span class="s1">object</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_substitution_cost</span><span class="s3">(</span><span class="s1">ch_a</span><span class="s3">, </span><span class="s1">ch_b</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">ch_a </span><span class="s3">== </span><span class="s1">ch_b</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s4">0</span>
    <span class="s2">if </span><span class="s1">ch_a</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">() == </span><span class="s1">ch_b</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s1">_CASE_COST</span>
    <span class="s2">return </span><span class="s1">_MOVE_COST</span>


<span class="s2">def </span><span class="s1">_compute_suggestion_error</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s1">tb</span><span class="s3">):</span>
    <span class="s1">wrong_name </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s5">&quot;name&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">wrong_name </span><span class="s2">is None or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">wrong_name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s2">return None</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">):</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s5">&quot;obj&quot;</span><span class="s3">, </span><span class="s1">_SENTINEL</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">obj </span><span class="s2">is </span><span class="s1">_SENTINEL</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">exc_value</span><span class="s3">.</span><span class="s1">obj</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">d </span><span class="s3">= </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">return None</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exc_value</span><span class="s3">, </span><span class="s1">NameError</span><span class="s3">)</span>
        <span class="s0"># find most recent frame</span>
        <span class="s2">if </span><span class="s1">tb </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">while </span><span class="s1">tb</span><span class="s3">.</span><span class="s1">tb_next </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">tb </span><span class="s3">= </span><span class="s1">tb</span><span class="s3">.</span><span class="s1">tb_next</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">tb</span><span class="s3">.</span><span class="s1">tb_frame</span>

        <span class="s1">d </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_locals</span><span class="s3">) + </span><span class="s1">list</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_globals</span><span class="s3">) + </span><span class="s1">list</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">.</span><span class="s1">f_builtins</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">d</span><span class="s3">) &gt; </span><span class="s1">_MAX_CANDIDATE_ITEMS</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s1">wrong_name_len </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">wrong_name</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">wrong_name_len </span><span class="s3">&gt; </span><span class="s1">_MAX_STRING_SIZE</span><span class="s3">:</span>
        <span class="s2">return None</span>
    <span class="s1">best_distance </span><span class="s3">= </span><span class="s1">wrong_name_len</span>
    <span class="s1">suggestion </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">for </span><span class="s1">possible_name </span><span class="s2">in </span><span class="s1">d</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">possible_name </span><span class="s3">== </span><span class="s1">wrong_name</span><span class="s3">:</span>
            <span class="s0"># A missing attribute is &quot;found&quot;. Don't suggest it (see GH-88821).</span>
            <span class="s2">continue</span>
        <span class="s0"># No more than 1/3 of the involved characters should need changed.</span>
        <span class="s1">max_distance </span><span class="s3">= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">possible_name</span><span class="s3">) + </span><span class="s1">wrong_name_len </span><span class="s3">+ </span><span class="s4">3</span><span class="s3">) * </span><span class="s1">_MOVE_COST </span><span class="s3">// </span><span class="s4">6</span>
        <span class="s0"># Don't take matches we've already beaten.</span>
        <span class="s1">max_distance </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">max_distance</span><span class="s3">, </span><span class="s1">best_distance </span><span class="s3">- </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">current_distance </span><span class="s3">= </span><span class="s1">_levenshtein_distance</span><span class="s3">(</span>
            <span class="s1">wrong_name</span><span class="s3">, </span><span class="s1">possible_name</span><span class="s3">, </span><span class="s1">max_distance</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">current_distance </span><span class="s3">&gt; </span><span class="s1">max_distance</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">if not </span><span class="s1">suggestion </span><span class="s2">or </span><span class="s1">current_distance </span><span class="s3">&lt; </span><span class="s1">best_distance</span><span class="s3">:</span>
            <span class="s1">suggestion </span><span class="s3">= </span><span class="s1">possible_name</span>
            <span class="s1">best_distance </span><span class="s3">= </span><span class="s1">current_distance</span>
    <span class="s2">return </span><span class="s1">suggestion</span>


<span class="s2">def </span><span class="s1">_levenshtein_distance</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">max_cost</span><span class="s3">):</span>
    <span class="s0"># A Python implementation of Python/suggestions.c:levenshtein_distance.</span>

    <span class="s0"># Both strings are the same</span>
    <span class="s2">if </span><span class="s1">a </span><span class="s3">== </span><span class="s1">b</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s4">0</span>

    <span class="s0"># Trim away common affixes</span>
    <span class="s1">pre </span><span class="s3">= </span><span class="s4">0</span>
    <span class="s2">while </span><span class="s1">a</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">:] </span><span class="s2">and </span><span class="s1">b</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">:] </span><span class="s2">and </span><span class="s1">a</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">] == </span><span class="s1">b</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">]:</span>
        <span class="s1">pre </span><span class="s3">+= </span><span class="s4">1</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">a</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">:]</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">b</span><span class="s3">[</span><span class="s1">pre</span><span class="s3">:]</span>
    <span class="s1">post </span><span class="s3">= </span><span class="s4">0</span>
    <span class="s2">while </span><span class="s1">a</span><span class="s3">[: </span><span class="s1">post </span><span class="s2">or None</span><span class="s3">] </span><span class="s2">and </span><span class="s1">b</span><span class="s3">[: </span><span class="s1">post </span><span class="s2">or None</span><span class="s3">] </span><span class="s2">and </span><span class="s1">a</span><span class="s3">[</span><span class="s1">post </span><span class="s3">- </span><span class="s4">1</span><span class="s3">] == </span><span class="s1">b</span><span class="s3">[</span><span class="s1">post </span><span class="s3">- </span><span class="s4">1</span><span class="s3">]:</span>
        <span class="s1">post </span><span class="s3">-= </span><span class="s4">1</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">a</span><span class="s3">[: </span><span class="s1">post </span><span class="s2">or None</span><span class="s3">]</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">b</span><span class="s3">[: </span><span class="s1">post </span><span class="s2">or None</span><span class="s3">]</span>
    <span class="s2">if not </span><span class="s1">a </span><span class="s2">or not </span><span class="s1">b</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">_MOVE_COST </span><span class="s3">* (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) + </span><span class="s1">len</span><span class="s3">(</span><span class="s1">b</span><span class="s3">))</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) &gt; </span><span class="s1">_MAX_STRING_SIZE </span><span class="s2">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) &gt; </span><span class="s1">_MAX_STRING_SIZE</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">max_cost </span><span class="s3">+ </span><span class="s4">1</span>

    <span class="s0"># Prefer shorter buffer</span>
    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) &lt; </span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">):</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">b</span><span class="s3">, </span><span class="s1">a</span>

    <span class="s0"># Quick fail when a match is impossible</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) - </span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)) * </span><span class="s1">_MOVE_COST </span><span class="s3">&gt; </span><span class="s1">max_cost</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">max_cost </span><span class="s3">+ </span><span class="s4">1</span>

    <span class="s0"># Instead of producing the whole traditional len(a)-by-len(b)</span>
    <span class="s0"># matrix, we can update just one row in place.</span>
    <span class="s0"># Initialize the buffer row</span>
    <span class="s1">row </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">_MOVE_COST</span><span class="s3">, </span><span class="s1">_MOVE_COST </span><span class="s3">* (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) + </span><span class="s4">1</span><span class="s3">), </span><span class="s1">_MOVE_COST</span><span class="s3">))</span>

    <span class="s1">result </span><span class="s3">= </span><span class="s4">0</span>
    <span class="s2">for </span><span class="s1">bindex </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)):</span>
        <span class="s1">bchar </span><span class="s3">= </span><span class="s1">b</span><span class="s3">[</span><span class="s1">bindex</span><span class="s3">]</span>
        <span class="s1">distance </span><span class="s3">= </span><span class="s1">result </span><span class="s3">= </span><span class="s1">bindex </span><span class="s3">* </span><span class="s1">_MOVE_COST</span>
        <span class="s1">minimum </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">maxsize</span>
        <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)):</span>
            <span class="s0"># 1) Previous distance in this row is cost(b[:b_index], a[:index])</span>
            <span class="s1">substitute </span><span class="s3">= </span><span class="s1">distance </span><span class="s3">+ </span><span class="s1">_substitution_cost</span><span class="s3">(</span><span class="s1">bchar</span><span class="s3">, </span><span class="s1">a</span><span class="s3">[</span><span class="s1">index</span><span class="s3">])</span>
            <span class="s0"># 2) cost(b[:b_index], a[:index+1]) from previous row</span>
            <span class="s1">distance </span><span class="s3">= </span><span class="s1">row</span><span class="s3">[</span><span class="s1">index</span><span class="s3">]</span>
            <span class="s0"># 3) existing result is cost(b[:b_index+1], a[index])</span>

            <span class="s1">insert_delete </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">distance</span><span class="s3">) + </span><span class="s1">_MOVE_COST</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">insert_delete</span><span class="s3">, </span><span class="s1">substitute</span><span class="s3">)</span>

            <span class="s0"># cost(b[:b_index+1], a[:index+1])</span>
            <span class="s1">row</span><span class="s3">[</span><span class="s1">index</span><span class="s3">] = </span><span class="s1">result</span>
            <span class="s2">if </span><span class="s1">result </span><span class="s3">&lt; </span><span class="s1">minimum</span><span class="s3">:</span>
                <span class="s1">minimum </span><span class="s3">= </span><span class="s1">result</span>
        <span class="s2">if </span><span class="s1">minimum </span><span class="s3">&gt; </span><span class="s1">max_cost</span><span class="s3">:</span>
            <span class="s0"># Everything in this row is too big, so bail early.</span>
            <span class="s2">return </span><span class="s1">max_cost </span><span class="s3">+ </span><span class="s4">1</span>
    <span class="s2">return </span><span class="s1">result</span>
</pre>
</body>
</html>