<html>
<head>
<title>path.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
path.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;local path implementation.&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">atexit</span>
<span class="s2">import </span><span class="s1">fnmatch</span>
<span class="s2">import </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">util</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">posixpath</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">uuid</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">contextmanager</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">abspath</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">dirname</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">exists</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">isabs</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">isdir</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">isfile</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">islink</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">normpath</span>
<span class="s2">from </span><span class="s1">stat </span><span class="s2">import </span><span class="s1">S_ISDIR</span>
<span class="s2">from </span><span class="s1">stat </span><span class="s2">import </span><span class="s1">S_ISLNK</span>
<span class="s2">from </span><span class="s1">stat </span><span class="s2">import </span><span class="s1">S_ISREG</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Callable</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">cast</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">overload</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">TYPE_CHECKING</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">error</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Literal</span>

<span class="s4"># Moved from local.py.</span>
<span class="s1">iswin32 </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;win32&quot; </span><span class="s2">or </span><span class="s3">(</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">, </span><span class="s5">&quot;_name&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">) == </span><span class="s5">&quot;nt&quot;</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Checkers</span><span class="s3">:</span>
    <span class="s1">_depend_on_existence </span><span class="s3">= </span><span class="s5">&quot;exists&quot;</span><span class="s3">, </span><span class="s5">&quot;link&quot;</span><span class="s3">, </span><span class="s5">&quot;dir&quot;</span><span class="s3">, </span><span class="s5">&quot;file&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span>

    <span class="s2">def </span><span class="s1">dotfile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">ext</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">):</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s5">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">arg</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">ext </span><span class="s3">== </span><span class="s1">arg</span>

    <span class="s2">def </span><span class="s1">basename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename </span><span class="s3">== </span><span class="s1">arg</span>

    <span class="s2">def </span><span class="s1">basestarts</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">relto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">fnmatch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">fnmatch</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">).</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_evaluate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kw</span><span class="s3">):</span>
        <span class="s2">from </span><span class="s3">..</span><span class="s1">_code</span><span class="s3">.</span><span class="s1">source </span><span class="s2">import </span><span class="s1">getrawcode</span>

        <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s1">invert </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s1">meth </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">meth </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">name</span><span class="s3">[:</span><span class="s6">3</span><span class="s3">] == </span><span class="s5">&quot;not&quot;</span><span class="s3">:</span>
                    <span class="s1">invert </span><span class="s3">= </span><span class="s2">True</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">meth </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">[</span><span class="s6">3</span><span class="s3">:])</span>
                    <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                        <span class="s2">pass</span>
            <span class="s2">if </span><span class="s1">meth </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">f&quot;no </span><span class="s2">{</span><span class="s1">name</span><span class="s2">!r} </span><span class="s5">checker available for </span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s2">!r}</span><span class="s5">&quot;</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">getrawcode</span><span class="s3">(</span><span class="s1">meth</span><span class="s3">).</span><span class="s1">co_argcount </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s3">(</span><span class="s2">not </span><span class="s1">meth</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)) ^ </span><span class="s1">invert</span><span class="s3">:</span>
                        <span class="s2">return False</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">value</span><span class="s3">) ^ </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">meth</span><span class="s3">()) ^ </span><span class="s1">invert</span><span class="s3">:</span>
                        <span class="s2">return False</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOTDIR</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EBUSY</span><span class="s3">):</span>
                <span class="s4"># EBUSY feels not entirely correct,</span>
                <span class="s4"># but its kind of necessary since ENOMEDIUM</span>
                <span class="s4"># is not accessible in python</span>
                <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_depend_on_existence</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
                            <span class="s2">return False</span>
                    <span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;not&quot; </span><span class="s3">+ </span><span class="s1">name</span>
                    <span class="s2">if </span><span class="s1">name </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
                        <span class="s2">if not </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
                            <span class="s2">return False</span>
        <span class="s2">return True</span>

    <span class="s1">_statcache</span><span class="s3">: </span><span class="s1">Stat</span>

    <span class="s2">def </span><span class="s1">_stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Stat</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_statcache</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_statcache </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ELOOP</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_statcache </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_statcache</span>

    <span class="s2">def </span><span class="s1">dir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">S_ISDIR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stat</span><span class="s3">().</span><span class="s1">mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">file</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">S_ISREG</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stat</span><span class="s3">().</span><span class="s1">mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_stat</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">link</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">st </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">S_ISLNK</span><span class="s3">(</span><span class="s1">st</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">NeverRaised</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">class </span><span class="s1">Visitor</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fil</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">, </span><span class="s1">ignore</span><span class="s3">, </span><span class="s1">bf</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">fil </span><span class="s3">= </span><span class="s1">FNMatcher</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rec</span><span class="s3">: </span><span class="s1">Callable</span><span class="s3">[[</span><span class="s1">LocalPath</span><span class="s3">], </span><span class="s1">bool</span><span class="s3">] = </span><span class="s1">FNMatcher</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">)</span>
        <span class="s2">elif not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">, </span><span class="s5">&quot;__call__&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">rec</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rec </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">path</span><span class="s3">: </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rec </span><span class="s3">= </span><span class="s1">rec</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fil </span><span class="s3">= </span><span class="s1">fil</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ignore </span><span class="s3">= </span><span class="s1">ignore</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">breadthfirst </span><span class="s3">= </span><span class="s1">bf</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">optsort </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">Callable</span><span class="s3">[[</span><span class="s1">Any</span><span class="s3">], </span><span class="s1">Any</span><span class="s3">], </span><span class="s1">sorted</span><span class="s3">) </span><span class="s2">if </span><span class="s1">sort </span><span class="s2">else </span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">gen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">entries </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ignore</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">rec </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rec</span>
        <span class="s1">dirs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">optsort</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">p </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">entries </span><span class="s2">if </span><span class="s1">p</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span><span class="s1">rec </span><span class="s2">is None or </span><span class="s1">rec</span><span class="s3">(</span><span class="s1">p</span><span class="s3">))]</span>
        <span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">breadthfirst</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">subdir </span><span class="s2">in </span><span class="s1">dirs</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gen</span><span class="s3">(</span><span class="s1">subdir</span><span class="s3">):</span>
                    <span class="s2">yield </span><span class="s1">p</span>
        <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">optsort</span><span class="s3">(</span><span class="s1">entries</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fil </span><span class="s2">is None or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fil</span><span class="s3">(</span><span class="s1">p</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">p</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">breadthfirst</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">subdir </span><span class="s2">in </span><span class="s1">dirs</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gen</span><span class="s3">(</span><span class="s1">subdir</span><span class="s3">):</span>
                    <span class="s2">yield </span><span class="s1">p</span>


<span class="s2">class </span><span class="s1">FNMatcher</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">pattern </span><span class="s3">= </span><span class="s1">pattern</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s1">pattern </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pattern</span>

        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">pattern</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">) == -</span><span class="s6">1</span>
            <span class="s2">and </span><span class="s1">iswin32</span>
            <span class="s2">and </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">posixpath</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">) != -</span><span class="s6">1</span>
        <span class="s3">):</span>
            <span class="s4"># Running on Windows, the pattern has no Windows path separators,</span>
            <span class="s4"># and the pattern has one or more Posix path separators. Replace</span>
            <span class="s4"># the Posix path separators with the Windows path separator.</span>
            <span class="s1">pattern </span><span class="s3">= </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">posixpath</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">) == -</span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)  </span><span class="s4"># path.strpath # XXX svn?</span>
            <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isabs</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">):</span>
                <span class="s1">pattern </span><span class="s3">= </span><span class="s5">&quot;*&quot; </span><span class="s3">+ </span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep </span><span class="s3">+ </span><span class="s1">pattern</span>
        <span class="s2">return </span><span class="s1">fnmatch</span><span class="s3">.</span><span class="s1">fnmatch</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">map_as_list</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">iter</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">iter</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">Stat</span><span class="s3">:</span>
    <span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>

        <span class="s3">@</span><span class="s1">property</span>
        <span class="s2">def </span><span class="s1">size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
            <span class="s3">...</span>

        <span class="s3">@</span><span class="s1">property</span>
        <span class="s2">def </span><span class="s1">mtime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
            <span class="s3">...</span>

    <span class="s2">def </span><span class="s1">__getattr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Any</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_osstatresult</span><span class="s3">, </span><span class="s5">&quot;st_&quot; </span><span class="s3">+ </span><span class="s1">name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">osstatresult</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_osstatresult </span><span class="s3">= </span><span class="s1">osstatresult</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">owner</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s5">&quot;XXX win32&quot;</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">pwd</span>

        <span class="s1">entry </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">pwd</span><span class="s3">.</span><span class="s1">getpwuid</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">uid</span><span class="s3">)  </span><span class="s4"># type:ignore[attr-defined]</span>
        <span class="s2">return </span><span class="s1">entry</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">group</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return group name of file.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span><span class="s3">(</span><span class="s5">&quot;XXX win32&quot;</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">grp</span>

        <span class="s1">entry </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">grp</span><span class="s3">.</span><span class="s1">getgrgid</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gid</span><span class="s3">)  </span><span class="s4"># type:ignore[attr-defined]</span>
        <span class="s2">return </span><span class="s1">entry</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">S_ISDIR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_osstatresult</span><span class="s3">.</span><span class="s1">st_mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">S_ISREG</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_osstatresult</span><span class="s3">.</span><span class="s1">st_mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">islink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">S_ISLNK</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_osstatresult</span><span class="s3">.</span><span class="s1">st_mode</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getuserid</span><span class="s3">(</span><span class="s1">user</span><span class="s3">):</span>
    <span class="s2">import </span><span class="s1">pwd</span>

    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">user</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
        <span class="s1">user </span><span class="s3">= </span><span class="s1">pwd</span><span class="s3">.</span><span class="s1">getpwnam</span><span class="s3">(</span><span class="s1">user</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">]  </span><span class="s4"># type:ignore[attr-defined]</span>
    <span class="s2">return </span><span class="s1">user</span>


<span class="s2">def </span><span class="s1">getgroupid</span><span class="s3">(</span><span class="s1">group</span><span class="s3">):</span>
    <span class="s2">import </span><span class="s1">grp</span>

    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">group</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
        <span class="s1">group </span><span class="s3">= </span><span class="s1">grp</span><span class="s3">.</span><span class="s1">getgrnam</span><span class="s3">(</span><span class="s1">group</span><span class="s3">)[</span><span class="s6">2</span><span class="s3">]  </span><span class="s4"># type:ignore[attr-defined]</span>
    <span class="s2">return </span><span class="s1">group</span>


<span class="s2">class </span><span class="s1">LocalPath</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Object oriented interface to os.path and other local filesystem 
    related information. 
    &quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">ImportMismatchError</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;raised on pyimport() if there is a mismatch of __file__'s&quot;&quot;&quot;</span>

    <span class="s1">sep </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">expanduser</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Initialize and return a local Path instance. 
 
        Path can be relative to the current directory. 
        If path is None it defaults to the current working directory. 
        If expanduser is True, tilde-expansion is performed. 
        Note that Path instances always carry an absolute path. 
        Note also that passing in a local path object will simply return 
        the exact same path object. Use new() to get a new copy. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">path </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s5">&quot;can only pass None, Path instances &quot;</span>
                    <span class="s5">&quot;or non-empty strings to LocalPath&quot;</span>
                <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">expanduser</span><span class="s3">:</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">expanduser</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">!= </span><span class="s5">&quot;win32&quot;</span><span class="s3">:</span>

        <span class="s2">def </span><span class="s1">chown</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">user</span><span class="s3">, </span><span class="s1">group</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Change ownership to the given user and group. 
            user and group may be specified by a number or 
            by a name.  if rec is True change ownership 
            recursively. 
            &quot;&quot;&quot;</span>
            <span class="s1">uid </span><span class="s3">= </span><span class="s1">getuserid</span><span class="s3">(</span><span class="s1">user</span><span class="s3">)</span>
            <span class="s1">gid </span><span class="s3">= </span><span class="s1">getgroupid</span><span class="s3">(</span><span class="s1">group</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">rec</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">link</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)):</span>
                    <span class="s2">if </span><span class="s1">x</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">link</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
                        <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">chown</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">uid</span><span class="s3">, </span><span class="s1">gid</span><span class="s3">)</span>
            <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">chown</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s1">uid</span><span class="s3">, </span><span class="s1">gid</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">readlink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
            <span class="s0">&quot;&quot;&quot;Return value of a symbolic link.&quot;&quot;&quot;</span>
            <span class="s4"># https://github.com/python/mypy/issues/12278</span>
            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">readlink</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)  </span><span class="s4"># type: ignore[arg-type,return-value]</span>

        <span class="s2">def </span><span class="s1">mklinkto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">oldname</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Posix style hard link to another name.&quot;&quot;&quot;</span>
            <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">link</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">oldname</span><span class="s3">), </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">))</span>

        <span class="s2">def </span><span class="s1">mksymlinkto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">absolute</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Create a symbolic link with the given value (pointing to another name).&quot;&quot;&quot;</span>
            <span class="s2">if </span><span class="s1">absolute</span><span class="s3">:</span>
                <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">symlink</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">value</span><span class="s3">), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">base </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">common</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                <span class="s4"># with posix local paths '/' is always a common base</span>
                <span class="s1">relsource </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">(</span><span class="s1">value</span><span class="s3">).</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                <span class="s1">reldest </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
                <span class="s1">n </span><span class="s3">= </span><span class="s1">reldest</span><span class="s3">.</span><span class="s1">count</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                <span class="s1">target </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">((</span><span class="s5">&quot;..&quot;</span><span class="s3">,) * </span><span class="s1">n </span><span class="s3">+ (</span><span class="s1">relsource</span><span class="s3">,))</span>
                <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">symlink</span><span class="s3">, </span><span class="s1">target</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__div__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">))</span>

    <span class="s1">__truediv__ </span><span class="s3">= </span><span class="s1">__div__  </span><span class="s4"># py3k</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">basename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Basename part of path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getbyspec</span><span class="s3">(</span><span class="s5">&quot;basename&quot;</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Dirname part of path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getbyspec</span><span class="s3">(</span><span class="s5">&quot;dirname&quot;</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">purebasename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pure base name of the path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getbyspec</span><span class="s3">(</span><span class="s5">&quot;purebasename&quot;</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">ext</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Extension of the path (including the '.').&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getbyspec</span><span class="s3">(</span><span class="s5">&quot;ext&quot;</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">read_binary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Read and return a bytestring from reading the path.&quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">read_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Read and return a Unicode string from reading the path.&quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;r&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s5">&quot;r&quot;</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Read and return a bytestring from reading the path.&quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">readlines</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cr</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Read and return a list of lines from the path. if cr is False, the 
        newline will be removed from the end of each line.&quot;&quot;&quot;</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s5">&quot;r&quot;</span>

        <span class="s2">if not </span><span class="s1">cr</span><span class="s3">:</span>
            <span class="s1">content </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">content</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">f</span><span class="s3">.</span><span class="s1">readlines</span><span class="s3">()</span>
            <span class="s2">finally</span><span class="s3">:</span>
                <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">load</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;(deprecated) return object unpickled from self.read()&quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;rb&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">import </span><span class="s1">pickle</span>

            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">load</span><span class="s3">, </span><span class="s1">f</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">move</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Move this path to target.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">target</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EINVAL</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s5">&quot;cannot move path into a subdirectory of itself&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rename</span><span class="s3">(</span><span class="s1">target</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EXDEV</span><span class="s3">:  </span><span class="s4"># invalid cross-device link</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">target</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">fnmatch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return true if the basename/fullname matches the glob-'pattern'. 
 
        valid pattern characters:: 
 
            *       matches everything 
            ?       matches any single character 
            [seq]   matches any character in seq 
            [!seq]  matches any char not in seq 
 
        If the pattern contains a path-separator then the full path 
        is used for pattern matching and a '*' is prepended to the 
        pattern. 
 
        if the pattern doesn't contain a path-separator the pattern 
        is only matched against the basename. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">FNMatcher</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">)(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">relto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">relpath</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a string which is the relative part of the path 
        to the given 'relpath'. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">relpath</span><span class="s3">, (</span><span class="s1">str</span><span class="s3">, </span><span class="s1">LocalPath</span><span class="s3">)):</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">relpath</span><span class="s2">!r}</span><span class="s5">: not a string or path object&quot;</span><span class="s3">)</span>
        <span class="s1">strrelpath </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">relpath</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">strrelpath </span><span class="s2">and </span><span class="s1">strrelpath</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">] != </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">:</span>
            <span class="s1">strrelpath </span><span class="s3">+= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span>
        <span class="s4"># assert strrelpath[-1] == self.sep</span>
        <span class="s4"># assert strrelpath[-2] != self.sep</span>
        <span class="s1">strself </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">&quot;win32&quot; </span><span class="s2">or </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">, </span><span class="s5">&quot;_name&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) == </span><span class="s5">&quot;nt&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normcase</span><span class="s3">(</span><span class="s1">strself</span><span class="s3">).</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normcase</span><span class="s3">(</span><span class="s1">strrelpath</span><span class="s3">)):</span>
                <span class="s2">return </span><span class="s1">strself</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">strrelpath</span><span class="s3">) :]</span>
        <span class="s2">elif </span><span class="s1">strself</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">strrelpath</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">strself</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">strrelpath</span><span class="s3">) :]</span>
        <span class="s2">return </span><span class="s5">&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">ensure_dir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Ensure the path joined with args is a directory.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ensure</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **{</span><span class="s5">&quot;dir&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a string which is a relative path from self 
        (assumed to be a directory) to dest such that 
        self.join(bestrelpath) == dest and if not such 
        path can be determined return dest. 
        &quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self </span><span class="s3">== </span><span class="s1">dest</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">curdir</span>
            <span class="s1">base </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">common</span><span class="s3">(</span><span class="s1">dest</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">base</span><span class="s3">:  </span><span class="s4"># can be the case on windows</span>
                <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">dest</span><span class="s3">)</span>
            <span class="s1">self2base </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
            <span class="s1">reldest </span><span class="s3">= </span><span class="s1">dest</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">base</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self2base</span><span class="s3">:</span>
                <span class="s1">n </span><span class="s3">= </span><span class="s1">self2base</span><span class="s3">.</span><span class="s1">count</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">) + </span><span class="s6">1</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">n </span><span class="s3">= </span><span class="s6">0</span>
            <span class="s1">lst </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">pardir</span><span class="s3">] * </span><span class="s1">n</span>
            <span class="s2">if </span><span class="s1">reldest</span><span class="s3">:</span>
                <span class="s1">lst</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">reldest</span><span class="s3">)</span>
            <span class="s1">target </span><span class="s3">= </span><span class="s1">dest</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">target</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">dest</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">parts</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reverse</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a root-first list of all ancestor directories 
        plus the path itself. 
        &quot;&quot;&quot;</span>
        <span class="s1">current </span><span class="s3">= </span><span class="s1">self</span>
        <span class="s1">lst </span><span class="s3">= [</span><span class="s1">self</span><span class="s3">]</span>
        <span class="s2">while </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">last </span><span class="s3">= </span><span class="s1">current</span>
            <span class="s1">current </span><span class="s3">= </span><span class="s1">current</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">last </span><span class="s3">== </span><span class="s1">current</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">lst</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">current</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">reverse</span><span class="s3">:</span>
            <span class="s1">lst</span><span class="s3">.</span><span class="s1">reverse</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">lst</span>

    <span class="s2">def </span><span class="s1">common</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the common part shared with the other path 
        or None if there is no common part. 
        &quot;&quot;&quot;</span>
        <span class="s1">last </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">parts</span><span class="s3">(), </span><span class="s1">other</span><span class="s3">.</span><span class="s1">parts</span><span class="s3">()):</span>
            <span class="s2">if </span><span class="s1">x </span><span class="s3">!= </span><span class="s1">y</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">last</span>
            <span class="s1">last </span><span class="s3">= </span><span class="s1">x</span>
        <span class="s2">return </span><span class="s1">last</span>

    <span class="s2">def </span><span class="s1">__add__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return new path object with 'other' added to the basename&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">basename </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">other</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">visit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fil</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ignore</span><span class="s3">=</span><span class="s1">NeverRaised</span><span class="s3">, </span><span class="s1">bf</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Yields all paths below the current one 
 
        fil is a filter (glob pattern or callable), if not matching the 
        path will not be yielded, defaulting to None (everything is 
        returned) 
 
        rec is a filter (glob pattern or callable) that controls whether 
        a node is descended, defaulting to None 
 
        ignore is an Exception class that is ignoredwhen calling dirlist() 
        on any of the paths (by default, all exceptions are reported) 
 
        bf if True will cause a breadthfirst search instead of the 
        default depthfirst. Default: False 
 
        sort if True will sort entries within each directory level. 
        &quot;&quot;&quot;</span>
        <span class="s2">yield from </span><span class="s1">Visitor</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">, </span><span class="s1">ignore</span><span class="s3">, </span><span class="s1">bf</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">).</span><span class="s1">gen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_sortlist</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">sort</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">sort</span><span class="s3">, </span><span class="s5">&quot;__call__&quot;</span><span class="s3">):</span>
                <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                    <span class="s1">DeprecationWarning</span><span class="s3">(</span>
                        <span class="s5">&quot;listdir(sort=callable) is deprecated and breaks on python3&quot;</span>
                    <span class="s3">),</span>
                    <span class="s1">stacklevel</span><span class="s3">=</span><span class="s6">3</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">sort</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">__fspath__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>

    <span class="s2">def </span><span class="s1">__hash__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>
        <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
            <span class="s1">s </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">hash</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__eq__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s1">s1 </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">s2 </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
            <span class="s2">return False</span>
        <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
            <span class="s1">s1 </span><span class="s3">= </span><span class="s1">s1</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">s2 </span><span class="s3">= </span><span class="s1">s2</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s2">return False</span>
        <span class="s2">return </span><span class="s1">s1 </span><span class="s3">== </span><span class="s1">s2</span>

    <span class="s2">def </span><span class="s1">__ne__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return not </span><span class="s3">(</span><span class="s1">self </span><span class="s3">== </span><span class="s1">other</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__lt__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) &lt; </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__gt__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) &gt; </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">samefile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">other</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return True if 'other' references the same file as 'self'.&quot;&quot;&quot;</span>
        <span class="s1">other </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isabs</span><span class="s3">(</span><span class="s1">other</span><span class="s3">):</span>
            <span class="s1">other </span><span class="s3">= </span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">other</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self </span><span class="s3">== </span><span class="s1">other</span><span class="s3">:</span>
            <span class="s2">return True</span>
        <span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s5">&quot;samefile&quot;</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">samefile</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">other</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">remove</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Remove a file or directory (or a directory tree if rec=1). 
        if ignore_errors is True, errors while removing directories will 
        be ignored. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">link</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">rec</span><span class="s3">:</span>
                <span class="s4"># force remove of readonly files on windows</span>
                <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">(</span><span class="s6">0o700</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s2">import </span><span class="s1">shutil</span>

                <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span>
                    <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">ignore_errors</span><span class="s3">=</span><span class="s1">ignore_errors</span>
                <span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">rmdir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">(</span><span class="s6">0o700</span><span class="s3">)</span>
            <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">computehash</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">hashtype</span><span class="s3">=</span><span class="s5">&quot;md5&quot;</span><span class="s3">, </span><span class="s1">chunksize</span><span class="s3">=</span><span class="s6">524288</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return hexdigest of hashvalue for this file.&quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">import </span><span class="s1">hashlib </span><span class="s2">as </span><span class="s1">mod</span>
            <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">hashtype </span><span class="s3">== </span><span class="s5">&quot;sha1&quot;</span><span class="s3">:</span>
                    <span class="s1">hashtype </span><span class="s3">= </span><span class="s5">&quot;sha&quot;</span>
                <span class="s1">mod </span><span class="s3">= </span><span class="s1">__import__</span><span class="s3">(</span><span class="s1">hashtype</span><span class="s3">)</span>
            <span class="s1">hash </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">, </span><span class="s1">hashtype</span><span class="s3">)()</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">ImportError</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f&quot;Don't know how to compute </span><span class="s2">{</span><span class="s1">hashtype</span><span class="s2">!r} </span><span class="s5">hash&quot;</span><span class="s3">)</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;rb&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">while </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">buf </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunksize</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">buf</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">hash</span><span class="s3">.</span><span class="s1">hexdigest</span><span class="s3">()</span>
                <span class="s1">hash</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">new</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Create a modified version of this path. 
        the following keyword arguments modify various path parts:: 
 
          a:/some/path/to/a/file.ext 
          xx                           drive 
          xxxxxxxxxxxxxxxxx            dirname 
                            xxxxxxxx   basename 
                            xxxx       purebasename 
                                 xxx   ext 
        &quot;&quot;&quot;</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">object</span><span class="s3">.</span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">kw</span><span class="s3">:</span>
            <span class="s1">obj</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>
            <span class="s2">return </span><span class="s1">obj</span>
        <span class="s1">drive</span><span class="s3">, </span><span class="s1">dirname</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">purebasename</span><span class="s3">, </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getbyspec</span><span class="s3">(</span>
            <span class="s5">&quot;drive,dirname,basename,purebasename,ext&quot;</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s5">&quot;basename&quot; </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s5">&quot;purebasename&quot; </span><span class="s2">in </span><span class="s1">kw </span><span class="s2">or </span><span class="s5">&quot;ext&quot; </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;invalid specification %r&quot; </span><span class="s3">% </span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">pb </span><span class="s3">= </span><span class="s1">kw</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;purebasename&quot;</span><span class="s3">, </span><span class="s1">purebasename</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">ext </span><span class="s3">= </span><span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;ext&quot;</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                <span class="s2">pass</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">ext </span><span class="s2">and not </span><span class="s1">ext</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">):</span>
                    <span class="s1">ext </span><span class="s3">= </span><span class="s5">&quot;.&quot; </span><span class="s3">+ </span><span class="s1">ext</span>
            <span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;basename&quot;</span><span class="s3">] = </span><span class="s1">pb </span><span class="s3">+ </span><span class="s1">ext</span>

        <span class="s2">if </span><span class="s5">&quot;dirname&quot; </span><span class="s2">in </span><span class="s1">kw </span><span class="s2">and not </span><span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;dirname&quot;</span><span class="s3">]:</span>
            <span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;dirname&quot;</span><span class="s3">] = </span><span class="s1">drive</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">kw</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;dirname&quot;</span><span class="s3">, </span><span class="s1">dirname</span><span class="s3">)</span>
        <span class="s1">kw</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">&quot;sep&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
        <span class="s1">obj</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">normpath</span><span class="s3">(</span><span class="s5">&quot;%(dirname)s%(sep)s%(basename)s&quot; </span><span class="s3">% </span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">obj</span>

    <span class="s2">def </span><span class="s1">_getbyspec</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">spec</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot;See new for what 'spec' can be.&quot;&quot;&quot;</span>
        <span class="s1">res </span><span class="s3">= []</span>
        <span class="s1">parts </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>

        <span class="s1">args </span><span class="s3">= </span><span class="s1">filter</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">spec</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;,&quot;</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">args</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s5">&quot;drive&quot;</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
            <span class="s2">elif </span><span class="s1">name </span><span class="s3">== </span><span class="s5">&quot;dirname&quot;</span><span class="s3">:</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[:-</span><span class="s6">1</span><span class="s3">]))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">basename </span><span class="s3">= </span><span class="s1">parts</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s5">&quot;basename&quot;</span><span class="s3">:</span>
                    <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">i </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">rfind</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">i </span><span class="s3">== -</span><span class="s6">1</span><span class="s3">:</span>
                        <span class="s1">purebasename</span><span class="s3">, </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">, </span><span class="s5">&quot;&quot;</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">purebasename</span><span class="s3">, </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">[:</span><span class="s1">i</span><span class="s3">], </span><span class="s1">basename</span><span class="s3">[</span><span class="s1">i</span><span class="s3">:]</span>
                    <span class="s2">if </span><span class="s1">name </span><span class="s3">== </span><span class="s5">&quot;purebasename&quot;</span><span class="s3">:</span>
                        <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">purebasename</span><span class="s3">)</span>
                    <span class="s2">elif </span><span class="s1">name </span><span class="s3">== </span><span class="s5">&quot;ext&quot;</span><span class="s3">:</span>
                        <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;invalid part specification %r&quot; </span><span class="s3">% </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">dirpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the directory path joined with any given path arguments.&quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">kwargs</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">object</span><span class="s3">.</span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">)</span>
            <span class="s1">path</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">args</span><span class="s3">:</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">path</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">).</span><span class="s1">join</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">os</span><span class="s3">.</span><span class="s1">PathLike</span><span class="s3">[</span><span class="s1">str</span><span class="s3">], </span><span class="s1">abs</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; LocalPath</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return a new path by appending all 'args' as path 
        components.  if abs=1 is used restart from root if any 
        of the args is an absolute path. 
        &quot;&quot;&quot;</span>
        <span class="s1">sep </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span>
        <span class="s1">strargs </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">args</span><span class="s3">]</span>
        <span class="s1">strpath </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>
        <span class="s2">if </span><span class="s1">abs</span><span class="s3">:</span>
            <span class="s1">newargs</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = []</span>
            <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">strargs</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">isabs</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">):</span>
                    <span class="s1">strpath </span><span class="s3">= </span><span class="s1">arg</span>
                    <span class="s1">strargs </span><span class="s3">= </span><span class="s1">newargs</span>
                    <span class="s2">break</span>
                <span class="s1">newargs</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>
        <span class="s4"># special case for when we have e.g. strpath == &quot;/&quot;</span>
        <span class="s1">actual_sep </span><span class="s3">= </span><span class="s5">&quot;&quot; </span><span class="s2">if </span><span class="s1">strpath</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">) </span><span class="s2">else </span><span class="s1">sep</span>
        <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">strargs</span><span class="s3">:</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
                <span class="s4"># allow unix style paths even on windows.</span>
                <span class="s1">arg </span><span class="s3">= </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">(</span><span class="s5">&quot;/&quot;</span><span class="s3">)</span>
                <span class="s1">arg </span><span class="s3">= </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;/&quot;</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">)</span>
            <span class="s1">strpath </span><span class="s3">= </span><span class="s1">strpath </span><span class="s3">+ </span><span class="s1">actual_sep </span><span class="s3">+ </span><span class="s1">arg</span>
            <span class="s1">actual_sep </span><span class="s3">= </span><span class="s1">sep</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">object</span><span class="s3">.</span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">)</span>
        <span class="s1">obj</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">obj</span>

    <span class="s2">def </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s5">&quot;r&quot;</span><span class="s3">, </span><span class="s1">ensure</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return an opened file with the given mode. 
 
        If ensure is True, create parent directories if needed. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">ensure</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">encoding</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">io</span><span class="s3">.</span><span class="s1">open</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">open</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_fastjoin</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s1">child </span><span class="s3">= </span><span class="s1">object</span><span class="s3">.</span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">)</span>
        <span class="s1">child</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath </span><span class="s3">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep </span><span class="s3">+ </span><span class="s1">name</span>
        <span class="s2">return </span><span class="s1">child</span>

    <span class="s2">def </span><span class="s1">islink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">islink</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Check a path for existence and properties. 
 
        Without arguments, return True if the path exists, otherwise False. 
 
        valid checkers:: 
 
            file=1    # is a file 
            file=0    # is not a file (may not even exist) 
            dir=1     # is a dir 
            link=1    # is a link 
            exists=1  # exists 
 
        You can specify multiple checker definitions, for example:: 
 
            path.check(file=1, link=1)  # a link pointing to a file 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">kw</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s5">&quot;dir&quot; </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
                <span class="s2">return not </span><span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;dir&quot;</span><span class="s3">] ^ </span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s5">&quot;file&quot; </span><span class="s2">in </span><span class="s1">kw</span><span class="s3">:</span>
                <span class="s2">return not </span><span class="s1">kw</span><span class="s3">[</span><span class="s5">&quot;file&quot;</span><span class="s3">] ^ </span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">kw</span><span class="s3">:</span>
            <span class="s1">kw </span><span class="s3">= {</span><span class="s5">&quot;exists&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}</span>
        <span class="s2">return </span><span class="s1">Checkers</span><span class="s3">(</span><span class="s1">self</span><span class="s3">).</span><span class="s1">_evaluate</span><span class="s3">(</span><span class="s1">kw</span><span class="s3">)</span>

    <span class="s1">_patternchars </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s5">&quot;*?[&quot; </span><span class="s3">+ </span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fil</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;List directory contents, possibly filter by the given fil func 
        and possibly sorted. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">fil </span><span class="s2">is None and </span><span class="s1">sort </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">names </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">map_as_list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fastjoin</span><span class="s3">, </span><span class="s1">names</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_patternchars</span><span class="s3">.</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">):</span>
                <span class="s1">child </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fastjoin</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">exists</span><span class="s3">(</span><span class="s1">child</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">):</span>
                    <span class="s2">return </span><span class="s3">[</span><span class="s1">child</span><span class="s3">]</span>
                <span class="s2">return </span><span class="s3">[]</span>
            <span class="s1">fil </span><span class="s3">= </span><span class="s1">FNMatcher</span><span class="s3">(</span><span class="s1">fil</span><span class="s3">)</span>
        <span class="s1">names </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">names</span><span class="s3">:</span>
            <span class="s1">child </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fastjoin</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">fil </span><span class="s2">is None or </span><span class="s1">fil</span><span class="s3">(</span><span class="s1">child</span><span class="s3">):</span>
                <span class="s1">res</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">child</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_sortlist</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return size of the underlying file object&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">().</span><span class="s1">size</span>

    <span class="s2">def </span><span class="s1">mtime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; float</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return last modification time of the path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">().</span><span class="s1">mtime</span>

    <span class="s2">def </span><span class="s1">copy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">stat</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Copy path to target. 
 
        If mode is True, will copy copy permission from path to target. 
        If stat is True, copy permission, last modification 
        time, last access time, and flags from path to target. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">target</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                <span class="s1">target </span><span class="s3">= </span><span class="s1">target</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">self </span><span class="s3">!= </span><span class="s1">target</span>
            <span class="s1">copychunked</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">mode</span><span class="s3">:</span>
                <span class="s1">copymode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">target</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">stat</span><span class="s3">:</span>
                <span class="s1">copystat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>

            <span class="s2">def </span><span class="s1">rec</span><span class="s3">(</span><span class="s1">p</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">p</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">link</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">=</span><span class="s1">rec</span><span class="s3">):</span>
                <span class="s1">relpath </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
                <span class="s1">newx </span><span class="s3">= </span><span class="s1">target</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">relpath</span><span class="s3">)</span>
                <span class="s1">newx</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">x</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">link</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                    <span class="s1">newx</span><span class="s3">.</span><span class="s1">mksymlinkto</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">readlink</span><span class="s3">())</span>
                    <span class="s2">continue</span>
                <span class="s2">elif </span><span class="s1">x</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                    <span class="s1">copychunked</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">newx</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">x</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                    <span class="s1">newx</span><span class="s3">.</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">mode</span><span class="s3">:</span>
                    <span class="s1">copymode</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">newx</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">stat</span><span class="s3">:</span>
                    <span class="s1">copystat</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">newx</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">rename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">target</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Rename this path to target.&quot;&quot;&quot;</span>
        <span class="s1">target </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">target</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">rename</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">target</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">dump</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">bin</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Pickle object into path location&quot;&quot;&quot;</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;wb&quot;</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">pickle</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">dump</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">bin</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Create &amp; return the directory joined with args.&quot;&quot;&quot;</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fspath</span><span class="s3">(</span><span class="s1">p</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">p</span>

    <span class="s2">def </span><span class="s1">write_binary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">ensure</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Write binary data into path.   If ensure is True create 
        missing parent directories. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">ensure</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">write_text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">, </span><span class="s1">ensure</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Write text data into path using the specified encoding. 
        If ensure is True create missing parent directories. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">ensure</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;w&quot;</span><span class="s3">, </span><span class="s1">encoding</span><span class="s3">=</span><span class="s1">encoding</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">=</span><span class="s5">&quot;w&quot;</span><span class="s3">, </span><span class="s1">ensure</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Write data into path.   If ensure is True create 
        missing parent directories. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">ensure</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s5">&quot;b&quot; </span><span class="s2">in </span><span class="s1">mode</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;can only process bytes&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                    <span class="s1">data </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">getdefaultencoding</span><span class="s3">())</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_ensuredirs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">parent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">parent </span><span class="s3">== </span><span class="s1">self</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span>
        <span class="s2">if </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
            <span class="s1">parent</span><span class="s3">.</span><span class="s1">_ensuredirs</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EEXIST</span><span class="s3">:</span>
                <span class="s4"># race condition: file/dir created by another thread/process.</span>
                <span class="s4"># complain if it is not a dir</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
                    <span class="s2">raise</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">ensure</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Ensure that an args-joined path exists (by default as 
        a file). if you specify a keyword argument 'dir=True' 
        then the path is forced to be a directory path. 
        &quot;&quot;&quot;</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;dir&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">p</span><span class="s3">.</span><span class="s1">_ensuredirs</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">p</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">().</span><span class="s1">_ensuredirs</span><span class="s3">()</span>
            <span class="s2">if not </span><span class="s1">p</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                <span class="s1">p</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;wb&quot;</span><span class="s3">).</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">p</span>

    <span class="s3">@</span><span class="s1">overload</span>
    <span class="s2">def </span><span class="s1">stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">raising</span><span class="s3">: </span><span class="s1">Literal</span><span class="s3">[</span><span class="s2">True</span><span class="s3">] = ...) </span><span class="s1">-&gt; Stat</span><span class="s3">:</span>
        <span class="s3">...</span>

    <span class="s3">@</span><span class="s1">overload</span>
    <span class="s2">def </span><span class="s1">stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">raising</span><span class="s3">: </span><span class="s1">Literal</span><span class="s3">[</span><span class="s2">False</span><span class="s3">]) </span><span class="s1">-&gt; Stat </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s3">...</span>

    <span class="s2">def </span><span class="s1">stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">raising</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">) </span><span class="s1">-&gt; Stat </span><span class="s3">| </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return an os.stat() tuple.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">raising</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">Stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">))</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">Stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">))</span>
        <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
            <span class="s2">raise</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">lstat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Stat</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return an os.lstat() tuple.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">Stat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">setmtime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Set modification time for the given path.  if 'mtime' is None 
        (the default) then the file's mtime is set to current time. 
 
        Note that the resolution for 'mtime' is platform dependent. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">mtime </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">utime</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">utime</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, (-</span><span class="s6">1</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">))</span>
        <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EINVAL</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">utime</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, (</span><span class="s1">self</span><span class="s3">.</span><span class="s1">atime</span><span class="s3">(), </span><span class="s1">mtime</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Change directory to self and return old current directory&quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">old </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">()</span>
        <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">:</span>
            <span class="s1">old </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">old</span>

    <span class="s3">@</span><span class="s1">contextmanager</span>
    <span class="s2">def </span><span class="s1">as_cwd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Return a context manager, which changes to the path's dir during the 
        managed &quot;with&quot; context. 
        On __enter__ it returns the old dir, which might be ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s1">old </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">()</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">yield </span><span class="s1">old</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">old </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">old</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">realpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a new path which contains no symbolic links.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">realpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">atime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return last access time of the path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">().</span><span class="s1">atime</span>

    <span class="s2">def </span><span class="s1">__repr__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s5">&quot;local(%r)&quot; </span><span class="s3">% </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return string representation of the Path.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span>

    <span class="s2">def </span><span class="s1">chmod</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">rec</span><span class="s3">=</span><span class="s6">0</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Change permissions to the given mode. If mode is an 
        integer it directly encodes the os-specific modes. 
        if rec is True perform recursively. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">f&quot;mode </span><span class="s2">{</span><span class="s1">mode</span><span class="s2">!r} </span><span class="s5">must be an integer&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">rec</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">visit</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">=</span><span class="s1">rec</span><span class="s3">):</span>
                <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">chmod</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">strpath</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pypkgpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the Python package path by looking for the last 
        directory upwards which still contains an __init__.py. 
        Return None if a pkgpath can not be determined. 
        &quot;&quot;&quot;</span>
        <span class="s1">pkgpath </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">parent </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">parts</span><span class="s3">(</span><span class="s1">reverse</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">():</span>
                <span class="s2">if not </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s5">&quot;__init__.py&quot;</span><span class="s3">).</span><span class="s1">exists</span><span class="s3">():</span>
                    <span class="s2">break</span>
                <span class="s2">if not </span><span class="s1">isimportable</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">):</span>
                    <span class="s2">break</span>
                <span class="s1">pkgpath </span><span class="s3">= </span><span class="s1">parent</span>
        <span class="s2">return </span><span class="s1">pkgpath</span>

    <span class="s2">def </span><span class="s1">_ensuresyspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ensuremode</span><span class="s3">, </span><span class="s1">path</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">ensuremode</span><span class="s3">:</span>
            <span class="s1">s </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">ensuremode </span><span class="s3">== </span><span class="s5">&quot;append&quot;</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">s </span><span class="s2">not in </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">:</span>
                    <span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">s </span><span class="s3">!= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]:</span>
                    <span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pyimport</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">modname</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">ensuresyspath</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return path as an imported python module. 
 
        If modname is None, look for the containing package 
        and construct an according module name. 
        The module will be put/looked up in sys.modules. 
        if ensuresyspath is True then the root dir for importing 
        the file (taking __init__.py files into account) will 
        be prepended to sys.path if it isn't there already. 
        If ensuresyspath==&quot;append&quot; the root dir will be appended 
        if it isn't already contained in sys.path. 
        if ensuresyspath is False no modification of syspath happens. 
 
        Special value of ensuresyspath==&quot;importlib&quot; is intended 
        purely for using in pytest, it is capable only of importing 
        separate .py files outside packages, e.g. for test suite 
        without any __init__.py file. It effectively allows having 
        same-named test modules in different places and offers 
        mild opt-in via this option. Note that it works only in 
        recent versions of python. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">check</span><span class="s3">():</span>
            <span class="s2">raise </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">ensuresyspath </span><span class="s3">== </span><span class="s5">&quot;importlib&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">modname </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">modname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">purebasename</span>
            <span class="s1">spec </span><span class="s3">= </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">spec_from_file_location</span><span class="s3">(</span><span class="s1">modname</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">spec </span><span class="s2">is None or </span><span class="s1">spec</span><span class="s3">.</span><span class="s1">loader </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ImportError</span><span class="s3">(</span>
                    <span class="s5">f&quot;Can't find module </span><span class="s2">{</span><span class="s1">modname</span><span class="s2">} </span><span class="s5">at location </span><span class="s2">{</span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">}</span><span class="s5">&quot;</span>
                <span class="s3">)</span>
            <span class="s1">mod </span><span class="s3">= </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">module_from_spec</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">)</span>
            <span class="s1">spec</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">exec_module</span><span class="s3">(</span><span class="s1">mod</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">mod</span>

        <span class="s1">pkgpath </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">modname </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">pkgpath </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pypkgpath</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">pkgpath </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">pkgroot </span><span class="s3">= </span><span class="s1">pkgpath</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">()</span>
                <span class="s1">names </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">).</span><span class="s1">relto</span><span class="s3">(</span><span class="s1">pkgroot</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">names</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">] == </span><span class="s5">&quot;__init__&quot;</span><span class="s3">:</span>
                    <span class="s1">names</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
                <span class="s1">modname </span><span class="s3">= </span><span class="s5">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">names</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">pkgroot </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dirpath</span><span class="s3">()</span>
                <span class="s1">modname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">purebasename</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ensuresyspath</span><span class="s3">(</span><span class="s1">ensuresyspath</span><span class="s3">, </span><span class="s1">pkgroot</span><span class="s3">)</span>
            <span class="s1">__import__</span><span class="s3">(</span><span class="s1">modname</span><span class="s3">)</span>
            <span class="s1">mod </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">modname</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">basename </span><span class="s3">== </span><span class="s5">&quot;__init__.py&quot;</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">mod  </span><span class="s4"># we don't check anything as we might</span>
                <span class="s4"># be in a namespace package ... too icky to check</span>
            <span class="s1">modfile </span><span class="s3">= </span><span class="s1">mod</span><span class="s3">.</span><span class="s1">__file__</span>
            <span class="s2">assert </span><span class="s1">modfile </span><span class="s2">is not None</span>
            <span class="s2">if </span><span class="s1">modfile</span><span class="s3">[-</span><span class="s6">4</span><span class="s3">:] </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;.pyc&quot;</span><span class="s3">, </span><span class="s5">&quot;.pyo&quot;</span><span class="s3">):</span>
                <span class="s1">modfile </span><span class="s3">= </span><span class="s1">modfile</span><span class="s3">[:-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">modfile</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">&quot;$py.class&quot;</span><span class="s3">):</span>
                <span class="s1">modfile </span><span class="s3">= </span><span class="s1">modfile</span><span class="s3">[:-</span><span class="s6">9</span><span class="s3">] + </span><span class="s5">&quot;.py&quot;</span>
            <span class="s2">if </span><span class="s1">modfile</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">sep </span><span class="s3">+ </span><span class="s5">&quot;__init__.py&quot;</span><span class="s3">):</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">basename </span><span class="s3">!= </span><span class="s5">&quot;__init__.py&quot;</span><span class="s3">:</span>
                    <span class="s1">modfile </span><span class="s3">= </span><span class="s1">modfile</span><span class="s3">[:-</span><span class="s6">12</span><span class="s3">]</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">issame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">samefile</span><span class="s3">(</span><span class="s1">modfile</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">:</span>
                <span class="s1">issame </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">if not </span><span class="s1">issame</span><span class="s3">:</span>
                <span class="s1">ignore </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getenv</span><span class="s3">(</span><span class="s5">&quot;PY_IGNORE_IMPORTMISMATCH&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">ignore </span><span class="s3">!= </span><span class="s5">&quot;1&quot;</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ImportMismatchError</span><span class="s3">(</span><span class="s1">modname</span><span class="s3">, </span><span class="s1">modfile</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">mod</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">modname</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                <span class="s4"># we have a custom modname, do a pseudo-import</span>
                <span class="s2">import </span><span class="s1">types</span>

                <span class="s1">mod </span><span class="s3">= </span><span class="s1">types</span><span class="s3">.</span><span class="s1">ModuleType</span><span class="s3">(</span><span class="s1">modname</span><span class="s3">)</span>
                <span class="s1">mod</span><span class="s3">.</span><span class="s1">__file__ </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
                <span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">modname</span><span class="s3">] = </span><span class="s1">mod</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">), </span><span class="s5">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                        <span class="s1">exec</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(), </span><span class="s1">mod</span><span class="s3">.</span><span class="s1">__dict__</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">BaseException</span><span class="s3">:</span>
                    <span class="s2">del </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">modules</span><span class="s3">[</span><span class="s1">modname</span><span class="s3">]</span>
                    <span class="s2">raise</span>
                <span class="s2">return </span><span class="s1">mod</span>

    <span class="s2">def </span><span class="s1">sysexec</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">argv</span><span class="s3">: </span><span class="s1">os</span><span class="s3">.</span><span class="s1">PathLike</span><span class="s3">[</span><span class="s1">str</span><span class="s3">], **</span><span class="s1">popen_opts</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return stdout text from executing a system child process, 
        where the 'self' path points to executable. 
        The process is directly invoked and not through a system shell. 
        &quot;&quot;&quot;</span>
        <span class="s2">from </span><span class="s1">subprocess </span><span class="s2">import </span><span class="s1">Popen</span><span class="s3">, </span><span class="s1">PIPE</span>

        <span class="s1">popen_opts</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">&quot;stdout&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">popen_opts</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">&quot;stderr&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">proc </span><span class="s3">= </span><span class="s1">Popen</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)] + [</span><span class="s1">str</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">argv</span><span class="s3">],</span>
            <span class="s3">**</span><span class="s1">popen_opts</span><span class="s3">,</span>
            <span class="s1">stdout</span><span class="s3">=</span><span class="s1">PIPE</span><span class="s3">,</span>
            <span class="s1">stderr</span><span class="s3">=</span><span class="s1">PIPE</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">stdout</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span>
        <span class="s1">stdout</span><span class="s3">, </span><span class="s1">stderr </span><span class="s3">= </span><span class="s1">proc</span><span class="s3">.</span><span class="s1">communicate</span><span class="s3">()</span>
        <span class="s1">ret </span><span class="s3">= </span><span class="s1">proc</span><span class="s3">.</span><span class="s1">wait</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">stdout</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">stdout </span><span class="s3">= </span><span class="s1">stdout</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">getdefaultencoding</span><span class="s3">())</span>
        <span class="s2">if </span><span class="s1">ret </span><span class="s3">!= </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">stderr</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                <span class="s1">stderr </span><span class="s3">= </span><span class="s1">stderr</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">getdefaultencoding</span><span class="s3">())</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span>
                <span class="s1">ret</span><span class="s3">,</span>
                <span class="s1">ret</span><span class="s3">,</span>
                <span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">),</span>
                <span class="s1">stdout</span><span class="s3">,</span>
                <span class="s1">stderr</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">return </span><span class="s1">stdout</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">sysfind</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">checker</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">paths</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a path object found by looking at the systems 
        underlying PATH specification. If the checker is not None 
        it will be invoked to filter matching paths.  If a binary 
        cannot be found, None is returned 
        Note: This is probably not working on plain win32 systems 
        but may work on cygwin. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isabs</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
            <span class="s1">p </span><span class="s3">= </span><span class="s1">local</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">p</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">p</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">paths </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
                    <span class="s1">paths </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;Path&quot;</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;;&quot;</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s5">&quot;&quot; </span><span class="s2">not in </span><span class="s1">paths </span><span class="s2">and </span><span class="s5">&quot;.&quot; </span><span class="s2">not in </span><span class="s1">paths</span><span class="s3">:</span>
                        <span class="s1">paths</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">)</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">systemroot </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;SYSTEMROOT&quot;</span><span class="s3">]</span>
                    <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                        <span class="s2">pass</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">paths </span><span class="s3">= [</span>
                            <span class="s1">path</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;%SystemRoot%&quot;</span><span class="s3">, </span><span class="s1">systemroot</span><span class="s3">) </span><span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">paths</span>
                        <span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">paths </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;PATH&quot;</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;:&quot;</span><span class="s3">)</span>
            <span class="s1">tryadd </span><span class="s3">= []</span>
            <span class="s2">if </span><span class="s1">iswin32</span><span class="s3">:</span>
                <span class="s1">tryadd </span><span class="s3">+= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;PATHEXT&quot;</span><span class="s3">].</span><span class="s1">split</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">pathsep</span><span class="s3">)</span>
            <span class="s1">tryadd</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">paths</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">addext </span><span class="s2">in </span><span class="s1">tryadd</span><span class="s3">:</span>
                    <span class="s1">p </span><span class="s3">= </span><span class="s1">local</span><span class="s3">(</span><span class="s1">x</span><span class="s3">).</span><span class="s1">join</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">abs</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) + </span><span class="s1">addext</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">p</span><span class="s3">.</span><span class="s1">check</span><span class="s3">(</span><span class="s1">file</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
                            <span class="s2">if </span><span class="s1">checker</span><span class="s3">:</span>
                                <span class="s2">if not </span><span class="s1">checker</span><span class="s3">(</span><span class="s1">p</span><span class="s3">):</span>
                                    <span class="s2">continue</span>
                            <span class="s2">return </span><span class="s1">p</span>
                    <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EACCES</span><span class="s3">:</span>
                        <span class="s2">pass</span>
        <span class="s2">return None</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">_gethomedir</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;HOME&quot;</span><span class="s3">]</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;HOMEDRIVE&quot;</span><span class="s3">] + </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;HOMEPATH&quot;</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                <span class="s2">return None</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s4"># &quot;&quot;&quot;</span>
    <span class="s4"># special class constructors for local filesystem paths</span>
    <span class="s4"># &quot;&quot;&quot;</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">get_temproot</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return the system's temporary directory 
        (where tempfiles are usually created in) 
        &quot;&quot;&quot;</span>
        <span class="s2">import </span><span class="s1">tempfile</span>

        <span class="s2">return </span><span class="s1">local</span><span class="s3">(</span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">gettempdir</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">mkdtemp</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">rootdir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return a Path object pointing to a fresh new temporary directory 
        (which we created ourself). 
        &quot;&quot;&quot;</span>
        <span class="s2">import </span><span class="s1">tempfile</span>

        <span class="s2">if </span><span class="s1">rootdir </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">rootdir </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">get_temproot</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(</span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span><span class="s1">tempfile</span><span class="s3">.</span><span class="s1">mkdtemp</span><span class="s3">, </span><span class="s1">dir</span><span class="s3">=</span><span class="s1">str</span><span class="s3">(</span><span class="s1">rootdir</span><span class="s3">)))</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">make_numbered_dir</span><span class="s3">(</span>
        <span class="s1">cls</span><span class="s3">, </span><span class="s1">prefix</span><span class="s3">=</span><span class="s5">&quot;session-&quot;</span><span class="s3">, </span><span class="s1">rootdir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">keep</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">lock_timeout</span><span class="s3">=</span><span class="s6">172800</span>
    <span class="s3">):  </span><span class="s4"># two days</span>
        <span class="s0">&quot;&quot;&quot;Return unique directory with a number greater than the current 
        maximum one.  The number is assumed to start directly after prefix. 
        if keep is true directories with a number less than (maxnum-keep) 
        will be removed. If .lock files are used (lock_timeout non-zero), 
        algorithm is multi-process safe. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">rootdir </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">rootdir </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">get_temproot</span><span class="s3">()</span>

        <span class="s1">nprefix </span><span class="s3">= </span><span class="s1">prefix</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">parse_num</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Parse the number out of a path (if it matches the prefix)&quot;&quot;&quot;</span>
            <span class="s1">nbasename </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">nbasename</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">nprefix</span><span class="s3">):</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">int</span><span class="s3">(</span><span class="s1">nbasename</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">nprefix</span><span class="s3">) :])</span>
                <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                    <span class="s2">pass</span>

        <span class="s2">def </span><span class="s1">create_lockfile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Exclusively create lockfile. Throws when failed&quot;&quot;&quot;</span>
            <span class="s1">mypid </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getpid</span><span class="s3">()</span>
            <span class="s1">lockfile </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s5">&quot;.lock&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">lockfile</span><span class="s3">, </span><span class="s5">&quot;mksymlinkto&quot;</span><span class="s3">):</span>
                <span class="s1">lockfile</span><span class="s3">.</span><span class="s1">mksymlinkto</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">mypid</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">fd </span><span class="s3">= </span><span class="s1">error</span><span class="s3">.</span><span class="s1">checked_call</span><span class="s3">(</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">open</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">lockfile</span><span class="s3">), </span><span class="s1">os</span><span class="s3">.</span><span class="s1">O_WRONLY </span><span class="s3">| </span><span class="s1">os</span><span class="s3">.</span><span class="s1">O_CREAT </span><span class="s3">| </span><span class="s1">os</span><span class="s3">.</span><span class="s1">O_EXCL</span><span class="s3">, </span><span class="s6">0o644</span>
                <span class="s3">)</span>
                <span class="s2">with </span><span class="s1">os</span><span class="s3">.</span><span class="s1">fdopen</span><span class="s3">(</span><span class="s1">fd</span><span class="s3">, </span><span class="s5">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                    <span class="s1">f</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">mypid</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s1">lockfile</span>

        <span class="s2">def </span><span class="s1">atexit_remove_lockfile</span><span class="s3">(</span><span class="s1">lockfile</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Ensure lockfile is removed at process exit&quot;&quot;&quot;</span>
            <span class="s1">mypid </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getpid</span><span class="s3">()</span>

            <span class="s2">def </span><span class="s1">try_remove_lockfile</span><span class="s3">():</span>
                <span class="s4"># in a fork() situation, only the last process should</span>
                <span class="s4"># remove the .lock, otherwise the other processes run the</span>
                <span class="s4"># risk of seeing their temporary dir disappear.  For now</span>
                <span class="s4"># we remove the .lock in the parent only (i.e. we assume</span>
                <span class="s4"># that the children finish before the parent).</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getpid</span><span class="s3">() != </span><span class="s1">mypid</span><span class="s3">:</span>
                    <span class="s2">return</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">lockfile</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">()</span>
                <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">Error</span><span class="s3">:</span>
                    <span class="s2">pass</span>

            <span class="s1">atexit</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">try_remove_lockfile</span><span class="s3">)</span>

        <span class="s4"># compute the maximum number currently in use with the prefix</span>
        <span class="s1">lastmax </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">maxnum </span><span class="s3">= -</span><span class="s6">1</span>
            <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">rootdir</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">():</span>
                <span class="s1">num </span><span class="s3">= </span><span class="s1">parse_num</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">num </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">maxnum </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">maxnum</span><span class="s3">, </span><span class="s1">num</span><span class="s3">)</span>

            <span class="s4"># make the new directory</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">udir </span><span class="s3">= </span><span class="s1">rootdir</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">prefix </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">maxnum </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">))</span>
                <span class="s2">if </span><span class="s1">lock_timeout</span><span class="s3">:</span>
                    <span class="s1">lockfile </span><span class="s3">= </span><span class="s1">create_lockfile</span><span class="s3">(</span><span class="s1">udir</span><span class="s3">)</span>
                    <span class="s1">atexit_remove_lockfile</span><span class="s3">(</span><span class="s1">lockfile</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">error</span><span class="s3">.</span><span class="s1">EEXIST</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EBUSY</span><span class="s3">):</span>
                <span class="s4"># race condition (1): another thread/process created the dir</span>
                <span class="s4">#                     in the meantime - try again</span>
                <span class="s4"># race condition (2): another thread/process spuriously acquired</span>
                <span class="s4">#                     lock treating empty directory as candidate</span>
                <span class="s4">#                     for removal - try again</span>
                <span class="s4"># race condition (3): another thread/process tried to create the lock at</span>
                <span class="s4">#                     the same time (happened in Python 3.3 on Windows)</span>
                <span class="s4"># https://ci.appveyor.com/project/pytestbot/py/build/1.0.21/job/ffi85j4c0lqwsfwa</span>
                <span class="s2">if </span><span class="s1">lastmax </span><span class="s3">== </span><span class="s1">maxnum</span><span class="s3">:</span>
                    <span class="s2">raise</span>
                <span class="s1">lastmax </span><span class="s3">= </span><span class="s1">maxnum</span>
                <span class="s2">continue</span>
            <span class="s2">break</span>

        <span class="s2">def </span><span class="s1">get_mtime</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Read file modification time&quot;&quot;&quot;</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">path</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">().</span><span class="s1">mtime</span>
            <span class="s2">except </span><span class="s1">error</span><span class="s3">.</span><span class="s1">Error</span><span class="s3">:</span>
                <span class="s2">pass</span>

        <span class="s1">garbage_prefix </span><span class="s3">= </span><span class="s1">prefix </span><span class="s3">+ </span><span class="s5">&quot;garbage-&quot;</span>

        <span class="s2">def </span><span class="s1">is_garbage</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
            <span class="s0">&quot;&quot;&quot;Check if path denotes directory scheduled for removal&quot;&quot;&quot;</span>
            <span class="s1">bn </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span>
            <span class="s2">return </span><span class="s1">bn</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">garbage_prefix</span><span class="s3">)</span>

        <span class="s4"># prune old directories</span>
        <span class="s1">udir_time </span><span class="s3">= </span><span class="s1">get_mtime</span><span class="s3">(</span><span class="s1">udir</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">keep </span><span class="s2">and </span><span class="s1">udir_time</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">rootdir</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">():</span>
                <span class="s1">num </span><span class="s3">= </span><span class="s1">parse_num</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">num </span><span class="s2">is not None and </span><span class="s1">num </span><span class="s3">&lt;= (</span><span class="s1">maxnum </span><span class="s3">- </span><span class="s1">keep</span><span class="s3">):</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s4"># try acquiring lock to remove directory as exclusive user</span>
                        <span class="s2">if </span><span class="s1">lock_timeout</span><span class="s3">:</span>
                            <span class="s1">create_lockfile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
                    <span class="s2">except </span><span class="s3">(</span><span class="s1">error</span><span class="s3">.</span><span class="s1">EEXIST</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">ENOENT</span><span class="s3">, </span><span class="s1">error</span><span class="s3">.</span><span class="s1">EBUSY</span><span class="s3">):</span>
                        <span class="s1">path_time </span><span class="s3">= </span><span class="s1">get_mtime</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
                        <span class="s2">if not </span><span class="s1">path_time</span><span class="s3">:</span>
                            <span class="s4"># assume directory doesn't exist now</span>
                            <span class="s2">continue</span>
                        <span class="s2">if </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">udir_time </span><span class="s3">- </span><span class="s1">path_time</span><span class="s3">) &lt; </span><span class="s1">lock_timeout</span><span class="s3">:</span>
                            <span class="s4"># assume directory with lockfile exists</span>
                            <span class="s4"># and lock timeout hasn't expired yet</span>
                            <span class="s2">continue</span>

                    <span class="s4"># path dir locked for exclusive use</span>
                    <span class="s4"># and scheduled for removal to avoid another thread/process</span>
                    <span class="s4"># treating it as a new directory or removal candidate</span>
                    <span class="s1">garbage_path </span><span class="s3">= </span><span class="s1">rootdir</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">garbage_prefix </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">uuid</span><span class="s3">.</span><span class="s1">uuid4</span><span class="s3">()))</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">path</span><span class="s3">.</span><span class="s1">rename</span><span class="s3">(</span><span class="s1">garbage_path</span><span class="s3">)</span>
                        <span class="s1">garbage_path</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                    <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
                        <span class="s2">raise</span>
                    <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:  </span><span class="s4"># this might be error.Error, WindowsError ...</span>
                        <span class="s2">pass</span>
                <span class="s2">if </span><span class="s1">is_garbage</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                    <span class="s2">try</span><span class="s3">:</span>
                        <span class="s1">path</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">rec</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                    <span class="s2">except </span><span class="s1">KeyboardInterrupt</span><span class="s3">:</span>
                        <span class="s2">raise</span>
                    <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:  </span><span class="s4"># this might be error.Error, WindowsError ...</span>
                        <span class="s2">pass</span>

        <span class="s4"># make link...</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">username </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;USER&quot;</span><span class="s3">]  </span><span class="s4"># linux, et al</span>
        <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">username </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">[</span><span class="s5">&quot;USERNAME&quot;</span><span class="s3">]  </span><span class="s4"># windows</span>
            <span class="s2">except </span><span class="s1">KeyError</span><span class="s3">:</span>
                <span class="s1">username </span><span class="s3">= </span><span class="s5">&quot;current&quot;</span>

        <span class="s1">src </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">udir</span><span class="s3">)</span>
        <span class="s1">dest </span><span class="s3">= </span><span class="s1">src</span><span class="s3">[: </span><span class="s1">src</span><span class="s3">.</span><span class="s1">rfind</span><span class="s3">(</span><span class="s5">&quot;-&quot;</span><span class="s3">)] + </span><span class="s5">&quot;-&quot; </span><span class="s3">+ </span><span class="s1">username</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">dest</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">symlink</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">OSError</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">NotImplementedError</span><span class="s3">):</span>
            <span class="s2">pass</span>

        <span class="s2">return </span><span class="s1">udir</span>


<span class="s2">def </span><span class="s1">copymode</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Copy permission from src to dst.&quot;&quot;&quot;</span>
    <span class="s2">import </span><span class="s1">shutil</span>

    <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copymode</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">copystat</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Copy permission,  last modification time, 
    last access time, and flags from src to dst.&quot;&quot;&quot;</span>
    <span class="s2">import </span><span class="s1">shutil</span>

    <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copystat</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">src</span><span class="s3">), </span><span class="s1">str</span><span class="s3">(</span><span class="s1">dest</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">copychunked</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">):</span>
    <span class="s1">chunksize </span><span class="s3">= </span><span class="s6">524288  </span><span class="s4"># half a meg of bytes</span>
    <span class="s1">fsrc </span><span class="s3">= </span><span class="s1">src</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;rb&quot;</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">fdest </span><span class="s3">= </span><span class="s1">dest</span><span class="s3">.</span><span class="s1">open</span><span class="s3">(</span><span class="s5">&quot;wb&quot;</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">while </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">buf </span><span class="s3">= </span><span class="s1">fsrc</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunksize</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">buf</span><span class="s3">:</span>
                    <span class="s2">break</span>
                <span class="s1">fdest</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">fdest</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">fsrc</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">isimportable</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">name </span><span class="s2">and </span><span class="s3">(</span><span class="s1">name</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">isalpha</span><span class="s3">() </span><span class="s2">or </span><span class="s1">name</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s5">&quot;_&quot;</span><span class="s3">):</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;_&quot;</span><span class="s3">, </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
        <span class="s2">return not </span><span class="s1">name </span><span class="s2">or </span><span class="s1">name</span><span class="s3">.</span><span class="s1">isalnum</span><span class="s3">()</span>


<span class="s1">local </span><span class="s3">= </span><span class="s1">LocalPath</span>
</pre>
</body>
</html>