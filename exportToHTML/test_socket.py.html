<html>
<head>
<title>test_socket.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_socket.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">errno</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">socket </span><span class="s0">as </span><span class="s1">stdlib_socket</span>
<span class="s0">import </span><span class="s1">sys </span><span class="s0">as </span><span class="s1">_sys</span>
<span class="s0">import </span><span class="s1">tempfile</span>

<span class="s0">import </span><span class="s1">attr</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s2">.. </span><span class="s0">import </span><span class="s1">_core</span><span class="s2">, </span><span class="s1">socket </span><span class="s0">as </span><span class="s1">tsocket</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">_tests</span><span class="s2">.</span><span class="s1">tutil </span><span class="s0">import </span><span class="s1">binds_ipv6</span><span class="s2">, </span><span class="s1">creates_ipv6</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_socket </span><span class="s0">import </span><span class="s1">_NUMERIC_ONLY</span><span class="s2">, </span><span class="s1">_try_sync</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_checkpoints</span><span class="s2">, </span><span class="s1">wait_all_tasks_blocked</span>

<span class="s3">################################################################</span>
<span class="s3"># utils</span>
<span class="s3">################################################################</span>


<span class="s0">class </span><span class="s1">MonkeypatchedGAI</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">orig_getaddrinfo</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_getaddrinfo </span><span class="s2">= </span><span class="s1">orig_getaddrinfo</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_responses </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">record </span><span class="s2">= []</span>

    <span class="s3"># get a normalized getaddrinfo argument tuple</span>
    <span class="s0">def </span><span class="s1">_frozenbind</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_getaddrinfo</span><span class="s2">)</span>
        <span class="s1">bound </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">bound</span><span class="s2">.</span><span class="s1">apply_defaults</span><span class="s2">()</span>
        <span class="s1">frozenbound </span><span class="s2">= </span><span class="s1">bound</span><span class="s2">.</span><span class="s1">args</span>
        <span class="s0">assert not </span><span class="s1">bound</span><span class="s2">.</span><span class="s1">kwargs</span>
        <span class="s0">return </span><span class="s1">frozenbound</span>

    <span class="s0">def </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">response</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_responses</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_frozenbind</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)] = </span><span class="s1">response</span>

    <span class="s0">def </span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">bound </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_frozenbind</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">record</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bound</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">bound </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_responses</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_responses</span><span class="s2">[</span><span class="s1">bound</span><span class="s2">]</span>
        <span class="s0">elif </span><span class="s1">bound</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] &amp; </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">AI_NUMERICHOST</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_orig_getaddrinfo</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s5">f&quot;gai called with unexpected arguments </span><span class="s0">{</span><span class="s1">bound</span><span class="s0">}</span><span class="s5">&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">monkeygai</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">controller </span><span class="s2">= </span><span class="s1">MonkeypatchedGAI</span><span class="s2">(</span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">stdlib_socket</span><span class="s2">, </span><span class="s5">&quot;getaddrinfo&quot;</span><span class="s2">, </span><span class="s1">controller</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">controller</span>


<span class="s0">async def </span><span class="s1">test__try_sync</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">async with </span><span class="s1">_try_sync</span><span class="s2">():</span>
            <span class="s0">pass</span>

    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s0">async with </span><span class="s1">_try_sync</span><span class="s2">():</span>
                <span class="s0">raise </span><span class="s1">KeyError</span>

    <span class="s0">async with </span><span class="s1">_try_sync</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">BlockingIOError</span>

    <span class="s0">def </span><span class="s1">_is_ValueError</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_try_sync</span><span class="s2">(</span><span class="s1">_is_ValueError</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span>

    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BlockingIOError</span><span class="s2">):</span>
            <span class="s0">async with </span><span class="s1">_try_sync</span><span class="s2">(</span><span class="s1">_is_ValueError</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">BlockingIOError</span>


<span class="s3">################################################################</span>
<span class="s3"># basic re-exports</span>
<span class="s3">################################################################</span>


<span class="s0">def </span><span class="s1">test_socket_has_some_reexports</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOL_SOCKET </span><span class="s2">== </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">SOL_SOCKET</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">TCP_NODELAY </span><span class="s2">== </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror </span><span class="s2">== </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">gaierror</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">ntohs </span><span class="s2">== </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">ntohs</span>


<span class="s3">################################################################</span>
<span class="s3"># name resolution</span>
<span class="s3">################################################################</span>


<span class="s0">async def </span><span class="s1">test_getaddrinfo</span><span class="s2">(</span><span class="s1">monkeygai</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s3"># win32 returns 0 for the proto field</span>
        <span class="s3"># musl and glibc have inconsistent handling of the canonical name</span>
        <span class="s3"># field (https://github.com/python-trio/trio/issues/1499)</span>
        <span class="s3"># Neither field gets used much and there isn't much opportunity for us</span>
        <span class="s3"># to mess them up, so we don't bother checking them here</span>
        <span class="s0">def </span><span class="s1">interesting_fields</span><span class="s2">(</span><span class="s1">gai_tup</span><span class="s2">):</span>
            <span class="s3"># (family, type, proto, canonname, sockaddr)</span>
            <span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">, </span><span class="s1">canonname</span><span class="s2">, </span><span class="s1">sockaddr </span><span class="s2">= </span><span class="s1">gai_tup</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">sockaddr</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">filtered</span><span class="s2">(</span><span class="s1">gai_list</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">interesting_fields</span><span class="s2">(</span><span class="s1">gai_tup</span><span class="s2">) </span><span class="s0">for </span><span class="s1">gai_tup </span><span class="s0">in </span><span class="s1">gai_list</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">filtered</span><span class="s2">(</span><span class="s1">got</span><span class="s2">) == </span><span class="s1">filtered</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s3"># Simple non-blocking non-error cases, ipv4 and ipv6:</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">&quot;12345&quot;</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_STREAM</span><span class="s2">)</span>

    <span class="s1">check</span><span class="s2">(</span>
        <span class="s1">res</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span><span class="s2">,  </span><span class="s3"># 127.0.0.1 is ipv4</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_STREAM</span><span class="s2">,</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">,</span>
                <span class="s5">&quot;&quot;</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">12345</span><span class="s2">),</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s5">&quot;12345&quot;</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span>
        <span class="s1">res</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">,</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">,</span>
                <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_UDP</span><span class="s2">,</span>
                <span class="s5">&quot;&quot;</span><span class="s2">,</span>
                <span class="s2">(</span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s4">12345</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;x&quot;</span><span class="s2">, </span><span class="s6">b&quot;host&quot;</span><span class="s2">, </span><span class="s5">&quot;port&quot;</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;host&quot;</span><span class="s2">, </span><span class="s5">&quot;port&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res </span><span class="s2">== </span><span class="s5">&quot;x&quot;</span>
    <span class="s0">assert </span><span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">record</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] == (</span><span class="s6">b&quot;host&quot;</span><span class="s2">, </span><span class="s5">&quot;port&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s3"># check raising an error from a non-blocking getaddrinfo</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s5">&quot;12345&quot;</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s3"># Linux + glibc, Windows</span>
    <span class="s1">expected_errnos </span><span class="s2">= {</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">EAI_SOCKTYPE</span><span class="s2">}</span>
    <span class="s3"># Linux + musl</span>
    <span class="s1">expected_errnos</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">EAI_SERVICE</span><span class="s2">)</span>
    <span class="s3"># macOS</span>
    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">, </span><span class="s5">&quot;EAI_BADHINTS&quot;</span><span class="s2">):</span>
        <span class="s1">expected_errnos</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">EAI_BADHINTS</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s0">in </span><span class="s1">expected_errnos</span>

    <span class="s3"># check raising an error from a blocking getaddrinfo (exploits the fact</span>
    <span class="s3"># that monkeygai raises if it gets a non-numeric request it hasn't been</span>
    <span class="s3"># given an answer for)</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;asdf&quot;</span><span class="s2">, </span><span class="s5">&quot;12345&quot;</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_getnameinfo</span><span class="s2">():</span>
    <span class="s3"># Trivial test:</span>
    <span class="s1">ni_numeric </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">NI_NUMERICHOST </span><span class="s2">| </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">NI_NUMERICSERV</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">1234</span><span class="s2">), </span><span class="s1">ni_numeric</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== (</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">&quot;1234&quot;</span><span class="s2">)</span>

    <span class="s3"># getnameinfo requires a numeric address as input:</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">):</span>
            <span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;google.com&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">):</span>
            <span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;localhost&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s3"># Blocking call to get expected values:</span>
    <span class="s1">host</span><span class="s2">, </span><span class="s1">service </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s3"># Some working calls:</span>
    <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== (</span><span class="s1">host</span><span class="s2">, </span><span class="s1">service</span><span class="s2">)</span>

    <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">NI_NUMERICHOST</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== (</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s1">service</span><span class="s2">)</span>

    <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">NI_NUMERICSERV</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== (</span><span class="s1">host</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">)</span>


<span class="s3">################################################################</span>
<span class="s3"># constructors</span>
<span class="s3">################################################################</span>


<span class="s0">async def </span><span class="s1">test_from_stdlib_socket</span><span class="s2">():</span>
    <span class="s1">sa</span><span class="s2">, </span><span class="s1">sb </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sa</span><span class="s2">, </span><span class="s1">sb</span><span class="s2">:</span>
        <span class="s1">ta </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ta</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sb</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>

    <span class="s3"># rejects other types</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">class </span><span class="s1">MySocket</span><span class="s2">(</span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">with </span><span class="s1">MySocket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">mysock</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">mysock</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_from_fd</span><span class="s2">():</span>
    <span class="s1">sa</span><span class="s2">, </span><span class="s1">sb </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s1">ta </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">fromfd</span><span class="s2">(</span><span class="s1">sa</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">(), </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">family</span><span class="s2">, </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">proto</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sa</span><span class="s2">, </span><span class="s1">sb</span><span class="s2">, </span><span class="s1">ta</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() != </span><span class="s1">sa</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sb</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">3</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>


<span class="s0">async def </span><span class="s1">test_socketpair_simple</span><span class="s2">():</span>
    <span class="s0">async def </span><span class="s1">child</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">):</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">&quot;sending hello&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;h&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;h&quot;</span>

    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">child</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">, </span><span class="s5">&quot;fromshare&quot;</span><span class="s2">), </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;windows only&quot;</span><span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_fromshare</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s3"># share with ourselves</span>
        <span class="s1">shared </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">share</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">getpid</span><span class="s2">())</span>
        <span class="s1">a2 </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">fromshare</span><span class="s2">(</span><span class="s1">shared</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">a2</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() != </span><span class="s1">a2</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">a2</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>


<span class="s0">async def </span><span class="s1">test_socket</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">family </span><span class="s2">== </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span>


<span class="s2">@</span><span class="s1">creates_ipv6</span>
<span class="s0">async def </span><span class="s1">test_socket_v6</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">family </span><span class="s2">== </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">_sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s5">&quot;linux&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;linux only&quot;</span><span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_sniff_sockopts</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">socket </span><span class="s0">import </span><span class="s1">AF_INET</span><span class="s2">, </span><span class="s1">AF_INET6</span><span class="s2">, </span><span class="s1">SOCK_DGRAM</span><span class="s2">, </span><span class="s1">SOCK_STREAM</span>

    <span class="s3"># generate the combinations of families/types we're testing:</span>
    <span class="s1">sockets </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">family </span><span class="s0">in </span><span class="s2">[</span><span class="s1">AF_INET</span><span class="s2">, </span><span class="s1">AF_INET6</span><span class="s2">]:</span>
        <span class="s0">for </span><span class="s1">type </span><span class="s0">in </span><span class="s2">[</span><span class="s1">SOCK_DGRAM</span><span class="s2">, </span><span class="s1">SOCK_STREAM</span><span class="s2">]:</span>
            <span class="s1">sockets</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">socket </span><span class="s0">in </span><span class="s1">sockets</span><span class="s2">:</span>
        <span class="s3"># regular Trio socket constructor</span>
        <span class="s1">tsocket_socket </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">fileno</span><span class="s2">=</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">())</span>
        <span class="s3"># check family / type for correctness:</span>
        <span class="s0">assert </span><span class="s1">tsocket_socket</span><span class="s2">.</span><span class="s1">family </span><span class="s2">== </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">family</span>
        <span class="s0">assert </span><span class="s1">tsocket_socket</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">type</span>
        <span class="s1">tsocket_socket</span><span class="s2">.</span><span class="s1">detach</span><span class="s2">()</span>

        <span class="s3"># fromfd constructor</span>
        <span class="s1">tsocket_from_fd </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">fromfd</span><span class="s2">(</span><span class="s1">socket</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">(), </span><span class="s1">AF_INET</span><span class="s2">, </span><span class="s1">SOCK_STREAM</span><span class="s2">)</span>
        <span class="s3"># check family / type for correctness:</span>
        <span class="s0">assert </span><span class="s1">tsocket_from_fd</span><span class="s2">.</span><span class="s1">family </span><span class="s2">== </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">family</span>
        <span class="s0">assert </span><span class="s1">tsocket_from_fd</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">socket</span><span class="s2">.</span><span class="s1">type</span>
        <span class="s1">tsocket_from_fd</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

        <span class="s1">socket</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s3">################################################################</span>
<span class="s3"># _SocketType</span>
<span class="s3">################################################################</span>


<span class="s0">async def </span><span class="s1">test_SocketType_basics</span><span class="s2">():</span>
    <span class="s1">sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">sock </span><span class="s0">as </span><span class="s1">cm_enter_value</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">cm_enter_value </span><span class="s0">is </span><span class="s1">sock</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">(), </span><span class="s1">int</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">get_inheritable</span><span class="s2">()</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">set_inheritable</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">get_inheritable</span><span class="s2">()</span>

        <span class="s1">sock</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">getsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span><span class="s2">)</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">getsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">TCP_NODELAY</span><span class="s2">)</span>
    <span class="s3"># closed sockets have fileno() == -1</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s4">1</span>

    <span class="s3"># smoke test</span>
    <span class="s1">repr</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">)</span>

    <span class="s3"># detach</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s1">fd </span><span class="s2">= </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">detach</span><span class="s2">() == </span><span class="s1">fd</span>
        <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s4">1</span>

    <span class="s3"># close</span>
    <span class="s1">sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() &gt;= </span><span class="s4">0</span>
    <span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s4">1</span>

    <span class="s3"># share was tested above together with fromshare</span>

    <span class="s3"># check __dir__</span>
    <span class="s0">assert </span><span class="s5">&quot;family&quot; </span><span class="s0">in </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;recv&quot; </span><span class="s0">in </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;setsockopt&quot; </span><span class="s0">in </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">)</span>

    <span class="s3"># our __getattr__ handles unknown names</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">asdf</span>

    <span class="s3"># type family proto</span>
    <span class="s1">stdlib_sock </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>
    <span class="s1">sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">stdlib_sock</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">type </span><span class="s2">== </span><span class="s1">stdlib_sock</span><span class="s2">.</span><span class="s1">type</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">family </span><span class="s2">== </span><span class="s1">stdlib_sock</span><span class="s2">.</span><span class="s1">family</span>
    <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">proto </span><span class="s2">== </span><span class="s1">stdlib_sock</span><span class="s2">.</span><span class="s1">proto</span>
    <span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_SocketType_dup</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">a2 </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dup</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">a2</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">a2</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() != </span><span class="s1">a</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">()</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">a2</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>


<span class="s0">async def </span><span class="s1">test_SocketType_shutdown</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s0">assert not </span><span class="s1">b</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SHUT_WR</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s0">assert not </span><span class="s1">b</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;y&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;y&quot;</span>

    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SHUT_RD</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>

    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>
        <span class="s1">a</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SHUT_RDWR</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">did_shutdown_SHUT_WR</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;address, socket_type&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span><span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">binds_ipv6</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_SocketType_simple_server</span><span class="s2">(</span><span class="s1">address</span><span class="s2">, </span><span class="s1">socket_type</span><span class="s2">):</span>
    <span class="s3"># listen, bind, accept, connect, getpeername, getsockname</span>
    <span class="s1">listener </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">socket_type</span><span class="s2">)</span>
    <span class="s1">client </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">socket_type</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">listener</span><span class="s2">, </span><span class="s1">client</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">listener</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s1">address</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">listener</span><span class="s2">.</span><span class="s1">listen</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">addr </span><span class="s2">= </span><span class="s1">listener</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()[:</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">)</span>
            <span class="s1">server</span><span class="s2">, </span><span class="s1">client_addr </span><span class="s2">= </span><span class="s0">await </span><span class="s1">listener</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">server</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">client_addr </span><span class="s2">== </span><span class="s1">server</span><span class="s2">.</span><span class="s1">getpeername</span><span class="s2">() == </span><span class="s1">client</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s0">assert await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>


<span class="s0">async def </span><span class="s1">test_SocketType_is_readable</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">is_readable</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">wait_readable</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">is_readable</span><span class="s2">()</span>
        <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">assert not </span><span class="s1">a</span><span class="s2">.</span><span class="s1">is_readable</span><span class="s2">()</span>


<span class="s3"># On some macOS systems, getaddrinfo likes to return V4-mapped addresses even</span>
<span class="s3"># when we *don't* pass AI_V4MAPPED.</span>
<span class="s3"># https://github.com/python-trio/trio/issues/580</span>
<span class="s0">def </span><span class="s1">gai_without_v4mapped_is_buggy</span><span class="s2">():  </span><span class="s3"># pragma: no cover</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=</span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">:</span>
        <span class="s0">return False</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return True</span>


<span class="s2">@</span><span class="s1">attr</span><span class="s2">.</span><span class="s1">s</span>
<span class="s0">class </span><span class="s1">Addresses</span><span class="s2">:</span>
    <span class="s1">bind_all </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">ib</span><span class="s2">()</span>
    <span class="s1">localhost </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">ib</span><span class="s2">()</span>
    <span class="s1">arbitrary </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">ib</span><span class="s2">()</span>
    <span class="s1">broadcast </span><span class="s2">= </span><span class="s1">attr</span><span class="s2">.</span><span class="s1">ib</span><span class="s2">()</span>


<span class="s3"># Direct thorough tests of the implicit resolver helpers</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;socket_type, addrs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span><span class="s2">,</span>
            <span class="s1">Addresses</span><span class="s2">(</span>
                <span class="s1">bind_all</span><span class="s2">=</span><span class="s5">&quot;0.0.0.0&quot;</span><span class="s2">,</span>
                <span class="s1">localhost</span><span class="s2">=</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">,</span>
                <span class="s1">arbitrary</span><span class="s2">=</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">,</span>
                <span class="s1">broadcast</span><span class="s2">=</span><span class="s5">&quot;255.255.255.255&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span>
            <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span><span class="s2">,</span>
            <span class="s1">Addresses</span><span class="s2">(</span>
                <span class="s1">bind_all</span><span class="s2">=</span><span class="s5">&quot;::&quot;</span><span class="s2">,</span>
                <span class="s1">localhost</span><span class="s2">=</span><span class="s5">&quot;::1&quot;</span><span class="s2">,</span>
                <span class="s1">arbitrary</span><span class="s2">=</span><span class="s5">&quot;1::2&quot;</span><span class="s2">,</span>
                <span class="s1">broadcast</span><span class="s2">=</span><span class="s5">&quot;::ffff:255.255.255.255&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s1">marks</span><span class="s2">=</span><span class="s1">creates_ipv6</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_SocketType_resolve</span><span class="s2">(</span><span class="s1">socket_type</span><span class="s2">, </span><span class="s1">addrs</span><span class="s2">):</span>
    <span class="s1">v6 </span><span class="s2">= </span><span class="s1">socket_type </span><span class="s2">== </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET6</span>

    <span class="s0">def </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">v6</span><span class="s2">:</span>
            <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">addr</span><span class="s2">) &lt; </span><span class="s4">4</span><span class="s2">:</span>
                <span class="s1">addr </span><span class="s2">+= (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">return </span><span class="s1">addr</span>

    <span class="s0">def </span><span class="s1">assert_eq</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">) == </span><span class="s1">pad</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=</span><span class="s1">socket_type</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s3"># For some reason the stdlib special-cases &quot;&quot; to pass NULL to</span>
        <span class="s3"># getaddrinfo. They also error out on None, but whatever, None is much</span>
        <span class="s3"># more consistent, so we accept it too.</span>
        <span class="s0">for </span><span class="s1">null </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s2">]:</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">_resolve_address_nocp</span><span class="s2">((</span><span class="s1">null</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s1">local</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">assert_eq</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, (</span><span class="s1">addrs</span><span class="s2">.</span><span class="s1">bind_all</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>
            <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">_resolve_address_nocp</span><span class="s2">((</span><span class="s1">null</span><span class="s2">, </span><span class="s4">80</span><span class="s2">), </span><span class="s1">local</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">assert_eq</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, (</span><span class="s1">addrs</span><span class="s2">.</span><span class="s1">localhost</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>

        <span class="s3"># AI_PASSIVE only affects the wildcard address, so for everything else</span>
        <span class="s3"># local=True/local=False should work the same:</span>
        <span class="s0">for </span><span class="s1">local </span><span class="s0">in </span><span class="s2">[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]:</span>

            <span class="s0">async def </span><span class="s1">res</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">):</span>
                <span class="s0">return await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">_resolve_address_nocp</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, </span><span class="s1">local</span><span class="s2">=</span><span class="s1">local</span><span class="s2">)</span>

            <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s1">addrs</span><span class="s2">.</span><span class="s1">arbitrary</span><span class="s2">, </span><span class="s5">&quot;http&quot;</span><span class="s2">)), (</span><span class="s1">addrs</span><span class="s2">.</span><span class="s1">arbitrary</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">v6</span><span class="s2">:</span>
                <span class="s3"># Check handling of different length ipv6 address tuples</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s3"># Non-zero flowinfo/scopeid get passed through</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

                <span class="s3"># And again with a string port, as a trick to avoid the</span>
                <span class="s3"># already-resolved address fastpath and make sure we call</span>
                <span class="s3"># getaddrinfo</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s5">&quot;80&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), (</span><span class="s5">&quot;1::2&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

                <span class="s3"># V4 mapped addresses resolved if V6ONLY is False</span>
                <span class="s1">sock</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_IPV6</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPV6_V6ONLY</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s5">&quot;http&quot;</span><span class="s2">)), (</span><span class="s5">&quot;::ffff:1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>

            <span class="s3"># Check the &lt;broadcast&gt; special case, because why not</span>
            <span class="s1">assert_eq</span><span class="s2">(</span><span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;&lt;broadcast&gt;&quot;</span><span class="s2">, </span><span class="s4">123</span><span class="s2">)), (</span><span class="s1">addrs</span><span class="s2">.</span><span class="s1">broadcast</span><span class="s2">, </span><span class="s4">123</span><span class="s2">))</span>

            <span class="s3"># But not if it's true (at least on systems where getaddrinfo works</span>
            <span class="s3"># correctly)</span>
            <span class="s0">if </span><span class="s1">v6 </span><span class="s0">and not </span><span class="s1">gai_without_v4mapped_is_buggy</span><span class="s2">():</span>
                <span class="s1">sock</span><span class="s2">.</span><span class="s1">setsockopt</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_IPV6</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPV6_V6ONLY</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
                    <span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>
                <span class="s3"># Windows, macOS</span>
                <span class="s1">expected_errnos </span><span class="s2">= {</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">EAI_NONAME</span><span class="s2">}</span>
                <span class="s3"># Linux</span>
                <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">, </span><span class="s5">&quot;EAI_ADDRFAMILY&quot;</span><span class="s2">):</span>
                    <span class="s1">expected_errnos</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">EAI_ADDRFAMILY</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">errno </span><span class="s0">in </span><span class="s1">expected_errnos</span>

            <span class="s3"># A family where we know nothing about the addresses, so should just</span>
            <span class="s3"># pass them through. This should work on Linux, which is enough to</span>
            <span class="s3"># smoke test the basic functionality...</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">netlink_sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span>
                    <span class="s1">family</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_NETLINK</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span>
                <span class="s2">)</span>
            <span class="s0">except </span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">OSError</span><span class="s2">):</span>
                <span class="s0">pass</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s2">(</span>
                    <span class="s0">await </span><span class="s1">netlink_sock</span><span class="s2">.</span><span class="s1">_resolve_address_nocp</span><span class="s2">(</span><span class="s5">&quot;asdf&quot;</span><span class="s2">, </span><span class="s1">local</span><span class="s2">=</span><span class="s1">local</span><span class="s2">)</span>
                    <span class="s2">== </span><span class="s5">&quot;asdf&quot;</span>
                <span class="s2">)</span>
                <span class="s1">netlink_sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">res</span><span class="s2">(</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">,))</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">v6</span><span class="s2">:</span>
                    <span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">await </span><span class="s1">res</span><span class="s2">((</span><span class="s5">&quot;1.2.3.4&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>


<span class="s0">async def </span><span class="s1">test_SocketType_unresolved_names</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;localhost&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">] == </span><span class="s5">&quot;127.0.0.1&quot;</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">listen</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock2</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">sock2</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">((</span><span class="s5">&quot;localhost&quot;</span><span class="s2">, </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s0">assert </span><span class="s1">sock2</span><span class="s2">.</span><span class="s1">getpeername</span><span class="s2">() == </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

    <span class="s3"># check gaierror propagates out</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">gaierror</span><span class="s2">):</span>
            <span class="s3"># definitely not a valid request</span>
            <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;1.2:3&quot;</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">))</span>


<span class="s3"># This tests all the complicated paths through _nonblocking_helper, using recv</span>
<span class="s3"># as a stand-in for all the methods that use _nonblocking_helper.</span>
<span class="s0">async def </span><span class="s1">test_SocketType_non_blocking_paths</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">ta </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">setblocking</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s3"># cancel before even calling</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;1&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">CancelScope</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cscope</span><span class="s2">:</span>
            <span class="s1">cscope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">Cancelled</span><span class="s2">):</span>
                    <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s3"># immediate success (also checks that the previous attempt didn't</span>
        <span class="s3"># actually read anything)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;1&quot;</span>
        <span class="s3"># immediate failure</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">&quot;haha&quot;</span><span class="s2">)</span>
        <span class="s3"># block then succeed</span>

        <span class="s0">async def </span><span class="s1">do_successful_blocking_recv</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">assert await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;2&quot;</span>

        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_successful_blocking_recv</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;2&quot;</span><span class="s2">)</span>
        <span class="s3"># block then cancelled</span>

        <span class="s0">async def </span><span class="s1">do_cancelled_blocking_recv</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">Cancelled</span><span class="s2">):</span>
                    <span class="s0">await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>

        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_cancelled_blocking_recv</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
        <span class="s3"># Okay, here's the trickiest one: we want to exercise the path where</span>
        <span class="s3"># the task is signaled to wake, goes to recv, but then the recv fails,</span>
        <span class="s3"># so it has to go back to sleep and try again. Strategy: have two</span>
        <span class="s3"># tasks waiting on two sockets (to work around the rule against having</span>
        <span class="s3"># two tasks waiting on the same socket), wake them both up at the same</span>
        <span class="s3"># time, and whichever one runs first &quot;steals&quot; the data from the</span>
        <span class="s3"># other:</span>
        <span class="s1">tb </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">t1</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">assert await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;a&quot;</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">assert await </span><span class="s1">tb</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;b&quot;</span>

        <span class="s0">async def </span><span class="s1">t2</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">assert await </span><span class="s1">tb</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;b&quot;</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">assert await </span><span class="s1">ta</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;a&quot;</span>

        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;b&quot;</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;b&quot;</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>


<span class="s3"># This tests the complicated paths through connect</span>
<span class="s0">async def </span><span class="s1">test_SocketType_connect_paths</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s3"># Should be a tuple</span>
            <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s5">&quot;localhost&quot;</span><span class="s2">)</span>

    <span class="s3"># cancelled before we start</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">CancelScope</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cancel_scope</span><span class="s2">:</span>
            <span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">Cancelled</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">))</span>

    <span class="s3"># Cancelled in between the connect() call and the connect completing</span>
    <span class="s0">with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">CancelScope</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cancel_scope</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">listener</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">listener</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
            <span class="s1">listener</span><span class="s2">.</span><span class="s1">listen</span><span class="s2">()</span>

            <span class="s3"># Swap in our weird subclass under the trio.socket._SocketType's</span>
            <span class="s3"># nose -- and then swap it back out again before we hit</span>
            <span class="s3"># wait_socket_writable, which insists on a real socket.</span>
            <span class="s0">class </span><span class="s1">CancelSocket</span><span class="s2">(</span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">):</span>
                <span class="s0">def </span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                    <span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                    <span class="s1">sock</span><span class="s2">.</span><span class="s1">_sock </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">fromfd</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">detach</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">family</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">type</span>
                    <span class="s2">)</span>
                    <span class="s1">sock</span><span class="s2">.</span><span class="s1">_sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
                    <span class="s3"># If connect *doesn't* raise, then pretend it did</span>
                    <span class="s0">raise </span><span class="s1">BlockingIOError  </span><span class="s3"># pragma: no cover</span>

            <span class="s1">sock</span><span class="s2">.</span><span class="s1">_sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s1">sock</span><span class="s2">.</span><span class="s1">_sock </span><span class="s2">= </span><span class="s1">CancelSocket</span><span class="s2">()</span>

            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">Cancelled</span><span class="s2">):</span>
                    <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">listener</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
            <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s4">1</span>

    <span class="s3"># Failed connect (hopefully after raising BlockingIOError)</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">OSError</span><span class="s2">):</span>
            <span class="s3"># TCP port 2 is not assigned. Pretty sure nothing will be</span>
            <span class="s3"># listening there. (We used to bind a port and then *not* call</span>
            <span class="s3"># listen() to ensure nothing was listening there, but it turns</span>
            <span class="s3"># out on macOS if you do this it takes 30 seconds for the</span>
            <span class="s3"># connect to fail. Really. Also if you use a non-routable</span>
            <span class="s3"># address. This way fails instantly though. As long as nothing</span>
            <span class="s3"># is listening on port 2.)</span>
            <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>


<span class="s3"># Fix issue #1810</span>
<span class="s0">async def </span><span class="s1">test_address_in_socket_error</span><span class="s2">():</span>
    <span class="s1">address </span><span class="s2">= </span><span class="s5">&quot;127.0.0.1&quot;</span>
    <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">((</span><span class="s1">address</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">any</span><span class="s2">(</span><span class="s1">address </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">) </span><span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">e</span><span class="s2">.</span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_resolve_address_exception_in_connect_closes_socket</span><span class="s2">():</span>
    <span class="s3"># Here we are testing issue 247, any cancellation will leave the socket closed</span>
    <span class="s0">with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">CancelScope</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cancel_scope</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>

            <span class="s0">async def </span><span class="s1">_resolve_address_nocp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
                <span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>

            <span class="s1">sock</span><span class="s2">.</span><span class="s1">_resolve_address_nocp </span><span class="s2">= </span><span class="s1">_resolve_address_nocp</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">Cancelled</span><span class="s2">):</span>
                    <span class="s0">await </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s5">&quot;&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s4">1</span>


<span class="s0">async def </span><span class="s1">test_send_recv_variants</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s3"># recv, including with flags</span>
        <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">MSG_PEEK</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>

        <span class="s3"># recv_into</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv_into</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">buf </span><span class="s2">== </span><span class="s6">b&quot;x&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot; </span><span class="s2">* </span><span class="s4">9</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">&quot;sendmsg&quot;</span><span class="s2">):</span>
            <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendmsg</span><span class="s2">([</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">], []) == </span><span class="s4">3</span>
            <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;xxx&quot;</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>

        <span class="s1">targets </span><span class="s2">= [</span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">(), (</span><span class="s5">&quot;localhost&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">])]</span>

        <span class="s3"># recvfrom + sendto, with and without names</span>
        <span class="s0">for </span><span class="s1">target </span><span class="s0">in </span><span class="s1">targets</span><span class="s2">:</span>
            <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">, </span><span class="s1">target</span><span class="s2">) == </span><span class="s4">3</span>
            <span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;xxx&quot;</span>
            <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s3"># sendto + flags</span>
        <span class="s3">#</span>
        <span class="s3"># I can't find any flags that send() accepts... on Linux at least</span>
        <span class="s3"># passing MSG_MORE to send_some on a connected UDP socket seems to</span>
        <span class="s3"># just be ignored.</span>
        <span class="s3">#</span>
        <span class="s3"># But there's no MSG_MORE on Windows or macOS. I guess send_some flags</span>
        <span class="s3"># are really not very useful, but at least this tests them a bit.</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">, </span><span class="s5">&quot;MSG_MORE&quot;</span><span class="s2">):</span>
            <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">MSG_MORE</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
            <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;yyy&quot;</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">MSG_MORE</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
            <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;zzz&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
            <span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;xxxyyyzzz&quot;</span>
            <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s3"># recvfrom_into</span>
        <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s4">3</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvfrom_into</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s4">3</span>
        <span class="s0">assert </span><span class="s1">buf </span><span class="s2">== </span><span class="s6">b&quot;xxx&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot; </span><span class="s2">* </span><span class="s4">7</span>
        <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s5">&quot;recvmsg&quot;</span><span class="s2">):</span>
            <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s4">3</span>
            <span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">ancdata</span><span class="s2">, </span><span class="s1">msg_flags</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvmsg</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">data </span><span class="s2">== </span><span class="s6">b&quot;xxx&quot;</span>
            <span class="s0">assert </span><span class="s1">ancdata </span><span class="s2">== []</span>
            <span class="s0">assert </span><span class="s1">msg_flags </span><span class="s2">== </span><span class="s4">0</span>
            <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s5">&quot;recvmsg_into&quot;</span><span class="s2">):</span>
            <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendto</span><span class="s2">(</span><span class="s6">b&quot;xyzw&quot;</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()) == </span><span class="s4">4</span>
            <span class="s1">buf1 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">buf2 </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
            <span class="s1">ret </span><span class="s2">= </span><span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvmsg_into</span><span class="s2">([</span><span class="s1">buf1</span><span class="s2">, </span><span class="s1">buf2</span><span class="s2">])</span>
            <span class="s2">(</span><span class="s1">nbytes</span><span class="s2">, </span><span class="s1">ancdata</span><span class="s2">, </span><span class="s1">msg_flags</span><span class="s2">, </span><span class="s1">addr</span><span class="s2">) = </span><span class="s1">ret</span>
            <span class="s0">assert </span><span class="s1">nbytes </span><span class="s2">== </span><span class="s4">4</span>
            <span class="s0">assert </span><span class="s1">buf1 </span><span class="s2">== </span><span class="s6">b&quot;xy&quot;</span>
            <span class="s0">assert </span><span class="s1">buf2 </span><span class="s2">== </span><span class="s6">b&quot;zw&quot; </span><span class="s2">+ </span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot;</span>
            <span class="s0">assert </span><span class="s1">ancdata </span><span class="s2">== []</span>
            <span class="s0">assert </span><span class="s1">msg_flags </span><span class="s2">== </span><span class="s4">0</span>
            <span class="s0">assert </span><span class="s1">addr </span><span class="s2">== </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">&quot;sendmsg&quot;</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">target </span><span class="s0">in </span><span class="s1">targets</span><span class="s2">:</span>
                <span class="s0">assert await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">sendmsg</span><span class="s2">([</span><span class="s6">b&quot;x&quot;</span><span class="s2">, </span><span class="s6">b&quot;yz&quot;</span><span class="s2">], [], </span><span class="s4">0</span><span class="s2">, </span><span class="s1">target</span><span class="s2">) == </span><span class="s4">3</span>
                <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recvfrom</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == (</span><span class="s6">b&quot;xyz&quot;</span><span class="s2">, </span><span class="s1">a</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">type</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_DGRAM</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s5">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
        <span class="s3"># send on a connected udp socket; each call creates a separate</span>
        <span class="s3"># datagram</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;yyy&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;xxx&quot;</span>
        <span class="s0">assert await </span><span class="s1">b</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) == </span><span class="s6">b&quot;yyy&quot;</span>


<span class="s0">async def </span><span class="s1">test_idna</span><span class="s2">(</span><span class="s1">monkeygai</span><span class="s2">):</span>
    <span class="s3"># This is the encoding for &quot;fa.de&quot;, which uses one of the characters that</span>
    <span class="s3"># IDNA 2003 handles incorrectly:</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;ok fa.de&quot;</span><span class="s2">, </span><span class="s6">b&quot;xn--fa-hia.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;ok ::1&quot;</span><span class="s2">, </span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">_NUMERIC_ONLY</span><span class="s2">)</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;ok ::1&quot;</span><span class="s2">, </span><span class="s6">b&quot;::1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s1">_NUMERIC_ONLY</span><span class="s2">)</span>
    <span class="s3"># Some things that should not reach the underlying socket.getaddrinfo:</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;bad&quot;</span><span class="s2">, </span><span class="s5">&quot;fass.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s3"># We always call socket.getaddrinfo with bytes objects:</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;bad&quot;</span><span class="s2">, </span><span class="s5">&quot;xn--fa-hia.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s5">&quot;ok ::1&quot; </span><span class="s2">== </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;::1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;ok ::1&quot; </span><span class="s2">== </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s6">b&quot;::1&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;ok fa.de&quot; </span><span class="s2">== </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;fa.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;ok fa.de&quot; </span><span class="s2">== </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;xn--fa-hia.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s5">&quot;ok fa.de&quot; </span><span class="s2">== </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s6">b&quot;xn--fa-hia.de&quot;</span><span class="s2">, </span><span class="s4">80</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_getprotobyname</span><span class="s2">():</span>
    <span class="s3"># These are the constants used in IP header fields, so the numeric values</span>
    <span class="s3"># had *better* be stable across systems...</span>
    <span class="s0">assert await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getprotobyname</span><span class="s2">(</span><span class="s5">&quot;udp&quot;</span><span class="s2">) == </span><span class="s4">17</span>
    <span class="s0">assert await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getprotobyname</span><span class="s2">(</span><span class="s5">&quot;tcp&quot;</span><span class="s2">) == </span><span class="s4">6</span>


<span class="s0">async def </span><span class="s1">test_custom_hostname_resolver</span><span class="s2">(</span><span class="s1">monkeygai</span><span class="s2">):</span>
    <span class="s0">class </span><span class="s1">CustomResolver</span><span class="s2">:</span>
        <span class="s0">async def </span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, </span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s5">&quot;custom_gai&quot;</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, </span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">getnameinfo</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sockaddr</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s5">&quot;custom_gni&quot;</span><span class="s2">, </span><span class="s1">sockaddr</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">)</span>

    <span class="s1">cr </span><span class="s2">= </span><span class="s1">CustomResolver</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">set_custom_hostname_resolver</span><span class="s2">(</span><span class="s1">cr</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s3"># Check that the arguments are all getting passed through.</span>
    <span class="s3"># We have to use valid calls to avoid making the underlying system</span>
    <span class="s3"># getaddrinfo cranky when it's used for NUMERIC checks.</span>
    <span class="s0">for </span><span class="s1">vals </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_STREAM</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">IPPROTO_TCP</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AI_CANONNAME</span><span class="s2">),</span>
    <span class="s2">]:</span>
        <span class="s0">assert await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;localhost&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, *</span><span class="s1">vals</span><span class="s2">) == (</span>
            <span class="s5">&quot;custom_gai&quot;</span><span class="s2">,</span>
            <span class="s6">b&quot;localhost&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
            <span class="s2">*</span><span class="s1">vals</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s3"># IDNA encoding is handled before calling the special object</span>
    <span class="s1">got </span><span class="s2">= </span><span class="s0">await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= (</span><span class="s5">&quot;custom_gai&quot;</span><span class="s2">, </span><span class="s6">b&quot;xn--f-1gaa&quot;</span><span class="s2">, </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s0">assert await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getnameinfo</span><span class="s2">(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">) == (</span><span class="s5">&quot;custom_gni&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s3"># We can set it back to None</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">set_custom_hostname_resolver</span><span class="s2">(</span><span class="s0">None</span><span class="s2">) </span><span class="s0">is </span><span class="s1">cr</span>

    <span class="s3"># And now Trio switches back to calling socket.getaddrinfo (specifically</span>
    <span class="s3"># our monkeypatched version of socket.getaddrinfo)</span>
    <span class="s1">monkeygai</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s5">&quot;x&quot;</span><span class="s2">, </span><span class="s6">b&quot;host&quot;</span><span class="s2">, </span><span class="s5">&quot;port&quot;</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">flags</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert await </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">getaddrinfo</span><span class="s2">(</span><span class="s5">&quot;host&quot;</span><span class="s2">, </span><span class="s5">&quot;port&quot;</span><span class="s2">) == </span><span class="s5">&quot;x&quot;</span>


<span class="s0">async def </span><span class="s1">test_custom_socket_factory</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">CustomSocketFactory</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">socket</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s5">&quot;hi&quot;</span><span class="s2">, </span><span class="s1">family</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">proto</span><span class="s2">)</span>

    <span class="s1">csf </span><span class="s2">= </span><span class="s1">CustomSocketFactory</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">set_custom_socket_factory</span><span class="s2">(</span><span class="s1">csf</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">() == (</span><span class="s5">&quot;hi&quot;</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_INET</span><span class="s2">, </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SOCK_STREAM</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">) == (</span><span class="s5">&quot;hi&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

    <span class="s3"># socket with fileno= doesn't call our custom method</span>
    <span class="s1">fd </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">().</span><span class="s1">detach</span><span class="s2">()</span>
    <span class="s1">wrapped </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">fileno</span><span class="s2">=</span><span class="s1">fd</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">wrapped</span><span class="s2">, </span><span class="s5">&quot;bind&quot;</span><span class="s2">)</span>
    <span class="s1">wrapped</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s3"># Likewise for socketpair</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">&quot;bind&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s5">&quot;bind&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">set_custom_socket_factory</span><span class="s2">(</span><span class="s0">None</span><span class="s2">) </span><span class="s0">is </span><span class="s1">csf</span>


<span class="s0">async def </span><span class="s1">test_SocketType_is_abstract</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">tsocket</span><span class="s2">.</span><span class="s1">SocketType</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">, </span><span class="s5">&quot;AF_UNIX&quot;</span><span class="s2">), </span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;no unix domain sockets&quot;</span><span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_unix_domain_socket</span><span class="s2">():</span>
    <span class="s3"># Bind has a special branch to use a thread, since it has to do filesystem</span>
    <span class="s3"># traversal. Maybe connect should too? Not sure.</span>

    <span class="s0">async def </span><span class="s1">check_AF_UNIX</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_UNIX</span><span class="s2">) </span><span class="s0">as </span><span class="s1">lsock</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">lsock</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">lsock</span><span class="s2">.</span><span class="s1">listen</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">AF_UNIX</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csock</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">csock</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                <span class="s1">ssock</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s0">await </span><span class="s1">lsock</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">()</span>
                <span class="s0">with </span><span class="s1">ssock</span><span class="s2">:</span>
                    <span class="s0">await </span><span class="s1">csock</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
                    <span class="s0">assert await </span><span class="s1">ssock</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>

    <span class="s3"># Can't use tmpdir fixture, because we can exceed the maximum AF_UNIX path</span>
    <span class="s3"># length on macOS.</span>
    <span class="s0">with </span><span class="s1">tempfile</span><span class="s2">.</span><span class="s1">TemporaryDirectory</span><span class="s2">() </span><span class="s0">as </span><span class="s1">tmpdir</span><span class="s2">:</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">tmpdir</span><span class="s0">}</span><span class="s5">/sock&quot;</span>
        <span class="s0">await </span><span class="s1">check_AF_UNIX</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">cookie </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">urandom</span><span class="s2">(</span><span class="s4">20</span><span class="s2">).</span><span class="s1">hex</span><span class="s2">().</span><span class="s1">encode</span><span class="s2">(</span><span class="s5">&quot;ascii&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">check_AF_UNIX</span><span class="s2">(</span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">trio-test-&quot; </span><span class="s2">+ </span><span class="s1">cookie</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">FileNotFoundError</span><span class="s2">:</span>
        <span class="s3"># macOS doesn't support abstract filenames with the leading NUL byte</span>
        <span class="s0">pass</span>


<span class="s0">async def </span><span class="s1">test_interrupted_by_close</span><span class="s2">():</span>
    <span class="s1">a_stdlib</span><span class="s2">, </span><span class="s1">b_stdlib </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a_stdlib</span><span class="s2">, </span><span class="s1">b_stdlib</span><span class="s2">:</span>
        <span class="s1">a_stdlib</span><span class="s2">.</span><span class="s1">setblocking</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s6">b&quot;x&quot; </span><span class="s2">* </span><span class="s4">99999</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s1">a_stdlib</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">BlockingIOError</span><span class="s2">:</span>
            <span class="s0">pass</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">a_stdlib</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">sender</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">receiver</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">a</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">sender</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">receiver</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
            <span class="s1">a</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_many_sockets</span><span class="s2">():</span>
    <span class="s1">total </span><span class="s2">= </span><span class="s4">5000  </span><span class="s3"># Must be more than MAX_AFD_GROUP_SIZE</span>
    <span class="s1">sockets </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">total </span><span class="s2">// </span><span class="s4">2</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
            <span class="s0">assert </span><span class="s1">e</span><span class="s2">.</span><span class="s1">errno </span><span class="s0">in </span><span class="s2">(</span><span class="s1">errno</span><span class="s2">.</span><span class="s1">EMFILE</span><span class="s2">, </span><span class="s1">errno</span><span class="s2">.</span><span class="s1">ENFILE</span><span class="s2">)</span>
            <span class="s0">break</span>
        <span class="s1">sockets </span><span class="s2">+= [</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">]</span>
    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">sockets</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">wait_readable</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">wait_all_tasks_blocked</span><span class="s2">()</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">sock </span><span class="s0">in </span><span class="s1">sockets</span><span class="s2">:</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">x </span><span class="s2">!= </span><span class="s1">total </span><span class="s2">// </span><span class="s4">2 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s5">f&quot;Unable to open more than </span><span class="s0">{</span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)*</span><span class="s4">2</span><span class="s0">} </span><span class="s5">sockets.&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>