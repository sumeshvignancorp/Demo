<html>
<head>
<title>verifier.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
verifier.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># DEPRECATED: implementation for ffi.verify()</span>
<span class="s0">#</span>
<span class="s2">import </span><span class="s1">sys</span><span class="s3">, </span><span class="s1">os</span><span class="s3">, </span><span class="s1">binascii</span><span class="s3">, </span><span class="s1">shutil</span><span class="s3">, </span><span class="s1">io</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">__version_verifier_modules__</span>
<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">ffiplatform</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">error </span><span class="s2">import </span><span class="s1">VerificationError</span>

<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">):</span>
    <span class="s2">import </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">machinery</span>
    <span class="s2">def </span><span class="s1">_extension_suffixes</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s1">importlib</span><span class="s3">.</span><span class="s1">machinery</span><span class="s3">.</span><span class="s1">EXTENSION_SUFFIXES</span><span class="s3">[:]</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">imp</span>
    <span class="s2">def </span><span class="s1">_extension_suffixes</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">suffix </span><span class="s2">for </span><span class="s1">suffix</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">type </span><span class="s2">in </span><span class="s1">imp</span><span class="s3">.</span><span class="s1">get_suffixes</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">type </span><span class="s3">== </span><span class="s1">imp</span><span class="s3">.</span><span class="s1">C_EXTENSION</span><span class="s3">]</span>


<span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">,):</span>
    <span class="s1">NativeIO </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">StringIO</span>
<span class="s2">else</span><span class="s3">:</span>
    <span class="s2">class </span><span class="s1">NativeIO</span><span class="s3">(</span><span class="s1">io</span><span class="s3">.</span><span class="s1">BytesIO</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">s</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">unicode</span><span class="s3">):</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">'ascii'</span><span class="s3">)</span>
            <span class="s1">super</span><span class="s3">(</span><span class="s1">NativeIO</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">write</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Verifier</span><span class="s3">(</span><span class="s1">object</span><span class="s3">):</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ffi</span><span class="s3">, </span><span class="s1">preamble</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">modulename</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                 <span class="s1">ext_package</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">tag</span><span class="s3">=</span><span class="s5">''</span><span class="s3">, </span><span class="s1">force_generic_engine</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                 <span class="s1">source_extension</span><span class="s3">=</span><span class="s5">'.c'</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">relative_to</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">kwds</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_parser</span><span class="s3">.</span><span class="s1">_uses_new_feature</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">VerificationError</span><span class="s3">(</span>
                <span class="s5">&quot;feature not supported with ffi.verify(), but only &quot;</span>
                <span class="s5">&quot;with ffi.set_source(): %s&quot; </span><span class="s3">% (</span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_parser</span><span class="s3">.</span><span class="s1">_uses_new_feature</span><span class="s3">,))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ffi </span><span class="s3">= </span><span class="s1">ffi</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">preamble </span><span class="s3">= </span><span class="s1">preamble</span>
        <span class="s2">if not </span><span class="s1">modulename</span><span class="s3">:</span>
            <span class="s1">flattened_kwds </span><span class="s3">= </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">(</span><span class="s1">kwds</span><span class="s3">)</span>
        <span class="s1">vengine_class </span><span class="s3">= </span><span class="s1">_locate_engine_class</span><span class="s3">(</span><span class="s1">ffi</span><span class="s3">, </span><span class="s1">force_generic_engine</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine </span><span class="s3">= </span><span class="s1">vengine_class</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">patch_extension_kwds</span><span class="s3">(</span><span class="s1">kwds</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">flags </span><span class="s3">= </span><span class="s1">flags</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">kwds </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_relative_to</span><span class="s3">(</span><span class="s1">kwds</span><span class="s3">, </span><span class="s1">relative_to</span><span class="s3">)</span>
        <span class="s0">#</span>
        <span class="s2">if </span><span class="s1">modulename</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">tag</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">&quot;can't specify both 'modulename' and 'tag'&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s5">'</span><span class="s2">\x00</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s5">'%d.%d' </span><span class="s3">% </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">],</span>
                               <span class="s1">__version_verifier_modules__</span><span class="s3">,</span>
                               <span class="s1">preamble</span><span class="s3">, </span><span class="s1">flattened_kwds</span><span class="s3">] +</span>
                              <span class="s1">ffi</span><span class="s3">.</span><span class="s1">_cdefsources</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info </span><span class="s3">&gt;= (</span><span class="s4">3</span><span class="s3">,):</span>
                <span class="s1">key </span><span class="s3">= </span><span class="s1">key</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s5">'utf-8'</span><span class="s3">)</span>
            <span class="s1">k1 </span><span class="s3">= </span><span class="s1">hex</span><span class="s3">(</span><span class="s1">binascii</span><span class="s3">.</span><span class="s1">crc32</span><span class="s3">(</span><span class="s1">key</span><span class="s3">[</span><span class="s4">0</span><span class="s3">::</span><span class="s4">2</span><span class="s3">]) &amp; </span><span class="s4">0xffffffff</span><span class="s3">)</span>
            <span class="s1">k1 </span><span class="s3">= </span><span class="s1">k1</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s5">'0x'</span><span class="s3">).</span><span class="s1">rstrip</span><span class="s3">(</span><span class="s5">'L'</span><span class="s3">)</span>
            <span class="s1">k2 </span><span class="s3">= </span><span class="s1">hex</span><span class="s3">(</span><span class="s1">binascii</span><span class="s3">.</span><span class="s1">crc32</span><span class="s3">(</span><span class="s1">key</span><span class="s3">[</span><span class="s4">1</span><span class="s3">::</span><span class="s4">2</span><span class="s3">]) &amp; </span><span class="s4">0xffffffff</span><span class="s3">)</span>
            <span class="s1">k2 </span><span class="s3">= </span><span class="s1">k2</span><span class="s3">.</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s5">'0'</span><span class="s3">).</span><span class="s1">rstrip</span><span class="s3">(</span><span class="s5">'L'</span><span class="s3">)</span>
            <span class="s1">modulename </span><span class="s3">= </span><span class="s5">'_cffi_%s_%s%s%s' </span><span class="s3">% (</span><span class="s1">tag</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">_class_key</span><span class="s3">,</span>
                                              <span class="s1">k1</span><span class="s3">, </span><span class="s1">k2</span><span class="s3">)</span>
        <span class="s1">suffix </span><span class="s3">= </span><span class="s1">_get_so_suffixes</span><span class="s3">()[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tmpdir </span><span class="s3">= </span><span class="s1">tmpdir </span><span class="s2">or </span><span class="s1">_caller_dir_pycache</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">modulename </span><span class="s3">+ </span><span class="s1">source_extension</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">modulename </span><span class="s3">+ </span><span class="s1">suffix</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ext_package </span><span class="s3">= </span><span class="s1">ext_package</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">write_source</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Write the C source code.  It is produced in 'self.sourcefilename', 
        which can be tweaked beforehand.&quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_lock</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source </span><span class="s2">and </span><span class="s1">file </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">VerificationError</span><span class="s3">(</span>
                    <span class="s5">&quot;source code already written&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source</span><span class="s3">(</span><span class="s1">file</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">compile_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Write the C source code (if not done already) and compile it. 
        This produces a dynamic link library in 'self.modulefilename'.&quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_lock</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">VerificationError</span><span class="s3">(</span><span class="s5">&quot;module already compiled&quot;</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_compile_module</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">load_library</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Get a C module from this Verifier instance. 
        Returns an instance of a FFILibrary class that behaves like the 
        objects returned by ffi.dlopen(), but that delegates all 
        operations to the C module.  If necessary, the C code is written 
        and compiled first. 
        &quot;&quot;&quot;</span>
        <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_lock</span><span class="s3">:</span>
            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_locate_module</span><span class="s3">()</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module</span><span class="s3">:</span>
                    <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source</span><span class="s3">()</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_compile_module</span><span class="s3">()</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_load_library</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">get_module_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">basename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename</span><span class="s3">)</span>
        <span class="s0"># kill both the .so extension and the other .'s, as introduced</span>
        <span class="s0"># by Python 3: 'basename.cpython-33m.so'</span>
        <span class="s1">basename </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s0"># and the _d added in Python 2 debug builds --- but try to be</span>
        <span class="s0"># conservative and not kill a legitimate _d</span>
        <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">'_d'</span><span class="s3">) </span><span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">, </span><span class="s5">'gettotalrefcount'</span><span class="s3">):</span>
            <span class="s1">basename </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">[:-</span><span class="s4">2</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">basename</span>

    <span class="s2">def </span><span class="s1">get_extension</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">_hack_at_distutils</span><span class="s3">() </span><span class="s0"># backward compatibility hack</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_lock</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source</span><span class="s3">()</span>
        <span class="s1">sourcename </span><span class="s3">= </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">maybe_relative_path</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">)</span>
        <span class="s1">modname </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_module_name</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">get_extension</span><span class="s3">(</span><span class="s1">sourcename</span><span class="s3">, </span><span class="s1">modname</span><span class="s3">, **</span><span class="s1">self</span><span class="s3">.</span><span class="s1">kwds</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">generates_python_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">_gen_python_module</span>

    <span class="s2">def </span><span class="s1">make_relative_to</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kwds</span><span class="s3">, </span><span class="s1">relative_to</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">relative_to </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">relative_to</span><span class="s3">):</span>
            <span class="s1">dirname </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">relative_to</span><span class="s3">)</span>
            <span class="s1">kwds </span><span class="s3">= </span><span class="s1">kwds</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">LIST_OF_FILE_NAMES</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s1">kwds</span><span class="s3">:</span>
                    <span class="s1">lst </span><span class="s3">= </span><span class="s1">kwds</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
                    <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
                        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">&quot;keyword '%s' should be a list or tuple&quot;</span>
                                        <span class="s3">% (</span><span class="s1">key</span><span class="s3">,))</span>
                    <span class="s1">lst </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">) </span><span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">lst</span><span class="s3">]</span>
                    <span class="s1">kwds</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s1">lst</span>
        <span class="s2">return </span><span class="s1">kwds</span>

    <span class="s0"># ----------</span>

    <span class="s2">def </span><span class="s1">_locate_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">ext_package</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">pkg </span><span class="s3">= </span><span class="s1">__import__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">ext_package</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, [</span><span class="s5">'__doc__'</span><span class="s3">])</span>
                <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
                    <span class="s2">return      </span><span class="s0"># cannot import the package itself, give up</span>
                    <span class="s0"># (e.g. it might be called differently before installation)</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s1">pkg</span><span class="s3">.</span><span class="s1">__path__</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">path </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">filename </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">find_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_module_name</span><span class="s3">(), </span><span class="s1">path</span><span class="s3">,</span>
                                                 <span class="s1">_get_so_suffixes</span><span class="s3">())</span>
            <span class="s2">if </span><span class="s1">filename </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s2">return</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename </span><span class="s3">= </span><span class="s1">filename</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">collect_types</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">_write_source_to</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">_f </span><span class="s3">= </span><span class="s1">file</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">write_source_to_f</span><span class="s3">()</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s2">del </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">_f</span>

    <span class="s2">def </span><span class="s1">_write_source</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">file</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">file </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source_to</span><span class="s3">(</span><span class="s1">file</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s0"># Write our source file to an in memory file.</span>
            <span class="s1">f </span><span class="s3">= </span><span class="s1">NativeIO</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_source_to</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s1">source_data </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">getvalue</span><span class="s3">()</span>

            <span class="s0"># Determine if this matches the current file</span>
            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">, </span><span class="s5">&quot;r&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fp</span><span class="s3">:</span>
                    <span class="s1">needs_written </span><span class="s3">= </span><span class="s2">not </span><span class="s3">(</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">() == </span><span class="s1">source_data</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">needs_written </span><span class="s3">= </span><span class="s2">True</span>

            <span class="s0"># Actually write the file out if it doesn't match</span>
            <span class="s2">if </span><span class="s1">needs_written</span><span class="s3">:</span>
                <span class="s1">_ensure_dir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">)</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">, </span><span class="s5">&quot;w&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fp</span><span class="s3">:</span>
                    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">source_data</span><span class="s3">)</span>

            <span class="s0"># Set this flag</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_source </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">_compile_module</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># compile this C source</span>
        <span class="s1">tmpdir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">sourcefilename</span><span class="s3">)</span>
        <span class="s1">outputfilename </span><span class="s3">= </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_extension</span><span class="s3">())</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">same </span><span class="s3">= </span><span class="s1">ffiplatform</span><span class="s3">.</span><span class="s1">samefile</span><span class="s3">(</span><span class="s1">outputfilename</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
            <span class="s1">same </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">if not </span><span class="s1">same</span><span class="s3">:</span>
            <span class="s1">_ensure_dir</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename</span><span class="s3">)</span>
            <span class="s1">shutil</span><span class="s3">.</span><span class="s1">move</span><span class="s3">(</span><span class="s1">outputfilename</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">modulefilename</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">_load_library</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_has_module</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">flags </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">load_library</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vengine</span><span class="s3">.</span><span class="s1">load_library</span><span class="s3">()</span>

<span class="s0"># ____________________________________________________________</span>

<span class="s1">_FORCE_GENERIC_ENGINE </span><span class="s3">= </span><span class="s2">False      </span><span class="s0"># for tests</span>

<span class="s2">def </span><span class="s1">_locate_engine_class</span><span class="s3">(</span><span class="s1">ffi</span><span class="s3">, </span><span class="s1">force_generic_engine</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">_FORCE_GENERIC_ENGINE</span><span class="s3">:</span>
        <span class="s1">force_generic_engine </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">if not </span><span class="s1">force_generic_engine</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s5">'__pypy__' </span><span class="s2">in </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">builtin_module_names</span><span class="s3">:</span>
            <span class="s1">force_generic_engine </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">import </span><span class="s1">_cffi_backend</span>
            <span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
                <span class="s1">_cffi_backend </span><span class="s3">= </span><span class="s5">'?'</span>
            <span class="s2">if </span><span class="s1">ffi</span><span class="s3">.</span><span class="s1">_backend </span><span class="s2">is not </span><span class="s1">_cffi_backend</span><span class="s3">:</span>
                <span class="s1">force_generic_engine </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">if </span><span class="s1">force_generic_engine</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">vengine_gen</span>
        <span class="s2">return </span><span class="s1">vengine_gen</span><span class="s3">.</span><span class="s1">VGenericEngine</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">vengine_cpy</span>
        <span class="s2">return </span><span class="s1">vengine_cpy</span><span class="s3">.</span><span class="s1">VCPythonEngine</span>

<span class="s0"># ____________________________________________________________</span>

<span class="s1">_TMPDIR </span><span class="s3">= </span><span class="s2">None</span>

<span class="s2">def </span><span class="s1">_caller_dir_pycache</span><span class="s3">():</span>
    <span class="s2">if </span><span class="s1">_TMPDIR</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">_TMPDIR</span>
    <span class="s1">result </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">environ</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'CFFI_TMPDIR'</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">result</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">result</span>
    <span class="s1">filename </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">_getframe</span><span class="s3">(</span><span class="s4">2</span><span class="s3">).</span><span class="s1">f_code</span><span class="s3">.</span><span class="s1">co_filename</span>
    <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">),</span>
                           <span class="s5">'__pycache__'</span><span class="s3">))</span>

<span class="s2">def </span><span class="s1">set_tmpdir</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Set the temporary directory to use instead of __pycache__.&quot;&quot;&quot;</span>
    <span class="s2">global </span><span class="s1">_TMPDIR</span>
    <span class="s1">_TMPDIR </span><span class="s3">= </span><span class="s1">dirname</span>

<span class="s2">def </span><span class="s1">cleanup_tmpdir</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">keep_so</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Clean up the temporary directory by removing all files in it 
    called `_cffi_*.{c,so}` as well as the `build` subdirectory.&quot;&quot;&quot;</span>
    <span class="s1">tmpdir </span><span class="s3">= </span><span class="s1">tmpdir </span><span class="s2">or </span><span class="s1">_caller_dir_pycache</span><span class="s3">()</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">filelist </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
        <span class="s2">return</span>
    <span class="s2">if </span><span class="s1">keep_so</span><span class="s3">:</span>
        <span class="s1">suffix </span><span class="s3">= </span><span class="s5">'.c'   </span><span class="s0"># only remove .c files</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">suffix </span><span class="s3">= </span><span class="s1">_get_so_suffixes</span><span class="s3">()[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">lower</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">filelist</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">'_cffi_'</span><span class="s3">) </span><span class="s2">and </span><span class="s3">(</span>
                <span class="s1">fn</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">suffix</span><span class="s3">) </span><span class="s2">or </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">'.c'</span><span class="s3">)):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">))</span>
            <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
                <span class="s2">pass</span>
    <span class="s1">clean_dir </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s5">'build'</span><span class="s3">)]</span>
    <span class="s2">for </span><span class="s1">dir </span><span class="s2">in </span><span class="s1">clean_dir</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">):</span>
                <span class="s1">fn </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
                    <span class="s1">clean_dir</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">OSError</span><span class="s3">:</span>
            <span class="s2">pass</span>

<span class="s2">def </span><span class="s1">_get_so_suffixes</span><span class="s3">():</span>
    <span class="s1">suffixes </span><span class="s3">= </span><span class="s1">_extension_suffixes</span><span class="s3">()</span>
    <span class="s2">if not </span><span class="s1">suffixes</span><span class="s3">:</span>
        <span class="s0"># bah, no C_EXTENSION available.  Occurs on pypy without cpyext</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s5">'win32'</span><span class="s3">:</span>
            <span class="s1">suffixes </span><span class="s3">= [</span><span class="s5">&quot;.pyd&quot;</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">suffixes </span><span class="s3">= [</span><span class="s5">&quot;.so&quot;</span><span class="s3">]</span>

    <span class="s2">return </span><span class="s1">suffixes</span>

<span class="s2">def </span><span class="s1">_ensure_dir</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
    <span class="s1">dirname </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">dirname </span><span class="s2">and not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">):</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">)</span>
</pre>
</body>
</html>