<html>
<head>
<title>terminal.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
terminal.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Terminal reporting of the full testing process. 
 
This is a good source for looking at the various reporting hooks. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">argparse</span>
<span class="s2">import </span><span class="s1">dataclasses</span>
<span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">import </span><span class="s1">inspect</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">collections </span><span class="s2">import </span><span class="s1">Counter</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Callable</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">cast</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">ClassVar</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Dict</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Generator</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">List</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Mapping</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">NamedTuple</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Optional</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Sequence</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Set</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">TextIO</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Tuple</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">TYPE_CHECKING</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Union</span>

<span class="s2">import </span><span class="s1">pluggy</span>

<span class="s2">import </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_version</span>
<span class="s2">from </span><span class="s1">_pytest </span><span class="s2">import </span><span class="s1">nodes</span>
<span class="s2">from </span><span class="s1">_pytest </span><span class="s2">import </span><span class="s1">timing</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_code </span><span class="s2">import </span><span class="s1">ExceptionInfo</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_code</span><span class="s3">.</span><span class="s1">code </span><span class="s2">import </span><span class="s1">ExceptionRepr</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_io </span><span class="s2">import </span><span class="s1">TerminalWriter</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_io</span><span class="s3">.</span><span class="s1">wcwidth </span><span class="s2">import </span><span class="s1">wcswidth</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">assertion</span><span class="s3">.</span><span class="s1">util </span><span class="s2">import </span><span class="s1">running_on_ci</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">compat </span><span class="s2">import </span><span class="s1">final</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">_PluggyPlugin</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">Config</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">ExitCode</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">hookimpl</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">argparsing </span><span class="s2">import </span><span class="s1">Parser</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">nodes </span><span class="s2">import </span><span class="s1">Item</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">nodes </span><span class="s2">import </span><span class="s1">Node</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">absolutepath</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">bestrelpath</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">reports </span><span class="s2">import </span><span class="s1">BaseReport</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">reports </span><span class="s2">import </span><span class="s1">CollectReport</span>
<span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">reports </span><span class="s2">import </span><span class="s1">TestReport</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s1">typing_extensions </span><span class="s2">import </span><span class="s1">Literal</span>

    <span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">main </span><span class="s2">import </span><span class="s1">Session</span>


<span class="s1">REPORT_COLLECTING_RESOLUTION </span><span class="s3">= </span><span class="s4">0.5</span>

<span class="s1">KNOWN_TYPES </span><span class="s3">= (</span>
    <span class="s5">&quot;failed&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;passed&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;skipped&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;deselected&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;xfailed&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;xpassed&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;warnings&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;error&quot;</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s1">_REPORTCHARS_DEFAULT </span><span class="s3">= </span><span class="s5">&quot;fE&quot;</span>


<span class="s2">class </span><span class="s1">MoreQuietAction</span><span class="s3">(</span><span class="s1">argparse</span><span class="s3">.</span><span class="s1">Action</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;A modified copy of the argparse count action which counts down and updates 
    the legacy quiet attribute at the same time. 
 
    Used to unify verbosity handling. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">option_strings</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">],</span>
        <span class="s1">dest</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">: </span><span class="s1">object </span><span class="s3">= </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">required</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span>
            <span class="s1">option_strings</span><span class="s3">=</span><span class="s1">option_strings</span><span class="s3">,</span>
            <span class="s1">dest</span><span class="s3">=</span><span class="s1">dest</span><span class="s3">,</span>
            <span class="s1">nargs</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
            <span class="s1">default</span><span class="s3">=</span><span class="s1">default</span><span class="s3">,</span>
            <span class="s1">required</span><span class="s3">=</span><span class="s1">required</span><span class="s3">,</span>
            <span class="s1">help</span><span class="s3">=</span><span class="s1">help</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">parser</span><span class="s3">: </span><span class="s1">argparse</span><span class="s3">.</span><span class="s1">ArgumentParser</span><span class="s3">,</span>
        <span class="s1">namespace</span><span class="s3">: </span><span class="s1">argparse</span><span class="s3">.</span><span class="s1">Namespace</span><span class="s3">,</span>
        <span class="s1">values</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">object</span><span class="s3">], </span><span class="s2">None</span><span class="s3">],</span>
        <span class="s1">option_string</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">new_count </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">, </span><span class="s4">0</span><span class="s3">) - </span><span class="s4">1</span>
        <span class="s1">setattr</span><span class="s3">(</span><span class="s1">namespace</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dest</span><span class="s3">, </span><span class="s1">new_count</span><span class="s3">)</span>
        <span class="s6"># todo Deprecate config.quiet</span>
        <span class="s1">namespace</span><span class="s3">.</span><span class="s1">quiet </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">namespace</span><span class="s3">, </span><span class="s5">&quot;quiet&quot;</span><span class="s3">, </span><span class="s4">0</span><span class="s3">) + </span><span class="s4">1</span>


<span class="s2">class </span><span class="s1">TestShortLogReport</span><span class="s3">(</span><span class="s1">NamedTuple</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Used to store the test status result category, shortletter and verbose word. 
    For example ``&quot;rerun&quot;, &quot;R&quot;, (&quot;RERUN&quot;, {&quot;yellow&quot;: True})``. 
 
    :ivar category: 
        The class of result, for example ``“passed”``, ``“skipped”``, ``“error”``, or the empty string. 
 
    :ivar letter: 
        The short letter shown as testing progresses, for example ``&quot;.&quot;``, ``&quot;s&quot;``, ``&quot;E&quot;``, or the empty string. 
 
    :ivar word: 
        Verbose word is shown as testing progresses in verbose mode, for example ``&quot;PASSED&quot;``, ``&quot;SKIPPED&quot;``, 
        ``&quot;ERROR&quot;``, or the empty string. 
    &quot;&quot;&quot;</span>

    <span class="s1">category</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">letter</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">word</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]]]</span>


<span class="s2">def </span><span class="s1">pytest_addoption</span><span class="s3">(</span><span class="s1">parser</span><span class="s3">: </span><span class="s1">Parser</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">group </span><span class="s3">= </span><span class="s1">parser</span><span class="s3">.</span><span class="s1">getgroup</span><span class="s3">(</span><span class="s5">&quot;terminal reporting&quot;</span><span class="s3">, </span><span class="s5">&quot;Reporting&quot;</span><span class="s3">, </span><span class="s1">after</span><span class="s3">=</span><span class="s5">&quot;general&quot;</span><span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;-v&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;--verbose&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;count&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;verbose&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Increase verbosity&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--no-header&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_true&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;no_header&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Disable header&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--no-summary&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_true&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;no_summary&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Disable summary&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;-q&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;--quiet&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s1">MoreQuietAction</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;verbose&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Decrease verbosity&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--verbosity&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;verbose&quot;</span><span class="s3">,</span>
        <span class="s1">type</span><span class="s3">=</span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s4">0</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Set verbosity. Default: 0.&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;-r&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;reportchars&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s1">_REPORTCHARS_DEFAULT</span><span class="s3">,</span>
        <span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;chars&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Show extra test summary info as specified by chars: (f)ailed, &quot;</span>
        <span class="s5">&quot;(E)rror, (s)kipped, (x)failed, (X)passed, &quot;</span>
        <span class="s5">&quot;(p)assed, (P)assed with output, (a)ll except passed (p/P), or (A)ll. &quot;</span>
        <span class="s5">&quot;(w)arnings are enabled by default (see --disable-warnings), &quot;</span>
        <span class="s5">&quot;'N' can be used to reset the list. (default: 'fE').&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--disable-warnings&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;--disable-pytest-warnings&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;disable_warnings&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_true&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Disable warnings summary&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;-l&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;--showlocals&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_true&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;showlocals&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Show locals in tracebacks (disabled by default)&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--no-showlocals&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_false&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;showlocals&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Hide locals in tracebacks (negate --showlocals passed through addopts)&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--tb&quot;</span><span class="s3">,</span>
        <span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;style&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;tbstyle&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s5">&quot;auto&quot;</span><span class="s3">,</span>
        <span class="s1">choices</span><span class="s3">=[</span><span class="s5">&quot;auto&quot;</span><span class="s3">, </span><span class="s5">&quot;long&quot;</span><span class="s3">, </span><span class="s5">&quot;short&quot;</span><span class="s3">, </span><span class="s5">&quot;no&quot;</span><span class="s3">, </span><span class="s5">&quot;line&quot;</span><span class="s3">, </span><span class="s5">&quot;native&quot;</span><span class="s3">],</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Traceback print mode (auto/long/short/line/native/no)&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--show-capture&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;showcapture&quot;</span><span class="s3">,</span>
        <span class="s1">choices</span><span class="s3">=[</span><span class="s5">&quot;no&quot;</span><span class="s3">, </span><span class="s5">&quot;stdout&quot;</span><span class="s3">, </span><span class="s5">&quot;stderr&quot;</span><span class="s3">, </span><span class="s5">&quot;log&quot;</span><span class="s3">, </span><span class="s5">&quot;all&quot;</span><span class="s3">],</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s5">&quot;all&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Controls how captured stdout/stderr/log is shown on failed tests. &quot;</span>
        <span class="s5">&quot;Default: all.&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--fulltrace&quot;</span><span class="s3">,</span>
        <span class="s5">&quot;--full-trace&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store_true&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Don't cut any tracebacks (default is to cut)&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--color&quot;</span><span class="s3">,</span>
        <span class="s1">metavar</span><span class="s3">=</span><span class="s5">&quot;color&quot;</span><span class="s3">,</span>
        <span class="s1">action</span><span class="s3">=</span><span class="s5">&quot;store&quot;</span><span class="s3">,</span>
        <span class="s1">dest</span><span class="s3">=</span><span class="s5">&quot;color&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s5">&quot;auto&quot;</span><span class="s3">,</span>
        <span class="s1">choices</span><span class="s3">=[</span><span class="s5">&quot;yes&quot;</span><span class="s3">, </span><span class="s5">&quot;no&quot;</span><span class="s3">, </span><span class="s5">&quot;auto&quot;</span><span class="s3">],</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Color terminal output (yes/no/auto)&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">group</span><span class="s3">.</span><span class="s1">_addoption</span><span class="s3">(</span>
        <span class="s5">&quot;--code-highlight&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s5">&quot;yes&quot;</span><span class="s3">,</span>
        <span class="s1">choices</span><span class="s3">=[</span><span class="s5">&quot;yes&quot;</span><span class="s3">, </span><span class="s5">&quot;no&quot;</span><span class="s3">],</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">&quot;Whether code should be highlighted (only if --color is also enabled). &quot;</span>
        <span class="s5">&quot;Default: yes.&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">parser</span><span class="s3">.</span><span class="s1">addini</span><span class="s3">(</span>
        <span class="s5">&quot;console_output_style&quot;</span><span class="s3">,</span>
        <span class="s1">help</span><span class="s3">=</span><span class="s5">'Console output: &quot;classic&quot;, or with additional progress information '</span>
        <span class="s5">'(&quot;progress&quot; (percentage) | &quot;count&quot; | &quot;progress-even-when-capture-no&quot; (forces '</span>
        <span class="s5">&quot;progress even when capture=no)&quot;</span><span class="s3">,</span>
        <span class="s1">default</span><span class="s3">=</span><span class="s5">&quot;progress&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">pytest_configure</span><span class="s3">(</span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">reporter </span><span class="s3">= </span><span class="s1">TerminalReporter</span><span class="s3">(</span><span class="s1">config</span><span class="s3">, </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span><span class="s3">)</span>
    <span class="s1">config</span><span class="s3">.</span><span class="s1">pluginmanager</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">reporter</span><span class="s3">, </span><span class="s5">&quot;terminalreporter&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">debug </span><span class="s2">or </span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">traceconfig</span><span class="s3">:</span>

        <span class="s2">def </span><span class="s1">mywriter</span><span class="s3">(</span><span class="s1">tags</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot; &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">args</span><span class="s3">))</span>
            <span class="s1">reporter</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s5">&quot;[traceconfig] &quot; </span><span class="s3">+ </span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s1">config</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">.</span><span class="s1">root</span><span class="s3">.</span><span class="s1">setprocessor</span><span class="s3">(</span><span class="s5">&quot;pytest:config&quot;</span><span class="s3">, </span><span class="s1">mywriter</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">getreportopt</span><span class="s3">(</span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s1">reportchars</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">reportchars</span>

    <span class="s1">old_aliases </span><span class="s3">= {</span><span class="s5">&quot;F&quot;</span><span class="s3">, </span><span class="s5">&quot;S&quot;</span><span class="s3">}</span>
    <span class="s1">reportopts </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>
    <span class="s2">for </span><span class="s1">char </span><span class="s2">in </span><span class="s1">reportchars</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">char </span><span class="s2">in </span><span class="s1">old_aliases</span><span class="s3">:</span>
            <span class="s1">char </span><span class="s3">= </span><span class="s1">char</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">char </span><span class="s3">== </span><span class="s5">&quot;a&quot;</span><span class="s3">:</span>
            <span class="s1">reportopts </span><span class="s3">= </span><span class="s5">&quot;sxXEf&quot;</span>
        <span class="s2">elif </span><span class="s1">char </span><span class="s3">== </span><span class="s5">&quot;A&quot;</span><span class="s3">:</span>
            <span class="s1">reportopts </span><span class="s3">= </span><span class="s5">&quot;PpsxXEf&quot;</span>
        <span class="s2">elif </span><span class="s1">char </span><span class="s3">== </span><span class="s5">&quot;N&quot;</span><span class="s3">:</span>
            <span class="s1">reportopts </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>
        <span class="s2">elif </span><span class="s1">char </span><span class="s2">not in </span><span class="s1">reportopts</span><span class="s3">:</span>
            <span class="s1">reportopts </span><span class="s3">+= </span><span class="s1">char</span>

    <span class="s2">if not </span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">disable_warnings </span><span class="s2">and </span><span class="s5">&quot;w&quot; </span><span class="s2">not in </span><span class="s1">reportopts</span><span class="s3">:</span>
        <span class="s1">reportopts </span><span class="s3">= </span><span class="s5">&quot;w&quot; </span><span class="s3">+ </span><span class="s1">reportopts</span>
    <span class="s2">elif </span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">disable_warnings </span><span class="s2">and </span><span class="s5">&quot;w&quot; </span><span class="s2">in </span><span class="s1">reportopts</span><span class="s3">:</span>
        <span class="s1">reportopts </span><span class="s3">= </span><span class="s1">reportopts</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;w&quot;</span><span class="s3">, </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">reportopts</span>


<span class="s3">@</span><span class="s1">hookimpl</span><span class="s3">(</span><span class="s1">trylast</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)  </span><span class="s6"># after _pytest.runner</span>
<span class="s2">def </span><span class="s1">pytest_report_teststatus</span><span class="s3">(</span><span class="s1">report</span><span class="s3">: </span><span class="s1">BaseReport</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s1">letter </span><span class="s3">= </span><span class="s5">&quot;F&quot;</span>
    <span class="s2">if </span><span class="s1">report</span><span class="s3">.</span><span class="s1">passed</span><span class="s3">:</span>
        <span class="s1">letter </span><span class="s3">= </span><span class="s5">&quot;.&quot;</span>
    <span class="s2">elif </span><span class="s1">report</span><span class="s3">.</span><span class="s1">skipped</span><span class="s3">:</span>
        <span class="s1">letter </span><span class="s3">= </span><span class="s5">&quot;s&quot;</span>

    <span class="s1">outcome</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s1">report</span><span class="s3">.</span><span class="s1">outcome</span>
    <span class="s2">if </span><span class="s1">report</span><span class="s3">.</span><span class="s1">when </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;collect&quot;</span><span class="s3">, </span><span class="s5">&quot;setup&quot;</span><span class="s3">, </span><span class="s5">&quot;teardown&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s1">outcome </span><span class="s3">== </span><span class="s5">&quot;failed&quot;</span><span class="s3">:</span>
        <span class="s1">outcome </span><span class="s3">= </span><span class="s5">&quot;error&quot;</span>
        <span class="s1">letter </span><span class="s3">= </span><span class="s5">&quot;E&quot;</span>

    <span class="s2">return </span><span class="s1">outcome</span><span class="s3">, </span><span class="s1">letter</span><span class="s3">, </span><span class="s1">outcome</span><span class="s3">.</span><span class="s1">upper</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">dataclasses</span><span class="s3">.</span><span class="s1">dataclass</span>
<span class="s2">class </span><span class="s1">WarningReport</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Simple structure to hold warnings information captured by ``pytest_warning_recorded``. 
 
    :ivar str message: 
        User friendly message about the warning. 
    :ivar str|None nodeid: 
        nodeid that generated the warning (see ``get_location``). 
    :ivar tuple fslocation: 
        File system location of the source of the warning (see ``get_location``). 
    &quot;&quot;&quot;</span>

    <span class="s1">message</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s1">nodeid</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span>
    <span class="s1">fslocation</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]] = </span><span class="s2">None</span>

    <span class="s1">count_towards_summary</span><span class="s3">: </span><span class="s1">ClassVar </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">get_location</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot;Return the more user-friendly information about the location of a warning, or None.&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">nodeid</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fslocation</span><span class="s3">:</span>
            <span class="s1">filename</span><span class="s3">, </span><span class="s1">linenum </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fslocation</span>
            <span class="s1">relpath </span><span class="s3">= </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">invocation_params</span><span class="s3">.</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">absolutepath</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">))</span>
            <span class="s2">return </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">relpath</span><span class="s2">}</span><span class="s5">:</span><span class="s2">{</span><span class="s1">linenum</span><span class="s2">}</span><span class="s5">&quot;</span>
        <span class="s2">return None</span>


<span class="s3">@</span><span class="s1">final</span>
<span class="s2">class </span><span class="s1">TerminalReporter</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">, </span><span class="s1">file</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">TextIO</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">import </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">config </span><span class="s3">= </span><span class="s1">config</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Session</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_showfspath</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s2">None</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">]] = {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_main_color</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_known_types</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">startpath </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">invocation_params</span><span class="s3">.</span><span class="s1">dir</span>
        <span class="s2">if </span><span class="s1">file </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">file </span><span class="s3">= </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">stdout</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw </span><span class="s3">= </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">create_terminal_writer</span><span class="s3">(</span><span class="s1">config</span><span class="s3">, </span><span class="s1">file</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_screen_width </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">fullwidth</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">reportchars </span><span class="s3">= </span><span class="s1">getreportopt</span><span class="s3">(</span><span class="s1">config</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hasmarkup </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">hasmarkup</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">isatty </span><span class="s3">= </span><span class="s1">file</span><span class="s3">.</span><span class="s1">isatty</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span><span class="s3">: </span><span class="s1">Set</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_determine_show_progress_info</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_collect_report_last_write</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">float</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_already_displayed_warnings</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboardinterrupt_memo</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">ExceptionRepr</span><span class="s3">] = </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">_determine_show_progress_info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">&quot;Literal['progress', 'count', False]&quot;</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return whether we should display progress information based on the current config.&quot;&quot;&quot;</span>
        <span class="s6"># do not show progress if we are not capturing output (#3038) unless explicitly</span>
        <span class="s6"># overridden by progress-even-when-capture-no</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getoption</span><span class="s3">(</span><span class="s5">&quot;capture&quot;</span><span class="s3">, </span><span class="s5">&quot;no&quot;</span><span class="s3">) == </span><span class="s5">&quot;no&quot;</span>
            <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getini</span><span class="s3">(</span><span class="s5">&quot;console_output_style&quot;</span><span class="s3">)</span>
            <span class="s3">!= </span><span class="s5">&quot;progress-even-when-capture-no&quot;</span>
        <span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s6"># do not show progress if we are showing fixture setup/teardown</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getoption</span><span class="s3">(</span><span class="s5">&quot;setupshow&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
            <span class="s2">return False</span>
        <span class="s1">cfg</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getini</span><span class="s3">(</span><span class="s5">&quot;console_output_style&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">cfg </span><span class="s3">== </span><span class="s5">&quot;progress&quot; </span><span class="s2">or </span><span class="s1">cfg </span><span class="s3">== </span><span class="s5">&quot;progress-even-when-capture-no&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">&quot;progress&quot;</span>
        <span class="s2">elif </span><span class="s1">cfg </span><span class="s3">== </span><span class="s5">&quot;count&quot;</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s5">&quot;count&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return False</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">verbosity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s1">verbosity</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose</span>
        <span class="s2">return </span><span class="s1">verbosity</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">showheader</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt;= </span><span class="s4">0</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">no_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">no_header</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">no_summary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">no_summary</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">showfspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_showfspath </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt;= </span><span class="s4">0</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_showfspath</span>

    <span class="s3">@</span><span class="s1">showfspath</span><span class="s3">.</span><span class="s1">setter</span>
    <span class="s2">def </span><span class="s1">showfspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">value</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_showfspath </span><span class="s3">= </span><span class="s1">value</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">showlongtestinfo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt; </span><span class="s4">0</span>

    <span class="s2">def </span><span class="s1">hasopt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">char</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s1">char </span><span class="s3">= {</span><span class="s5">&quot;xfailed&quot;</span><span class="s3">: </span><span class="s5">&quot;x&quot;</span><span class="s3">, </span><span class="s5">&quot;skipped&quot;</span><span class="s3">: </span><span class="s5">&quot;s&quot;</span><span class="s3">}.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">char</span><span class="s3">, </span><span class="s1">char</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">char </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reportchars</span>

    <span class="s2">def </span><span class="s1">write_fspath_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">fspath </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">rootpath </span><span class="s3">/ </span><span class="s1">nodeid</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s2">is None or </span><span class="s1">fspath </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s2">is not None and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_progress_information_filling_space</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">= </span><span class="s1">fspath</span>
            <span class="s1">relfspath </span><span class="s3">= </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">startpath</span><span class="s3">, </span><span class="s1">fspath</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">relfspath </span><span class="s3">+ </span><span class="s5">&quot; &quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">flush</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">write_ensure_prefix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">prefix</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">extra</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;&quot;</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">!= </span><span class="s1">prefix</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">= </span><span class="s1">prefix</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">extra</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">extra</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">= -</span><span class="s4">2</span>

    <span class="s2">def </span><span class="s1">ensure_newline</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">wrap_write</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">content</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s3">*,</span>
        <span class="s1">flush</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">margin</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s4">8</span><span class="s3">,</span>
        <span class="s1">line_sep</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Wrap message with margin for progress info.&quot;&quot;&quot;</span>
        <span class="s1">width_of_current_line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">width_of_current_line</span>
        <span class="s1">wrapped </span><span class="s3">= </span><span class="s1">line_sep</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
            <span class="s1">textwrap</span><span class="s3">.</span><span class="s1">wrap</span><span class="s3">(</span>
                <span class="s5">&quot; &quot; </span><span class="s3">* </span><span class="s1">width_of_current_line </span><span class="s3">+ </span><span class="s1">content</span><span class="s3">,</span>
                <span class="s1">width</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_screen_width </span><span class="s3">- </span><span class="s1">margin</span><span class="s3">,</span>
                <span class="s1">drop_whitespace</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s1">replace_whitespace</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">wrapped </span><span class="s3">= </span><span class="s1">wrapped</span><span class="s3">[</span><span class="s1">width_of_current_line</span><span class="s3">:]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">wrapped</span><span class="s3">, </span><span class="s1">flush</span><span class="s3">=</span><span class="s1">flush</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">content</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, *, </span><span class="s1">flush</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">content</span><span class="s3">, </span><span class="s1">flush</span><span class="s3">=</span><span class="s1">flush</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">flush</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">line</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">], **</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">errors</span><span class="s3">=</span><span class="s5">&quot;replace&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ensure_newline</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">rewrite</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">line</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Rewinds the terminal cursor to the beginning and writes the given line. 
 
        :param erase: 
            If True, will also add spaces until the full terminal width to ensure 
            previous lines are properly erased. 
 
        The rest of the keyword arguments are markup instructions. 
        &quot;&quot;&quot;</span>
        <span class="s1">erase </span><span class="s3">= </span><span class="s1">markup</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s5">&quot;erase&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">erase</span><span class="s3">:</span>
            <span class="s1">fill_count </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">fullwidth </span><span class="s3">- </span><span class="s1">len</span><span class="s3">(</span><span class="s1">line</span><span class="s3">) - </span><span class="s4">1</span>
            <span class="s1">fill </span><span class="s3">= </span><span class="s5">&quot; &quot; </span><span class="s3">* </span><span class="s1">fill_count</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">fill </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\r</span><span class="s5">&quot; </span><span class="s3">+ </span><span class="s1">line </span><span class="s3">+ </span><span class="s1">fill</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">write_sep</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">sep</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
        <span class="s1">title</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">fullwidth</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">markup</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">ensure_newline</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">, </span><span class="s1">title</span><span class="s3">, </span><span class="s1">fullwidth</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">section</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">title</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">sep</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s5">&quot;=&quot;</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">(</span><span class="s1">sep</span><span class="s3">, </span><span class="s1">title</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">line</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">category</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">items</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">set_main_color </span><span class="s3">= </span><span class="s1">category </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">category</span><span class="s3">, []).</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">items</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">set_main_color</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_main_color</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">pytest_internalerror</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">excrepr</span><span class="s3">: </span><span class="s1">ExceptionRepr</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">excrepr</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s5">&quot;INTERNALERROR&gt; &quot; </span><span class="s3">+ </span><span class="s1">line</span><span class="s3">)</span>
        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">pytest_warning_recorded</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">warning_message</span><span class="s3">: </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">WarningMessage</span><span class="s3">,</span>
        <span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">from </span><span class="s1">_pytest</span><span class="s3">.</span><span class="s1">warnings </span><span class="s2">import </span><span class="s1">warning_record_to_str</span>

        <span class="s1">fslocation </span><span class="s3">= </span><span class="s1">warning_message</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">warning_message</span><span class="s3">.</span><span class="s1">lineno</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s1">warning_record_to_str</span><span class="s3">(</span><span class="s1">warning_message</span><span class="s3">)</span>

        <span class="s1">warning_report </span><span class="s3">= </span><span class="s1">WarningReport</span><span class="s3">(</span>
            <span class="s1">fslocation</span><span class="s3">=</span><span class="s1">fslocation</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s1">message</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">=</span><span class="s1">nodeid</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s5">&quot;warnings&quot;</span><span class="s3">, [</span><span class="s1">warning_report</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">pytest_plugin_registered</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">plugin</span><span class="s3">: </span><span class="s1">_PluggyPlugin</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">traceconfig</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;PLUGIN registered: </span><span class="s2">{</span><span class="s1">plugin</span><span class="s2">}</span><span class="s5">&quot;</span>
            <span class="s6"># XXX This event may happen during setup/teardown time</span>
            <span class="s6">#     which unfortunately captures our output here</span>
            <span class="s6">#     which garbles our output if we use self.write_line.</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pytest_deselected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">items</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Item</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s5">&quot;deselected&quot;</span><span class="s3">, </span><span class="s1">items</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pytest_runtest_logstart</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">location</span><span class="s3">: </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">str</span><span class="s3">]</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s6"># Ensure that the path is printed before the</span>
        <span class="s6"># 1st test of a module starts running.</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">showlongtestinfo</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_locationline</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">, *</span><span class="s1">location</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_ensure_prefix</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">showfspath</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_fspath_result</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">, </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">pytest_runtest_logreport</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">report</span><span class="s3">: </span><span class="s1">TestReport</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tests_ran </span><span class="s3">= </span><span class="s2">True</span>
        <span class="s1">rep </span><span class="s3">= </span><span class="s1">report</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">TestShortLogReport</span><span class="s3">(</span>
            <span class="s3">*</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">hook</span><span class="s3">.</span><span class="s1">pytest_report_teststatus</span><span class="s3">(</span><span class="s1">report</span><span class="s3">=</span><span class="s1">rep</span><span class="s3">, </span><span class="s1">config</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">category</span><span class="s3">, </span><span class="s1">letter</span><span class="s3">, </span><span class="s1">word </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">category</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">letter</span><span class="s3">, </span><span class="s1">res</span><span class="s3">.</span><span class="s1">word</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">word</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">):</span>
            <span class="s1">markup </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">word</span><span class="s3">, </span><span class="s1">markup </span><span class="s3">= </span><span class="s1">word</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s1">category</span><span class="s3">, [</span><span class="s1">rep</span><span class="s3">])</span>
        <span class="s2">if not </span><span class="s1">letter </span><span class="s2">and not </span><span class="s1">word</span><span class="s3">:</span>
            <span class="s6"># Probably passed setup/teardown.</span>
            <span class="s2">return</span>
        <span class="s1">running_xdist </span><span class="s3">= </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">, </span><span class="s5">&quot;node&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">markup </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">was_xfail </span><span class="s3">= </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">report</span><span class="s3">, </span><span class="s5">&quot;wasxfail&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">passed </span><span class="s2">and not </span><span class="s1">was_xfail</span><span class="s3">:</span>
                <span class="s1">markup </span><span class="s3">= {</span><span class="s5">&quot;green&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
            <span class="s2">elif </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">passed </span><span class="s2">and </span><span class="s1">was_xfail</span><span class="s3">:</span>
                <span class="s1">markup </span><span class="s3">= {</span><span class="s5">&quot;yellow&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
            <span class="s2">elif </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">failed</span><span class="s3">:</span>
                <span class="s1">markup </span><span class="s3">= {</span><span class="s5">&quot;red&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
            <span class="s2">elif </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">skipped</span><span class="s3">:</span>
                <span class="s1">markup </span><span class="s3">= {</span><span class="s5">&quot;yellow&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">markup </span><span class="s3">= {}</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&lt;= </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">letter</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">)</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_locationline</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">, *</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">location</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">running_xdist</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write_ensure_prefix</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">word</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">skipped </span><span class="s2">or </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">report</span><span class="s3">, </span><span class="s5">&quot;wasxfail&quot;</span><span class="s3">):</span>
                    <span class="s1">reason </span><span class="s3">= </span><span class="s1">_get_raw_skip_reason</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&lt; </span><span class="s4">2</span><span class="s3">:</span>
                        <span class="s1">available_width </span><span class="s3">= (</span>
                            <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">fullwidth </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">width_of_current_line</span><span class="s3">)</span>
                            <span class="s3">- </span><span class="s1">len</span><span class="s3">(</span><span class="s5">&quot; [100%]&quot;</span><span class="s3">)</span>
                            <span class="s3">- </span><span class="s4">1</span>
                        <span class="s3">)</span>
                        <span class="s1">formatted_reason </span><span class="s3">= </span><span class="s1">_format_trimmed</span><span class="s3">(</span>
                            <span class="s5">&quot; ({})&quot;</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">, </span><span class="s1">available_width</span>
                        <span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">formatted_reason </span><span class="s3">= </span><span class="s5">f&quot; (</span><span class="s2">{</span><span class="s1">reason</span><span class="s2">}</span><span class="s5">)&quot;</span>

                    <span class="s2">if </span><span class="s1">reason </span><span class="s2">and </span><span class="s1">formatted_reason </span><span class="s2">is not None</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">wrap_write</span><span class="s3">(</span><span class="s1">formatted_reason</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_progress_information_filling_space</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">ensure_newline</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;[%s]&quot; </span><span class="s3">% </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">gateway</span><span class="s3">.</span><span class="s1">id</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_get_progress_information_message</span><span class="s3">() + </span><span class="s5">&quot; &quot;</span><span class="s3">, </span><span class="s1">cyan</span><span class="s3">=</span><span class="s2">True</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot; &quot;</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">word</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot; &quot; </span><span class="s3">+ </span><span class="s1">line</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">currentfspath </span><span class="s3">= -</span><span class="s4">2</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_is_last_item</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session </span><span class="s2">is not None</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span><span class="s3">) == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span><span class="s3">.</span><span class="s1">testscollected</span>

    <span class="s2">def </span><span class="s1">pytest_runtest_logfinish</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&lt;= </span><span class="s4">0 </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info </span><span class="s3">== </span><span class="s5">&quot;count&quot;</span><span class="s3">:</span>
                <span class="s1">num_tests </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span><span class="s3">.</span><span class="s1">testscollected</span>
                <span class="s1">progress_length </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s5">f&quot; [</span><span class="s2">{</span><span class="s1">num_tests</span><span class="s2">}</span><span class="s5">/</span><span class="s2">{</span><span class="s1">num_tests</span><span class="s2">}</span><span class="s5">]&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">progress_length </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s5">&quot; [100%]&quot;</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_last_item</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_progress_information_filling_space</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">main_color</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_main_color</span><span class="s3">()</span>
                <span class="s1">w </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_width_of_current_line</span>
                <span class="s1">past_edge </span><span class="s3">= </span><span class="s1">w </span><span class="s3">+ </span><span class="s1">progress_length </span><span class="s3">+ </span><span class="s4">1 </span><span class="s3">&gt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_screen_width</span>
                <span class="s2">if </span><span class="s1">past_edge</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_progress_information_message</span><span class="s3">()</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">msg </span><span class="s3">+ </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">, **{</span><span class="s1">main_color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">_get_progress_information_message</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span>
        <span class="s1">collected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_session</span><span class="s3">.</span><span class="s1">testscollected</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_show_progress_info </span><span class="s3">== </span><span class="s5">&quot;count&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">collected</span><span class="s3">:</span>
                <span class="s1">progress </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span>
                <span class="s1">counter_format </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{{</span><span class="s5">:</span><span class="s2">{</span><span class="s1">len</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">collected</span><span class="s3">))</span><span class="s2">}</span><span class="s5">d</span><span class="s2">}}</span><span class="s5">&quot;</span>
                <span class="s1">format_string </span><span class="s3">= </span><span class="s5">f&quot; [</span><span class="s2">{</span><span class="s1">counter_format</span><span class="s2">}</span><span class="s5">/</span><span class="s2">{{}}</span><span class="s5">]&quot;</span>
                <span class="s2">return </span><span class="s1">format_string</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">progress</span><span class="s3">), </span><span class="s1">collected</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s5">f&quot; [ </span><span class="s2">{</span><span class="s1">collected</span><span class="s2">} </span><span class="s5">/ </span><span class="s2">{</span><span class="s1">collected</span><span class="s2">} </span><span class="s5">]&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">collected</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s5">&quot; [{:3d}%]&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                    <span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_progress_nodeids_reported</span><span class="s3">) * </span><span class="s4">100 </span><span class="s3">// </span><span class="s1">collected</span>
                <span class="s3">)</span>
            <span class="s2">return </span><span class="s5">&quot; [100%]&quot;</span>

    <span class="s2">def </span><span class="s1">_write_progress_information_filling_space</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">color</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_main_color</span><span class="s3">()</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_progress_information_message</span><span class="s3">()</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_width_of_current_line</span>
        <span class="s1">fill </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">fullwidth </span><span class="s3">- </span><span class="s1">w </span><span class="s3">- </span><span class="s4">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">.</span><span class="s1">rjust</span><span class="s3">(</span><span class="s1">fill</span><span class="s3">), </span><span class="s1">flush</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, **{</span><span class="s1">color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">_width_of_current_line</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s0">&quot;&quot;&quot;Return the width of the current line.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">width_of_current_line</span>

    <span class="s2">def </span><span class="s1">pytest_collection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isatty</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&gt;= </span><span class="s4">0</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;collecting ... &quot;</span><span class="s3">, </span><span class="s1">flush</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_collect_report_last_write </span><span class="s3">= </span><span class="s1">timing</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&gt;= </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;collecting ... &quot;</span><span class="s3">, </span><span class="s1">flush</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pytest_collectreport</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">report</span><span class="s3">: </span><span class="s1">CollectReport</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">report</span><span class="s3">.</span><span class="s1">failed</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, [</span><span class="s1">report</span><span class="s3">])</span>
        <span class="s2">elif </span><span class="s1">report</span><span class="s3">.</span><span class="s1">skipped</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_add_stats</span><span class="s3">(</span><span class="s5">&quot;skipped&quot;</span><span class="s3">, [</span><span class="s1">report</span><span class="s3">])</span>
        <span class="s1">items </span><span class="s3">= [</span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">report</span><span class="s3">.</span><span class="s1">result </span><span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">Item</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">items</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isatty</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">report_collect</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">report_collect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">final</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&lt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">if not </span><span class="s1">final</span><span class="s3">:</span>
            <span class="s6"># Only write &quot;collecting&quot; report every 0.5s.</span>
            <span class="s1">t </span><span class="s3">= </span><span class="s1">timing</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_collect_report_last_write </span><span class="s2">is not None</span>
                <span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_collect_report_last_write </span><span class="s3">&gt; </span><span class="s1">t </span><span class="s3">- </span><span class="s1">REPORT_COLLECTING_RESOLUTION</span>
            <span class="s3">):</span>
                <span class="s2">return</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_collect_report_last_write </span><span class="s3">= </span><span class="s1">t</span>

        <span class="s1">errors </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, []))</span>
        <span class="s1">skipped </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;skipped&quot;</span><span class="s3">, []))</span>
        <span class="s1">deselected </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;deselected&quot;</span><span class="s3">, []))</span>
        <span class="s1">selected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">- </span><span class="s1">deselected</span>
        <span class="s1">line </span><span class="s3">= </span><span class="s5">&quot;collected &quot; </span><span class="s2">if </span><span class="s1">final </span><span class="s2">else </span><span class="s5">&quot;collecting &quot;</span>
        <span class="s1">line </span><span class="s3">+= (</span>
            <span class="s1">str</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected</span><span class="s3">) + </span><span class="s5">&quot; item&quot; </span><span class="s3">+ (</span><span class="s5">&quot;&quot; </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">== </span><span class="s4">1 </span><span class="s2">else </span><span class="s5">&quot;s&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">errors</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot; / %d error%s&quot; </span><span class="s3">% (</span><span class="s1">errors</span><span class="s3">, </span><span class="s5">&quot;s&quot; </span><span class="s2">if </span><span class="s1">errors </span><span class="s3">!= </span><span class="s4">1 </span><span class="s2">else </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">deselected</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot; / %d deselected&quot; </span><span class="s3">% </span><span class="s1">deselected</span>
        <span class="s2">if </span><span class="s1">skipped</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot; / %d skipped&quot; </span><span class="s3">% </span><span class="s1">skipped</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">&gt; </span><span class="s1">selected</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot; / %d selected&quot; </span><span class="s3">% </span><span class="s1">selected</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isatty</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">rewrite</span><span class="s3">(</span><span class="s1">line</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">erase</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">final</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">hookimpl</span><span class="s3">(</span><span class="s1">trylast</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">pytest_sessionstart</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">session</span><span class="s3">: </span><span class="s5">&quot;Session&quot;</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_session </span><span class="s3">= </span><span class="s1">session</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_sessionstarttime </span><span class="s3">= </span><span class="s1">timing</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">showheader</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s5">&quot;test session starts&quot;</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">verinfo </span><span class="s3">= </span><span class="s1">platform</span><span class="s3">.</span><span class="s1">python_version</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">no_header</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;platform </span><span class="s2">{</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform</span><span class="s2">} </span><span class="s5">-- Python </span><span class="s2">{</span><span class="s1">verinfo</span><span class="s2">}</span><span class="s5">&quot;</span>
            <span class="s1">pypy_version_info </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">, </span><span class="s5">&quot;pypy_version_info&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">pypy_version_info</span><span class="s3">:</span>
                <span class="s1">verinfo </span><span class="s3">= </span><span class="s5">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">pypy_version_info</span><span class="s3">[:</span><span class="s4">3</span><span class="s3">]))</span>
                <span class="s1">msg </span><span class="s3">+= </span><span class="s5">f&quot;[pypy-</span><span class="s2">{</span><span class="s1">verinfo</span><span class="s2">}</span><span class="s5">-</span><span class="s2">{</span><span class="s1">pypy_version_info</span><span class="s3">[</span><span class="s4">3</span><span class="s3">]</span><span class="s2">}</span><span class="s5">]&quot;</span>
            <span class="s1">msg </span><span class="s3">+= </span><span class="s5">&quot;, pytest-{}, pluggy-{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">_pytest</span><span class="s3">.</span><span class="s1">_version</span><span class="s3">.</span><span class="s1">version</span><span class="s3">, </span><span class="s1">pluggy</span><span class="s3">.</span><span class="s1">__version__</span>
            <span class="s3">)</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt; </span><span class="s4">0</span>
                <span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">debug</span>
                <span class="s2">or </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">, </span><span class="s5">&quot;pastebin&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s3">):</span>
                <span class="s1">msg </span><span class="s3">+= </span><span class="s5">&quot; -- &quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">executable</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">hook</span><span class="s3">.</span><span class="s1">pytest_report_header</span><span class="s3">(</span>
                <span class="s1">config</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">, </span><span class="s1">start_path</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">startpath</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_report_lines_from_hooks</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_write_report_lines_from_hooks</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">lines</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]]]</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">line_or_lines </span><span class="s2">in </span><span class="s1">reversed</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">line_or_lines</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">line_or_lines</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">line_or_lines</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pytest_report_header</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s1">result </span><span class="s3">= [</span><span class="s5">f&quot;rootdir: </span><span class="s2">{</span><span class="s1">config</span><span class="s3">.</span><span class="s1">rootpath</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">]</span>

        <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">inipath</span><span class="s3">:</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;configfile: &quot; </span><span class="s3">+ </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">rootpath</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">inipath</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">args_source </span><span class="s3">== </span><span class="s1">Config</span><span class="s3">.</span><span class="s1">ArgsSource</span><span class="s3">.</span><span class="s1">TESTPATHS</span><span class="s3">:</span>
            <span class="s1">testpaths</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = </span><span class="s1">config</span><span class="s3">.</span><span class="s1">getini</span><span class="s3">(</span><span class="s5">&quot;testpaths&quot;</span><span class="s3">)</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;testpaths: {}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s5">&quot;, &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">testpaths</span><span class="s3">)))</span>

        <span class="s1">plugininfo </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">pluginmanager</span><span class="s3">.</span><span class="s1">list_plugin_distinfo</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">plugininfo</span><span class="s3">:</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;plugins: %s&quot; </span><span class="s3">% </span><span class="s5">&quot;, &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">_plugin_nameversions</span><span class="s3">(</span><span class="s1">plugininfo</span><span class="s3">)))</span>
        <span class="s2">return </span><span class="s1">result</span>

    <span class="s2">def </span><span class="s1">pytest_collection_finish</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">session</span><span class="s3">: </span><span class="s5">&quot;Session&quot;</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">report_collect</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">lines </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">hook</span><span class="s3">.</span><span class="s1">pytest_report_collectionfinish</span><span class="s3">(</span>
            <span class="s1">config</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">,</span>
            <span class="s1">start_path</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">startpath</span><span class="s3">,</span>
            <span class="s1">items</span><span class="s3">=</span><span class="s1">session</span><span class="s3">.</span><span class="s1">items</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_write_report_lines_from_hooks</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getoption</span><span class="s3">(</span><span class="s5">&quot;collectonly&quot;</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">session</span><span class="s3">.</span><span class="s1">items</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&gt; -</span><span class="s4">1</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_printcollecteditems</span><span class="s3">(</span><span class="s1">session</span><span class="s3">.</span><span class="s1">items</span><span class="s3">)</span>

            <span class="s1">failed </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;failed&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">failed</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">(</span><span class="s5">&quot;!&quot;</span><span class="s3">, </span><span class="s5">&quot;collection failures&quot;</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">failed</span><span class="s3">:</span>
                    <span class="s1">rep</span><span class="s3">.</span><span class="s1">toterminal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_printcollecteditems</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">items</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Item</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&lt; </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&lt; -</span><span class="s4">1</span><span class="s3">:</span>
                <span class="s1">counts </span><span class="s3">= </span><span class="s1">Counter</span><span class="s3">(</span><span class="s1">item</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">items</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">count </span><span class="s2">in </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">counts</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s5">&quot;%s: %d&quot; </span><span class="s3">% (</span><span class="s1">name</span><span class="s3">, </span><span class="s1">count</span><span class="s3">))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">items</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">item</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s1">stack</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Node</span><span class="s3">] = []</span>
        <span class="s1">indent </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">items</span><span class="s3">:</span>
            <span class="s1">needed_collectors </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">listchain</span><span class="s3">()[</span><span class="s4">1</span><span class="s3">:]  </span><span class="s6"># strip root node</span>
            <span class="s2">while </span><span class="s1">stack</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">stack </span><span class="s3">== </span><span class="s1">needed_collectors</span><span class="s3">[: </span><span class="s1">len</span><span class="s3">(</span><span class="s1">stack</span><span class="s3">)]:</span>
                    <span class="s2">break</span>
                <span class="s1">stack</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">needed_collectors</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">stack</span><span class="s3">) :]:</span>
                <span class="s1">stack</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">col</span><span class="s3">)</span>
                <span class="s1">indent </span><span class="s3">= (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">stack</span><span class="s3">) - </span><span class="s4">1</span><span class="s3">) * </span><span class="s5">&quot;  &quot;</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">indent</span><span class="s2">}{</span><span class="s1">col</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">verbose </span><span class="s3">&gt;= </span><span class="s4">1</span><span class="s3">:</span>
                    <span class="s1">obj </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, </span><span class="s5">&quot;obj&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                    <span class="s1">doc </span><span class="s3">= </span><span class="s1">inspect</span><span class="s3">.</span><span class="s1">getdoc</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">) </span><span class="s2">if </span><span class="s1">obj </span><span class="s2">else None</span>
                    <span class="s2">if </span><span class="s1">doc</span><span class="s3">:</span>
                        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">doc</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">():</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s5">&quot;{}{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">indent </span><span class="s3">+ </span><span class="s5">&quot;  &quot;</span><span class="s3">, </span><span class="s1">line</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">hookimpl</span><span class="s3">(</span><span class="s1">hookwrapper</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">pytest_sessionfinish</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">session</span><span class="s3">: </span><span class="s5">&quot;Session&quot;</span><span class="s3">, </span><span class="s1">exitstatus</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">ExitCode</span><span class="s3">]</span>
    <span class="s3">):</span>
        <span class="s1">outcome </span><span class="s3">= </span><span class="s2">yield</span>
        <span class="s1">outcome</span><span class="s3">.</span><span class="s1">get_result</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
        <span class="s1">summary_exit_codes </span><span class="s3">= (</span>
            <span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">OK</span><span class="s3">,</span>
            <span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">TESTS_FAILED</span><span class="s3">,</span>
            <span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">INTERRUPTED</span><span class="s3">,</span>
            <span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">USAGE_ERROR</span><span class="s3">,</span>
            <span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">NO_TESTS_COLLECTED</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">exitstatus </span><span class="s2">in </span><span class="s1">summary_exit_codes </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">no_summary</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">hook</span><span class="s3">.</span><span class="s1">pytest_terminal_summary</span><span class="s3">(</span>
                <span class="s1">terminalreporter</span><span class="s3">=</span><span class="s1">self</span><span class="s3">, </span><span class="s1">exitstatus</span><span class="s3">=</span><span class="s1">exitstatus</span><span class="s3">, </span><span class="s1">config</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span>
            <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">session</span><span class="s3">.</span><span class="s1">shouldfail</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;!&quot;</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">session</span><span class="s3">.</span><span class="s1">shouldfail</span><span class="s3">), </span><span class="s1">red</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">exitstatus </span><span class="s3">== </span><span class="s1">ExitCode</span><span class="s3">.</span><span class="s1">INTERRUPTED</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_report_keyboardinterrupt</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboardinterrupt_memo </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">elif </span><span class="s1">session</span><span class="s3">.</span><span class="s1">shouldstop</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;!&quot;</span><span class="s3">, </span><span class="s1">str</span><span class="s3">(</span><span class="s1">session</span><span class="s3">.</span><span class="s1">shouldstop</span><span class="s3">), </span><span class="s1">red</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_stats</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">hookimpl</span><span class="s3">(</span><span class="s1">hookwrapper</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">pytest_terminal_summary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Generator</span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_errors</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_failures</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_warnings</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_passes</span><span class="s3">()</span>
        <span class="s2">yield</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">short_test_summary</span><span class="s3">()</span>
        <span class="s6"># Display any extra warnings from teardown here (if any).</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">summary_warnings</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">pytest_keyboard_interrupt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">excinfo</span><span class="s3">: </span><span class="s1">ExceptionInfo</span><span class="s3">[</span><span class="s1">BaseException</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboardinterrupt_memo </span><span class="s3">= </span><span class="s1">excinfo</span><span class="s3">.</span><span class="s1">getrepr</span><span class="s3">(</span><span class="s1">funcargs</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">pytest_unconfigure</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboardinterrupt_memo </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_report_keyboardinterrupt</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_report_keyboardinterrupt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">excrepr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_keyboardinterrupt_memo</span>
        <span class="s2">assert </span><span class="s1">excrepr </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">excrepr</span><span class="s3">.</span><span class="s1">reprcrash </span><span class="s2">is not None</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">excrepr</span><span class="s3">.</span><span class="s1">reprcrash</span><span class="s3">.</span><span class="s1">message</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;!&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s5">&quot;KeyboardInterrupt&quot; </span><span class="s2">in </span><span class="s1">msg</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">fulltrace</span><span class="s3">:</span>
                <span class="s1">excrepr</span><span class="s3">.</span><span class="s1">toterminal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">excrepr</span><span class="s3">.</span><span class="s1">reprcrash</span><span class="s3">.</span><span class="s1">toterminal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span>
                    <span class="s5">&quot;(to show a full traceback on KeyboardInterrupt use --full-trace)&quot;</span><span class="s3">,</span>
                    <span class="s1">yellow</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_locationline</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">fspath</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">domain</span><span class="s3">: </span><span class="s1">str</span>
    <span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s2">def </span><span class="s1">mkrel</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">cwd_relative_nodeid</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">domain </span><span class="s2">and </span><span class="s1">line</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">domain</span><span class="s3">):</span>
                <span class="s1">line </span><span class="s3">= </span><span class="s1">line</span><span class="s3">[: -</span><span class="s1">len</span><span class="s3">(</span><span class="s1">domain</span><span class="s3">)]</span>
                <span class="s1">values </span><span class="s3">= </span><span class="s1">domain</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;[&quot;</span><span class="s3">)</span>
                <span class="s1">values</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] = </span><span class="s1">values</span><span class="s3">[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;.&quot;</span><span class="s3">, </span><span class="s5">&quot;::&quot;</span><span class="s3">)  </span><span class="s6"># don't replace '.' in params</span>
                <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot;[&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">values</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">line</span>

        <span class="s6"># collect_fspath comes from testid which has a &quot;/&quot;-normalized path.</span>
        <span class="s2">if </span><span class="s1">fspath</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">mkrel</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt;= </span><span class="s4">2 </span><span class="s2">and </span><span class="s1">nodeid</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">] != </span><span class="s1">fspath</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span>
                <span class="s5">&quot;</span><span class="s2">\\</span><span class="s5">&quot;</span><span class="s3">, </span><span class="s1">nodes</span><span class="s3">.</span><span class="s1">SEP</span>
            <span class="s3">):</span>
                <span class="s1">res </span><span class="s3">+= </span><span class="s5">&quot; &lt;- &quot; </span><span class="s3">+ </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">startpath</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">fspath</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">&quot;[location]&quot;</span>
        <span class="s2">return </span><span class="s1">res </span><span class="s3">+ </span><span class="s5">&quot; &quot;</span>

    <span class="s2">def </span><span class="s1">_getfailureheadline</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">):</span>
        <span class="s1">head_line </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">head_line</span>
        <span class="s2">if </span><span class="s1">head_line</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">head_line</span>
        <span class="s2">return </span><span class="s5">&quot;test session&quot;  </span><span class="s6"># XXX?</span>

    <span class="s2">def </span><span class="s1">_getcrashline</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">.</span><span class="s1">reprcrash</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">str</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">)[:</span><span class="s4">50</span><span class="s3">]</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s5">&quot;&quot;</span>

    <span class="s6">#</span>
    <span class="s6"># Summaries for sessionfinish.</span>
    <span class="s6">#</span>
    <span class="s2">def </span><span class="s1">getreports</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">str</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, ()) </span><span class="s2">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">&quot;_pdbshown&quot;</span><span class="s3">)]</span>

    <span class="s2">def </span><span class="s1">summary_warnings</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hasopt</span><span class="s3">(</span><span class="s5">&quot;w&quot;</span><span class="s3">):</span>
            <span class="s1">all_warnings</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">WarningReport</span><span class="s3">]] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;warnings&quot;</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">all_warnings</span><span class="s3">:</span>
                <span class="s2">return</span>

            <span class="s1">final </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_already_displayed_warnings </span><span class="s2">is not None</span>
            <span class="s2">if </span><span class="s1">final</span><span class="s3">:</span>
                <span class="s1">warning_reports </span><span class="s3">= </span><span class="s1">all_warnings</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_already_displayed_warnings </span><span class="s3">:]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">warning_reports </span><span class="s3">= </span><span class="s1">all_warnings</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_already_displayed_warnings </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">warning_reports</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">warning_reports</span><span class="s3">:</span>
                <span class="s2">return</span>

            <span class="s1">reports_grouped_by_message</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">WarningReport</span><span class="s3">]] = {}</span>
            <span class="s2">for </span><span class="s1">wr </span><span class="s2">in </span><span class="s1">warning_reports</span><span class="s3">:</span>
                <span class="s1">reports_grouped_by_message</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">wr</span><span class="s3">.</span><span class="s1">message</span><span class="s3">, []).</span><span class="s1">append</span><span class="s3">(</span><span class="s1">wr</span><span class="s3">)</span>

            <span class="s2">def </span><span class="s1">collapsed_location_report</span><span class="s3">(</span><span class="s1">reports</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">WarningReport</span><span class="s3">]) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
                <span class="s1">locations </span><span class="s3">= []</span>
                <span class="s2">for </span><span class="s1">w </span><span class="s2">in </span><span class="s1">reports</span><span class="s3">:</span>
                    <span class="s1">location </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">get_location</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">location</span><span class="s3">:</span>
                        <span class="s1">locations</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">location</span><span class="s3">)</span>

                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">locations</span><span class="s3">) &lt; </span><span class="s4">10</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">locations</span><span class="s3">))</span>

                <span class="s1">counts_by_filename </span><span class="s3">= </span><span class="s1">Counter</span><span class="s3">(</span>
                    <span class="s1">str</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">).</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">loc </span><span class="s2">in </span><span class="s1">locations</span>
                <span class="s3">)</span>
                <span class="s2">return </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                    <span class="s5">&quot;{}: {} warning{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s5">&quot;s&quot; </span><span class="s2">if </span><span class="s1">v </span><span class="s3">&gt; </span><span class="s4">1 </span><span class="s2">else </span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">counts_by_filename</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>
                <span class="s3">)</span>

            <span class="s1">title </span><span class="s3">= </span><span class="s5">&quot;warnings summary (final)&quot; </span><span class="s2">if </span><span class="s1">final </span><span class="s2">else </span><span class="s5">&quot;warnings summary&quot;</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s1">title</span><span class="s3">, </span><span class="s1">yellow</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">message</span><span class="s3">, </span><span class="s1">message_reports </span><span class="s2">in </span><span class="s1">reports_grouped_by_message</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s1">maybe_location </span><span class="s3">= </span><span class="s1">collapsed_location_report</span><span class="s3">(</span><span class="s1">message_reports</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">maybe_location</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">maybe_location</span><span class="s3">)</span>
                    <span class="s1">lines </span><span class="s3">= </span><span class="s1">message</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()</span>
                    <span class="s1">indented </span><span class="s3">= </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s5">&quot;  &quot; </span><span class="s3">+ </span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">)</span>
                    <span class="s1">message </span><span class="s3">= </span><span class="s1">indented</span><span class="s3">.</span><span class="s1">rstrip</span><span class="s3">()</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">message </span><span class="s3">= </span><span class="s1">message</span><span class="s3">.</span><span class="s1">rstrip</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span>
                <span class="s5">&quot;-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html&quot;</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">summary_passes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">tbstyle </span><span class="s3">!= </span><span class="s5">&quot;no&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hasopt</span><span class="s3">(</span><span class="s5">&quot;P&quot;</span><span class="s3">):</span>
                <span class="s1">reports</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">TestReport</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getreports</span><span class="s3">(</span><span class="s5">&quot;passed&quot;</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">reports</span><span class="s3">:</span>
                    <span class="s2">return</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s5">&quot;PASSES&quot;</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">reports</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">sections</span><span class="s3">:</span>
                        <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfailureheadline</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;_&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">green</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_outrep_summary</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_teardown_sections</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_teardown_reports</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">TestReport</span><span class="s3">]:</span>
        <span class="s1">reports </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getreports</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s3">[</span>
            <span class="s1">report</span>
            <span class="s2">for </span><span class="s1">report </span><span class="s2">in </span><span class="s1">reports</span>
            <span class="s2">if </span><span class="s1">report</span><span class="s3">.</span><span class="s1">when </span><span class="s3">== </span><span class="s5">&quot;teardown&quot; </span><span class="s2">and </span><span class="s1">report</span><span class="s3">.</span><span class="s1">nodeid </span><span class="s3">== </span><span class="s1">nodeid</span>
        <span class="s3">]</span>

    <span class="s2">def </span><span class="s1">_handle_teardown_sections</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">nodeid</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">report </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_teardown_reports</span><span class="s3">(</span><span class="s1">nodeid</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">print_teardown_sections</span><span class="s3">(</span><span class="s1">report</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">print_teardown_sections</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">: </span><span class="s1">TestReport</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">showcapture </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">showcapture</span>
        <span class="s2">if </span><span class="s1">showcapture </span><span class="s3">== </span><span class="s5">&quot;no&quot;</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s2">for </span><span class="s1">secname</span><span class="s3">, </span><span class="s1">content </span><span class="s2">in </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">sections</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">showcapture </span><span class="s3">!= </span><span class="s5">&quot;all&quot; </span><span class="s2">and </span><span class="s1">showcapture </span><span class="s2">not in </span><span class="s1">secname</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s2">if </span><span class="s5">&quot;teardown&quot; </span><span class="s2">in </span><span class="s1">secname</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">(</span><span class="s5">&quot;-&quot;</span><span class="s3">, </span><span class="s1">secname</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">content</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">:] == </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">:</span>
                    <span class="s1">content </span><span class="s3">= </span><span class="s1">content</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">]</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">summary_failures</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">tbstyle </span><span class="s3">!= </span><span class="s5">&quot;no&quot;</span><span class="s3">:</span>
            <span class="s1">reports</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">BaseReport</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getreports</span><span class="s3">(</span><span class="s5">&quot;failed&quot;</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">reports</span><span class="s3">:</span>
                <span class="s2">return</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s5">&quot;FAILURES&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">tbstyle </span><span class="s3">== </span><span class="s5">&quot;line&quot;</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">reports</span><span class="s3">:</span>
                    <span class="s1">line </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getcrashline</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">reports</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfailureheadline</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;_&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">red</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_outrep_summary</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_teardown_sections</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">summary_errors</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">tbstyle </span><span class="s3">!= </span><span class="s5">&quot;no&quot;</span><span class="s3">:</span>
            <span class="s1">reports</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">BaseReport</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getreports</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">reports</span><span class="s3">:</span>
                <span class="s2">return</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s5">&quot;ERRORS&quot;</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">[</span><span class="s5">&quot;error&quot;</span><span class="s3">]:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_getfailureheadline</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">when </span><span class="s3">== </span><span class="s5">&quot;collect&quot;</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;ERROR collecting &quot; </span><span class="s3">+ </span><span class="s1">msg</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;ERROR at </span><span class="s2">{</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">when</span><span class="s2">} </span><span class="s5">of </span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}</span><span class="s5">&quot;</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;_&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">red</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_outrep_summary</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_outrep_summary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">: </span><span class="s1">BaseReport</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">rep</span><span class="s3">.</span><span class="s1">toterminal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">)</span>
        <span class="s1">showcapture </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">option</span><span class="s3">.</span><span class="s1">showcapture</span>
        <span class="s2">if </span><span class="s1">showcapture </span><span class="s3">== </span><span class="s5">&quot;no&quot;</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s2">for </span><span class="s1">secname</span><span class="s3">, </span><span class="s1">content </span><span class="s2">in </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">sections</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">showcapture </span><span class="s3">!= </span><span class="s5">&quot;all&quot; </span><span class="s2">and </span><span class="s1">showcapture </span><span class="s2">not in </span><span class="s1">secname</span><span class="s3">:</span>
                <span class="s2">continue</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">(</span><span class="s5">&quot;-&quot;</span><span class="s3">, </span><span class="s1">secname</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">content</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">:] == </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">:</span>
                <span class="s1">content </span><span class="s3">= </span><span class="s1">content</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">line</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">summary_stats</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&lt; -</span><span class="s4">1</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s1">session_duration </span><span class="s3">= </span><span class="s1">timing</span><span class="s3">.</span><span class="s1">time</span><span class="s3">() - </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_sessionstarttime</span>
        <span class="s3">(</span><span class="s1">parts</span><span class="s3">, </span><span class="s1">main_color</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">build_summary_stats_line</span><span class="s3">()</span>
        <span class="s1">line_parts </span><span class="s3">= []</span>

        <span class="s1">display_sep </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">verbosity </span><span class="s3">&gt;= </span><span class="s4">0</span>
        <span class="s2">if </span><span class="s1">display_sep</span><span class="s3">:</span>
            <span class="s1">fullwidth </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">fullwidth</span>
        <span class="s2">for </span><span class="s1">text</span><span class="s3">, </span><span class="s1">markup </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">:</span>
            <span class="s1">with_markup </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, **</span><span class="s1">markup</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">display_sep</span><span class="s3">:</span>
                <span class="s1">fullwidth </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">with_markup</span><span class="s3">) - </span><span class="s1">len</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
            <span class="s1">line_parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">with_markup</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;, &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">line_parts</span><span class="s3">)</span>

        <span class="s1">main_markup </span><span class="s3">= {</span><span class="s1">main_color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
        <span class="s1">duration </span><span class="s3">= </span><span class="s5">f&quot; in </span><span class="s2">{</span><span class="s1">format_session_duration</span><span class="s3">(</span><span class="s1">session_duration</span><span class="s3">)</span><span class="s2">}</span><span class="s5">&quot;</span>
        <span class="s1">duration_with_markup </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span><span class="s1">duration</span><span class="s3">, **</span><span class="s1">main_markup</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">display_sep</span><span class="s3">:</span>
            <span class="s1">fullwidth </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">duration_with_markup</span><span class="s3">) - </span><span class="s1">len</span><span class="s3">(</span><span class="s1">duration</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">+= </span><span class="s1">duration_with_markup</span>

        <span class="s2">if </span><span class="s1">display_sep</span><span class="s3">:</span>
            <span class="s1">markup_for_end_sep </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">, **</span><span class="s1">main_markup</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">markup_for_end_sep</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\x1b</span><span class="s5">[0m&quot;</span><span class="s3">):</span>
                <span class="s1">markup_for_end_sep </span><span class="s3">= </span><span class="s1">markup_for_end_sep</span><span class="s3">[:-</span><span class="s4">4</span><span class="s3">]</span>
            <span class="s1">fullwidth </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">markup_for_end_sep</span><span class="s3">)</span>
            <span class="s1">msg </span><span class="s3">+= </span><span class="s1">markup_for_end_sep</span>

        <span class="s2">if </span><span class="s1">display_sep</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">fullwidth</span><span class="s3">=</span><span class="s1">fullwidth</span><span class="s3">, **</span><span class="s1">main_markup</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, **</span><span class="s1">main_markup</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">short_test_summary</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reportchars</span><span class="s3">:</span>
            <span class="s2">return</span>

        <span class="s2">def </span><span class="s1">show_simple</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">], *, </span><span class="s1">stat</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">failed </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, [])</span>
            <span class="s2">if not </span><span class="s1">failed</span><span class="s3">:</span>
                <span class="s2">return</span>
            <span class="s1">config </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span>
            <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">failed</span><span class="s3">:</span>
                <span class="s1">color </span><span class="s3">= </span><span class="s1">_color_for_type</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">stat</span><span class="s3">, </span><span class="s1">_color_for_type_default</span><span class="s3">)</span>
                <span class="s1">line </span><span class="s3">= </span><span class="s1">_get_line_with_reprcrash_message</span><span class="s3">(</span>
                    <span class="s1">config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">, {</span><span class="s1">color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}</span>
                <span class="s3">)</span>
                <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">show_xfailed</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">xfailed </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;xfailed&quot;</span><span class="s3">, [])</span>
            <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">xfailed</span><span class="s3">:</span>
                <span class="s1">verbose_word </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">_get_verbose_word</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">)</span>
                <span class="s1">markup_word </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span>
                    <span class="s1">verbose_word</span><span class="s3">, **{</span><span class="s1">_color_for_type</span><span class="s3">[</span><span class="s5">&quot;warnings&quot;</span><span class="s3">]: </span><span class="s2">True</span><span class="s3">}</span>
                <span class="s3">)</span>
                <span class="s1">nodeid </span><span class="s3">= </span><span class="s1">_get_node_id_with_markup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">)</span>
                <span class="s1">line </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">markup_word</span><span class="s2">} {</span><span class="s1">nodeid</span><span class="s2">}</span><span class="s5">&quot;</span>
                <span class="s1">reason </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">wasxfail</span>
                <span class="s2">if </span><span class="s1">reason</span><span class="s3">:</span>
                    <span class="s1">line </span><span class="s3">+= </span><span class="s5">&quot; - &quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">)</span>

                <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">show_xpassed</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">xpassed </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;xpassed&quot;</span><span class="s3">, [])</span>
            <span class="s2">for </span><span class="s1">rep </span><span class="s2">in </span><span class="s1">xpassed</span><span class="s3">:</span>
                <span class="s1">verbose_word </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">_get_verbose_word</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">)</span>
                <span class="s1">markup_word </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span>
                    <span class="s1">verbose_word</span><span class="s3">, **{</span><span class="s1">_color_for_type</span><span class="s3">[</span><span class="s5">&quot;warnings&quot;</span><span class="s3">]: </span><span class="s2">True</span><span class="s3">}</span>
                <span class="s3">)</span>
                <span class="s1">nodeid </span><span class="s3">= </span><span class="s1">_get_node_id_with_markup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">)</span>
                <span class="s1">reason </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">wasxfail</span>
                <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">markup_word</span><span class="s2">} {</span><span class="s1">nodeid</span><span class="s2">} {</span><span class="s1">reason</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">show_skipped</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">skipped</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">CollectReport</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;skipped&quot;</span><span class="s3">, [])</span>
            <span class="s1">fskips </span><span class="s3">= </span><span class="s1">_folded_skips</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">startpath</span><span class="s3">, </span><span class="s1">skipped</span><span class="s3">) </span><span class="s2">if </span><span class="s1">skipped </span><span class="s2">else </span><span class="s3">[]</span>
            <span class="s2">if not </span><span class="s1">fskips</span><span class="s3">:</span>
                <span class="s2">return</span>
            <span class="s1">verbose_word </span><span class="s3">= </span><span class="s1">skipped</span><span class="s3">[</span><span class="s4">0</span><span class="s3">].</span><span class="s1">_get_verbose_word</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">)</span>
            <span class="s1">markup_word </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span>
                <span class="s1">verbose_word</span><span class="s3">, **{</span><span class="s1">_color_for_type</span><span class="s3">[</span><span class="s5">&quot;warnings&quot;</span><span class="s3">]: </span><span class="s2">True</span><span class="s3">}</span>
            <span class="s3">)</span>
            <span class="s1">prefix </span><span class="s3">= </span><span class="s5">&quot;Skipped: &quot;</span>
            <span class="s2">for </span><span class="s1">num</span><span class="s3">, </span><span class="s1">fspath</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">, </span><span class="s1">reason </span><span class="s2">in </span><span class="s1">fskips</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">reason</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">):</span>
                    <span class="s1">reason </span><span class="s3">= </span><span class="s1">reason</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">) :]</span>
                <span class="s2">if </span><span class="s1">lineno </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                        <span class="s5">&quot;%s [%d] %s:%d: %s&quot; </span><span class="s3">% (</span><span class="s1">markup_word</span><span class="s3">, </span><span class="s1">num</span><span class="s3">, </span><span class="s1">fspath</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">)</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">lines</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;%s [%d] %s: %s&quot; </span><span class="s3">% (</span><span class="s1">markup_word</span><span class="s3">, </span><span class="s1">num</span><span class="s3">, </span><span class="s1">fspath</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">))</span>

        <span class="s1">REPORTCHAR_ACTIONS</span><span class="s3">: </span><span class="s1">Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Callable</span><span class="s3">[[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]], </span><span class="s2">None</span><span class="s3">]] = {</span>
            <span class="s5">&quot;x&quot;</span><span class="s3">: </span><span class="s1">show_xfailed</span><span class="s3">,</span>
            <span class="s5">&quot;X&quot;</span><span class="s3">: </span><span class="s1">show_xpassed</span><span class="s3">,</span>
            <span class="s5">&quot;f&quot;</span><span class="s3">: </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">show_simple</span><span class="s3">, </span><span class="s1">stat</span><span class="s3">=</span><span class="s5">&quot;failed&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;s&quot;</span><span class="s3">: </span><span class="s1">show_skipped</span><span class="s3">,</span>
            <span class="s5">&quot;p&quot;</span><span class="s3">: </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">show_simple</span><span class="s3">, </span><span class="s1">stat</span><span class="s3">=</span><span class="s5">&quot;passed&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;E&quot;</span><span class="s3">: </span><span class="s1">partial</span><span class="s3">(</span><span class="s1">show_simple</span><span class="s3">, </span><span class="s1">stat</span><span class="s3">=</span><span class="s5">&quot;error&quot;</span><span class="s3">),</span>
        <span class="s3">}</span>

        <span class="s1">lines</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = []</span>
        <span class="s2">for </span><span class="s1">char </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reportchars</span><span class="s3">:</span>
            <span class="s1">action </span><span class="s3">= </span><span class="s1">REPORTCHAR_ACTIONS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">char</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">action</span><span class="s3">:  </span><span class="s6"># skipping e.g. &quot;P&quot; (passed with output) here.</span>
                <span class="s1">action</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">lines</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">write_sep</span><span class="s3">(</span><span class="s5">&quot;=&quot;</span><span class="s3">, </span><span class="s5">&quot;short test summary info&quot;</span><span class="s3">, </span><span class="s1">cyan</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">lines</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">write_line</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_get_main_color</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]]:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_main_color </span><span class="s2">is None or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_known_types </span><span class="s2">is None or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_last_item</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_set_main_color</span><span class="s3">()</span>
            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_main_color</span>
            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_known_types</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_main_color</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_known_types</span>

    <span class="s2">def </span><span class="s1">_determine_main_color</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">unknown_type_seen</span><span class="s3">: </span><span class="s1">bool</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
        <span class="s1">stats </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span>
        <span class="s2">if </span><span class="s5">&quot;failed&quot; </span><span class="s2">in </span><span class="s1">stats </span><span class="s2">or </span><span class="s5">&quot;error&quot; </span><span class="s2">in </span><span class="s1">stats</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;red&quot;</span>
        <span class="s2">elif </span><span class="s5">&quot;warnings&quot; </span><span class="s2">in </span><span class="s1">stats </span><span class="s2">or </span><span class="s5">&quot;xpassed&quot; </span><span class="s2">in </span><span class="s1">stats </span><span class="s2">or </span><span class="s1">unknown_type_seen</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;yellow&quot;</span>
        <span class="s2">elif </span><span class="s5">&quot;passed&quot; </span><span class="s2">in </span><span class="s1">stats </span><span class="s2">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_is_last_item</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;green&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;yellow&quot;</span>
        <span class="s2">return </span><span class="s1">main_color</span>

    <span class="s2">def </span><span class="s1">_set_main_color</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">unknown_types</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = []</span>
        <span class="s2">for </span><span class="s1">found_type </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">found_type</span><span class="s3">:  </span><span class="s6"># setup/teardown reports have an empty key, ignore them</span>
                <span class="s2">if </span><span class="s1">found_type </span><span class="s2">not in </span><span class="s1">KNOWN_TYPES </span><span class="s2">and </span><span class="s1">found_type </span><span class="s2">not in </span><span class="s1">unknown_types</span><span class="s3">:</span>
                    <span class="s1">unknown_types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">found_type</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_known_types </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">KNOWN_TYPES</span><span class="s3">) + </span><span class="s1">unknown_types</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_main_color </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_determine_main_color</span><span class="s3">(</span><span class="s1">bool</span><span class="s3">(</span><span class="s1">unknown_types</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">build_summary_stats_line</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]]], </span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot; 
        Build the parts used in the last summary stats line. 
 
        The summary stats line is the line shown at the end, &quot;=== 12 passed, 2 errors in Xs===&quot;. 
 
        This function builds a list of the &quot;parts&quot; that make up for the text in that line, in 
        the example above it would be: 
 
            [ 
                (&quot;12 passed&quot;, {&quot;green&quot;: True}), 
                (&quot;2 errors&quot;, {&quot;red&quot;: True} 
            ] 
 
        That last dict for each line is a &quot;markup dictionary&quot;, used by TerminalWriter to 
        color output. 
 
        The final color of the line is also determined by this function, and is the second 
        element of the returned tuple. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">getoption</span><span class="s3">(</span><span class="s5">&quot;collectonly&quot;</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_collect_only_summary_stats_line</span><span class="s3">()</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_build_normal_summary_stats_line</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">_get_reports_to_display</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">]:</span>
        <span class="s0">&quot;&quot;&quot;Get test/collection reports for the given status key, such as `passed` or `error`.&quot;&quot;&quot;</span>
        <span class="s1">reports </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, [])</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">reports </span><span class="s2">if </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">&quot;count_towards_summary&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)]</span>

    <span class="s2">def </span><span class="s1">_build_normal_summary_stats_line</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]]], </span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s1">main_color</span><span class="s3">, </span><span class="s1">known_types </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_main_color</span><span class="s3">()</span>
        <span class="s1">parts </span><span class="s3">= []</span>

        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">known_types</span><span class="s3">:</span>
            <span class="s1">reports </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_reports_to_display</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">reports</span><span class="s3">:</span>
                <span class="s1">count </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">reports</span><span class="s3">)</span>
                <span class="s1">color </span><span class="s3">= </span><span class="s1">_color_for_type</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">_color_for_type_default</span><span class="s3">)</span>
                <span class="s1">markup </span><span class="s3">= {</span><span class="s1">color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s5">&quot;bold&quot;</span><span class="s3">: </span><span class="s1">color </span><span class="s3">== </span><span class="s1">main_color</span><span class="s3">}</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s5">&quot;%d %s&quot; </span><span class="s3">% </span><span class="s1">pluralize</span><span class="s3">(</span><span class="s1">count</span><span class="s3">, </span><span class="s1">key</span><span class="s3">), </span><span class="s1">markup</span><span class="s3">))</span>

        <span class="s2">if not </span><span class="s1">parts</span><span class="s3">:</span>
            <span class="s1">parts </span><span class="s3">= [(</span><span class="s5">&quot;no tests ran&quot;</span><span class="s3">, {</span><span class="s1">_color_for_type_default</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})]</span>

        <span class="s2">return </span><span class="s1">parts</span><span class="s3">, </span><span class="s1">main_color</span>

    <span class="s2">def </span><span class="s1">_build_collect_only_summary_stats_line</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]]], </span><span class="s1">str</span><span class="s3">]:</span>
        <span class="s1">deselected </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_reports_to_display</span><span class="s3">(</span><span class="s5">&quot;deselected&quot;</span><span class="s3">))</span>
        <span class="s1">errors </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_reports_to_display</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">parts </span><span class="s3">= [(</span><span class="s5">&quot;no tests collected&quot;</span><span class="s3">, {</span><span class="s5">&quot;yellow&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})]</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;yellow&quot;</span>

        <span class="s2">elif </span><span class="s1">deselected </span><span class="s3">== </span><span class="s4">0</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;green&quot;</span>
            <span class="s1">collected_output </span><span class="s3">= </span><span class="s5">&quot;%d %s collected&quot; </span><span class="s3">% </span><span class="s1">pluralize</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected</span><span class="s3">, </span><span class="s5">&quot;test&quot;</span><span class="s3">)</span>
            <span class="s1">parts </span><span class="s3">= [(</span><span class="s1">collected_output</span><span class="s3">, {</span><span class="s1">main_color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">all_tests_were_deselected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">== </span><span class="s1">deselected</span>
            <span class="s2">if </span><span class="s1">all_tests_were_deselected</span><span class="s3">:</span>
                <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;yellow&quot;</span>
                <span class="s1">collected_output </span><span class="s3">= </span><span class="s5">f&quot;no tests collected (</span><span class="s2">{</span><span class="s1">deselected</span><span class="s2">} </span><span class="s5">deselected)&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">main_color </span><span class="s3">= </span><span class="s5">&quot;green&quot;</span>
                <span class="s1">selected </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected </span><span class="s3">- </span><span class="s1">deselected</span>
                <span class="s1">collected_output </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">selected</span><span class="s2">}</span><span class="s5">/</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_numcollected</span><span class="s2">} </span><span class="s5">tests collected (</span><span class="s2">{</span><span class="s1">deselected</span><span class="s2">} </span><span class="s5">deselected)&quot;</span>

            <span class="s1">parts </span><span class="s3">= [(</span><span class="s1">collected_output</span><span class="s3">, {</span><span class="s1">main_color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})]</span>

        <span class="s2">if </span><span class="s1">errors</span><span class="s3">:</span>
            <span class="s1">main_color </span><span class="s3">= </span><span class="s1">_color_for_type</span><span class="s3">[</span><span class="s5">&quot;error&quot;</span><span class="s3">]</span>
            <span class="s1">parts </span><span class="s3">+= [(</span><span class="s5">&quot;%d %s&quot; </span><span class="s3">% </span><span class="s1">pluralize</span><span class="s3">(</span><span class="s1">errors</span><span class="s3">, </span><span class="s5">&quot;error&quot;</span><span class="s3">), {</span><span class="s1">main_color</span><span class="s3">: </span><span class="s2">True</span><span class="s3">})]</span>

        <span class="s2">return </span><span class="s1">parts</span><span class="s3">, </span><span class="s1">main_color</span>


<span class="s2">def </span><span class="s1">_get_node_id_with_markup</span><span class="s3">(</span><span class="s1">tw</span><span class="s3">: </span><span class="s1">TerminalWriter</span><span class="s3">, </span><span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">: </span><span class="s1">BaseReport</span><span class="s3">):</span>
    <span class="s1">nodeid </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">cwd_relative_nodeid</span><span class="s3">(</span><span class="s1">rep</span><span class="s3">.</span><span class="s1">nodeid</span><span class="s3">)</span>
    <span class="s1">path</span><span class="s3">, *</span><span class="s1">parts </span><span class="s3">= </span><span class="s1">nodeid</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">parts</span><span class="s3">:</span>
        <span class="s1">parts_markup </span><span class="s3">= </span><span class="s1">tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span><span class="s5">&quot;::&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">), </span><span class="s1">bold</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">path </span><span class="s3">+ </span><span class="s5">&quot;::&quot; </span><span class="s3">+ </span><span class="s1">parts_markup</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">path</span>


<span class="s2">def </span><span class="s1">_format_trimmed</span><span class="s3">(</span><span class="s1">format</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">available_width</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s0">&quot;&quot;&quot;Format msg into format, ellipsizing it if doesn't fit in available_width. 
 
    Returns None if even the ellipsis can't fit. 
    &quot;&quot;&quot;</span>
    <span class="s6"># Only use the first line.</span>
    <span class="s1">i </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">i </span><span class="s3">!= -</span><span class="s4">1</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">[:</span><span class="s1">i</span><span class="s3">]</span>

    <span class="s1">ellipsis </span><span class="s3">= </span><span class="s5">&quot;...&quot;</span>
    <span class="s1">format_width </span><span class="s3">= </span><span class="s1">wcswidth</span><span class="s3">(</span><span class="s1">format</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s5">&quot;&quot;</span><span class="s3">))</span>
    <span class="s2">if </span><span class="s1">format_width </span><span class="s3">+ </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ellipsis</span><span class="s3">) &gt; </span><span class="s1">available_width</span><span class="s3">:</span>
        <span class="s2">return None</span>

    <span class="s2">if </span><span class="s1">format_width </span><span class="s3">+ </span><span class="s1">wcswidth</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) &gt; </span><span class="s1">available_width</span><span class="s3">:</span>
        <span class="s1">available_width </span><span class="s3">-= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">ellipsis</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">[:</span><span class="s1">available_width</span><span class="s3">]</span>
        <span class="s2">while </span><span class="s1">format_width </span><span class="s3">+ </span><span class="s1">wcswidth</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) &gt; </span><span class="s1">available_width</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s1">msg</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">msg </span><span class="s3">+= </span><span class="s1">ellipsis</span>

    <span class="s2">return </span><span class="s1">format</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_get_line_with_reprcrash_message</span><span class="s3">(</span>
    <span class="s1">config</span><span class="s3">: </span><span class="s1">Config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">: </span><span class="s1">BaseReport</span><span class="s3">, </span><span class="s1">tw</span><span class="s3">: </span><span class="s1">TerminalWriter</span><span class="s3">, </span><span class="s1">word_markup</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]</span>
<span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Get summary line for a report, trying to add reprcrash message.&quot;&quot;&quot;</span>
    <span class="s1">verbose_word </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">_get_verbose_word</span><span class="s3">(</span><span class="s1">config</span><span class="s3">)</span>
    <span class="s1">word </span><span class="s3">= </span><span class="s1">tw</span><span class="s3">.</span><span class="s1">markup</span><span class="s3">(</span><span class="s1">verbose_word</span><span class="s3">, **</span><span class="s1">word_markup</span><span class="s3">)</span>
    <span class="s1">node </span><span class="s3">= </span><span class="s1">_get_node_id_with_markup</span><span class="s3">(</span><span class="s1">tw</span><span class="s3">, </span><span class="s1">config</span><span class="s3">, </span><span class="s1">rep</span><span class="s3">)</span>

    <span class="s1">line </span><span class="s3">= </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">word</span><span class="s2">} {</span><span class="s1">node</span><span class="s2">}</span><span class="s5">&quot;</span>
    <span class="s1">line_width </span><span class="s3">= </span><span class="s1">wcswidth</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s6"># Type ignored intentionally -- possible AttributeError expected.</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">rep</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">.</span><span class="s1">reprcrash</span><span class="s3">.</span><span class="s1">message  </span><span class="s6"># type: ignore[union-attr]</span>
    <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">running_on_ci</span><span class="s3">():</span>
            <span class="s1">available_width </span><span class="s3">= </span><span class="s1">tw</span><span class="s3">.</span><span class="s1">fullwidth </span><span class="s3">- </span><span class="s1">line_width</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s1">_format_trimmed</span><span class="s3">(</span><span class="s5">&quot; - {}&quot;</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, </span><span class="s1">available_width</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot; - </span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}</span><span class="s5">&quot;</span>
        <span class="s2">if </span><span class="s1">msg </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">line </span><span class="s3">+= </span><span class="s1">msg</span>

    <span class="s2">return </span><span class="s1">line</span>


<span class="s2">def </span><span class="s1">_folded_skips</span><span class="s3">(</span>
    <span class="s1">startpath</span><span class="s3">: </span><span class="s1">Path</span><span class="s3">,</span>
    <span class="s1">skipped</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">CollectReport</span><span class="s3">],</span>
<span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">str</span><span class="s3">]]:</span>
    <span class="s1">d</span><span class="s3">: </span><span class="s1">Dict</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">str</span><span class="s3">], </span><span class="s1">List</span><span class="s3">[</span><span class="s1">CollectReport</span><span class="s3">]] = {}</span>
    <span class="s2">for </span><span class="s1">event </span><span class="s2">in </span><span class="s1">skipped</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">), (</span><span class="s1">event</span><span class="s3">, </span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">) == </span><span class="s4">3</span><span class="s3">, (</span><span class="s1">event</span><span class="s3">, </span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">)</span>
        <span class="s1">fspath</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">, </span><span class="s1">reason </span><span class="s3">= </span><span class="s1">event</span><span class="s3">.</span><span class="s1">longrepr</span>
        <span class="s6"># For consistency, report all fspaths in relative form.</span>
        <span class="s1">fspath </span><span class="s3">= </span><span class="s1">bestrelpath</span><span class="s3">(</span><span class="s1">startpath</span><span class="s3">, </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">fspath</span><span class="s3">))</span>
        <span class="s1">keywords </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">event</span><span class="s3">, </span><span class="s5">&quot;keywords&quot;</span><span class="s3">, {})</span>
        <span class="s6"># Folding reports with global pytestmark variable.</span>
        <span class="s6"># This is a workaround, because for now we cannot identify the scope of a skip marker</span>
        <span class="s6"># TODO: Revisit after marks scope would be fixed.</span>
        <span class="s2">if </span><span class="s3">(</span>
            <span class="s1">event</span><span class="s3">.</span><span class="s1">when </span><span class="s3">== </span><span class="s5">&quot;setup&quot;</span>
            <span class="s2">and </span><span class="s5">&quot;skip&quot; </span><span class="s2">in </span><span class="s1">keywords</span>
            <span class="s2">and </span><span class="s5">&quot;pytestmark&quot; </span><span class="s2">not in </span><span class="s1">keywords</span>
        <span class="s3">):</span>
            <span class="s1">key</span><span class="s3">: </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">str</span><span class="s3">] = (</span><span class="s1">fspath</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">key </span><span class="s3">= (</span><span class="s1">fspath</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">)</span>
        <span class="s1">d</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, []).</span><span class="s1">append</span><span class="s3">(</span><span class="s1">event</span><span class="s3">)</span>
    <span class="s1">values</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">str</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">], </span><span class="s1">str</span><span class="s3">]] = []</span>
    <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">events </span><span class="s2">in </span><span class="s1">d</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">len</span><span class="s3">(</span><span class="s1">events</span><span class="s3">), *</span><span class="s1">key</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">values</span>


<span class="s1">_color_for_type </span><span class="s3">= {</span>
    <span class="s5">&quot;failed&quot;</span><span class="s3">: </span><span class="s5">&quot;red&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;error&quot;</span><span class="s3">: </span><span class="s5">&quot;red&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;warnings&quot;</span><span class="s3">: </span><span class="s5">&quot;yellow&quot;</span><span class="s3">,</span>
    <span class="s5">&quot;passed&quot;</span><span class="s3">: </span><span class="s5">&quot;green&quot;</span><span class="s3">,</span>
<span class="s3">}</span>
<span class="s1">_color_for_type_default </span><span class="s3">= </span><span class="s5">&quot;yellow&quot;</span>


<span class="s2">def </span><span class="s1">pluralize</span><span class="s3">(</span><span class="s1">count</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">noun</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s6"># No need to pluralize words such as `failed` or `passed`.</span>
    <span class="s2">if </span><span class="s1">noun </span><span class="s2">not in </span><span class="s3">[</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s5">&quot;warnings&quot;</span><span class="s3">, </span><span class="s5">&quot;test&quot;</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">count</span><span class="s3">, </span><span class="s1">noun</span>

    <span class="s6"># The `warnings` key is plural. To avoid API breakage, we keep it that way but</span>
    <span class="s6"># set it to singular here so we can determine plurality in the same way as we do</span>
    <span class="s6"># for `error`.</span>
    <span class="s1">noun </span><span class="s3">= </span><span class="s1">noun</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">&quot;warnings&quot;</span><span class="s3">, </span><span class="s5">&quot;warning&quot;</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">count</span><span class="s3">, </span><span class="s1">noun </span><span class="s3">+ </span><span class="s5">&quot;s&quot; </span><span class="s2">if </span><span class="s1">count </span><span class="s3">!= </span><span class="s4">1 </span><span class="s2">else </span><span class="s1">noun</span>


<span class="s2">def </span><span class="s1">_plugin_nameversions</span><span class="s3">(</span><span class="s1">plugininfo</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">]:</span>
    <span class="s1">values</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">str</span><span class="s3">] = []</span>
    <span class="s2">for </span><span class="s1">plugin</span><span class="s3">, </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">plugininfo</span><span class="s3">:</span>
        <span class="s6"># Gets us name and version!</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;{dist.project_name}-{dist.version}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">=</span><span class="s1">dist</span><span class="s3">)</span>
        <span class="s6"># Questionable convenience, but it keeps things short.</span>
        <span class="s2">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;pytest-&quot;</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[</span><span class="s4">7</span><span class="s3">:]</span>
        <span class="s6"># We decided to print python package names they can have more than one plugin.</span>
        <span class="s2">if </span><span class="s1">name </span><span class="s2">not in </span><span class="s1">values</span><span class="s3">:</span>
            <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">values</span>


<span class="s2">def </span><span class="s1">format_session_duration</span><span class="s3">(</span><span class="s1">seconds</span><span class="s3">: </span><span class="s1">float</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Format the given seconds in a human readable manner to show in the final summary.&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">seconds </span><span class="s3">&lt; </span><span class="s4">60</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">seconds</span><span class="s2">:</span><span class="s5">.2f</span><span class="s2">}</span><span class="s5">s&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">dt </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">seconds</span><span class="s3">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">seconds</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">seconds</span><span class="s2">:</span><span class="s5">.2f</span><span class="s2">}</span><span class="s5">s (</span><span class="s2">{</span><span class="s1">dt</span><span class="s2">}</span><span class="s5">)&quot;</span>


<span class="s2">def </span><span class="s1">_get_raw_skip_reason</span><span class="s3">(</span><span class="s1">report</span><span class="s3">: </span><span class="s1">TestReport</span><span class="s3">) </span><span class="s1">-&gt; str</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Get the reason string of a skip/xfail/xpass test report. 
 
    The string is just the part given by the user. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">report</span><span class="s3">, </span><span class="s5">&quot;wasxfail&quot;</span><span class="s3">):</span>
        <span class="s1">reason </span><span class="s3">= </span><span class="s1">cast</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">report</span><span class="s3">.</span><span class="s1">wasxfail</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">reason</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;reason: &quot;</span><span class="s3">):</span>
            <span class="s1">reason </span><span class="s3">= </span><span class="s1">reason</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s5">&quot;reason: &quot;</span><span class="s3">) :]</span>
        <span class="s2">return </span><span class="s1">reason</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">report</span><span class="s3">.</span><span class="s1">skipped</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">report</span><span class="s3">.</span><span class="s1">longrepr</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">reason </span><span class="s3">= </span><span class="s1">report</span><span class="s3">.</span><span class="s1">longrepr</span>
        <span class="s2">if </span><span class="s1">reason</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;Skipped: &quot;</span><span class="s3">):</span>
            <span class="s1">reason </span><span class="s3">= </span><span class="s1">reason</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s5">&quot;Skipped: &quot;</span><span class="s3">) :]</span>
        <span class="s2">elif </span><span class="s1">reason </span><span class="s3">== </span><span class="s5">&quot;Skipped&quot;</span><span class="s3">:</span>
            <span class="s1">reason </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">reason</span>
</pre>
</body>
</html>