<html>
<head>
<title>package_index.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
package_index.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;PyPI and direct package downloading.&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">io</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">socket</span>
<span class="s2">import </span><span class="s1">base64</span>
<span class="s2">import </span><span class="s1">hashlib</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">configparser</span>
<span class="s2">import </span><span class="s1">html</span>
<span class="s2">import </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client</span>
<span class="s2">import </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span>
<span class="s2">import </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span>
<span class="s2">import </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">wraps</span>

<span class="s2">import </span><span class="s1">setuptools</span>
<span class="s2">from </span><span class="s1">pkg_resources </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">CHECKOUT_DIST</span><span class="s3">,</span>
    <span class="s1">Distribution</span><span class="s3">,</span>
    <span class="s1">BINARY_DIST</span><span class="s3">,</span>
    <span class="s1">normalize_path</span><span class="s3">,</span>
    <span class="s1">SOURCE_DIST</span><span class="s3">,</span>
    <span class="s1">Environment</span><span class="s3">,</span>
    <span class="s1">find_distributions</span><span class="s3">,</span>
    <span class="s1">safe_name</span><span class="s3">,</span>
    <span class="s1">safe_version</span><span class="s3">,</span>
    <span class="s1">to_filename</span><span class="s3">,</span>
    <span class="s1">Requirement</span><span class="s3">,</span>
    <span class="s1">DEVELOP_DIST</span><span class="s3">,</span>
    <span class="s1">EGG_DIST</span><span class="s3">,</span>
    <span class="s1">parse_version</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">distutils </span><span class="s2">import </span><span class="s1">log</span>
<span class="s2">from </span><span class="s1">distutils</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">DistutilsError</span>
<span class="s2">from </span><span class="s1">fnmatch </span><span class="s2">import </span><span class="s1">translate</span>
<span class="s2">from </span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">wheel </span><span class="s2">import </span><span class="s1">Wheel</span>
<span class="s2">from </span><span class="s1">setuptools</span><span class="s3">.</span><span class="s1">extern</span><span class="s3">.</span><span class="s1">more_itertools </span><span class="s2">import </span><span class="s1">unique_everseen</span>


<span class="s1">EGG_FRAGMENT </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'^egg=([-A-Za-z0-9_.+!]+)$'</span><span class="s3">)</span>
<span class="s1">HREF </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r&quot;&quot;&quot;href\s*=\s*['&quot;]?([^'&quot;&gt; ]+)&quot;&quot;&quot;</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">)</span>
<span class="s1">PYPI_MD5 </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span>
    <span class="s4">r'&lt;a href=&quot;([^&quot;#]+)&quot;&gt;([^&lt;]+)&lt;/a&gt;\n\s+\(&lt;a (?:title=&quot;MD5 hash&quot;\n\s+)'</span>
    <span class="s4">r'href=&quot;[^?]+\?:action=show_md5&amp;amp;digest=([0-9a-f]{32})&quot;&gt;md5&lt;/a&gt;\)'</span>
<span class="s3">)</span>
<span class="s1">URL_SCHEME </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">'([-+.a-z0-9]{2,}):'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">).</span><span class="s1">match</span>
<span class="s1">EXTENSIONS </span><span class="s3">= </span><span class="s4">&quot;.tar.gz .tar.bz2 .tar .zip .tgz&quot;</span><span class="s3">.</span><span class="s1">split</span><span class="s3">()</span>

<span class="s1">__all__ </span><span class="s3">= [</span>
    <span class="s4">'PackageIndex'</span><span class="s3">,</span>
    <span class="s4">'distros_for_url'</span><span class="s3">,</span>
    <span class="s4">'parse_bdist_wininst'</span><span class="s3">,</span>
    <span class="s4">'interpret_distro_name'</span><span class="s3">,</span>
<span class="s3">]</span>

<span class="s1">_SOCKET_TIMEOUT </span><span class="s3">= </span><span class="s5">15</span>

<span class="s1">_tmpl </span><span class="s3">= </span><span class="s4">&quot;setuptools/{setuptools.__version__} Python-urllib/{py_major}&quot;</span>
<span class="s1">user_agent </span><span class="s3">= </span><span class="s1">_tmpl</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
    <span class="s1">py_major</span><span class="s3">=</span><span class="s4">'{}.{}'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(*</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">version_info</span><span class="s3">), </span><span class="s1">setuptools</span><span class="s3">=</span><span class="s1">setuptools</span>
<span class="s3">)</span>


<span class="s2">def </span><span class="s1">parse_requirement_arg</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">Requirement</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
            <span class="s4">&quot;Not a URL, existing file, or requirement spec: %r&quot; </span><span class="s3">% (</span><span class="s1">spec</span><span class="s3">,)</span>
        <span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>


<span class="s2">def </span><span class="s1">parse_bdist_wininst</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Return (base,pyversion) or (None,None) for possible .exe name&quot;&quot;&quot;</span>

    <span class="s1">lower </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span>
    <span class="s1">base</span><span class="s3">, </span><span class="s1">py_ver</span><span class="s3">, </span><span class="s1">plat </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>

    <span class="s2">if </span><span class="s1">lower</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.exe'</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">lower</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.win32.exe'</span><span class="s3">):</span>
            <span class="s1">base </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[:-</span><span class="s5">10</span><span class="s3">]</span>
            <span class="s1">plat </span><span class="s3">= </span><span class="s4">'win32'</span>
        <span class="s2">elif </span><span class="s1">lower</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'.win32-py'</span><span class="s3">, -</span><span class="s5">16</span><span class="s3">):</span>
            <span class="s1">py_ver </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[-</span><span class="s5">7</span><span class="s3">:-</span><span class="s5">4</span><span class="s3">]</span>
            <span class="s1">base </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[:-</span><span class="s5">16</span><span class="s3">]</span>
            <span class="s1">plat </span><span class="s3">= </span><span class="s4">'win32'</span>
        <span class="s2">elif </span><span class="s1">lower</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.win-amd64.exe'</span><span class="s3">):</span>
            <span class="s1">base </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[:-</span><span class="s5">14</span><span class="s3">]</span>
            <span class="s1">plat </span><span class="s3">= </span><span class="s4">'win-amd64'</span>
        <span class="s2">elif </span><span class="s1">lower</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'.win-amd64-py'</span><span class="s3">, -</span><span class="s5">20</span><span class="s3">):</span>
            <span class="s1">py_ver </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[-</span><span class="s5">7</span><span class="s3">:-</span><span class="s5">4</span><span class="s3">]</span>
            <span class="s1">base </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[:-</span><span class="s5">20</span><span class="s3">]</span>
            <span class="s1">plat </span><span class="s3">= </span><span class="s4">'win-amd64'</span>
    <span class="s2">return </span><span class="s1">base</span><span class="s3">, </span><span class="s1">py_ver</span><span class="s3">, </span><span class="s1">plat</span>


<span class="s2">def </span><span class="s1">egg_info_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
    <span class="s1">parts </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
    <span class="s1">scheme</span><span class="s3">, </span><span class="s1">server</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">parameters</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">parts</span>
    <span class="s1">base </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">unquote</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)[-</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s1">server </span><span class="s3">== </span><span class="s4">'sourceforge.net' </span><span class="s2">and </span><span class="s1">base </span><span class="s3">== </span><span class="s4">'download'</span><span class="s3">:  </span><span class="s6"># XXX Yuck</span>
        <span class="s1">base </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">unquote</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)[-</span><span class="s5">2</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s4">'#' </span><span class="s2">in </span><span class="s1">base</span><span class="s3">:</span>
        <span class="s1">base</span><span class="s3">, </span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">base</span><span class="s3">, </span><span class="s1">fragment</span>


<span class="s2">def </span><span class="s1">distros_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Yield egg or source distribution objects that might be found at a URL&quot;&quot;&quot;</span>
    <span class="s1">base</span><span class="s3">, </span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">egg_info_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">distros_for_location</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">base</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">):</span>
        <span class="s2">yield </span><span class="s1">dist</span>
    <span class="s2">if </span><span class="s1">fragment</span><span class="s3">:</span>
        <span class="s1">match </span><span class="s3">= </span><span class="s1">EGG_FRAGMENT</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">fragment</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">match</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">interpret_distro_name</span><span class="s3">(</span>
                <span class="s1">url</span><span class="s3">, </span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">precedence</span><span class="s3">=</span><span class="s1">CHECKOUT_DIST</span>
            <span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">dist</span>


<span class="s2">def </span><span class="s1">distros_for_location</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Yield egg or source distribution objects based on basename&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.egg.zip'</span><span class="s3">):</span>
        <span class="s1">basename </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">[:-</span><span class="s5">4</span><span class="s3">]  </span><span class="s6"># strip the .zip</span>
    <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.egg'</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'-' </span><span class="s2">in </span><span class="s1">basename</span><span class="s3">:</span>
        <span class="s6"># only one, unambiguous interpretation</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">Distribution</span><span class="s3">.</span><span class="s1">from_location</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">)]</span>
    <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.whl'</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'-' </span><span class="s2">in </span><span class="s1">basename</span><span class="s3">:</span>
        <span class="s1">wheel </span><span class="s3">= </span><span class="s1">Wheel</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">wheel</span><span class="s3">.</span><span class="s1">is_compatible</span><span class="s3">():</span>
            <span class="s2">return </span><span class="s3">[]</span>
        <span class="s2">return </span><span class="s3">[</span>
            <span class="s1">Distribution</span><span class="s3">(</span>
                <span class="s1">location</span><span class="s3">=</span><span class="s1">location</span><span class="s3">,</span>
                <span class="s1">project_name</span><span class="s3">=</span><span class="s1">wheel</span><span class="s3">.</span><span class="s1">project_name</span><span class="s3">,</span>
                <span class="s1">version</span><span class="s3">=</span><span class="s1">wheel</span><span class="s3">.</span><span class="s1">version</span><span class="s3">,</span>
                <span class="s6"># Increase priority over eggs.</span>
                <span class="s1">precedence</span><span class="s3">=</span><span class="s1">EGG_DIST </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.exe'</span><span class="s3">):</span>
        <span class="s1">win_base</span><span class="s3">, </span><span class="s1">py_ver</span><span class="s3">, </span><span class="s1">platform </span><span class="s3">= </span><span class="s1">parse_bdist_wininst</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">win_base </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">interpret_distro_name</span><span class="s3">(</span>
                <span class="s1">location</span><span class="s3">, </span><span class="s1">win_base</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">py_ver</span><span class="s3">, </span><span class="s1">BINARY_DIST</span><span class="s3">, </span><span class="s1">platform</span>
            <span class="s3">)</span>
    <span class="s6"># Try source distro extensions (.zip, .tgz, etc.)</span>
    <span class="s6">#</span>
    <span class="s2">for </span><span class="s1">ext </span><span class="s2">in </span><span class="s1">EXTENSIONS</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">):</span>
            <span class="s1">basename </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">[: -</span><span class="s1">len</span><span class="s3">(</span><span class="s1">ext</span><span class="s3">)]</span>
            <span class="s2">return </span><span class="s1">interpret_distro_name</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s3">[]  </span><span class="s6"># no extension matched</span>


<span class="s2">def </span><span class="s1">distros_for_filename</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Yield possible egg or source distribution objects based on a filename&quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">distros_for_location</span><span class="s3">(</span>
        <span class="s1">normalize_path</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">), </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">), </span><span class="s1">metadata</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">interpret_distro_name</span><span class="s3">(</span>
    <span class="s1">location</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">, </span><span class="s1">py_version</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">precedence</span><span class="s3">=</span><span class="s1">SOURCE_DIST</span><span class="s3">, </span><span class="s1">platform</span><span class="s3">=</span><span class="s2">None</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Generate alternative interpretations of a source distro name 
 
    Note: if `location` is a filesystem filename, you should call 
    ``pkg_resources.normalize_path()`` on it before passing it to this 
    routine! 
    &quot;&quot;&quot;</span>
    <span class="s6"># Generate alternative interpretations of a source distro name</span>
    <span class="s6"># Because some packages are ambiguous as to name/versions split</span>
    <span class="s6"># e.g. &quot;adns-python-1.1.0&quot;, &quot;egenix-mx-commercial&quot;, etc.</span>
    <span class="s6"># So, we generate each possible interpretation (e.g. &quot;adns, python-1.1.0&quot;</span>
    <span class="s6"># &quot;adns-python, 1.1.0&quot;, and &quot;adns-python-1.1.0, no version&quot;).  In practice,</span>
    <span class="s6"># the spurious interpretations should be ignored, because in the event</span>
    <span class="s6"># there's also an &quot;adns&quot; package, the spurious &quot;python-1.1.0&quot; version will</span>
    <span class="s6"># compare lower than any numeric version number, and is therefore unlikely</span>
    <span class="s6"># to match a request for it.  It's still a potential problem, though, and</span>
    <span class="s6"># in the long run PyPI and the distutils should go for &quot;safe&quot; names and</span>
    <span class="s6"># versions in distribution archive names (sdist and bdist).</span>

    <span class="s1">parts </span><span class="s3">= </span><span class="s1">basename</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">)</span>
    <span class="s2">if not </span><span class="s1">py_version </span><span class="s2">and </span><span class="s1">any</span><span class="s3">(</span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s4">r'py\d\.\d$'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">) </span><span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">2</span><span class="s3">:]):</span>
        <span class="s6"># it is a bdist_dumb, not an sdist -- bail out</span>
        <span class="s2">return</span>

    <span class="s2">for </span><span class="s1">p </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">):</span>
        <span class="s2">yield </span><span class="s1">Distribution</span><span class="s3">(</span>
            <span class="s1">location</span><span class="s3">,</span>
            <span class="s1">metadata</span><span class="s3">,</span>
            <span class="s4">'-'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[:</span><span class="s1">p</span><span class="s3">]),</span>
            <span class="s4">'-'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s1">p</span><span class="s3">:]),</span>
            <span class="s1">py_version</span><span class="s3">=</span><span class="s1">py_version</span><span class="s3">,</span>
            <span class="s1">precedence</span><span class="s3">=</span><span class="s1">precedence</span><span class="s3">,</span>
            <span class="s1">platform</span><span class="s3">=</span><span class="s1">platform</span><span class="s3">,</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">unique_values</span><span class="s3">(</span><span class="s1">func</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Wrap a function returning an iterable such that the resulting iterable 
    only ever yields unique items. 
    &quot;&quot;&quot;</span>

    <span class="s3">@</span><span class="s1">wraps</span><span class="s3">(</span><span class="s1">func</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">wrapper</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">unique_everseen</span><span class="s3">(</span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">))</span>

    <span class="s2">return </span><span class="s1">wrapper</span>


<span class="s1">REL </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r&quot;&quot;&quot;&lt;([^&gt;]*\srel\s{0,10}=\s{0,10}['&quot;]?([^'&quot; &gt;]+)[^&gt;]*)&gt;&quot;&quot;&quot;</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">I</span><span class="s3">)</span>
<span class="s4">&quot;&quot;&quot; 
Regex for an HTML tag with 'rel=&quot;val&quot;' attributes. 
&quot;&quot;&quot;</span>


<span class="s3">@</span><span class="s1">unique_values</span>
<span class="s2">def </span><span class="s1">find_external_links</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">page</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Find rel=&quot;homepage&quot; and rel=&quot;download&quot; links in `page`, yielding URLs&quot;&quot;&quot;</span>

    <span class="s2">for </span><span class="s1">match </span><span class="s2">in </span><span class="s1">REL</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">page</span><span class="s3">):</span>
        <span class="s1">tag</span><span class="s3">, </span><span class="s1">rel </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">()</span>
        <span class="s1">rels </span><span class="s3">= </span><span class="s1">set</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">, </span><span class="s1">rel</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s4">','</span><span class="s3">)))</span>
        <span class="s2">if </span><span class="s4">'homepage' </span><span class="s2">in </span><span class="s1">rels </span><span class="s2">or </span><span class="s4">'download' </span><span class="s2">in </span><span class="s1">rels</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">match </span><span class="s2">in </span><span class="s1">HREF</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">tag</span><span class="s3">):</span>
                <span class="s2">yield </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urljoin</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">htmldecode</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)))</span>

    <span class="s2">for </span><span class="s1">tag </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;&lt;th&gt;Home Page&quot;</span><span class="s3">, </span><span class="s4">&quot;&lt;th&gt;Download URL&quot;</span><span class="s3">):</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">page</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">tag</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">pos </span><span class="s3">!= -</span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s1">HREF</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">page</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">match</span><span class="s3">:</span>
                <span class="s2">yield </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urljoin</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">htmldecode</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)))</span>


<span class="s2">class </span><span class="s1">ContentChecker</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    A null content checker that defines the interface for checking content 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">feed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">block</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Feed a block of data to the hash. 
        &quot;&quot;&quot;</span>
        <span class="s2">return</span>

    <span class="s2">def </span><span class="s1">is_valid</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Check the hash. Return False if validation fails. 
        &quot;&quot;&quot;</span>
        <span class="s2">return True</span>

    <span class="s2">def </span><span class="s1">report</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reporter</span><span class="s3">, </span><span class="s1">template</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Call reporter with information about the checker (hash name) 
        substituted into the template. 
        &quot;&quot;&quot;</span>
        <span class="s2">return</span>


<span class="s2">class </span><span class="s1">HashChecker</span><span class="s3">(</span><span class="s1">ContentChecker</span><span class="s3">):</span>
    <span class="s1">pattern </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span>
        <span class="s4">r'(?P&lt;hash_name&gt;sha1|sha224|sha384|sha256|sha512|md5)='</span>
        <span class="s4">r'(?P&lt;expected&gt;[a-f0-9]+)'</span>
    <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">hash_name</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hash_name </span><span class="s3">= </span><span class="s1">hash_name</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hash </span><span class="s3">= </span><span class="s1">hashlib</span><span class="s3">.</span><span class="s1">new</span><span class="s3">(</span><span class="s1">hash_name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">expected </span><span class="s3">= </span><span class="s1">expected</span>

    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">from_url</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">url</span><span class="s3">):</span>
        <span class="s0">&quot;Construct a (possibly null) ContentChecker from a URL&quot;</span>
        <span class="s1">fragment </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)[-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">if not </span><span class="s1">fragment</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">ContentChecker</span><span class="s3">()</span>
        <span class="s1">match </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">pattern</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">fragment</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">match</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">ContentChecker</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">cls</span><span class="s3">(**</span><span class="s1">match</span><span class="s3">.</span><span class="s1">groupdict</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">feed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">block</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">hash</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">block</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">is_valid</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hash</span><span class="s3">.</span><span class="s1">hexdigest</span><span class="s3">() == </span><span class="s1">self</span><span class="s3">.</span><span class="s1">expected</span>

    <span class="s2">def </span><span class="s1">report</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">reporter</span><span class="s3">, </span><span class="s1">template</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s1">template </span><span class="s3">% </span><span class="s1">self</span><span class="s3">.</span><span class="s1">hash_name</span>
        <span class="s2">return </span><span class="s1">reporter</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PackageIndex</span><span class="s3">(</span><span class="s1">Environment</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;A distribution index that scans web pages for download URLs&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">index_url</span><span class="s3">=</span><span class="s4">&quot;https://pypi.org/simple/&quot;</span><span class="s3">,</span>
        <span class="s1">hosts</span><span class="s3">=(</span><span class="s4">'*'</span><span class="s3">,),</span>
        <span class="s1">ca_bundle</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s1">verify_ssl</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">*</span><span class="s1">args</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">kw</span>
    <span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">index_url </span><span class="s3">= </span><span class="s1">index_url </span><span class="s3">+ </span><span class="s4">&quot;/&quot;</span><span class="s3">[: </span><span class="s2">not </span><span class="s1">index_url</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scanned_urls </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">package_pages </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">allows </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">'|'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">translate</span><span class="s3">, </span><span class="s1">hosts</span><span class="s3">))).</span><span class="s1">match</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan </span><span class="s3">= []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">opener </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">urlopen</span>

    <span class="s2">def </span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">):</span>
        <span class="s6"># ignore invalid versions</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">parse_version</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">version</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">add</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">)</span>

    <span class="s6"># FIXME: 'PackageIndex.process_url' is too complex (14)</span>
    <span class="s2">def </span><span class="s1">process_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">retrieve</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):  </span><span class="s6"># noqa: C901</span>
        <span class="s0">&quot;&quot;&quot;Evaluate a URL as a possible download, and maybe retrieve it&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">url </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">scanned_urls </span><span class="s2">and not </span><span class="s1">retrieve</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scanned_urls</span><span class="s3">[</span><span class="s1">url</span><span class="s3">] = </span><span class="s2">True</span>
        <span class="s2">if not </span><span class="s1">URL_SCHEME</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">process_filename</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">dists </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">distros_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">dists</span><span class="s3">:</span>
                <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">url_ok</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
                    <span class="s2">return</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;Found link: %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">dists </span><span class="s2">or not </span><span class="s1">retrieve </span><span class="s2">or </span><span class="s1">url </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls</span><span class="s3">:</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">, </span><span class="s1">dists</span><span class="s3">))</span>
            <span class="s2">return  </span><span class="s6"># don't need the actual page</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">url_ok</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls</span><span class="s3">[</span><span class="s1">url</span><span class="s3">] = </span><span class="s2">True</span>
            <span class="s2">return</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Reading %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls</span><span class="s3">[</span><span class="s1">url</span><span class="s3">] = </span><span class="s2">True  </span><span class="s6"># prevent multiple fetch attempts</span>
        <span class="s1">tmpl </span><span class="s3">= </span><span class="s4">&quot;Download error on %s: %%s -- Some packages may not be found!&quot;</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">tmpl </span><span class="s3">% </span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">f </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">HTTPError</span><span class="s3">) </span><span class="s2">and </span><span class="s1">f</span><span class="s3">.</span><span class="s1">code </span><span class="s3">== </span><span class="s5">401</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Authentication error: %s&quot; </span><span class="s3">% </span><span class="s1">f</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls</span><span class="s3">[</span><span class="s1">f</span><span class="s3">.</span><span class="s1">url</span><span class="s3">] = </span><span class="s2">True</span>
        <span class="s2">if </span><span class="s4">'html' </span><span class="s2">not in </span><span class="s1">f</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'content-type'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">():</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()  </span><span class="s6"># not html, we can't process it</span>
            <span class="s2">return</span>

        <span class="s1">base </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">url  </span><span class="s6"># handle redirects</span>
        <span class="s1">page </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">page</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s6"># In Python 3 and got bytes but want str.</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">HTTPError</span><span class="s3">):</span>
                <span class="s6"># Errors have no charset, assume latin1:</span>
                <span class="s1">charset </span><span class="s3">= </span><span class="s4">'latin-1'</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">charset </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get_param</span><span class="s3">(</span><span class="s4">'charset'</span><span class="s3">) </span><span class="s2">or </span><span class="s4">'latin-1'</span>
            <span class="s1">page </span><span class="s3">= </span><span class="s1">page</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">, </span><span class="s4">&quot;ignore&quot;</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">match </span><span class="s2">in </span><span class="s1">HREF</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">page</span><span class="s3">):</span>
            <span class="s1">link </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urljoin</span><span class="s3">(</span><span class="s1">base</span><span class="s3">, </span><span class="s1">htmldecode</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)))</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">process_url</span><span class="s3">(</span><span class="s1">link</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url</span><span class="s3">) </span><span class="s2">and </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">'code'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) != </span><span class="s5">404</span><span class="s3">:</span>
            <span class="s1">page </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">process_index</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">page</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">process_filename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">, </span><span class="s1">nested</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s6"># process filenames or directories</span>
        <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;Not found: %s&quot;</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">nested</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">realpath</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">item </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">process_filename</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">item</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">dists </span><span class="s3">= </span><span class="s1">distros_for_filename</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dists</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;Found: %s&quot;</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">)</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">, </span><span class="s1">dists</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">url_ok</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">fatal</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">URL_SCHEME</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s1">is_file </span><span class="s3">= </span><span class="s1">s </span><span class="s2">and </span><span class="s1">s</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">() == </span><span class="s4">'file'</span>
        <span class="s2">if </span><span class="s1">is_file </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">allows</span><span class="s3">(</span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">]):</span>
            <span class="s2">return True</span>
        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s4">&quot;</span><span class="s2">\n</span><span class="s4">Note: Bypassing %s (disallowed host; see &quot;</span>
            <span class="s4">&quot;http://bit.ly/2hrImnY for details).</span><span class="s2">\n</span><span class="s4">&quot;</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">fatal</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span><span class="s1">msg </span><span class="s3">% </span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">url</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">scan_egg_links</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">):</span>
        <span class="s1">dirs </span><span class="s3">= </span><span class="s1">filter</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">, </span><span class="s1">search_path</span><span class="s3">)</span>
        <span class="s1">egg_links </span><span class="s3">= (</span>
            <span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s1">dirs</span>
            <span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.egg-link'</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">list</span><span class="s3">(</span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">starmap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">scan_egg_link</span><span class="s3">, </span><span class="s1">egg_links</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">scan_egg_link</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">)) </span><span class="s2">as </span><span class="s1">raw_lines</span><span class="s3">:</span>
            <span class="s6"># filter non-empty lines</span>
            <span class="s1">lines </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">filter</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">, </span><span class="s1">raw_lines</span><span class="s3">)))</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">) != </span><span class="s5">2</span><span class="s3">:</span>
            <span class="s6"># format is not recognized; punt</span>
            <span class="s2">return</span>

        <span class="s1">egg_path</span><span class="s3">, </span><span class="s1">setup_path </span><span class="s3">= </span><span class="s1">lines</span>

        <span class="s2">for </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">find_distributions</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">egg_path</span><span class="s3">)):</span>
            <span class="s1">dist</span><span class="s3">.</span><span class="s1">location </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, *</span><span class="s1">lines</span><span class="s3">)</span>
            <span class="s1">dist</span><span class="s3">.</span><span class="s1">precedence </span><span class="s3">= </span><span class="s1">SOURCE_DIST</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_scan</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">link</span><span class="s3">):</span>
        <span class="s6"># Process a URL to see if it's for a package page</span>
        <span class="s1">NO_MATCH_SENTINEL </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span>
        <span class="s2">if not </span><span class="s1">link</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">NO_MATCH_SENTINEL</span>

        <span class="s1">parts </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">unquote</span><span class="s3">, </span><span class="s1">link</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url</span><span class="s3">) :].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">)))</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">) != </span><span class="s5">2 </span><span class="s2">or </span><span class="s4">'#' </span><span class="s2">in </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]:</span>
            <span class="s2">return </span><span class="s1">NO_MATCH_SENTINEL</span>

        <span class="s6"># it's a package page, sanitize and index it</span>
        <span class="s1">pkg </span><span class="s3">= </span><span class="s1">safe_name</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">ver </span><span class="s3">= </span><span class="s1">safe_version</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">package_pages</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s1">pkg</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">(), {})[</span><span class="s1">link</span><span class="s3">] = </span><span class="s2">True</span>
        <span class="s2">return </span><span class="s1">to_filename</span><span class="s3">(</span><span class="s1">pkg</span><span class="s3">), </span><span class="s1">to_filename</span><span class="s3">(</span><span class="s1">ver</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">process_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">page</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Process the contents of a PyPI page&quot;&quot;&quot;</span>

        <span class="s6"># process an index page into the package-page index</span>
        <span class="s2">for </span><span class="s1">match </span><span class="s2">in </span><span class="s1">HREF</span><span class="s3">.</span><span class="s1">finditer</span><span class="s3">(</span><span class="s1">page</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_scan</span><span class="s3">(</span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urljoin</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">htmldecode</span><span class="s3">(</span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">))))</span>
            <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                <span class="s2">pass</span>

        <span class="s1">pkg</span><span class="s3">, </span><span class="s1">ver </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_scan</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)  </span><span class="s6"># ensure this page is in the page index</span>
        <span class="s2">if not </span><span class="s1">pkg</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s4">&quot;&quot;  </span><span class="s6"># no sense double-scanning non-package pages</span>

        <span class="s6"># process individual package page</span>
        <span class="s2">for </span><span class="s1">new_url </span><span class="s2">in </span><span class="s1">find_external_links</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">page</span><span class="s3">):</span>
            <span class="s6"># Process the found URL</span>
            <span class="s1">base</span><span class="s3">, </span><span class="s1">frag </span><span class="s3">= </span><span class="s1">egg_info_for_url</span><span class="s3">(</span><span class="s1">new_url</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">base</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.py'</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">frag</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">ver</span><span class="s3">:</span>
                    <span class="s1">new_url </span><span class="s3">+= </span><span class="s4">'#egg=%s-%s' </span><span class="s3">% (</span><span class="s1">pkg</span><span class="s3">, </span><span class="s1">ver</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">need_version_info</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">new_url</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">PYPI_MD5</span><span class="s3">.</span><span class="s1">sub</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">m</span><span class="s3">: </span><span class="s4">'&lt;a href=&quot;%s#md5=%s&quot;&gt;%s&lt;/a&gt;' </span><span class="s3">% </span><span class="s1">m</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">page</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">need_version_info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_all</span><span class="s3">(</span>
            <span class="s4">&quot;Page at %s links to .py file(s) without version info; an index &quot;</span>
            <span class="s4">&quot;scan is required.&quot;</span><span class="s3">,</span>
            <span class="s1">url</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">scan_all</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fetched_urls</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">msg</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Scanning index of all packages (this may take a while)&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url </span><span class="s3">+ </span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">unsafe_name </span><span class="s3">+ </span><span class="s4">'/'</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">package_pages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">key</span><span class="s3">):</span>
            <span class="s6"># Fall back to safe version of the name</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index_url </span><span class="s3">+ </span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">project_name </span><span class="s3">+ </span><span class="s4">'/'</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">package_pages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">key</span><span class="s3">):</span>
            <span class="s6"># We couldn't find the target package, so search the index page too</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">not_found_in_index</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">url </span><span class="s2">in </span><span class="s1">list</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">package_pages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">key</span><span class="s3">, ())):</span>
            <span class="s6"># scan each page that might be related to the desired package</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">obtain</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">installer</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">prescan</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">self</span><span class="s3">[</span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">key</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">requirement</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">dist</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;%s does not match %s&quot;</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">super</span><span class="s3">(</span><span class="s1">PackageIndex</span><span class="s3">, </span><span class="s1">self</span><span class="s3">).</span><span class="s1">obtain</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">installer</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_hash</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">checker</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">tfp</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        checker is a ContentChecker 
        &quot;&quot;&quot;</span>
        <span class="s1">checker</span><span class="s3">.</span><span class="s1">report</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">, </span><span class="s4">&quot;Validating %%s checksum for %s&quot; </span><span class="s3">% </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">checker</span><span class="s3">.</span><span class="s1">is_valid</span><span class="s3">():</span>
            <span class="s1">tfp</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                <span class="s4">&quot;%s validation failed for %s; &quot;</span>
                <span class="s4">&quot;possible download problem?&quot;</span>
                <span class="s3">% (</span><span class="s1">checker</span><span class="s3">.</span><span class="s1">hash</span><span class="s3">.</span><span class="s1">name</span><span class="s3">, </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">))</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">add_find_links</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">urls</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Add `urls` to the list that will be prescanned for searches&quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">url </span><span class="s2">in </span><span class="s1">urls</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan </span><span class="s2">is None  </span><span class="s6"># if we have already &quot;gone online&quot;</span>
                <span class="s2">or not </span><span class="s1">URL_SCHEME</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)  </span><span class="s6"># or it's a local file/directory</span>
                <span class="s2">or </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'file:'</span><span class="s3">)</span>
                <span class="s2">or </span><span class="s1">list</span><span class="s3">(</span><span class="s1">distros_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">))  </span><span class="s6"># or a direct package link</span>
            <span class="s3">):</span>
                <span class="s6"># then go ahead and process it now</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># otherwise, defer retrieval till later</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">prescan</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Scan urls scheduled for prescanning (e.g. --find-links)&quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan</span><span class="s3">:</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">scan_url</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan </span><span class="s3">= </span><span class="s2">None  </span><span class="s6"># from now on, go ahead and process immediately</span>

    <span class="s2">def </span><span class="s1">not_found_in_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">[</span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">key</span><span class="s3">]:  </span><span class="s6"># we've seen at least one distro</span>
            <span class="s1">meth</span><span class="s3">, </span><span class="s1">msg </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">, </span><span class="s4">&quot;Couldn't retrieve index page for %r&quot;</span>
        <span class="s2">else</span><span class="s3">:  </span><span class="s6"># no distros seen for this name, might be misspelled</span>
            <span class="s1">meth</span><span class="s3">, </span><span class="s1">msg </span><span class="s3">= (</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">,</span>
                <span class="s4">&quot;Couldn't find index page for %r (maybe misspelled?)&quot;</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s1">meth</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">.</span><span class="s1">unsafe_name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">scan_all</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">download</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">spec</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Locate and/or download `spec` to `tmpdir`, returning a local path 
 
        `spec` may be a ``Requirement`` object, or a string containing a URL, 
        an existing local filename, or a project/version requirement spec 
        (i.e. the string form of a ``Requirement`` object).  If it is the URL 
        of a .py file with an unambiguous ``#egg=name-version`` tag (i.e., one 
        that escapes ``-`` as ``_`` throughout), a trivial ``setup.py`` is 
        automatically created alongside the downloaded file. 
 
        If `spec` is a ``Requirement`` object or a string containing a 
        project/version requirement spec, this method returns the location of 
        a matching distribution (possibly after downloading it to `tmpdir`). 
        If `spec` is a locally existing file or directory name, it is simply 
        returned unchanged.  If `spec` is a URL, it is downloaded to a subpath 
        of `tmpdir`, and the local filename is returned.  Various errors may be 
        raised if a problem occurs during downloading. 
        &quot;&quot;&quot;</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">, </span><span class="s1">Requirement</span><span class="s3">):</span>
            <span class="s1">scheme </span><span class="s3">= </span><span class="s1">URL_SCHEME</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">scheme</span><span class="s3">:</span>
                <span class="s6"># It's a url, download it to tmpdir</span>
                <span class="s1">found </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_url</span><span class="s3">(</span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">spec</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">)</span>
                <span class="s1">base</span><span class="s3">, </span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">egg_info_for_url</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">base</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.py'</span><span class="s3">):</span>
                    <span class="s1">found </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">gen_setup</span><span class="s3">(</span><span class="s1">found</span><span class="s3">, </span><span class="s1">fragment</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">found</span>
            <span class="s2">elif </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">):</span>
                <span class="s6"># Existing file or directory, just return it</span>
                <span class="s2">return </span><span class="s1">spec</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">spec </span><span class="s3">= </span><span class="s1">parse_requirement_arg</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fetch_distribution</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">), </span><span class="s4">'location'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">fetch_distribution</span><span class="s3">(  </span><span class="s6"># noqa: C901  # is too complex (14)  # FIXME</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">requirement</span><span class="s3">,</span>
        <span class="s1">tmpdir</span><span class="s3">,</span>
        <span class="s1">force_scan</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">source</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">develop_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">local_index</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Obtain a distribution suitable for fulfilling `requirement` 
 
        `requirement` must be a ``pkg_resources.Requirement`` instance. 
        If necessary, or if the `force_scan` flag is set, the requirement is 
        searched for in the (online) package index as well as the locally 
        installed packages.  If a distribution matching `requirement` is found, 
        the returned distribution's ``location`` is the value you would have 
        gotten from calling the ``download()`` method with the matching 
        distribution's URL or filename.  If no matching distribution is found, 
        ``None`` is returned. 
 
        If the `source` flag is set, only source distributions and source 
        checkout links will be considered.  Unless the `develop_ok` flag is 
        set, development and system eggs (i.e., those using the ``.egg-info`` 
        format) will be ignored. 
        &quot;&quot;&quot;</span>
        <span class="s6"># process a Requirement</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Searching for %s&quot;</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">)</span>
        <span class="s1">skipped </span><span class="s3">= {}</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">def </span><span class="s1">find</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s1">env</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">env </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">env </span><span class="s3">= </span><span class="s1">self</span>
            <span class="s6"># Find a matching distribution; may be called more than once</span>

            <span class="s2">for </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">env</span><span class="s3">[</span><span class="s1">req</span><span class="s3">.</span><span class="s1">key</span><span class="s3">]:</span>

                <span class="s2">if </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">precedence </span><span class="s3">== </span><span class="s1">DEVELOP_DIST </span><span class="s2">and not </span><span class="s1">develop_ok</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">dist </span><span class="s2">not in </span><span class="s1">skipped</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                            <span class="s4">&quot;Skipping development or system egg: %s&quot;</span><span class="s3">,</span>
                            <span class="s1">dist</span><span class="s3">,</span>
                        <span class="s3">)</span>
                        <span class="s1">skipped</span><span class="s3">[</span><span class="s1">dist</span><span class="s3">] = </span><span class="s5">1</span>
                    <span class="s2">continue</span>

                <span class="s1">test </span><span class="s3">= </span><span class="s1">dist </span><span class="s2">in </span><span class="s1">req </span><span class="s2">and </span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">precedence </span><span class="s3">&lt;= </span><span class="s1">SOURCE_DIST </span><span class="s2">or not </span><span class="s1">source</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">test</span><span class="s3">:</span>
                    <span class="s1">loc </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">download</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">location</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">)</span>
                    <span class="s1">dist</span><span class="s3">.</span><span class="s1">download_location </span><span class="s3">= </span><span class="s1">loc</span>
                    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">download_location</span><span class="s3">):</span>
                        <span class="s2">return </span><span class="s1">dist</span>

        <span class="s2">if </span><span class="s1">force_scan</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">prescan</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">find</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">dist </span><span class="s2">and </span><span class="s1">local_index </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">find</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">local_index</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">dist </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">to_scan </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">prescan</span><span class="s3">()</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">find</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">dist </span><span class="s2">is None and not </span><span class="s1">force_scan</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">find_packages</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">find</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">dist </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s4">&quot;No local packages or working download links found for %s%s&quot;</span><span class="s3">,</span>
                <span class="s3">(</span><span class="s1">source </span><span class="s2">and </span><span class="s4">&quot;a source distribution of &quot; </span><span class="s2">or </span><span class="s4">&quot;&quot;</span><span class="s3">),</span>
                <span class="s1">requirement</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Best match: %s&quot;</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">(</span><span class="s1">location</span><span class="s3">=</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">download_location</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">fetch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">force_scan</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">source</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Obtain a file suitable for fulfilling `requirement` 
 
        DEPRECATED; use the ``fetch_distribution()`` method now instead.  For 
        backward compatibility, this routine is identical but returns the 
        ``location`` of the downloaded distribution instead of a distribution 
        object. 
        &quot;&quot;&quot;</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fetch_distribution</span><span class="s3">(</span><span class="s1">requirement</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">force_scan</span><span class="s3">, </span><span class="s1">source</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">dist </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">location</span>
        <span class="s2">return None</span>

    <span class="s2">def </span><span class="s1">gen_setup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">fragment</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">):</span>
        <span class="s1">match </span><span class="s3">= </span><span class="s1">EGG_FRAGMENT</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">fragment</span><span class="s3">)</span>
        <span class="s1">dists </span><span class="s3">= (</span>
            <span class="s1">match</span>
            <span class="s2">and </span><span class="s3">[</span>
                <span class="s1">d</span>
                <span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">interpret_distro_name</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s2">None</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">d</span><span class="s3">.</span><span class="s1">version</span>
            <span class="s3">]</span>
            <span class="s2">or </span><span class="s3">[]</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">dists</span><span class="s3">) == </span><span class="s5">1</span><span class="s3">:  </span><span class="s6"># unambiguous ``#egg`` fragment</span>
            <span class="s1">basename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>

            <span class="s6"># Make sure the file has been downloaded to the temp dir.</span>
            <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">) != </span><span class="s1">tmpdir</span><span class="s3">:</span>
                <span class="s1">dst </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">dst</span><span class="s3">) </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">samefile</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)):</span>
                    <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copy2</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">dst</span><span class="s3">)</span>
                    <span class="s1">filename </span><span class="s3">= </span><span class="s1">dst</span>

            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s4">'setup.py'</span><span class="s3">), </span><span class="s4">'w'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">file</span><span class="s3">:</span>
                <span class="s1">file</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span>
                    <span class="s4">&quot;from setuptools import setup</span><span class="s2">\n</span><span class="s4">&quot;</span>
                    <span class="s4">&quot;setup(name=%r, version=%r, py_modules=[%r])</span><span class="s2">\n</span><span class="s4">&quot;</span>
                    <span class="s3">% (</span>
                        <span class="s1">dists</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">project_name</span><span class="s3">,</span>
                        <span class="s1">dists</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">version</span><span class="s3">,</span>
                        <span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">basename</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">],</span>
                    <span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s2">return </span><span class="s1">filename</span>

        <span class="s2">elif </span><span class="s1">match</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                <span class="s4">&quot;Can't unambiguously interpret project/version identifier %r; &quot;</span>
                <span class="s4">&quot;any dashes in the name or version should be escaped using &quot;</span>
                <span class="s4">&quot;underscores. %r&quot; </span><span class="s3">% (</span><span class="s1">fragment</span><span class="s3">, </span><span class="s1">dists</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                <span class="s4">&quot;Can't process plain .py files without an '#egg=name-version'&quot;</span>
                <span class="s4">&quot; suffix to enable automatic setup script generation.&quot;</span>
            <span class="s3">)</span>

    <span class="s1">dl_blocksize </span><span class="s3">= </span><span class="s5">8192</span>

    <span class="s2">def </span><span class="s1">_download_to</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Downloading %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">)</span>
        <span class="s6"># Download the file</span>
        <span class="s1">fp </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">checker </span><span class="s3">= </span><span class="s1">HashChecker</span><span class="s3">.</span><span class="s1">from_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s1">fp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">open_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">HTTPError</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                    <span class="s4">&quot;Can't download %s: %s %s&quot; </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">code</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s1">headers </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">info</span><span class="s3">()</span>
            <span class="s1">blocknum </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">bs </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dl_blocksize</span>
            <span class="s1">size </span><span class="s3">= -</span><span class="s5">1</span>
            <span class="s2">if </span><span class="s4">&quot;content-length&quot; </span><span class="s2">in </span><span class="s1">headers</span><span class="s3">:</span>
                <span class="s6"># Some servers return multiple Content-Length headers :(</span>
                <span class="s1">sizes </span><span class="s3">= </span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get_all</span><span class="s3">(</span><span class="s4">'Content-Length'</span><span class="s3">)</span>
                <span class="s1">size </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">int</span><span class="s3">, </span><span class="s1">sizes</span><span class="s3">))</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">reporthook</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">blocknum</span><span class="s3">, </span><span class="s1">bs</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'wb'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">tfp</span><span class="s3">:</span>
                <span class="s2">while True</span><span class="s3">:</span>
                    <span class="s1">block </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">bs</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">block</span><span class="s3">:</span>
                        <span class="s1">checker</span><span class="s3">.</span><span class="s1">feed</span><span class="s3">(</span><span class="s1">block</span><span class="s3">)</span>
                        <span class="s1">tfp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">block</span><span class="s3">)</span>
                        <span class="s1">blocknum </span><span class="s3">+= </span><span class="s5">1</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">reporthook</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">blocknum</span><span class="s3">, </span><span class="s1">bs</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">break</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">check_hash</span><span class="s3">(</span><span class="s1">checker</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">tfp</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">headers</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">fp</span><span class="s3">:</span>
                <span class="s1">fp</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">reporthook</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">blocknum</span><span class="s3">, </span><span class="s1">blksize</span><span class="s3">, </span><span class="s1">size</span><span class="s3">):</span>
        <span class="s2">pass  </span><span class="s6"># no-op</span>

    <span class="s6"># FIXME:</span>
    <span class="s2">def </span><span class="s1">open_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">warning</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):  </span><span class="s6"># noqa: C901  # is too complex (12)</span>
        <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'file:'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">local_open</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">open_with_auth</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">opener</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client</span><span class="s3">.</span><span class="s1">InvalidURL</span><span class="s3">) </span><span class="s2">as </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s4">' '</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s1">str</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">) </span><span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s1">v</span><span class="s3">.</span><span class="s1">args</span><span class="s3">])</span>
            <span class="s2">if </span><span class="s1">warning</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">warning</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span><span class="s4">'%s %s' </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)) </span><span class="s2">from </span><span class="s1">v</span>
        <span class="s2">except </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">HTTPError </span><span class="s2">as </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">v</span>
        <span class="s2">except </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">URLError </span><span class="s2">as </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">warning</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">warning</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">reason</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                    <span class="s4">&quot;Download error for %s: %s&quot; </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">reason</span><span class="s3">)</span>
                <span class="s3">) </span><span class="s2">from </span><span class="s1">v</span>
        <span class="s2">except </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client</span><span class="s3">.</span><span class="s1">BadStatusLine </span><span class="s2">as </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">warning</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">warning</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">line</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span>
                    <span class="s4">'%s returned a bad status line. The server might be '</span>
                    <span class="s4">'down, %s' </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">line</span><span class="s3">)</span>
                <span class="s3">) </span><span class="s2">from </span><span class="s1">v</span>
        <span class="s2">except </span><span class="s3">(</span><span class="s1">http</span><span class="s3">.</span><span class="s1">client</span><span class="s3">.</span><span class="s1">HTTPException</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">error</span><span class="s3">) </span><span class="s2">as </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">warning</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">warning</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span><span class="s4">&quot;Download error for %s: %s&quot; </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)) </span><span class="s2">from </span><span class="s1">v</span>

    <span class="s2">def </span><span class="s1">_download_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">scheme</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">tmpdir</span><span class="s3">):</span>
        <span class="s6"># Determine download filename</span>
        <span class="s6">#</span>
        <span class="s1">name</span><span class="s3">, </span><span class="s1">fragment </span><span class="s3">= </span><span class="s1">egg_info_for_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">name</span><span class="s3">:</span>
            <span class="s2">while </span><span class="s4">'..' </span><span class="s2">in </span><span class="s1">name</span><span class="s3">:</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'..'</span><span class="s3">, </span><span class="s4">'.'</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\\</span><span class="s4">'</span><span class="s3">, </span><span class="s4">'_'</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s4">&quot;__downloaded__&quot;  </span><span class="s6"># default if URL has no path contents</span>

        <span class="s2">if </span><span class="s1">name</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'.egg.zip'</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">[:-</span><span class="s5">4</span><span class="s3">]  </span><span class="s6"># strip the extra .zip before download</span>

        <span class="s1">filename </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">tmpdir</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>

        <span class="s6"># Download the file</span>
        <span class="s6">#</span>
        <span class="s2">if </span><span class="s1">scheme </span><span class="s3">== </span><span class="s4">'svn' </span><span class="s2">or </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'svn+'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_svn</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">scheme </span><span class="s3">== </span><span class="s4">'git' </span><span class="s2">or </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'git+'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_git</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'hg+'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_hg</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">scheme </span><span class="s3">== </span><span class="s4">'file'</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">url2pathname</span><span class="s3">(</span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)[</span><span class="s5">2</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">url_ok</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)  </span><span class="s6"># raises error if not allowed</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_attempt_download</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">scan_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">process_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_attempt_download</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">headers </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_to</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s4">'html' </span><span class="s2">in </span><span class="s1">headers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'content-type'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">).</span><span class="s1">lower</span><span class="s3">():</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_html</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">filename</span>

    <span class="s2">def </span><span class="s1">_download_html</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">file </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">file</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">():</span>
                <span class="s6"># Check for a subversion index page</span>
                <span class="s2">if </span><span class="s1">re</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s4">r'&lt;title&gt;([^- ]+ - )?Revision \d+:'</span><span class="s3">, </span><span class="s1">line</span><span class="s3">):</span>
                    <span class="s6"># it's a subversion index page:</span>
                    <span class="s1">file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
                    <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
                    <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_download_svn</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
                <span class="s2">break  </span><span class="s6"># not an index page</span>
        <span class="s1">file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">DistutilsError</span><span class="s3">(</span><span class="s4">&quot;Unexpected HTML page found at &quot; </span><span class="s3">+ </span><span class="s1">url</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_download_svn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">&quot;SVN download support is deprecated&quot;</span><span class="s3">, </span><span class="s1">UserWarning</span><span class="s3">)</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">url</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]  </span><span class="s6"># remove any fragment for svn's sake</span>
        <span class="s1">creds </span><span class="s3">= </span><span class="s4">''</span>
        <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">().</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'svn:'</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'@' </span><span class="s2">in </span><span class="s1">url</span><span class="s3">:</span>
            <span class="s1">scheme</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">f </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">netloc </span><span class="s2">and </span><span class="s1">path</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">'//'</span><span class="s3">) </span><span class="s2">and </span><span class="s4">'/' </span><span class="s2">in </span><span class="s1">path</span><span class="s3">[</span><span class="s5">2</span><span class="s3">:]:</span>
                <span class="s1">netloc</span><span class="s3">, </span><span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">[</span><span class="s5">2</span><span class="s3">:].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">auth</span><span class="s3">, </span><span class="s1">host </span><span class="s3">= </span><span class="s1">_splituser</span><span class="s3">(</span><span class="s1">netloc</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">auth</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s4">':' </span><span class="s2">in </span><span class="s1">auth</span><span class="s3">:</span>
                        <span class="s1">user</span><span class="s3">, </span><span class="s1">pw </span><span class="s3">= </span><span class="s1">auth</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
                        <span class="s1">creds </span><span class="s3">= </span><span class="s4">&quot; --username=%s --password=%s&quot; </span><span class="s3">% (</span><span class="s1">user</span><span class="s3">, </span><span class="s1">pw</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">creds </span><span class="s3">= </span><span class="s4">&quot; --username=&quot; </span><span class="s3">+ </span><span class="s1">auth</span>
                    <span class="s1">netloc </span><span class="s3">= </span><span class="s1">host</span>
                    <span class="s1">parts </span><span class="s3">= </span><span class="s1">scheme</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">f</span>
                    <span class="s1">url </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlunparse</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Doing subversion checkout from %s to %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">system</span><span class="s3">(</span><span class="s4">&quot;svn checkout%s -q %s %s&quot; </span><span class="s3">% (</span><span class="s1">creds</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">filename</span>

    <span class="s3">@</span><span class="s1">staticmethod</span>
    <span class="s2">def </span><span class="s1">_vcs_split_rev_from_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">pop_prefix</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">scheme</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s1">frag </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlsplit</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>

        <span class="s1">scheme </span><span class="s3">= </span><span class="s1">scheme</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'+'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[-</span><span class="s5">1</span><span class="s3">]</span>

        <span class="s6"># Some fragment identification fails</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">rev </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s4">'@' </span><span class="s2">in </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">path</span><span class="s3">, </span><span class="s1">rev </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">rsplit</span><span class="s3">(</span><span class="s4">'@'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Also, discard fragment</span>
        <span class="s1">url </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlunsplit</span><span class="s3">((</span><span class="s1">scheme</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s4">''</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">url</span><span class="s3">, </span><span class="s1">rev</span>

    <span class="s2">def </span><span class="s1">_download_git</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">filename </span><span class="s3">= </span><span class="s1">filename</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">url</span><span class="s3">, </span><span class="s1">rev </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vcs_split_rev_from_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">pop_prefix</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Doing git clone from %s to %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">system</span><span class="s3">(</span><span class="s4">&quot;git clone --quiet %s %s&quot; </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">rev </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Checking out %s&quot;</span><span class="s3">, </span><span class="s1">rev</span><span class="s3">)</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">system</span><span class="s3">(</span>
                <span class="s4">&quot;git -C %s checkout --quiet %s&quot;</span>
                <span class="s3">% (</span>
                    <span class="s1">filename</span><span class="s3">,</span>
                    <span class="s1">rev</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s2">return </span><span class="s1">filename</span>

    <span class="s2">def </span><span class="s1">_download_hg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">filename </span><span class="s3">= </span><span class="s1">filename</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">url</span><span class="s3">, </span><span class="s1">rev </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_vcs_split_rev_from_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">pop_prefix</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Doing hg clone from %s to %s&quot;</span><span class="s3">, </span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">system</span><span class="s3">(</span><span class="s4">&quot;hg clone --quiet %s %s&quot; </span><span class="s3">% (</span><span class="s1">url</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">rev </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">&quot;Updating to %s&quot;</span><span class="s3">, </span><span class="s1">rev</span><span class="s3">)</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">system</span><span class="s3">(</span>
                <span class="s4">&quot;hg --cwd %s up -C -r %s -q&quot;</span>
                <span class="s3">% (</span>
                    <span class="s1">filename</span><span class="s3">,</span>
                    <span class="s1">rev</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s3">)</span>

        <span class="s2">return </span><span class="s1">filename</span>

    <span class="s2">def </span><span class="s1">debug</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">info</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">warn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s1">log</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>


<span class="s6"># This pattern matches a character entity reference (a decimal numeric</span>
<span class="s6"># references, a hexadecimal numeric reference, or a named reference).</span>
<span class="s1">entity_sub </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">r'&amp;(#(\d+|x[\da-fA-F]+)|[\w.:-]+);?'</span><span class="s3">).</span><span class="s1">sub</span>


<span class="s2">def </span><span class="s1">decode_entity</span><span class="s3">(</span><span class="s1">match</span><span class="s3">):</span>
    <span class="s1">what </span><span class="s3">= </span><span class="s1">match</span><span class="s3">.</span><span class="s1">group</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">html</span><span class="s3">.</span><span class="s1">unescape</span><span class="s3">(</span><span class="s1">what</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">htmldecode</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Decode HTML entities in the given text. 
 
    &gt;&gt;&gt; htmldecode( 
    ...     'https://../package_name-0.1.2.tar.gz' 
    ...     '?tokena=A&amp;amp;tokenb=B&quot;&gt;package_name-0.1.2.tar.gz') 
    'https://../package_name-0.1.2.tar.gz?tokena=A&amp;tokenb=B&quot;&gt;package_name-0.1.2.tar.gz' 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">entity_sub</span><span class="s3">(</span><span class="s1">decode_entity</span><span class="s3">, </span><span class="s1">text</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">socket_timeout</span><span class="s3">(</span><span class="s1">timeout</span><span class="s3">=</span><span class="s5">15</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">_socket_timeout</span><span class="s3">(</span><span class="s1">func</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">_socket_timeout</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
            <span class="s1">old_timeout </span><span class="s3">= </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">getdefaulttimeout</span><span class="s3">()</span>
            <span class="s1">socket</span><span class="s3">.</span><span class="s1">setdefaulttimeout</span><span class="s3">(</span><span class="s1">timeout</span><span class="s3">)</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">finally</span><span class="s3">:</span>
                <span class="s1">socket</span><span class="s3">.</span><span class="s1">setdefaulttimeout</span><span class="s3">(</span><span class="s1">old_timeout</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">_socket_timeout</span>

    <span class="s2">return </span><span class="s1">_socket_timeout</span>


<span class="s2">def </span><span class="s1">_encode_auth</span><span class="s3">(</span><span class="s1">auth</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Encode auth from a URL suitable for an HTTP header. 
    &gt;&gt;&gt; str(_encode_auth('username%3Apassword')) 
    'dXNlcm5hbWU6cGFzc3dvcmQ=' 
 
    Long auth strings should not cause a newline to be inserted. 
    &gt;&gt;&gt; long_auth = 'username:' + 'password'*10 
    &gt;&gt;&gt; chr(10) in str(_encode_auth(long_auth)) 
    False 
    &quot;&quot;&quot;</span>
    <span class="s1">auth_s </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">unquote</span><span class="s3">(</span><span class="s1">auth</span><span class="s3">)</span>
    <span class="s6"># convert to bytes</span>
    <span class="s1">auth_bytes </span><span class="s3">= </span><span class="s1">auth_s</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">()</span>
    <span class="s1">encoded_bytes </span><span class="s3">= </span><span class="s1">base64</span><span class="s3">.</span><span class="s1">b64encode</span><span class="s3">(</span><span class="s1">auth_bytes</span><span class="s3">)</span>
    <span class="s6"># convert back to a string</span>
    <span class="s1">encoded </span><span class="s3">= </span><span class="s1">encoded_bytes</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">()</span>
    <span class="s6"># strip the trailing carriage return</span>
    <span class="s2">return </span><span class="s1">encoded</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Credential</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    A username/password pair. Use like a namedtuple. 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">username</span><span class="s3">, </span><span class="s1">password</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">username </span><span class="s3">= </span><span class="s1">username</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">password </span><span class="s3">= </span><span class="s1">password</span>

    <span class="s2">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">yield </span><span class="s1">self</span><span class="s3">.</span><span class="s1">username</span>
        <span class="s2">yield </span><span class="s1">self</span><span class="s3">.</span><span class="s1">password</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">'%(username)s:%(password)s' </span><span class="s3">% </span><span class="s1">vars</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PyPIConfig</span><span class="s3">(</span><span class="s1">configparser</span><span class="s3">.</span><span class="s1">RawConfigParser</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        Load from ~/.pypirc 
        &quot;&quot;&quot;</span>
        <span class="s1">defaults </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">.</span><span class="s1">fromkeys</span><span class="s3">([</span><span class="s4">'username'</span><span class="s3">, </span><span class="s4">'password'</span><span class="s3">, </span><span class="s4">'repository'</span><span class="s3">], </span><span class="s4">''</span><span class="s3">)</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">defaults</span><span class="s3">)</span>

        <span class="s1">rc </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">expanduser</span><span class="s3">(</span><span class="s4">'~'</span><span class="s3">), </span><span class="s4">'.pypirc'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">rc</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">rc</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">creds_by_repository</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">sections_with_repositories </span><span class="s3">= [</span>
            <span class="s1">section</span>
            <span class="s2">for </span><span class="s1">section </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">sections</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">section</span><span class="s3">, </span><span class="s4">'repository'</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s3">]</span>

        <span class="s2">return </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_repo_cred</span><span class="s3">, </span><span class="s1">sections_with_repositories</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_get_repo_cred</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">section</span><span class="s3">):</span>
        <span class="s1">repo </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">section</span><span class="s3">, </span><span class="s4">'repository'</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">repo</span><span class="s3">, </span><span class="s1">Credential</span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">section</span><span class="s3">, </span><span class="s4">'username'</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">(),</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">section</span><span class="s3">, </span><span class="s4">'password'</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">(),</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">find_credential</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">url</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; 
        If the URL indicated appears to be a repository defined in this 
        config, return the credential for that repository. 
        &quot;&quot;&quot;</span>
        <span class="s2">for </span><span class="s1">repository</span><span class="s3">, </span><span class="s1">cred </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">creds_by_repository</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">url</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s1">repository</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">cred</span>


<span class="s2">def </span><span class="s1">open_with_auth</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">opener</span><span class="s3">=</span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">urlopen</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Open a urllib2 request, handling HTTP authentication&quot;&quot;&quot;</span>

    <span class="s1">parsed </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
    <span class="s1">scheme</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s1">frag </span><span class="s3">= </span><span class="s1">parsed</span>

    <span class="s6"># Double scheme does not raise on macOS as revealed by a</span>
    <span class="s6"># failing test. We would expect &quot;nonnumeric port&quot;. Refs #20.</span>
    <span class="s2">if </span><span class="s1">netloc</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">http</span><span class="s3">.</span><span class="s1">client</span><span class="s3">.</span><span class="s1">InvalidURL</span><span class="s3">(</span><span class="s4">&quot;nonnumeric port: ''&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">scheme </span><span class="s2">in </span><span class="s3">(</span><span class="s4">'http'</span><span class="s3">, </span><span class="s4">'https'</span><span class="s3">):</span>
        <span class="s1">auth</span><span class="s3">, </span><span class="s1">address </span><span class="s3">= </span><span class="s1">_splituser</span><span class="s3">(</span><span class="s1">netloc</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">auth </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">if not </span><span class="s1">auth</span><span class="s3">:</span>
        <span class="s1">cred </span><span class="s3">= </span><span class="s1">PyPIConfig</span><span class="s3">().</span><span class="s1">find_credential</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">cred</span><span class="s3">:</span>
            <span class="s1">auth </span><span class="s3">= </span><span class="s1">str</span><span class="s3">(</span><span class="s1">cred</span><span class="s3">)</span>
            <span class="s1">info </span><span class="s3">= </span><span class="s1">cred</span><span class="s3">.</span><span class="s1">username</span><span class="s3">, </span><span class="s1">url</span>
            <span class="s1">log</span><span class="s3">.</span><span class="s1">info</span><span class="s3">(</span><span class="s4">'Authenticating as %s for %s (from .pypirc)'</span><span class="s3">, *</span><span class="s1">info</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">auth</span><span class="s3">:</span>
        <span class="s1">auth </span><span class="s3">= </span><span class="s4">&quot;Basic &quot; </span><span class="s3">+ </span><span class="s1">_encode_auth</span><span class="s3">(</span><span class="s1">auth</span><span class="s3">)</span>
        <span class="s1">parts </span><span class="s3">= </span><span class="s1">scheme</span><span class="s3">, </span><span class="s1">address</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s1">frag</span>
        <span class="s1">new_url </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlunparse</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>
        <span class="s1">request </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">Request</span><span class="s3">(</span><span class="s1">new_url</span><span class="s3">)</span>
        <span class="s1">request</span><span class="s3">.</span><span class="s1">add_header</span><span class="s3">(</span><span class="s4">&quot;Authorization&quot;</span><span class="s3">, </span><span class="s1">auth</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">request </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">Request</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>

    <span class="s1">request</span><span class="s3">.</span><span class="s1">add_header</span><span class="s3">(</span><span class="s4">'User-Agent'</span><span class="s3">, </span><span class="s1">user_agent</span><span class="s3">)</span>
    <span class="s1">fp </span><span class="s3">= </span><span class="s1">opener</span><span class="s3">(</span><span class="s1">request</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">auth</span><span class="s3">:</span>
        <span class="s6"># Put authentication info back into request URL if same host,</span>
        <span class="s6"># so that links found on the page will work</span>
        <span class="s1">s2</span><span class="s3">, </span><span class="s1">h2</span><span class="s3">, </span><span class="s1">path2</span><span class="s3">, </span><span class="s1">param2</span><span class="s3">, </span><span class="s1">query2</span><span class="s3">, </span><span class="s1">frag2 </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">s2 </span><span class="s3">== </span><span class="s1">scheme </span><span class="s2">and </span><span class="s1">h2 </span><span class="s3">== </span><span class="s1">address</span><span class="s3">:</span>
            <span class="s1">parts </span><span class="s3">= </span><span class="s1">s2</span><span class="s3">, </span><span class="s1">netloc</span><span class="s3">, </span><span class="s1">path2</span><span class="s3">, </span><span class="s1">param2</span><span class="s3">, </span><span class="s1">query2</span><span class="s3">, </span><span class="s1">frag2</span>
            <span class="s1">fp</span><span class="s3">.</span><span class="s1">url </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlunparse</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">fp</span>


<span class="s6"># copy of urllib.parse._splituser from Python 3.8</span>
<span class="s2">def </span><span class="s1">_splituser</span><span class="s3">(</span><span class="s1">host</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;splituser('user[:passwd]@host[:port]') 
    --&gt; 'user[:passwd]', 'host[:port]'.&quot;&quot;&quot;</span>
    <span class="s1">user</span><span class="s3">, </span><span class="s1">delim</span><span class="s3">, </span><span class="s1">host </span><span class="s3">= </span><span class="s1">host</span><span class="s3">.</span><span class="s1">rpartition</span><span class="s3">(</span><span class="s4">'@'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">user </span><span class="s2">if </span><span class="s1">delim </span><span class="s2">else None</span><span class="s3">), </span><span class="s1">host</span>


<span class="s6"># adding a timeout to avoid freezing package_index</span>
<span class="s1">open_with_auth </span><span class="s3">= </span><span class="s1">socket_timeout</span><span class="s3">(</span><span class="s1">_SOCKET_TIMEOUT</span><span class="s3">)(</span><span class="s1">open_with_auth</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">fix_sf_url</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">url  </span><span class="s6"># backward compatibility</span>


<span class="s2">def </span><span class="s1">local_open</span><span class="s3">(</span><span class="s1">url</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Read a local path, with special support for directories&quot;&quot;&quot;</span>
    <span class="s1">scheme</span><span class="s3">, </span><span class="s1">server</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">param</span><span class="s3">, </span><span class="s1">query</span><span class="s3">, </span><span class="s1">frag </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">parse</span><span class="s3">.</span><span class="s1">urlparse</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
    <span class="s1">filename </span><span class="s3">= </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">url2pathname</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">request</span><span class="s3">.</span><span class="s1">urlopen</span><span class="s3">(</span><span class="s1">url</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">path</span><span class="s3">.</span><span class="s1">endswith</span><span class="s3">(</span><span class="s4">'/'</span><span class="s3">) </span><span class="s2">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
        <span class="s1">files </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">os</span><span class="s3">.</span><span class="s1">listdir</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">):</span>
            <span class="s1">filepath </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s1">f</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">f </span><span class="s3">== </span><span class="s4">'index.html'</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">, </span><span class="s4">'r'</span><span class="s3">) </span><span class="s2">as </span><span class="s1">fp</span><span class="s3">:</span>
                    <span class="s1">body </span><span class="s3">= </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
                <span class="s2">break</span>
            <span class="s2">elif </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isdir</span><span class="s3">(</span><span class="s1">filepath</span><span class="s3">):</span>
                <span class="s1">f </span><span class="s3">+= </span><span class="s4">'/'</span>
            <span class="s1">files</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s4">'&lt;a href=&quot;{name}&quot;&gt;{name}&lt;/a&gt;'</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">f</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">tmpl </span><span class="s3">= (</span>
                <span class="s4">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;{url}&lt;/title&gt;&quot; &quot;&lt;/head&gt;&lt;body&gt;{files}&lt;/body&gt;&lt;/html&gt;&quot;</span>
            <span class="s3">)</span>
            <span class="s1">body </span><span class="s3">= </span><span class="s1">tmpl</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">url</span><span class="s3">=</span><span class="s1">url</span><span class="s3">, </span><span class="s1">files</span><span class="s3">=</span><span class="s4">'</span><span class="s2">\n</span><span class="s4">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">files</span><span class="s3">))</span>
        <span class="s1">status</span><span class="s3">, </span><span class="s1">message </span><span class="s3">= </span><span class="s5">200</span><span class="s3">, </span><span class="s4">&quot;OK&quot;</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">status</span><span class="s3">, </span><span class="s1">message</span><span class="s3">, </span><span class="s1">body </span><span class="s3">= </span><span class="s5">404</span><span class="s3">, </span><span class="s4">&quot;Path not found&quot;</span><span class="s3">, </span><span class="s4">&quot;Not found&quot;</span>

    <span class="s1">headers </span><span class="s3">= {</span><span class="s4">'content-type'</span><span class="s3">: </span><span class="s4">'text/html'</span><span class="s3">}</span>
    <span class="s1">body_stream </span><span class="s3">= </span><span class="s1">io</span><span class="s3">.</span><span class="s1">StringIO</span><span class="s3">(</span><span class="s1">body</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">urllib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">HTTPError</span><span class="s3">(</span><span class="s1">url</span><span class="s3">, </span><span class="s1">status</span><span class="s3">, </span><span class="s1">message</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">, </span><span class="s1">body_stream</span><span class="s3">)</span>
</pre>
</body>
</html>