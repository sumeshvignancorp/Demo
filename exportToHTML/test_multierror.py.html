<html>
<head>
<title>test_multierror.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_multierror.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">gc</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">subprocess</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">from </span><span class="s1">traceback </span><span class="s0">import </span><span class="s1">extract_tb</span><span class="s2">, </span><span class="s1">print_exception</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s2">... </span><span class="s0">import </span><span class="s1">TrioDeprecationWarning</span>
<span class="s0">from </span><span class="s2">...</span><span class="s1">_core </span><span class="s0">import </span><span class="s1">open_nursery</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_multierror </span><span class="s0">import </span><span class="s1">MultiError</span><span class="s2">, </span><span class="s1">NonBaseMultiError</span><span class="s2">, </span><span class="s1">concat_tb</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">tutil </span><span class="s0">import </span><span class="s1">slow</span>

<span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">11</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">exceptiongroup </span><span class="s0">import </span><span class="s1">ExceptionGroup</span>


<span class="s0">class </span><span class="s1">NotHashableException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s1">code </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">code</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">code </span><span class="s2">= </span><span class="s1">code</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">NotHashableException</span><span class="s2">):</span>
            <span class="s0">return False</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">code </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">code</span>


<span class="s0">async def </span><span class="s1">raise_nothashable</span><span class="s2">(</span><span class="s1">code</span><span class="s2">):</span>
    <span class="s0">raise </span><span class="s1">NotHashableException</span><span class="s2">(</span><span class="s1">code</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">raiser1</span><span class="s2">():</span>
    <span class="s1">raiser1_2</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">raiser1_2</span><span class="s2">():</span>
    <span class="s1">raiser1_3</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">raiser1_3</span><span class="s2">():</span>
    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">&quot;raiser1_string&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">raiser2</span><span class="s2">():</span>
    <span class="s1">raiser2_2</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">raiser2_2</span><span class="s2">():</span>
    <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s4">&quot;raiser2_string&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">raiser3</span><span class="s2">():</span>
    <span class="s0">raise </span><span class="s1">NameError</span>


<span class="s0">def </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">raiser</span><span class="s2">()</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">exc</span>


<span class="s0">def </span><span class="s1">get_tb</span><span class="s2">(</span><span class="s1">raiser</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser</span><span class="s2">).</span><span class="s1">__traceback__</span>


<span class="s0">def </span><span class="s1">test_concat_tb</span><span class="s2">():</span>
    <span class="s1">tb1 </span><span class="s2">= </span><span class="s1">get_tb</span><span class="s2">(</span><span class="s1">raiser1</span><span class="s2">)</span>
    <span class="s1">tb2 </span><span class="s2">= </span><span class="s1">get_tb</span><span class="s2">(</span><span class="s1">raiser2</span><span class="s2">)</span>

    <span class="s5"># These return a list of (filename, lineno, fn name, text) tuples</span>
    <span class="s5"># https://docs.python.org/3/library/traceback.html#traceback.extract_tb</span>
    <span class="s1">entries1 </span><span class="s2">= </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">tb1</span><span class="s2">)</span>
    <span class="s1">entries2 </span><span class="s2">= </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">tb2</span><span class="s2">)</span>

    <span class="s1">tb12 </span><span class="s2">= </span><span class="s1">concat_tb</span><span class="s2">(</span><span class="s1">tb1</span><span class="s2">, </span><span class="s1">tb2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">tb12</span><span class="s2">) == </span><span class="s1">entries1 </span><span class="s2">+ </span><span class="s1">entries2</span>

    <span class="s1">tb21 </span><span class="s2">= </span><span class="s1">concat_tb</span><span class="s2">(</span><span class="s1">tb2</span><span class="s2">, </span><span class="s1">tb1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">tb21</span><span class="s2">) == </span><span class="s1">entries2 </span><span class="s2">+ </span><span class="s1">entries1</span>

    <span class="s5"># Check degenerate cases</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">concat_tb</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">tb1</span><span class="s2">)) == </span><span class="s1">entries1</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">concat_tb</span><span class="s2">(</span><span class="s1">tb1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)) == </span><span class="s1">entries1</span>
    <span class="s0">assert </span><span class="s1">concat_tb</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s5"># Make sure the original tracebacks didn't get mutated by mistake</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">get_tb</span><span class="s2">(</span><span class="s1">raiser1</span><span class="s2">)) == </span><span class="s1">entries1</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">get_tb</span><span class="s2">(</span><span class="s1">raiser2</span><span class="s2">)) == </span><span class="s1">entries2</span>


<span class="s0">def </span><span class="s1">test_MultiError</span><span class="s2">():</span>
    <span class="s1">exc1 </span><span class="s2">= </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser1</span><span class="s2">)</span>
    <span class="s1">exc2 </span><span class="s2">= </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser2</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">exc1</span><span class="s2">]) </span><span class="s0">is </span><span class="s1">exc1</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">exc1</span><span class="s2">, </span><span class="s1">exc2</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s2">== (</span><span class="s1">exc1</span><span class="s2">, </span><span class="s1">exc2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;ValueError&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;ValueError&quot; </span><span class="s0">in </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">MultiError</span><span class="s2">(</span><span class="s1">object</span><span class="s2">())</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">MultiError</span><span class="s2">([</span><span class="s1">KeyError</span><span class="s2">(), </span><span class="s1">ValueError</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_MultiErrorOfSingleMultiError</span><span class="s2">():</span>
    <span class="s5"># For MultiError([MultiError]), ensure there is no bad recursion by the</span>
    <span class="s5"># constructor where __init__ is called if __new__ returns a bare MultiError.</span>
    <span class="s1">exceptions </span><span class="s2">= (</span><span class="s1">KeyError</span><span class="s2">(), </span><span class="s1">ValueError</span><span class="s2">())</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">(</span><span class="s1">exceptions</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">a</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">b </span><span class="s2">== </span><span class="s1">a</span>
    <span class="s0">assert </span><span class="s1">b</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s2">== </span><span class="s1">exceptions</span>


<span class="s0">async def </span><span class="s1">test_MultiErrorNotHashable</span><span class="s2">():</span>
    <span class="s1">exc1 </span><span class="s2">= </span><span class="s1">NotHashableException</span><span class="s2">(</span><span class="s3">42</span><span class="s2">)</span>
    <span class="s1">exc2 </span><span class="s2">= </span><span class="s1">NotHashableException</span><span class="s2">(</span><span class="s3">4242</span><span class="s2">)</span>
    <span class="s1">exc3 </span><span class="s2">= </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">exc1 </span><span class="s2">!= </span><span class="s1">exc2</span>
    <span class="s0">assert </span><span class="s1">exc1 </span><span class="s2">!= </span><span class="s1">exc3</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MultiError</span><span class="s2">):</span>
        <span class="s0">async with </span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">raise_nothashable</span><span class="s2">, </span><span class="s3">42</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">raise_nothashable</span><span class="s2">, </span><span class="s3">4242</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_MultiError_filter_NotHashable</span><span class="s2">():</span>
    <span class="s1">excs </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">NotHashableException</span><span class="s2">(</span><span class="s3">42</span><span class="s2">), </span><span class="s1">ValueError</span><span class="s2">()])</span>

    <span class="s0">def </span><span class="s1">handle_ValueError</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">exc</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
        <span class="s1">filtered_excs </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">handle_ValueError</span><span class="s2">, </span><span class="s1">excs</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">filtered_excs</span><span class="s2">, </span><span class="s1">NotHashableException</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_tree</span><span class="s2">():</span>
    <span class="s5"># Returns an object like:</span>
    <span class="s5">#   MultiError([</span>
    <span class="s5">#     MultiError([</span>
    <span class="s5">#       ValueError,</span>
    <span class="s5">#       KeyError,</span>
    <span class="s5">#     ]),</span>
    <span class="s5">#     NameError,</span>
    <span class="s5">#   ])</span>
    <span class="s5"># where all exceptions except the root have a non-trivial traceback.</span>
    <span class="s1">exc1 </span><span class="s2">= </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser1</span><span class="s2">)</span>
    <span class="s1">exc2 </span><span class="s2">= </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser2</span><span class="s2">)</span>
    <span class="s1">exc3 </span><span class="s2">= </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser3</span><span class="s2">)</span>

    <span class="s5"># Give m12 a non-trivial traceback</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">exc1</span><span class="s2">, </span><span class="s1">exc2</span><span class="s2">])</span>
    <span class="s0">except </span><span class="s1">BaseException </span><span class="s0">as </span><span class="s1">m12</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">m12</span><span class="s2">, </span><span class="s1">exc3</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">m1 </span><span class="s0">is None or </span><span class="s1">m2 </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">m1 </span><span class="s0">is </span><span class="s1">m2</span>
        <span class="s0">return</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">) </span><span class="s0">is </span><span class="s1">type</span><span class="s2">(</span><span class="s1">m2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">) == </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">m2</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">)</span>
    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>
    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">.</span><span class="s1">__context__</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">.</span><span class="s1">__context__</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">, </span><span class="s1">MultiError</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">m2</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">e1</span><span class="s2">, </span><span class="s1">e2 </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">m1</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">, </span><span class="s1">m2</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">):</span>
            <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">e1</span><span class="s2">, </span><span class="s1">e2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_MultiError_filter</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">null_handler</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">exc</span>

    <span class="s1">m </span><span class="s2">= </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">null_handler</span><span class="s2">, </span><span class="s1">m</span><span class="s2">) </span><span class="s0">is </span><span class="s1">m</span>

    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">make_tree</span><span class="s2">())</span>

    <span class="s5"># Make sure we don't pick up any detritus if run in a context where</span>
    <span class="s5"># implicit exception chaining would like to kick in</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span>
    <span class="s0">except </span><span class="s1">ValueError</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">null_handler</span><span class="s2">, </span><span class="s1">m</span><span class="s2">) </span><span class="s0">is </span><span class="s1">m</span>
    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">make_tree</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">simple_filter</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">RuntimeError</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">exc</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
        <span class="s1">new_m </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">simple_filter</span><span class="s2">, </span><span class="s1">make_tree</span><span class="s2">())</span>

    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">, </span><span class="s1">MultiError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s5"># was: [[ValueError, KeyError], NameError]</span>
    <span class="s5"># ValueError disappeared &amp; KeyError became RuntimeError, so now:</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">RuntimeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">NameError</span><span class="s2">)</span>

    <span class="s5"># implicit chaining:</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">__context__</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">)</span>

    <span class="s5"># also, the traceback on the KeyError incorporates what used to be the</span>
    <span class="s5"># traceback on its parent MultiError</span>
    <span class="s1">orig </span><span class="s2">= </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s5"># make sure we have the right path</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">KeyError</span><span class="s2">)</span>
    <span class="s5"># get original traceback summary</span>
    <span class="s1">orig_extracted </span><span class="s2">= (</span>
        <span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">)</span>
        <span class="s2">+ </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">__traceback__</span><span class="s2">)</span>
        <span class="s2">+ </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">__traceback__</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">p</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s1">print_exception</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">), </span><span class="s1">exc</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">)</span>

    <span class="s1">p</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">)</span>
    <span class="s1">p</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">p</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">p</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">__context__</span><span class="s2">)</span>
    <span class="s5"># compare to the new path</span>
    <span class="s0">assert </span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">__traceback__ </span><span class="s0">is None</span>
    <span class="s1">new_extracted </span><span class="s2">= </span><span class="s1">extract_tb</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">__context__</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">orig_extracted </span><span class="s2">== </span><span class="s1">new_extracted</span>

    <span class="s5"># check preserving partial tree</span>
    <span class="s0">def </span><span class="s1">filter_NameError</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">NameError</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">exc</span>

    <span class="s1">m </span><span class="s2">= </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
        <span class="s1">new_m </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">filter_NameError</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>
    <span class="s5"># with the NameError gone, the other branch gets promoted</span>
    <span class="s0">assert </span><span class="s1">new_m </span><span class="s0">is </span><span class="s1">m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>

    <span class="s5"># check fully handling everything</span>
    <span class="s0">def </span><span class="s1">filter_all</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">return None</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">filter_all</span><span class="s2">, </span><span class="s1">make_tree</span><span class="s2">()) </span><span class="s0">is None</span>


<span class="s0">def </span><span class="s1">test_MultiError_catch</span><span class="s2">():</span>
    <span class="s5"># No exception to catch</span>

    <span class="s0">def </span><span class="s1">noop</span><span class="s2">(</span><span class="s1">_</span><span class="s2">):</span>
        <span class="s0">pass  </span><span class="s5"># pragma: no cover</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s1">noop</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s5"># Simple pass-through of all exceptions</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MultiError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">exc</span><span class="s2">: </span><span class="s1">exc</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">m</span>
    <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value </span><span class="s0">is </span><span class="s1">m</span>
    <span class="s5"># Should be unchanged, except that we added a traceback frame by raising</span>
    <span class="s5"># it here</span>
    <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">__traceback__ </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">.</span><span class="s1">tb_frame</span><span class="s2">.</span><span class="s1">f_code</span><span class="s2">.</span><span class="s1">co_name </span><span class="s2">== </span><span class="s4">&quot;test_MultiError_catch&quot;</span>
    <span class="s0">assert </span><span class="s1">m</span><span class="s2">.</span><span class="s1">__traceback__</span><span class="s2">.</span><span class="s1">tb_next </span><span class="s0">is None</span>
    <span class="s1">m</span><span class="s2">.</span><span class="s1">__traceback__ </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">assert_tree_eq</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">make_tree</span><span class="s2">())</span>

    <span class="s5"># Swallows everything</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">_</span><span class="s2">: </span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">make_tree</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">simple_filter</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return None</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">RuntimeError</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">exc</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MultiError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s1">simple_filter</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">make_tree</span><span class="s2">()</span>
    <span class="s1">new_m </span><span class="s2">= </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">, </span><span class="s1">MultiError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">) == </span><span class="s3">2</span>
    <span class="s5"># was: [[ValueError, KeyError], NameError]</span>
    <span class="s5"># ValueError disappeared &amp; KeyError became RuntimeError, so now:</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">RuntimeError</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">exceptions</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">NameError</span><span class="s2">)</span>
    <span class="s5"># Make sure that Python did not successfully attach the old MultiError to</span>
    <span class="s5"># our new MultiError's __context__</span>
    <span class="s0">assert not </span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">__suppress_context__</span>
    <span class="s0">assert </span><span class="s1">new_m</span><span class="s2">.</span><span class="s1">__context__ </span><span class="s0">is None</span>

    <span class="s5"># check preservation of __cause__ and __context__</span>
    <span class="s1">v </span><span class="s2">= </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s1">v</span><span class="s2">.</span><span class="s1">__cause__ </span><span class="s2">= </span><span class="s1">KeyError</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">exc</span><span class="s2">: </span><span class="s1">exc</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">v</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">)</span>

    <span class="s1">v </span><span class="s2">= </span><span class="s1">ValueError</span><span class="s2">()</span>
    <span class="s1">context </span><span class="s2">= </span><span class="s1">KeyError</span><span class="s2">()</span>
    <span class="s1">v</span><span class="s2">.</span><span class="s1">__context__ </span><span class="s2">= </span><span class="s1">context</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">exc</span><span class="s2">: </span><span class="s1">exc</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">v</span>
    <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__context__ </span><span class="s0">is </span><span class="s1">context</span>
    <span class="s0">assert not </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__suppress_context__</span>

    <span class="s0">for </span><span class="s1">suppress_context </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
        <span class="s1">v </span><span class="s2">= </span><span class="s1">ValueError</span><span class="s2">()</span>
        <span class="s1">context </span><span class="s2">= </span><span class="s1">KeyError</span><span class="s2">()</span>
        <span class="s1">v</span><span class="s2">.</span><span class="s1">__context__ </span><span class="s2">= </span><span class="s1">context</span>
        <span class="s1">v</span><span class="s2">.</span><span class="s1">__suppress_context__ </span><span class="s2">= </span><span class="s1">suppress_context</span>
        <span class="s1">distractor </span><span class="s2">= </span><span class="s1">RuntimeError</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>

            <span class="s0">def </span><span class="s1">catch_RuntimeError</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">):</span>
                    <span class="s0">return None</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">exc</span>

            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">):</span>
                <span class="s0">with </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s1">catch_RuntimeError</span><span class="s2">):</span>
                    <span class="s0">raise </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">v</span><span class="s2">, </span><span class="s1">distractor</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__context__ </span><span class="s0">is </span><span class="s1">context</span>
        <span class="s0">assert </span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__suppress_context__ </span><span class="s2">== </span><span class="s1">suppress_context</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">implementation</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s4">&quot;cpython&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Only makes sense with refcounting GC&quot;</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_MultiError_catch_doesnt_create_cyclic_garbage</span><span class="s2">():</span>
    <span class="s5"># https://github.com/python-trio/trio/pull/2063</span>
    <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
    <span class="s1">old_flags </span><span class="s2">= </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_debug</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">make_multi</span><span class="s2">():</span>
        <span class="s5"># make_tree creates cycles itself, so a simple</span>
        <span class="s0">raise </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser1</span><span class="s2">), </span><span class="s1">get_exc</span><span class="s2">(</span><span class="s1">raiser2</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">simple_filter</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">Exception</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">RuntimeError</span><span class="s2">()</span>
        <span class="s0">assert False</span><span class="s2">, </span><span class="s4">&quot;only ValueError and KeyError should exist&quot;  </span><span class="s5"># pragma: no cover</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s1">gc</span><span class="s2">.</span><span class="s1">DEBUG_SAVEALL</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">MultiError</span><span class="s2">):</span>
            <span class="s5"># covers MultiErrorCatcher.__exit__ and _multierror.copy_tb</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">TrioDeprecationWarning</span><span class="s2">), </span><span class="s1">MultiError</span><span class="s2">.</span><span class="s1">catch</span><span class="s2">(</span><span class="s1">simple_filter</span><span class="s2">):</span>
                <span class="s0">raise </span><span class="s1">make_multi</span><span class="s2">()</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
        <span class="s0">assert not </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span>
    <span class="s0">finally</span><span class="s2">:</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">set_debug</span><span class="s2">(</span><span class="s1">old_flags</span><span class="s2">)</span>
        <span class="s1">gc</span><span class="s2">.</span><span class="s1">garbage</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">assert_match_in_seq</span><span class="s2">(</span><span class="s1">pattern_list</span><span class="s2">, </span><span class="s1">string</span><span class="s2">):</span>
    <span class="s1">offset </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;looking for pattern matches...&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">pattern_list</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;checking pattern:&quot;</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">)</span>
        <span class="s1">reobj </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s1">reobj</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s1">string</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">match </span><span class="s0">is not None</span>
        <span class="s1">offset </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_assert_match_in_seq</span><span class="s2">():</span>
    <span class="s1">assert_match_in_seq</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s4">&quot;xx a xx b xx&quot;</span><span class="s2">)</span>
    <span class="s1">assert_match_in_seq</span><span class="s2">([</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s4">&quot;xx b xx a xx&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AssertionError</span><span class="s2">):</span>
        <span class="s1">assert_match_in_seq</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], </span><span class="s4">&quot;xx b xx a xx&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_base_multierror</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot; 
    Test that MultiError() with at least one base exception will return a MultiError 
    object. 
    &quot;&quot;&quot;</span>

    <span class="s1">exc </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">ZeroDivisionError</span><span class="s2">(), </span><span class="s1">KeyboardInterrupt</span><span class="s2">()])</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">) </span><span class="s0">is </span><span class="s1">MultiError</span>


<span class="s0">def </span><span class="s1">test_non_base_multierror</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot; 
    Test that MultiError() without base exceptions will return a NonBaseMultiError 
    object. 
    &quot;&quot;&quot;</span>

    <span class="s1">exc </span><span class="s2">= </span><span class="s1">MultiError</span><span class="s2">([</span><span class="s1">ZeroDivisionError</span><span class="s2">(), </span><span class="s1">ValueError</span><span class="s2">()])</span>
    <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">) </span><span class="s0">is </span><span class="s1">NonBaseMultiError</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">, </span><span class="s1">ExceptionGroup</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">run_script</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">use_ipython</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">trio</span>

    <span class="s1">trio_path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">trio</span><span class="s2">.</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent</span><span class="s2">.</span><span class="s1">parent</span>
    <span class="s1">script_path </span><span class="s2">= </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">parent </span><span class="s2">/ </span><span class="s4">&quot;test_multierror_scripts&quot; </span><span class="s2">/ </span><span class="s1">name</span>

    <span class="s1">env </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">environ</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;parent PYTHONPATH:&quot;</span><span class="s2">, </span><span class="s1">env</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;PYTHONPATH&quot;</span><span class="s2">))</span>
    <span class="s0">if </span><span class="s4">&quot;PYTHONPATH&quot; </span><span class="s0">in </span><span class="s1">env</span><span class="s2">:  </span><span class="s5"># pragma: no cover</span>
        <span class="s1">pp </span><span class="s2">= </span><span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;PYTHONPATH&quot;</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">pathsep</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">pp </span><span class="s2">= []</span>
    <span class="s1">pp</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">trio_path</span><span class="s2">))</span>
    <span class="s1">pp</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">script_path</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">))</span>
    <span class="s1">env</span><span class="s2">[</span><span class="s4">&quot;PYTHONPATH&quot;</span><span class="s2">] = </span><span class="s1">os</span><span class="s2">.</span><span class="s1">pathsep</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;subprocess PYTHONPATH:&quot;</span><span class="s2">, </span><span class="s1">env</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;PYTHONPATH&quot;</span><span class="s2">))</span>

    <span class="s0">if </span><span class="s1">use_ipython</span><span class="s2">:</span>
        <span class="s1">lines </span><span class="s2">= [</span>
            <span class="s4">&quot;import runpy&quot;</span><span class="s2">,</span>
            <span class="s4">f&quot;runpy.run_path(r'</span><span class="s0">{</span><span class="s1">script_path</span><span class="s0">}</span><span class="s4">', run_name='trio.fake')&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;exit()&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>

        <span class="s1">cmd </span><span class="s2">= [</span>
            <span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">,</span>
            <span class="s4">&quot;-u&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;-m&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;IPython&quot;</span><span class="s2">,</span>
            <span class="s5"># no startup files</span>
            <span class="s4">&quot;--quick&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;--TerminalIPythonApp.code_to_run=&quot; </span><span class="s2">+ </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">),</span>
        <span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">cmd </span><span class="s2">= [</span><span class="s1">sys</span><span class="s2">.</span><span class="s1">executable</span><span class="s2">, </span><span class="s4">&quot;-u&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">script_path</span><span class="s2">)]</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;running:&quot;</span><span class="s2">, </span><span class="s1">cmd</span><span class="s2">)</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span>
        <span class="s1">cmd</span><span class="s2">, </span><span class="s1">env</span><span class="s2">=</span><span class="s1">env</span><span class="s2">, </span><span class="s1">stdout</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">PIPE</span><span class="s2">, </span><span class="s1">stderr</span><span class="s2">=</span><span class="s1">subprocess</span><span class="s2">.</span><span class="s1">STDOUT</span>
    <span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;process output:&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">completed</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">completed</span>


<span class="s0">def </span><span class="s1">check_simple_excepthook</span><span class="s2">(</span><span class="s1">completed</span><span class="s2">, </span><span class="s1">uses_ipython</span><span class="s2">):</span>
    <span class="s1">assert_match_in_seq</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s4">&quot;in &lt;cell line: &quot;</span>
            <span class="s0">if </span><span class="s1">uses_ipython </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span>
            <span class="s0">else </span><span class="s4">&quot;in &lt;module&gt;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;MultiError&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;--- 1 ---&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;in exc1_fn&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;ValueError&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;--- 2 ---&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;in exc2_fn&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;KeyError&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">completed</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>


<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">IPython  </span><span class="s5"># noqa: F401</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:  </span><span class="s5"># pragma: no cover</span>
    <span class="s1">have_ipython </span><span class="s2">= </span><span class="s0">False</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s1">have_ipython </span><span class="s2">= </span><span class="s0">True</span>

<span class="s1">need_ipython </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">have_ipython</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;need IPython&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">need_ipython</span>
<span class="s0">def </span><span class="s1">test_ipython_exc_handler</span><span class="s2">():</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s1">run_script</span><span class="s2">(</span><span class="s4">&quot;simple_excepthook.py&quot;</span><span class="s2">, </span><span class="s1">use_ipython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">check_simple_excepthook</span><span class="s2">(</span><span class="s1">completed</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">need_ipython</span>
<span class="s0">def </span><span class="s1">test_ipython_imported_but_unused</span><span class="s2">():</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s1">run_script</span><span class="s2">(</span><span class="s4">&quot;simple_excepthook_IPython.py&quot;</span><span class="s2">)</span>
    <span class="s1">check_simple_excepthook</span><span class="s2">(</span><span class="s1">completed</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">need_ipython</span>
<span class="s0">def </span><span class="s1">test_ipython_custom_exc_handler</span><span class="s2">():</span>
    <span class="s5"># Check we get a nice warning (but only one!) if the user is using IPython</span>
    <span class="s5"># and already has some other set_custom_exc handler installed.</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s1">run_script</span><span class="s2">(</span><span class="s4">&quot;ipython_custom_exc.py&quot;</span><span class="s2">, </span><span class="s1">use_ipython</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">assert_match_in_seq</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s5"># The warning</span>
            <span class="s4">&quot;RuntimeWarning&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;IPython detected&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;skip installing Trio&quot;</span><span class="s2">,</span>
            <span class="s5"># The MultiError</span>
            <span class="s4">&quot;MultiError&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;ValueError&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;KeyError&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">completed</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s5"># Make sure our other warning doesn't show up</span>
    <span class="s0">assert </span><span class="s4">&quot;custom sys.excepthook&quot; </span><span class="s0">not in </span><span class="s1">completed</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s0">not </span><span class="s1">Path</span><span class="s2">(</span><span class="s4">&quot;/usr/lib/python3/dist-packages/apport_python_hook.py&quot;</span><span class="s2">).</span><span class="s1">exists</span><span class="s2">(),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;need Ubuntu with python3-apport installed&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_apport_excepthook_monkeypatch_interaction</span><span class="s2">():</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s1">run_script</span><span class="s2">(</span><span class="s4">&quot;apport_excepthook.py&quot;</span><span class="s2">)</span>
    <span class="s1">stdout </span><span class="s2">= </span><span class="s1">completed</span><span class="s2">.</span><span class="s1">stdout</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s2">)</span>

    <span class="s5"># No warning</span>
    <span class="s0">assert </span><span class="s4">&quot;custom sys.excepthook&quot; </span><span class="s0">not in </span><span class="s1">stdout</span>

    <span class="s5"># Proper traceback</span>
    <span class="s1">assert_match_in_seq</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s4">&quot;--- 1 ---&quot;</span><span class="s2">, </span><span class="s4">&quot;KeyError&quot;</span><span class="s2">, </span><span class="s4">&quot;--- 2 ---&quot;</span><span class="s2">, </span><span class="s4">&quot;ValueError&quot;</span><span class="s2">],</span>
        <span class="s1">stdout</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;protocol&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">HIGHEST_PROTOCOL </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_pickle_multierror</span><span class="s2">(</span><span class="s1">protocol</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s5"># use trio.MultiError to make sure that pickle works through the deprecation layer</span>
    <span class="s0">import </span><span class="s1">trio</span>

    <span class="s1">my_except </span><span class="s2">= </span><span class="s1">ZeroDivisionError</span><span class="s2">()</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s3">1 </span><span class="s2">/ </span><span class="s3">0</span>
    <span class="s0">except </span><span class="s1">ZeroDivisionError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">my_except </span><span class="s2">= </span><span class="s1">e</span>

    <span class="s5"># MultiError will collapse into different classes depending on the errors</span>
    <span class="s0">for </span><span class="s1">cls</span><span class="s2">, </span><span class="s1">errors </span><span class="s0">in </span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">ZeroDivisionError</span><span class="s2">, [</span><span class="s1">my_except</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s1">NonBaseMultiError</span><span class="s2">, [</span><span class="s1">my_except</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">()]),</span>
        <span class="s2">(</span><span class="s1">MultiError</span><span class="s2">, [</span><span class="s1">BaseException</span><span class="s2">(), </span><span class="s1">my_except</span><span class="s2">]),</span>
    <span class="s2">):</span>
        <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s4">&quot;ignore&quot;</span><span class="s2">, </span><span class="s1">TrioDeprecationWarning</span><span class="s2">)</span>
            <span class="s1">me </span><span class="s2">= </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">MultiError</span><span class="s2">(</span><span class="s1">errors</span><span class="s2">)  </span><span class="s5"># type: ignore[attr-defined]</span>
            <span class="s1">dump </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">me</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">protocol</span><span class="s2">)</span>
            <span class="s1">load </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">dump</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">me</span><span class="s2">) == </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">load</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">me</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s2">== </span><span class="s1">load</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s2">== </span><span class="s1">cls</span>

        <span class="s0">assert </span><span class="s1">me</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">() == </span><span class="s1">load</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">me_val</span><span class="s2">, </span><span class="s1">load_val </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">me</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">values</span><span class="s2">(), </span><span class="s1">load</span><span class="s2">.</span><span class="s1">__dict__</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()):</span>
            <span class="s5"># tracebacks etc are not preserved through pickling for the default</span>
            <span class="s5"># exceptions, so we only check that the repr stays the same</span>
            <span class="s0">assert </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">me_val</span><span class="s2">) == </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">load_val</span><span class="s2">)</span>
</pre>
</body>
</html>