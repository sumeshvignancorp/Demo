<html>
<head>
<title>model.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
model.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">types</span>
<span class="s0">import </span><span class="s1">weakref</span>

<span class="s0">from </span><span class="s2">.</span><span class="s1">lock </span><span class="s0">import </span><span class="s1">allocate_lock</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">error </span><span class="s0">import </span><span class="s1">CDefError</span><span class="s2">, </span><span class="s1">VerificationError</span><span class="s2">, </span><span class="s1">VerificationMissing</span>

<span class="s3"># type qualifiers</span>
<span class="s1">Q_CONST    </span><span class="s2">= </span><span class="s4">0x01</span>
<span class="s1">Q_RESTRICT </span><span class="s2">= </span><span class="s4">0x02</span>
<span class="s1">Q_VOLATILE </span><span class="s2">= </span><span class="s4">0x04</span>

<span class="s0">def </span><span class="s1">qualify</span><span class="s2">(</span><span class="s1">quals</span><span class="s2">, </span><span class="s1">replace_with</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">quals </span><span class="s2">&amp; </span><span class="s1">Q_CONST</span><span class="s2">:</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s5">' const ' </span><span class="s2">+ </span><span class="s1">replace_with</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">quals </span><span class="s2">&amp; </span><span class="s1">Q_VOLATILE</span><span class="s2">:</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s5">' volatile ' </span><span class="s2">+ </span><span class="s1">replace_with</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">quals </span><span class="s2">&amp; </span><span class="s1">Q_RESTRICT</span><span class="s2">:</span>
        <span class="s3"># It seems that __restrict is supported by gcc and msvc.</span>
        <span class="s3"># If you hit some different compiler, add a #define in</span>
        <span class="s3"># _cffi_include.h for it (and in its copies, documented there)</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s5">' __restrict ' </span><span class="s2">+ </span><span class="s1">replace_with</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">replace_with</span>


<span class="s0">class </span><span class="s1">BaseTypeByIdentity</span><span class="s2">(</span><span class="s1">object</span><span class="s2">):</span>
    <span class="s1">is_array_type </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">is_raw_function </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">get_c_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">replace_with</span><span class="s2">=</span><span class="s5">''</span><span class="s2">, </span><span class="s1">context</span><span class="s2">=</span><span class="s5">'a C file'</span><span class="s2">, </span><span class="s1">quals</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s3"># some logic duplication with ffi.getctype()... :-(</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s1">replace_with</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">replace_with</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">replace_with</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">'*'</span><span class="s2">) </span><span class="s0">and </span><span class="s5">'&amp;[' </span><span class="s0">in </span><span class="s1">result</span><span class="s2">:</span>
                <span class="s1">replace_with </span><span class="s2">= </span><span class="s5">'(%s)' </span><span class="s2">% </span><span class="s1">replace_with</span>
            <span class="s0">elif not </span><span class="s1">replace_with</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">in </span><span class="s5">'[('</span><span class="s2">:</span>
                <span class="s1">replace_with </span><span class="s2">= </span><span class="s5">' ' </span><span class="s2">+ </span><span class="s1">replace_with</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s1">qualify</span><span class="s2">(</span><span class="s1">quals</span><span class="s2">, </span><span class="s1">replace_with</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">, </span><span class="s1">replace_with</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s5">'$' </span><span class="s0">in </span><span class="s1">result</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">VerificationError</span><span class="s2">(</span>
                <span class="s5">&quot;cannot generate '%s' in %s: unknown type name&quot;</span>
                <span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">(), </span><span class="s1">context</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">result</span>

    <span class="s0">def </span><span class="s1">_get_c_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">, </span><span class="s5">''</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">has_c_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'$' </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">is_integer_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return False</span>

    <span class="s0">def </span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">, </span><span class="s1">can_delay</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">BType </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_cached_btypes</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s1">BType </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
            <span class="s1">BType2 </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_cached_btypes</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">BType</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">BType2 </span><span class="s0">is </span><span class="s1">BType</span>
        <span class="s0">return </span><span class="s1">BType</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s5">'&lt;%s&gt;' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">(),)</span>

    <span class="s0">def </span><span class="s1">_get_items</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_attrs_</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">BaseType</span><span class="s2">(</span><span class="s1">BaseTypeByIdentity</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">__class__ </span><span class="s0">and</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_get_items</span><span class="s2">() == </span><span class="s1">other</span><span class="s2">.</span><span class="s1">_get_items</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">__ne__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">):</span>
        <span class="s0">return not </span><span class="s1">self </span><span class="s2">== </span><span class="s1">other</span>

    <span class="s0">def </span><span class="s1">__hash__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">hash</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_items</span><span class="s2">())))</span>


<span class="s0">class </span><span class="s1">VoidType</span><span class="s2">(</span><span class="s1">BaseType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= ()</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s5">'void&amp;'</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_void_type'</span><span class="s2">)</span>

<span class="s1">void_type </span><span class="s2">= </span><span class="s1">VoidType</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">BasePrimitiveType</span><span class="s2">(</span><span class="s1">BaseType</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">is_complex_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return False</span>


<span class="s0">class </span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s1">BasePrimitiveType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'name'</span><span class="s2">,)</span>

    <span class="s1">ALL_PRIMITIVE_TYPES </span><span class="s2">= {</span>
        <span class="s5">'char'</span><span class="s2">:               </span><span class="s5">'c'</span><span class="s2">,</span>
        <span class="s5">'short'</span><span class="s2">:              </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int'</span><span class="s2">:                </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'long'</span><span class="s2">:               </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'long long'</span><span class="s2">:          </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'signed char'</span><span class="s2">:        </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'unsigned char'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'unsigned short'</span><span class="s2">:     </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'unsigned int'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'unsigned long'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'unsigned long long'</span><span class="s2">: </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'float'</span><span class="s2">:              </span><span class="s5">'f'</span><span class="s2">,</span>
        <span class="s5">'double'</span><span class="s2">:             </span><span class="s5">'f'</span><span class="s2">,</span>
        <span class="s5">'long double'</span><span class="s2">:        </span><span class="s5">'f'</span><span class="s2">,</span>
        <span class="s5">'float _Complex'</span><span class="s2">:     </span><span class="s5">'j'</span><span class="s2">,</span>
        <span class="s5">'double _Complex'</span><span class="s2">:    </span><span class="s5">'j'</span><span class="s2">,</span>
        <span class="s5">'_Bool'</span><span class="s2">:              </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s3"># the following types are not primitive in the C sense</span>
        <span class="s5">'wchar_t'</span><span class="s2">:            </span><span class="s5">'c'</span><span class="s2">,</span>
        <span class="s5">'char16_t'</span><span class="s2">:           </span><span class="s5">'c'</span><span class="s2">,</span>
        <span class="s5">'char32_t'</span><span class="s2">:           </span><span class="s5">'c'</span><span class="s2">,</span>
        <span class="s5">'int8_t'</span><span class="s2">:             </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint8_t'</span><span class="s2">:            </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int16_t'</span><span class="s2">:            </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint16_t'</span><span class="s2">:           </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int32_t'</span><span class="s2">:            </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint32_t'</span><span class="s2">:           </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int64_t'</span><span class="s2">:            </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint64_t'</span><span class="s2">:           </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_least8_t'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_least8_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_least16_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_least16_t'</span><span class="s2">:     </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_least32_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_least32_t'</span><span class="s2">:     </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_least64_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_least64_t'</span><span class="s2">:     </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_fast8_t'</span><span class="s2">:        </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_fast8_t'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_fast16_t'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_fast16_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_fast32_t'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_fast32_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'int_fast64_t'</span><span class="s2">:       </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uint_fast64_t'</span><span class="s2">:      </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'intptr_t'</span><span class="s2">:           </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uintptr_t'</span><span class="s2">:          </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'intmax_t'</span><span class="s2">:           </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'uintmax_t'</span><span class="s2">:          </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'ptrdiff_t'</span><span class="s2">:          </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'size_t'</span><span class="s2">:             </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s5">'ssize_t'</span><span class="s2">:            </span><span class="s5">'i'</span><span class="s2">,</span>
        <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">name </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ALL_PRIMITIVE_TYPES</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s5">'&amp;'</span>

    <span class="s0">def </span><span class="s1">is_char_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ALL_PRIMITIVE_TYPES</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] == </span><span class="s5">'c'</span>
    <span class="s0">def </span><span class="s1">is_integer_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ALL_PRIMITIVE_TYPES</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] == </span><span class="s5">'i'</span>
    <span class="s0">def </span><span class="s1">is_float_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ALL_PRIMITIVE_TYPES</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] == </span><span class="s5">'f'</span>
    <span class="s0">def </span><span class="s1">is_complex_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ALL_PRIMITIVE_TYPES</span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">] == </span><span class="s5">'j'</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_primitive_type'</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">UnknownIntegerType</span><span class="s2">(</span><span class="s1">BasePrimitiveType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'name'</span><span class="s2">,)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s5">'&amp;'</span>

    <span class="s0">def </span><span class="s1">is_integer_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s5">&quot;integer type '%s' can only be used after &quot;</span>
                                  <span class="s5">&quot;compilation&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

<span class="s0">class </span><span class="s1">UnknownFloatType</span><span class="s2">(</span><span class="s1">BasePrimitiveType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'name'</span><span class="s2">, )</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s5">'&amp;'</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s5">&quot;float type '%s' can only be used after &quot;</span>
                                  <span class="s5">&quot;compilation&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BaseFunctionType</span><span class="s2">(</span><span class="s1">BaseType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'args'</span><span class="s2">, </span><span class="s5">'result'</span><span class="s2">, </span><span class="s5">'ellipsis'</span><span class="s2">, </span><span class="s5">'abi'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">result</span><span class="s2">, </span><span class="s1">ellipsis</span><span class="s2">, </span><span class="s1">abi</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= </span><span class="s1">args</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">result </span><span class="s2">= </span><span class="s1">result</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis </span><span class="s2">= </span><span class="s1">ellipsis</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">abi </span><span class="s2">= </span><span class="s1">abi</span>
        <span class="s3">#</span>
        <span class="s1">reprargs </span><span class="s2">= [</span><span class="s1">arg</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">() </span><span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis</span><span class="s2">:</span>
            <span class="s1">reprargs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s5">'...'</span><span class="s2">)</span>
        <span class="s1">reprargs </span><span class="s2">= </span><span class="s1">reprargs </span><span class="s0">or </span><span class="s2">[</span><span class="s5">'void'</span><span class="s2">]</span>
        <span class="s1">replace_with </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_base_pattern </span><span class="s2">% (</span><span class="s5">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">reprargs</span><span class="s2">),)</span>
        <span class="s0">if </span><span class="s1">abi </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">replace_with </span><span class="s2">= </span><span class="s1">replace_with</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">abi </span><span class="s2">+ </span><span class="s5">' ' </span><span class="s2">+ </span><span class="s1">replace_with</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">result</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">, </span><span class="s1">replace_with</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">RawFunctionType</span><span class="s2">(</span><span class="s1">BaseFunctionType</span><span class="s2">):</span>
    <span class="s3"># Corresponds to a C type like 'int(int)', which is the C type of</span>
    <span class="s3"># a function, but not a pointer-to-function.  The backend has no</span>
    <span class="s3"># notion of such a type; it's used temporarily by parsing.</span>
    <span class="s1">_base_pattern </span><span class="s2">= </span><span class="s5">'(&amp;)(%s)'</span>
    <span class="s1">is_raw_function </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">CDefError</span><span class="s2">(</span><span class="s5">&quot;cannot render the type %r: it is a function &quot;</span>
                        <span class="s5">&quot;type, not a pointer-to-function type&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">,))</span>

    <span class="s0">def </span><span class="s1">as_function_pointer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">FunctionPtrType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">result</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">abi</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">FunctionPtrType</span><span class="s2">(</span><span class="s1">BaseFunctionType</span><span class="s2">):</span>
    <span class="s1">_base_pattern </span><span class="s2">= </span><span class="s5">'(*&amp;)(%s)'</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">result</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">tp </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">:</span>
            <span class="s1">args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">))</span>
        <span class="s1">abi_args </span><span class="s2">= ()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">abi </span><span class="s2">== </span><span class="s5">&quot;__stdcall&quot;</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis</span><span class="s2">:    </span><span class="s3"># __stdcall ignored for variadic funcs</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">abi_args </span><span class="s2">= (</span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_backend</span><span class="s2">.</span><span class="s1">FFI_STDCALL</span><span class="s2">,)</span>
                <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
                    <span class="s0">pass</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_function_type'</span><span class="s2">,</span>
                            <span class="s1">tuple</span><span class="s2">(</span><span class="s1">args</span><span class="s2">), </span><span class="s1">result</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis</span><span class="s2">, *</span><span class="s1">abi_args</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">as_raw_function</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">RawFunctionType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">args</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">result</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ellipsis</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">abi</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">BaseType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'totype'</span><span class="s2">, </span><span class="s5">'quals'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">totype</span><span class="s2">, </span><span class="s1">quals</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">totype </span><span class="s2">= </span><span class="s1">totype</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">quals </span><span class="s2">= </span><span class="s1">quals</span>
        <span class="s1">extra </span><span class="s2">= </span><span class="s1">qualify</span><span class="s2">(</span><span class="s1">quals</span><span class="s2">, </span><span class="s5">&quot; *&amp;&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">totype</span><span class="s2">.</span><span class="s1">is_array_type</span><span class="s2">:</span>
            <span class="s1">extra </span><span class="s2">= </span><span class="s5">&quot;(%s)&quot; </span><span class="s2">% (</span><span class="s1">extra</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(),)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">totype</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">, </span><span class="s1">extra</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s1">BItem </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">totype</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">, </span><span class="s1">can_delay</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_pointer_type'</span><span class="s2">, </span><span class="s1">BItem</span><span class="s2">)</span>

<span class="s1">voidp_type </span><span class="s2">= </span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">void_type</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">ConstPointerType</span><span class="s2">(</span><span class="s1">totype</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">totype</span><span class="s2">, </span><span class="s1">Q_CONST</span><span class="s2">)</span>

<span class="s1">const_voidp_type </span><span class="s2">= </span><span class="s1">ConstPointerType</span><span class="s2">(</span><span class="s1">void_type</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">NamedPointerType</span><span class="s2">(</span><span class="s1">PointerType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'totype'</span><span class="s2">, </span><span class="s5">'name'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">totype</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">quals</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s1">PointerType</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">totype</span><span class="s2">, </span><span class="s1">quals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s5">'&amp;'</span>


<span class="s0">class </span><span class="s1">ArrayType</span><span class="s2">(</span><span class="s1">BaseType</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'item'</span><span class="s2">, </span><span class="s5">'length'</span><span class="s2">)</span>
    <span class="s1">is_array_type </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">, </span><span class="s1">length</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">item </span><span class="s2">= </span><span class="s1">item</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">length </span><span class="s2">= </span><span class="s1">length</span>
        <span class="s3">#</span>
        <span class="s0">if </span><span class="s1">length </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">brackets </span><span class="s2">= </span><span class="s5">'&amp;[]'</span>
        <span class="s0">elif </span><span class="s1">length </span><span class="s2">== </span><span class="s5">'...'</span><span class="s2">:</span>
            <span class="s1">brackets </span><span class="s2">= </span><span class="s5">'&amp;[/*...*/]'</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">brackets </span><span class="s2">= </span><span class="s5">'&amp;[%s]' </span><span class="s2">% </span><span class="s1">length</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= (</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">item</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">, </span><span class="s1">brackets</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">length_is_unknown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">length</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">resolve_length</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">newlength</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">ArrayType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">item</span><span class="s2">, </span><span class="s1">newlength</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length_is_unknown</span><span class="s2">():</span>
            <span class="s0">raise </span><span class="s1">CDefError</span><span class="s2">(</span><span class="s5">&quot;cannot render the type %r: unknown length&quot; </span><span class="s2">%</span>
                            <span class="s2">(</span><span class="s1">self</span><span class="s2">,))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">item</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)   </span><span class="s3"># force the item BType</span>
        <span class="s1">BPtrItem </span><span class="s2">= </span><span class="s1">PointerType</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">item</span><span class="s2">).</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_array_type'</span><span class="s2">, </span><span class="s1">BPtrItem</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">length</span><span class="s2">)</span>

<span class="s1">char_array_type </span><span class="s2">= </span><span class="s1">ArrayType</span><span class="s2">(</span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s5">'char'</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StructOrUnionOrEnum</span><span class="s2">(</span><span class="s1">BaseTypeByIdentity</span><span class="s2">):</span>
    <span class="s1">_attrs_ </span><span class="s2">= (</span><span class="s5">'name'</span><span class="s2">,)</span>
    <span class="s1">forcename </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">build_c_name_with_marker</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">forcename </span><span class="s0">or </span><span class="s5">'%s %s' </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker </span><span class="s2">= </span><span class="s1">name </span><span class="s2">+ </span><span class="s5">'&amp;'</span>

    <span class="s0">def </span><span class="s1">force_the_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">forcename</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">forcename </span><span class="s2">= </span><span class="s1">forcename</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">build_c_name_with_marker</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">get_official_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s5">'&amp;'</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c_name_with_marker</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">StructOrUnion</span><span class="s2">(</span><span class="s1">StructOrUnionOrEnum</span><span class="s2">):</span>
    <span class="s1">fixedlayout </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">completed </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">partial </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">packed </span><span class="s2">= </span><span class="s4">0</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">fldnames</span><span class="s2">, </span><span class="s1">fldtypes</span><span class="s2">, </span><span class="s1">fldbitsize</span><span class="s2">, </span><span class="s1">fldquals</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames </span><span class="s2">= </span><span class="s1">fldnames</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes </span><span class="s2">= </span><span class="s1">fldtypes</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldbitsize </span><span class="s2">= </span><span class="s1">fldbitsize</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldquals </span><span class="s2">= </span><span class="s1">fldquals</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">build_c_name_with_marker</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">anonymous_struct_fields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">type </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s5">'' </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">StructOrUnion</span><span class="s2">):</span>
                    <span class="s0">yield </span><span class="s1">type</span>

    <span class="s0">def </span><span class="s1">enumfields</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">expand_anonymous_struct_union</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">fldquals </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldquals</span>
        <span class="s0">if </span><span class="s1">fldquals </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">fldquals </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">,) * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">, </span><span class="s1">quals </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">,</span>
                                              <span class="s1">self</span><span class="s2">.</span><span class="s1">fldbitsize</span><span class="s2">, </span><span class="s1">fldquals</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">== </span><span class="s5">'' </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">StructOrUnion</span><span class="s2">)</span>
                    <span class="s0">and </span><span class="s1">expand_anonymous_struct_union</span><span class="s2">):</span>
                <span class="s3"># nested anonymous struct/union</span>
                <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">type</span><span class="s2">.</span><span class="s1">enumfields</span><span class="s2">():</span>
                    <span class="s0">yield </span><span class="s1">result</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">yield </span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">, </span><span class="s1">quals</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">force_flatten</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># force the struct or union to have a declaration that lists</span>
        <span class="s3"># directly all fields returned by enumfields(), flattening</span>
        <span class="s3"># nested anonymous structs/unions.</span>
        <span class="s1">names </span><span class="s2">= []</span>
        <span class="s1">types </span><span class="s2">= []</span>
        <span class="s1">bitsizes </span><span class="s2">= []</span>
        <span class="s1">fldquals </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">bitsize</span><span class="s2">, </span><span class="s1">quals </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumfields</span><span class="s2">():</span>
            <span class="s1">names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">type</span><span class="s2">)</span>
            <span class="s1">bitsizes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bitsize</span><span class="s2">)</span>
            <span class="s1">fldquals</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">quals</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">names</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">types</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldbitsize </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">bitsizes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">fldquals </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">fldquals</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">, </span><span class="s1">can_delay</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">BType </span><span class="s2">= </span><span class="s1">StructOrUnionOrEnum</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">,</span>
                                                     <span class="s1">can_delay</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">can_delay</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">finish_backend_type</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">BType</span>

    <span class="s0">def </span><span class="s1">finish_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">completed</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">completed </span><span class="s2">!= </span><span class="s4">2</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s5">&quot;recursive structure declaration &quot;</span>
                                          <span class="s5">&quot;for '%s'&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,))</span>
            <span class="s0">return</span>
        <span class="s1">BType </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_cached_btypes</span><span class="s2">[</span><span class="s1">self</span><span class="s2">]</span>
        <span class="s3">#</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">completed </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s3">#</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">pass    </span><span class="s3"># not completing it: it's an opaque struct</span>
            <span class="s3">#</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fixedlayout </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">fldtypes </span><span class="s2">= [</span><span class="s1">tp</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
                        <span class="s0">for </span><span class="s1">tp </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">]</span>
            <span class="s1">lst </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">, </span><span class="s1">fldtypes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldbitsize</span><span class="s2">))</span>
            <span class="s1">extra_flags </span><span class="s2">= ()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packed</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packed </span><span class="s2">== </span><span class="s4">1</span><span class="s2">:</span>
                    <span class="s1">extra_flags </span><span class="s2">= (</span><span class="s4">8</span><span class="s2">,)    </span><span class="s3"># SF_PACKED</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">extra_flags </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">packed</span><span class="s2">)</span>
            <span class="s1">ffi</span><span class="s2">.</span><span class="s1">_backend</span><span class="s2">.</span><span class="s1">complete_struct_or_union</span><span class="s2">(</span><span class="s1">BType</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                                  <span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, *</span><span class="s1">extra_flags</span><span class="s2">)</span>
            <span class="s3">#</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fldtypes </span><span class="s2">= []</span>
            <span class="s1">fieldofs</span><span class="s2">, </span><span class="s1">fieldsize</span><span class="s2">, </span><span class="s1">totalsize</span><span class="s2">, </span><span class="s1">totalalignment </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fixedlayout</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">)):</span>
                <span class="s1">fsize </span><span class="s2">= </span><span class="s1">fieldsize</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s1">ftype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                <span class="s3">#</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ftype</span><span class="s2">, </span><span class="s1">ArrayType</span><span class="s2">) </span><span class="s0">and </span><span class="s1">ftype</span><span class="s2">.</span><span class="s1">length_is_unknown</span><span class="s2">():</span>
                    <span class="s3"># fix the length to match the total size</span>
                    <span class="s1">BItemType </span><span class="s2">= </span><span class="s1">ftype</span><span class="s2">.</span><span class="s1">item</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
                    <span class="s1">nlen</span><span class="s2">, </span><span class="s1">nrest </span><span class="s2">= </span><span class="s1">divmod</span><span class="s2">(</span><span class="s1">fsize</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">BItemType</span><span class="s2">))</span>
                    <span class="s0">if </span><span class="s1">nrest </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_verification_error</span><span class="s2">(</span>
                            <span class="s5">&quot;field '%s.%s' has a bogus size?&quot; </span><span class="s2">% (</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">or </span><span class="s5">'{}'</span><span class="s2">))</span>
                    <span class="s1">ftype </span><span class="s2">= </span><span class="s1">ftype</span><span class="s2">.</span><span class="s1">resolve_length</span><span class="s2">(</span><span class="s1">nlen</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes </span><span class="s2">= (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">] + (</span><span class="s1">ftype</span><span class="s2">,) +</span>
                                     <span class="s1">self</span><span class="s2">.</span><span class="s1">fldtypes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:])</span>
                <span class="s3">#</span>
                <span class="s1">BFieldType </span><span class="s2">= </span><span class="s1">ftype</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ftype</span><span class="s2">, </span><span class="s1">ArrayType</span><span class="s2">) </span><span class="s0">and </span><span class="s1">ftype</span><span class="s2">.</span><span class="s1">length </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">assert </span><span class="s1">fsize </span><span class="s2">== </span><span class="s4">0</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">bitemsize </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">BFieldType</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">bitemsize </span><span class="s2">!= </span><span class="s1">fsize</span><span class="s2">:</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">_verification_error</span><span class="s2">(</span>
                            <span class="s5">&quot;field '%s.%s' is declared as %d bytes, but is &quot;</span>
                            <span class="s5">&quot;really %d bytes&quot; </span><span class="s2">% (</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
                                                 <span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">or </span><span class="s5">'{}'</span><span class="s2">,</span>
                                                 <span class="s1">bitemsize</span><span class="s2">, </span><span class="s1">fsize</span><span class="s2">))</span>
                <span class="s1">fldtypes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">BFieldType</span><span class="s2">)</span>
            <span class="s3">#</span>
            <span class="s1">lst </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldnames</span><span class="s2">, </span><span class="s1">fldtypes</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fldbitsize</span><span class="s2">, </span><span class="s1">fieldofs</span><span class="s2">))</span>
            <span class="s1">ffi</span><span class="s2">.</span><span class="s1">_backend</span><span class="s2">.</span><span class="s1">complete_struct_or_union</span><span class="s2">(</span><span class="s1">BType</span><span class="s2">, </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                                                  <span class="s1">totalsize</span><span class="s2">, </span><span class="s1">totalalignment</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">completed </span><span class="s2">= </span><span class="s4">2</span>

    <span class="s0">def </span><span class="s1">_verification_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">VerificationError</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_not_partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">partial </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">fixedlayout </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">VerificationMissing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_not_partial</span><span class="s2">()</span>
        <span class="s1">finishlist</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s3">#</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_%s_type' </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">kind</span><span class="s2">,</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_official_name</span><span class="s2">(), </span><span class="s1">key</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">StructType</span><span class="s2">(</span><span class="s1">StructOrUnion</span><span class="s2">):</span>
    <span class="s1">kind </span><span class="s2">= </span><span class="s5">'struct'</span>


<span class="s0">class </span><span class="s1">UnionType</span><span class="s2">(</span><span class="s1">StructOrUnion</span><span class="s2">):</span>
    <span class="s1">kind </span><span class="s2">= </span><span class="s5">'union'</span>


<span class="s0">class </span><span class="s1">EnumType</span><span class="s2">(</span><span class="s1">StructOrUnionOrEnum</span><span class="s2">):</span>
    <span class="s1">kind </span><span class="s2">= </span><span class="s5">'enum'</span>
    <span class="s1">partial </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">partial_resolved </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">enumerators</span><span class="s2">, </span><span class="s1">enumvalues</span><span class="s2">, </span><span class="s1">baseinttype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enumerators </span><span class="s2">= </span><span class="s1">enumerators</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">enumvalues </span><span class="s2">= </span><span class="s1">enumvalues</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">baseinttype </span><span class="s2">= </span><span class="s1">baseinttype</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">build_c_name_with_marker</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">force_the_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">forcename</span><span class="s2">):</span>
        <span class="s1">StructOrUnionOrEnum</span><span class="s2">.</span><span class="s1">force_the_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">forcename</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">forcename </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_official_name</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">forcename </span><span class="s2">= </span><span class="s5">'$' </span><span class="s2">+ </span><span class="s1">name</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s5">' '</span><span class="s2">, </span><span class="s5">'_'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check_not_partial</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">partial </span><span class="s0">and not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">partial_resolved</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">VerificationMissing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">build_backend_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_not_partial</span><span class="s2">()</span>
        <span class="s1">base_btype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build_baseinttype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_enum_type'</span><span class="s2">,</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">get_official_name</span><span class="s2">(),</span>
                            <span class="s1">self</span><span class="s2">.</span><span class="s1">enumerators</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumvalues</span><span class="s2">,</span>
                            <span class="s1">base_btype</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">build_baseinttype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">baseinttype </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">baseinttype</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s3">#</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumvalues</span><span class="s2">:</span>
            <span class="s1">smallest_value </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumvalues</span><span class="s2">)</span>
            <span class="s1">largest_value </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">enumvalues</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">import </span><span class="s1">warnings</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s3"># XXX!  The goal is to ensure that the warnings.warn()</span>
                <span class="s3"># will not suppress the warning.  We want to get it</span>
                <span class="s3"># several times if we reach this point several times.</span>
                <span class="s1">__warningregistry__</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">NameError</span><span class="s2">:</span>
                <span class="s0">pass</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;%r has no values explicitly defined; &quot;</span>
                          <span class="s5">&quot;guessing that it is equivalent to 'unsigned int'&quot;</span>
                          <span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">())</span>
            <span class="s1">smallest_value </span><span class="s2">= </span><span class="s1">largest_value </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s0">if </span><span class="s1">smallest_value </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:   </span><span class="s3"># needs a signed type</span>
            <span class="s1">sign </span><span class="s2">= </span><span class="s4">1</span>
            <span class="s1">candidate1 </span><span class="s2">= </span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s5">&quot;int&quot;</span><span class="s2">)</span>
            <span class="s1">candidate2 </span><span class="s2">= </span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s5">&quot;long&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">sign </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">candidate1 </span><span class="s2">= </span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s5">&quot;unsigned int&quot;</span><span class="s2">)</span>
            <span class="s1">candidate2 </span><span class="s2">= </span><span class="s1">PrimitiveType</span><span class="s2">(</span><span class="s5">&quot;unsigned long&quot;</span><span class="s2">)</span>
        <span class="s1">btype1 </span><span class="s2">= </span><span class="s1">candidate1</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s1">btype2 </span><span class="s2">= </span><span class="s1">candidate2</span><span class="s2">.</span><span class="s1">get_cached_btype</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">finishlist</span><span class="s2">)</span>
        <span class="s1">size1 </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">btype1</span><span class="s2">)</span>
        <span class="s1">size2 </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">sizeof</span><span class="s2">(</span><span class="s1">btype2</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">smallest_value </span><span class="s2">&gt;= ((-</span><span class="s4">1</span><span class="s2">) &lt;&lt; (</span><span class="s4">8</span><span class="s2">*</span><span class="s1">size1</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)) </span><span class="s0">and</span>
            <span class="s1">largest_value </span><span class="s2">&lt; (</span><span class="s4">1 </span><span class="s2">&lt;&lt; (</span><span class="s4">8</span><span class="s2">*</span><span class="s1">size1</span><span class="s2">-</span><span class="s1">sign</span><span class="s2">))):</span>
            <span class="s0">return </span><span class="s1">btype1</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">smallest_value </span><span class="s2">&gt;= ((-</span><span class="s4">1</span><span class="s2">) &lt;&lt; (</span><span class="s4">8</span><span class="s2">*</span><span class="s1">size2</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)) </span><span class="s0">and</span>
            <span class="s1">largest_value </span><span class="s2">&lt; (</span><span class="s4">1 </span><span class="s2">&lt;&lt; (</span><span class="s4">8</span><span class="s2">*</span><span class="s1">size2</span><span class="s2">-</span><span class="s1">sign</span><span class="s2">))):</span>
            <span class="s0">return </span><span class="s1">btype2</span>
        <span class="s0">raise </span><span class="s1">CDefError</span><span class="s2">(</span><span class="s5">&quot;%s values don't all fit into either 'long' &quot;</span>
                        <span class="s5">&quot;or 'unsigned long'&quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_c_name</span><span class="s2">())</span>

<span class="s0">def </span><span class="s1">unknown_type</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">structname</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">structname </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">structname </span><span class="s2">= </span><span class="s5">'$%s' </span><span class="s2">% </span><span class="s1">name</span>
    <span class="s1">tp </span><span class="s2">= </span><span class="s1">StructType</span><span class="s2">(</span><span class="s1">structname</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">tp</span><span class="s2">.</span><span class="s1">force_the_name</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s1">tp</span><span class="s2">.</span><span class="s1">origin </span><span class="s2">= </span><span class="s5">&quot;unknown_type&quot;</span>
    <span class="s0">return </span><span class="s1">tp</span>

<span class="s0">def </span><span class="s1">unknown_ptr_type</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">structname</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">structname </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">structname </span><span class="s2">= </span><span class="s5">'$$%s' </span><span class="s2">% </span><span class="s1">name</span>
    <span class="s1">tp </span><span class="s2">= </span><span class="s1">StructType</span><span class="s2">(</span><span class="s1">structname</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">NamedPointerType</span><span class="s2">(</span><span class="s1">tp</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>


<span class="s1">global_lock </span><span class="s2">= </span><span class="s1">allocate_lock</span><span class="s2">()</span>
<span class="s1">_typecache_cffi_backend </span><span class="s2">= </span><span class="s1">weakref</span><span class="s2">.</span><span class="s1">WeakValueDictionary</span><span class="s2">()</span>

<span class="s0">def </span><span class="s1">get_typecache</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">):</span>
    <span class="s3"># returns _typecache_cffi_backend if backend is the _cffi_backend</span>
    <span class="s3"># module, or type(backend).__typecache if backend is an instance of</span>
    <span class="s3"># CTypesBackend (or some FakeBackend class during tests)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">, </span><span class="s1">types</span><span class="s2">.</span><span class="s1">ModuleType</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">_typecache_cffi_backend</span>
    <span class="s0">with </span><span class="s1">global_lock</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">), </span><span class="s5">'__typecache'</span><span class="s2">):</span>
            <span class="s1">type</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">).</span><span class="s1">__typecache </span><span class="s2">= </span><span class="s1">weakref</span><span class="s2">.</span><span class="s1">WeakValueDictionary</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">type</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">).</span><span class="s1">__typecache</span>

<span class="s0">def </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s1">srctype</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwds</span><span class="s2">):</span>
    <span class="s1">key </span><span class="s2">= </span><span class="s1">kwds</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s5">'key'</span><span class="s2">, (</span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">args</span><span class="s2">))</span>
    <span class="s0">assert not </span><span class="s1">kwds</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_typecache</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
    <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_backend</span><span class="s2">, </span><span class="s1">funcname</span><span class="s2">)(*</span><span class="s1">args</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">NotImplementedError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">(</span><span class="s5">&quot;%s: %r: %s&quot; </span><span class="s2">% (</span><span class="s1">funcname</span><span class="s2">, </span><span class="s1">srctype</span><span class="s2">, </span><span class="s1">e</span><span class="s2">))</span>
    <span class="s3"># note that setdefault() on WeakValueDictionary is not atomic</span>
    <span class="s3"># and contains a rare bug (http://bugs.python.org/issue19542);</span>
    <span class="s3"># we have to use a lock and do it ourselves</span>
    <span class="s1">cache </span><span class="s2">= </span><span class="s1">ffi</span><span class="s2">.</span><span class="s1">_typecache</span>
    <span class="s0">with </span><span class="s1">global_lock</span><span class="s2">:</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">cache</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">res1 </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">cache</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">res</span>
            <span class="s0">return </span><span class="s1">res</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">res1</span>

<span class="s0">def </span><span class="s1">pointer_cache</span><span class="s2">(</span><span class="s1">ffi</span><span class="s2">, </span><span class="s1">BType</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">global_cache</span><span class="s2">(</span><span class="s5">'?'</span><span class="s2">, </span><span class="s1">ffi</span><span class="s2">, </span><span class="s5">'new_pointer_type'</span><span class="s2">, </span><span class="s1">BType</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">attach_exception_info</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">e</span><span class="s2">.</span><span class="s1">args </span><span class="s0">and </span><span class="s1">type</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) </span><span class="s0">is </span><span class="s1">str</span><span class="s2">:</span>
        <span class="s1">e</span><span class="s2">.</span><span class="s1">args </span><span class="s2">= (</span><span class="s5">'%s: %s' </span><span class="s2">% (</span><span class="s1">name</span><span class="s2">, </span><span class="s1">e</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]),) + </span><span class="s1">e</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>
</pre>
</body>
</html>