<html>
<head>
<title>test_ssl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ssl.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">socket </span><span class="s0">as </span><span class="s1">stdlib_socket</span>
<span class="s0">import </span><span class="s1">ssl</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">threading</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">asynccontextmanager</span><span class="s2">, </span><span class="s1">contextmanager</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">trustme</span>
<span class="s0">from </span><span class="s1">OpenSSL </span><span class="s0">import </span><span class="s1">SSL</span>

<span class="s0">import </span><span class="s1">trio</span>

<span class="s0">from </span><span class="s2">.. </span><span class="s0">import </span><span class="s1">_core</span><span class="s2">, </span><span class="s1">socket </span><span class="s0">as </span><span class="s1">tsocket</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_core </span><span class="s0">import </span><span class="s1">BrokenResourceError</span><span class="s2">, </span><span class="s1">ClosedResourceError</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">_tests</span><span class="s2">.</span><span class="s1">tutil </span><span class="s0">import </span><span class="s1">slow</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_highlevel_generic </span><span class="s0">import </span><span class="s1">aclose_forcefully</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_highlevel_open_tcp_stream </span><span class="s0">import </span><span class="s1">open_tcp_stream</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_highlevel_socket </span><span class="s0">import </span><span class="s1">SocketListener</span><span class="s2">, </span><span class="s1">SocketStream</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_ssl </span><span class="s0">import </span><span class="s1">NeedHandshakeError</span><span class="s2">, </span><span class="s1">SSLListener</span><span class="s2">, </span><span class="s1">SSLStream</span><span class="s2">, </span><span class="s1">_is_eof</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">ConflictDetector</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">Sequencer</span><span class="s2">,</span>
    <span class="s1">assert_checkpoints</span><span class="s2">,</span>
    <span class="s1">check_two_way_stream</span><span class="s2">,</span>
    <span class="s1">lockstep_stream_pair</span><span class="s2">,</span>
    <span class="s1">memory_stream_pair</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">_pytest</span><span class="s2">.</span><span class="s1">mark </span><span class="s0">import </span><span class="s1">MarkDecorator</span>


<span class="s3"># We have two different kinds of echo server fixtures we use for testing. The</span>
<span class="s3"># first is a real server written using the stdlib ssl module and blocking</span>
<span class="s3"># sockets. It runs in a thread and we talk to it over a real socketpair(), to</span>
<span class="s3"># validate interoperability in a semi-realistic setting.</span>
<span class="s3">#</span>
<span class="s3"># The second is a very weird virtual echo server that lives inside a custom</span>
<span class="s3"># Stream class. It lives entirely inside the Python object space; there are no</span>
<span class="s3"># operating system calls in it at all. No threads, no I/O, nothing. It's</span>
<span class="s3"># 'send_all' call takes encrypted data from a client and feeds it directly into</span>
<span class="s3"># the server-side TLS state engine to decrypt, then takes that data, feeds it</span>
<span class="s3"># back through to get the encrypted response, and returns it from 'receive_some'. This</span>
<span class="s3"># gives us full control and reproducibility. This server is written using</span>
<span class="s3"># PyOpenSSL, so that we can trigger renegotiations on demand. It also allows</span>
<span class="s3"># us to insert random (virtual) delays, to really exercise all the weird paths</span>
<span class="s3"># in SSLStream's state engine.</span>
<span class="s3">#</span>
<span class="s3"># Both present a certificate for &quot;trio-test-1.example.org&quot;.</span>

<span class="s1">TRIO_TEST_CA </span><span class="s2">= </span><span class="s1">trustme</span><span class="s2">.</span><span class="s1">CA</span><span class="s2">()</span>
<span class="s1">TRIO_TEST_1_CERT </span><span class="s2">= </span><span class="s1">TRIO_TEST_CA</span><span class="s2">.</span><span class="s1">issue_server_cert</span><span class="s2">(</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>

<span class="s1">SERVER_CTX </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">(</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">Purpose</span><span class="s2">.</span><span class="s1">CLIENT_AUTH</span><span class="s2">)</span>
<span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">ssl</span><span class="s2">, </span><span class="s4">&quot;OP_IGNORE_UNEXPECTED_EOF&quot;</span><span class="s2">):</span>
    <span class="s1">SERVER_CTX</span><span class="s2">.</span><span class="s1">options </span><span class="s2">&amp;= ~</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">OP_IGNORE_UNEXPECTED_EOF</span>

<span class="s1">TRIO_TEST_1_CERT</span><span class="s2">.</span><span class="s1">configure_cert</span><span class="s2">(</span><span class="s1">SERVER_CTX</span><span class="s2">)</span>


<span class="s1">skip_on_broken_openssl</span><span class="s2">: </span><span class="s1">MarkDecorator </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&lt; (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">8</span><span class="s2">) </span><span class="s0">and </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">OPENSSL_VERSION_INFO</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &gt; </span><span class="s5">1</span><span class="s2">,</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Python 3.7 does not work with OpenSSL versions higher than 1.X&quot;</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s3"># TLS 1.3 has a lot of changes from previous versions. So we want to run tests</span>
<span class="s3"># with both TLS 1.3, and TLS 1.2.</span>
<span class="s3"># &quot;tls13&quot; means that we're willing to negotiate TLS 1.3. Usually that's</span>
<span class="s3"># what will happen, but the renegotiation tests explicitly force a</span>
<span class="s3"># downgrade on the server side. &quot;tls12&quot; means we refuse to negotiate TLS</span>
<span class="s3"># 1.3, so we'll almost certainly use TLS 1.2.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s4">&quot;module&quot;</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=[</span><span class="s4">&quot;tls13&quot;</span><span class="s2">, </span><span class="s4">&quot;tls12&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">client_ctx</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">ssl</span><span class="s2">, </span><span class="s4">&quot;OP_IGNORE_UNEXPECTED_EOF&quot;</span><span class="s2">):</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">options </span><span class="s2">&amp;= ~</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">OP_IGNORE_UNEXPECTED_EOF</span>

    <span class="s1">TRIO_TEST_CA</span><span class="s2">.</span><span class="s1">configure_trust</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;default&quot;</span><span class="s2">, </span><span class="s4">&quot;tls13&quot;</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">ctx</span>
    <span class="s0">elif </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param </span><span class="s2">== </span><span class="s4">&quot;tls12&quot;</span><span class="s2">:</span>
        <span class="s1">ctx</span><span class="s2">.</span><span class="s1">maximum_version </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">TLSVersion</span><span class="s2">.</span><span class="s1">TLSv1_2</span>
        <span class="s0">return </span><span class="s1">ctx</span>
    <span class="s0">else</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
        <span class="s0">assert False</span>


<span class="s3"># The blocking socket server.</span>
<span class="s0">def </span><span class="s1">ssl_echo_serve_sync</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, *, </span><span class="s1">expect_fail</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">wrapped </span><span class="s2">= </span><span class="s1">SERVER_CTX</span><span class="s2">.</span><span class="s1">wrap_socket</span><span class="s2">(</span>
            <span class="s1">sock</span><span class="s2">, </span><span class="s1">server_side</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">suppress_ragged_eofs</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">wrapped</span><span class="s2">:</span>
            <span class="s1">wrapped</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s1">data </span><span class="s2">= </span><span class="s1">wrapped</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">4096</span><span class="s2">)</span>
                <span class="s0">if not </span><span class="s1">data</span><span class="s2">:</span>
                    <span class="s3"># other side has initiated a graceful shutdown; we try to</span>
                    <span class="s3"># respond in kind but it's legal for them to have already</span>
                    <span class="s3"># gone away.</span>
                    <span class="s1">exceptions </span><span class="s2">= (</span><span class="s1">BrokenPipeError</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">SSLZeroReturnError</span><span class="s2">)</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s1">wrapped</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>
                    <span class="s0">except </span><span class="s1">exceptions</span><span class="s2">:</span>
                        <span class="s0">pass</span>
                    <span class="s0">except </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">SSLWantWriteError</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
                        <span class="s3"># Under unclear conditions, CPython sometimes raises</span>
                        <span class="s3"># SSLWantWriteError here. This is a bug (bpo-32219),</span>
                        <span class="s3"># but it's not our bug.  Christian Heimes thinks</span>
                        <span class="s3"># it's fixed in 'recent' CPython versions so we fail</span>
                        <span class="s3"># the test for those and ignore it for earlier</span>
                        <span class="s3"># versions.</span>
                        <span class="s0">if </span><span class="s2">(</span>
                            <span class="s1">sys</span><span class="s2">.</span><span class="s1">implementation</span><span class="s2">.</span><span class="s1">name </span><span class="s2">!= </span><span class="s4">&quot;cpython&quot;</span>
                            <span class="s0">or </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
                        <span class="s2">):</span>
                            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span>
                                <span class="s4">&quot;still an issue on recent python versions &quot;</span>
                                <span class="s4">&quot;add a comment to &quot;</span>
                                <span class="s4">&quot;https://bugs.python.org/issue32219&quot;</span>
                            <span class="s2">)</span>
                    <span class="s0">return</span>
                <span class="s1">wrapped</span><span class="s2">.</span><span class="s1">sendall</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s3"># This is an obscure workaround for an openssl bug. In server mode, in</span>
    <span class="s3"># some versions, openssl sends some extra data at the end of do_handshake</span>
    <span class="s3"># that it shouldn't send. Normally this is harmless, but, if the other</span>
    <span class="s3"># side shuts down the connection before it reads that data, it might cause</span>
    <span class="s3"># the OS to report a ECONNREST or even ECONNABORTED (which is just wrong,</span>
    <span class="s3"># since ECONNABORTED is supposed to mean that connect() failed, but what</span>
    <span class="s3"># can you do). In this case the other side did nothing wrong, but there's</span>
    <span class="s3"># no way to recover, so we let it pass, and just cross our fingers its not</span>
    <span class="s3"># hiding any (other) real bugs. For more details see:</span>
    <span class="s3">#</span>
    <span class="s3">#   https://github.com/python-trio/trio/issues/1293</span>
    <span class="s3">#</span>
    <span class="s3"># Also, this happens frequently but non-deterministically, so we have to</span>
    <span class="s3"># 'no cover' it to avoid coverage flapping.</span>
    <span class="s0">except </span><span class="s2">(</span><span class="s1">ConnectionResetError</span><span class="s2">, </span><span class="s1">ConnectionAbortedError</span><span class="s2">):  </span><span class="s3"># pragma: no cover</span>
        <span class="s0">return</span>
    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">expect_fail</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;ssl_echo_serve_sync got error as expected:&quot;</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;ssl_echo_serve_sync got unexpected error:&quot;</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">)</span>
            <span class="s0">raise</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">expect_fail</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;failed to fail?&quot;</span><span class="s2">)</span>
    <span class="s0">finally</span><span class="s2">:</span>
        <span class="s1">sock</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s3"># Fixture that gives a raw socket connected to a trio-test-1 echo server</span>
<span class="s3"># (running in a thread). Useful for testing making connections with different</span>
<span class="s3"># SSLContexts.</span>
<span class="s2">@</span><span class="s1">asynccontextmanager</span>
<span class="s0">async def </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">async with </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s3"># Exiting the 'with a, b' context manager closes the sockets, which</span>
        <span class="s3"># causes the thread to exit (possibly with an error), which allows the</span>
        <span class="s3"># nursery context manager to exit too.</span>
        <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span>
                <span class="s1">trio</span><span class="s2">.</span><span class="s1">to_thread</span><span class="s2">.</span><span class="s1">run_sync</span><span class="s2">, </span><span class="s1">partial</span><span class="s2">(</span><span class="s1">ssl_echo_serve_sync</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s2">)</span>

            <span class="s0">yield </span><span class="s1">SocketStream</span><span class="s2">(</span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))</span>


<span class="s3"># Fixture that gives a properly set up SSLStream connected to a trio-test-1</span>
<span class="s3"># echo server (running in a thread)</span>
<span class="s2">@</span><span class="s1">asynccontextmanager</span>
<span class="s0">async def </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>


<span class="s3"># The weird in-memory server ... thing.</span>
<span class="s3"># Doesn't inherit from Stream because I left out the methods that we don't</span>
<span class="s3"># actually need.</span>
<span class="s0">class </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sleeper</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">ctx </span><span class="s2">= </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">Context</span><span class="s2">(</span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">SSLv23_METHOD</span><span class="s2">)</span>
        <span class="s3"># TLS 1.3 removes renegotiation support. Which is great for them, but</span>
        <span class="s3"># we still have to support versions before that, and that means we</span>
        <span class="s3"># need to test renegotiation support, which means we need to force this</span>
        <span class="s3"># to use a lower version where this test server can trigger</span>
        <span class="s3"># renegotiations. Of course TLS 1.3 support isn't released yet, but</span>
        <span class="s3"># I'm told that this will work once it is. (And once it is we can</span>
        <span class="s3"># remove the pragma: no cover too.) Alternatively, we could switch to</span>
        <span class="s3"># using TLSv1_2_METHOD.</span>
        <span class="s3">#</span>
        <span class="s3"># Discussion: https://github.com/pyca/pyopenssl/issues/624</span>

        <span class="s3"># This is the right way, but we can't use it until this PR is in a</span>
        <span class="s3"># released:</span>
        <span class="s3">#     https://github.com/pyca/pyopenssl/pull/861</span>
        <span class="s3">#</span>
        <span class="s3"># if hasattr(SSL, &quot;OP_NO_TLSv1_3&quot;):</span>
        <span class="s3">#     ctx.set_options(SSL.OP_NO_TLSv1_3)</span>
        <span class="s3">#</span>
        <span class="s3"># Fortunately pyopenssl uses cryptography under the hood, so we can be</span>
        <span class="s3"># confident that they're using the same version of openssl</span>
        <span class="s0">from </span><span class="s1">cryptography</span><span class="s2">.</span><span class="s1">hazmat</span><span class="s2">.</span><span class="s1">bindings</span><span class="s2">.</span><span class="s1">openssl</span><span class="s2">.</span><span class="s1">binding </span><span class="s0">import </span><span class="s1">Binding</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">Binding</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">, </span><span class="s4">&quot;SSL_OP_NO_TLSv1_3&quot;</span><span class="s2">):</span>
            <span class="s1">ctx</span><span class="s2">.</span><span class="s1">set_options</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">SSL_OP_NO_TLSv1_3</span><span class="s2">)</span>

        <span class="s3"># Unfortunately there's currently no way to say &quot;use 1.3 or worse&quot;, we</span>
        <span class="s3"># can only disable specific versions. And if the two sides start</span>
        <span class="s3"># negotiating 1.4 at some point in the future, it *might* mean that</span>
        <span class="s3"># our tests silently stop working properly. So the next line is a</span>
        <span class="s3"># tripwire to remind us we need to revisit this stuff in 5 years or</span>
        <span class="s3"># whatever when the next TLS version is released:</span>
        <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">SSL</span><span class="s2">, </span><span class="s4">&quot;OP_NO_TLSv1_4&quot;</span><span class="s2">)</span>
        <span class="s1">TRIO_TEST_1_CERT</span><span class="s2">.</span><span class="s1">configure_cert</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn </span><span class="s2">= </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">(</span><span class="s1">ctx</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">set_accept_state</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_lot </span><span class="s2">= </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">ParkingLot</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_send_all_conflict_detector </span><span class="s2">= </span><span class="s1">ConflictDetector</span><span class="s2">(</span>
            <span class="s4">&quot;simultaneous calls to PyOpenSSLEchoStream.send_all&quot;</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_receive_some_conflict_detector </span><span class="s2">= </span><span class="s1">ConflictDetector</span><span class="s2">(</span>
            <span class="s4">&quot;simultaneous calls to PyOpenSSLEchoStream.receive_some&quot;</span>
        <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">sleeper </span><span class="s0">is None</span><span class="s2">:</span>

            <span class="s0">async def </span><span class="s1">no_op_sleeper</span><span class="s2">(</span><span class="s1">_</span><span class="s2">):</span>
                <span class="s0">return</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper </span><span class="s2">= </span><span class="s1">no_op_sleeper</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper </span><span class="s2">= </span><span class="s1">sleeper</span>

    <span class="s0">async def </span><span class="s1">aclose</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">bio_shutdown</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">renegotiate_pending</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">renegotiate_pending</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">renegotiate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Returns false if a renegotiation is already in progress, meaning</span>
        <span class="s3"># nothing happens.</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">wait_send_all_might_not_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_send_all_conflict_detector</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;wait_send_all_might_not_block&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">send_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;  --&gt; transport_stream.send_all&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_send_all_conflict_detector</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;send_all&quot;</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">bio_write</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s0">while True</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;send_all&quot;</span><span class="s2">)</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">data </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">ZeroReturnError</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>
                    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;renegotiations:&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">total_renegotiations</span><span class="s2">())</span>
                    <span class="s0">break</span>
                <span class="s0">except </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">WantReadError</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext </span><span class="s2">+= </span><span class="s1">data</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_lot</span><span class="s2">.</span><span class="s1">unpark_all</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;send_all&quot;</span><span class="s2">)</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;  &lt;-- transport_stream.send_all finished&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">receive_some</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">nbytes</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;  --&gt; transport_stream.receive_some&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">nbytes </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">nbytes </span><span class="s2">= </span><span class="s5">65536  </span><span class="s3"># arbitrary</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_receive_some_conflict_detector</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
                <span class="s0">await </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">checkpoint</span><span class="s2">()</span>
                <span class="s0">while True</span><span class="s2">:</span>
                    <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;receive_some&quot;</span><span class="s2">)</span>
                    <span class="s0">try</span><span class="s2">:</span>
                        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">bio_read</span><span class="s2">(</span><span class="s1">nbytes</span><span class="s2">)</span>
                    <span class="s0">except </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">WantReadError</span><span class="s2">:</span>
                        <span class="s3"># No data in our ciphertext buffer; try to generate</span>
                        <span class="s3"># some.</span>
                        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext</span><span class="s2">:</span>
                            <span class="s3"># We have some cleartext; maybe we can encrypt it</span>
                            <span class="s3"># and then return it.</span>
                            <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;    trying&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext</span><span class="s2">)</span>
                            <span class="s0">try</span><span class="s2">:</span>
                                <span class="s3"># PyOpenSSL bug: doesn't accept bytearray</span>
                                <span class="s3"># https://github.com/pyca/pyopenssl/issues/621</span>
                                <span class="s1">next_byte </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">1</span><span class="s2">]</span>
                                <span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">next_byte</span><span class="s2">))</span>
                            <span class="s3"># Apparently this next bit never gets hit in the</span>
                            <span class="s3"># test suite, but it's not an interesting omission</span>
                            <span class="s3"># so let's pragma it.</span>
                            <span class="s0">except </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">WantReadError</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
                                <span class="s3"># We didn't manage to send the cleartext (and</span>
                                <span class="s3"># in particular we better leave it there to</span>
                                <span class="s3"># try again, due to openssl's retry</span>
                                <span class="s3"># semantics), but it's possible we pushed a</span>
                                <span class="s3"># renegotiation forward and *now* we have data</span>
                                <span class="s3"># to send.</span>
                                <span class="s0">try</span><span class="s2">:</span>
                                    <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_conn</span><span class="s2">.</span><span class="s1">bio_read</span><span class="s2">(</span><span class="s1">nbytes</span><span class="s2">)</span>
                                <span class="s0">except </span><span class="s1">SSL</span><span class="s2">.</span><span class="s1">WantReadError</span><span class="s2">:</span>
                                    <span class="s3"># Nope. We're just going to have to wait</span>
                                    <span class="s3"># for someone to call send_all() to give</span>
                                    <span class="s3"># use more data.</span>
                                    <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;parking (a)&quot;</span><span class="s2">)</span>
                                    <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lot</span><span class="s2">.</span><span class="s1">park</span><span class="s2">()</span>
                            <span class="s0">else</span><span class="s2">:</span>
                                <span class="s3"># We successfully sent that byte, so we don't</span>
                                <span class="s3"># have to again.</span>
                                <span class="s0">del </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_pending_cleartext</span><span class="s2">[</span><span class="s5">0</span><span class="s2">:</span><span class="s5">1</span><span class="s2">]</span>
                        <span class="s0">else</span><span class="s2">:</span>
                            <span class="s3"># no pending cleartext; nothing to do but wait for</span>
                            <span class="s3"># someone to call send_all</span>
                            <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;parking (b)&quot;</span><span class="s2">)</span>
                            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_lot</span><span class="s2">.</span><span class="s1">park</span><span class="s2">()</span>
            <span class="s0">finally</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;receive_some&quot;</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;  &lt;-- transport_stream.receive_some finished&quot;</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_PyOpenSSLEchoStream_gives_resource_busy_errors</span><span class="s2">():</span>
    <span class="s3"># Make sure that PyOpenSSLEchoStream complains if two tasks call send_all</span>
    <span class="s3"># at the same time, or ditto for receive_some. The tricky cases where SSLStream</span>
    <span class="s3"># might accidentally do this are during renegotiation, which we test using</span>
    <span class="s3"># PyOpenSSLEchoStream, so this makes sure that if we do have a bug then</span>
    <span class="s3"># PyOpenSSLEchoStream will notice and complain.</span>

    <span class="s1">s </span><span class="s2">= </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">, </span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">, </span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;simultaneous&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s </span><span class="s2">= </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">, </span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;simultaneous&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s </span><span class="s2">= </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;simultaneous&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s </span><span class="s2">= </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;simultaneous&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">contextmanager</span>
<span class="s0">def </span><span class="s1">virtual_ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">fakesock </span><span class="s2">= </span><span class="s1">PyOpenSSLEchoStream</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">fakesock</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">ssl_wrap_pair</span><span class="s2">(</span>
    <span class="s1">client_ctx</span><span class="s2">,</span>
    <span class="s1">client_transport</span><span class="s2">,</span>
    <span class="s1">server_transport</span><span class="s2">,</span>
    <span class="s2">*,</span>
    <span class="s1">client_kwargs</span><span class="s2">={},</span>
    <span class="s1">server_kwargs</span><span class="s2">={},</span>
<span class="s2">):</span>
    <span class="s1">client_ssl </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
        <span class="s1">client_transport</span><span class="s2">,</span>
        <span class="s1">client_ctx</span><span class="s2">,</span>
        <span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">client_kwargs</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">server_ssl </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
        <span class="s1">server_transport</span><span class="s2">, </span><span class="s1">SERVER_CTX</span><span class="s2">, </span><span class="s1">server_side</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, **</span><span class="s1">server_kwargs</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">client_ssl</span><span class="s2">, </span><span class="s1">server_ssl</span>


<span class="s0">def </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">client_transport</span><span class="s2">, </span><span class="s1">server_transport </span><span class="s2">= </span><span class="s1">memory_stream_pair</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">ssl_wrap_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">client_transport</span><span class="s2">, </span><span class="s1">server_transport</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">client_transport</span><span class="s2">, </span><span class="s1">server_transport </span><span class="s2">= </span><span class="s1">lockstep_stream_pair</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">ssl_wrap_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">client_transport</span><span class="s2">, </span><span class="s1">server_transport</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s3"># Simple smoke test for handshake/send/receive/shutdown talking to a</span>
<span class="s3"># synchronous server, plus make sure that we do the bare minimum of</span>
<span class="s3"># certificate checking (even though this is really Python's responsibility)</span>
<span class="s0">async def </span><span class="s1">test_ssl_client_basics</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># Everything OK</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">server_side</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s3"># Didn't configure the CA file, should fail</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(</span><span class="s1">expect_fail</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s1">bad_client_ctx </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">()</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">bad_client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">server_side</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">SSLError</span><span class="s2">)</span>

    <span class="s3"># Trusted CA, but wrong host name</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(</span><span class="s1">expect_fail</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-2.example.org&quot;</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">s</span><span class="s2">.</span><span class="s1">server_side</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">CertificateError</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_ssl_server_basics</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">stdlib_socket</span><span class="s2">.</span><span class="s1">socketpair</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">server_sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">from_stdlib_socket</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">server_transport </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
            <span class="s1">SocketStream</span><span class="s2">(</span><span class="s1">server_sock</span><span class="s2">), </span><span class="s1">SERVER_CTX</span><span class="s2">, </span><span class="s1">server_side</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">server_side</span>

        <span class="s0">def </span><span class="s1">client</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">client_ctx</span><span class="s2">.</span><span class="s1">wrap_socket</span><span class="s2">(</span>
                <span class="s1">a</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span>
            <span class="s2">) </span><span class="s0">as </span><span class="s1">client_sock</span><span class="s2">:</span>
                <span class="s1">client_sock</span><span class="s2">.</span><span class="s1">sendall</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">client_sock</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;y&quot;</span>
                <span class="s1">client_sock</span><span class="s2">.</span><span class="s1">sendall</span><span class="s2">(</span><span class="s6">b&quot;z&quot;</span><span class="s2">)</span>
                <span class="s1">client_sock</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>

        <span class="s1">t </span><span class="s2">= </span><span class="s1">threading</span><span class="s2">.</span><span class="s1">Thread</span><span class="s2">(</span><span class="s1">target</span><span class="s2">=</span><span class="s1">client</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>

        <span class="s0">assert await </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">await </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;y&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;z&quot;</span>
        <span class="s0">assert await </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">await </span><span class="s1">server_transport</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

        <span class="s1">t</span><span class="s2">.</span><span class="s1">join</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_attributes</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(</span><span class="s1">expect_fail</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s1">good_ctx </span><span class="s2">= </span><span class="s1">client_ctx</span>
        <span class="s1">bad_ctx </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">()</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">good_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream </span><span class="s0">is </span><span class="s1">sock</span>

        <span class="s3"># Forwarded attribute getting</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">context </span><span class="s0">is </span><span class="s1">good_ctx</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">server_side </span><span class="s2">== </span><span class="s0">False  </span><span class="s3"># noqa</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">server_hostname </span><span class="s2">== </span><span class="s4">&quot;trio-test-1.example.org&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">asfdasdfsa</span>

        <span class="s3"># __dir__</span>
        <span class="s0">assert </span><span class="s4">&quot;transport_stream&quot; </span><span class="s0">in </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s4">&quot;context&quot; </span><span class="s0">in </span><span class="s1">dir</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

        <span class="s3"># Setting the attribute goes through to the underlying object</span>

        <span class="s3"># most attributes on SSLObject are read-only</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">server_side </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">server_hostname </span><span class="s2">= </span><span class="s4">&quot;asdf&quot;</span>

        <span class="s3"># but .context is *not*. Check that we forward attribute setting by</span>
        <span class="s3"># making sure that after we set the bad context our handshake indeed</span>
        <span class="s3"># fails:</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">context </span><span class="s2">= </span><span class="s1">bad_ctx</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">context </span><span class="s0">is </span><span class="s1">bad_ctx</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">SSLError</span><span class="s2">)</span>


<span class="s3"># Note: this test fails horribly if we force TLS 1.2 and trigger a</span>
<span class="s3"># renegotiation at the beginning (e.g. by switching to the pyopenssl</span>
<span class="s3"># server). Usually the client crashes in SSLObject.write with &quot;UNEXPECTED</span>
<span class="s3"># RECORD&quot;; sometimes we get something more exotic like a SyscallError. This is</span>
<span class="s3"># odd because openssl isn't doing any syscalls, but so it goes. After lots of</span>
<span class="s3"># websearching I'm pretty sure this is due to a bug in OpenSSL, where it just</span>
<span class="s3"># can't reliably handle full-duplex communication combined with</span>
<span class="s3"># renegotiation. Nice, eh?</span>
<span class="s3">#</span>
<span class="s3">#   https://rt.openssl.org/Ticket/Display.html?id=3712</span>
<span class="s3">#   https://rt.openssl.org/Ticket/Display.html?id=2481</span>
<span class="s3">#   http://openssl.6102.n7.nabble.com/TLS-renegotiation-failure-on-receiving-application-data-during-handshake-td48127.html</span>
<span class="s3">#   https://stackoverflow.com/questions/18728355/ssl-renegotiation-with-full-duplex-socket-communication</span>
<span class="s3">#</span>
<span class="s3"># In some variants of this test (maybe only against the java server?) I've</span>
<span class="s3"># also seen cases where our send_all blocks waiting to write, and then our receive_some</span>
<span class="s3"># also blocks waiting to write, and they never wake up again. It looks like</span>
<span class="s3"># some kind of deadlock. I suspect there may be an issue where we've filled up</span>
<span class="s3"># the send buffers, and the remote side is trying to handle the renegotiation</span>
<span class="s3"># from inside a write() call, so it has a problem: there's all this application</span>
<span class="s3"># data clogging up the pipe, but it can't process and return it to the</span>
<span class="s3"># application because it's in write(), and it doesn't want to buffer infinite</span>
<span class="s3"># amounts of data, and... actually I guess those are the only two choices.</span>
<span class="s3">#</span>
<span class="s3"># NSS even documents that you shouldn't try to do a renegotiation except when</span>
<span class="s3"># the connection is idle:</span>
<span class="s3">#</span>
<span class="s3">#   https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/SSL_functions/sslfnc.html#1061582</span>
<span class="s3">#</span>
<span class="s3"># I begin to see why HTTP/2 forbids renegotiation and TLS 1.3 removes it...</span>


<span class="s0">async def </span><span class="s1">test_full_duplex_basics</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">CHUNKS </span><span class="s2">= </span><span class="s5">30</span>
    <span class="s1">CHUNK_SIZE </span><span class="s2">= </span><span class="s5">32768</span>
    <span class="s1">EXPECTED </span><span class="s2">= </span><span class="s1">CHUNKS </span><span class="s2">* </span><span class="s1">CHUNK_SIZE</span>

    <span class="s1">sent </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>
    <span class="s1">received </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">sender</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
        <span class="s0">nonlocal </span><span class="s1">sent</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">CHUNKS</span><span class="s2">):</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">([</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">CHUNK_SIZE</span><span class="s2">)</span>
            <span class="s1">sent </span><span class="s2">+= </span><span class="s1">chunk</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">receiver</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
        <span class="s0">nonlocal </span><span class="s1">received</span>
        <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">received</span><span class="s2">) &lt; </span><span class="s1">EXPECTED</span><span class="s2">:</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s1">CHUNK_SIZE </span><span class="s2">// </span><span class="s5">2</span><span class="s2">)</span>
            <span class="s1">received </span><span class="s2">+= </span><span class="s1">chunk</span>

    <span class="s0">async with </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">sender</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">receiver</span><span class="s2">, </span><span class="s1">s</span><span class="s2">)</span>
            <span class="s3"># And let's have some doing handshakes too, everyone</span>
            <span class="s3"># simultaneously</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sent</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">received</span><span class="s2">) == </span><span class="s1">EXPECTED</span>
    <span class="s0">assert </span><span class="s1">sent </span><span class="s2">== </span><span class="s1">received</span>


<span class="s0">async def </span><span class="s1">test_renegotiation_simple</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">virtual_ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>

        <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;a&quot;</span>

        <span class="s3"># Have to send some more data back and forth to make sure the</span>
        <span class="s3"># renegotiation is finished before shutting down the</span>
        <span class="s3"># connection... otherwise openssl raises an error. I think this is a</span>
        <span class="s3"># bug in openssl but what can ya do.</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;b&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;b&quot;</span>

        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">slow</span>
<span class="s0">async def </span><span class="s1">test_renegotiation_randomized</span><span class="s2">(</span><span class="s1">mock_clock</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># The only blocking things in this function are our random sleeps, so 0 is</span>
    <span class="s3"># a good threshold.</span>
    <span class="s1">mock_clock</span><span class="s2">.</span><span class="s1">autojump_threshold </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">import </span><span class="s1">random</span>

    <span class="s1">r </span><span class="s2">= </span><span class="s1">random</span><span class="s2">.</span><span class="s1">Random</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">sleeper</span><span class="s2">(</span><span class="s1">_</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>

    <span class="s0">async def </span><span class="s1">clear</span><span class="s2">():</span>
        <span class="s0">while </span><span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate_pending</span><span class="s2">():</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">await </span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;-&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">await </span><span class="s1">expect</span><span class="s2">(</span><span class="s6">b&quot;-&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;-- clear --&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">send</span><span class="s2">(</span><span class="s1">byte</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;outer send&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;calling SSLStream.send_all&quot;</span><span class="s2">, </span><span class="s1">byte</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s1">byte</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">expect</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">sleeper</span><span class="s2">(</span><span class="s4">&quot;expect&quot;</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;calling SSLStream.receive_some, expecting&quot;</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">) == </span><span class="s5">1</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">assert await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s1">expected</span>

    <span class="s0">with </span><span class="s1">virtual_ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">sleeper</span><span class="s2">=</span><span class="s1">sleeper</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>

        <span class="s0">await </span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">expect</span><span class="s2">(</span><span class="s6">b&quot;a&quot;</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">100</span><span class="s2">):</span>
            <span class="s1">b1 </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">([</span><span class="s1">i </span><span class="s2">% </span><span class="s5">0xFF</span><span class="s2">])</span>
            <span class="s1">b2 </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">([(</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) % </span><span class="s5">0xFF</span><span class="s2">])</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
            <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">send</span><span class="s2">, </span><span class="s1">b1</span><span class="s2">)</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s1">b1</span><span class="s2">)</span>
            <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">send</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">100</span><span class="s2">):</span>
            <span class="s1">b1 </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">([</span><span class="s1">i </span><span class="s2">% </span><span class="s5">0xFF</span><span class="s2">])</span>
            <span class="s1">b2 </span><span class="s2">= </span><span class="s1">bytes</span><span class="s2">([(</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">i</span><span class="s2">) % </span><span class="s5">0xFF</span><span class="s2">])</span>
            <span class="s0">await </span><span class="s1">send</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">)</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">expect</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">)</span>
            <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">send</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">clear</span><span class="s2">()</span>

    <span class="s3"># Checking that wait_send_all_might_not_block and receive_some don't</span>
    <span class="s3"># conflict:</span>

    <span class="s3"># 1) Set up a situation where expect (receive_some) is blocked sending,</span>
    <span class="s3"># and wait_send_all_might_not_block comes in.</span>

    <span class="s3"># Our receive_some() call will get stuck when it hits send_all</span>
    <span class="s0">async def </span><span class="s1">sleeper_with_slow_send_all</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">&quot;send_all&quot;</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s5">100000</span><span class="s2">)</span>

    <span class="s3"># And our wait_send_all_might_not_block call will give it time to get</span>
    <span class="s3"># stuck, and then start</span>
    <span class="s0">async def </span><span class="s1">sleep_then_wait_writable</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">virtual_ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">sleeper</span><span class="s2">=</span><span class="s1">sleeper_with_slow_send_all</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">sleep_then_wait_writable</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s3"># 2) Same, but now wait_send_all_might_not_block is stuck when</span>
    <span class="s3"># receive_some tries to send.</span>

    <span class="s0">async def </span><span class="s1">sleeper_with_slow_wait_writable_and_expect</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s4">&quot;wait_send_all_might_not_block&quot;</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s5">100000</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">method </span><span class="s2">== </span><span class="s4">&quot;expect&quot;</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">virtual_ssl_echo_server</span><span class="s2">(</span>
        <span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">sleeper</span><span class="s2">=</span><span class="s1">sleeper_with_slow_wait_writable_and_expect</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">send</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s1">s</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">renegotiate</span><span class="s2">()</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect</span><span class="s2">, </span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">clear</span><span class="s2">()</span>

        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_resource_busy_errors</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">async def </span><span class="s1">do_send_all</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">do_receive_some</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">do_wait_send_all_might_not_block</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">()</span>

    <span class="s1">s</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_send_all</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_send_all</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;another task&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_receive_some</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_receive_some</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;another task&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_send_all</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_wait_send_all_might_not_block</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;another task&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>

    <span class="s1">s</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">_core</span><span class="s2">.</span><span class="s1">BusyResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_wait_send_all_might_not_block</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">do_wait_send_all_might_not_block</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">&quot;another task&quot; </span><span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_wait_writable_calls_underlying_wait_writable</span><span class="s2">():</span>
    <span class="s1">record </span><span class="s2">= []</span>

    <span class="s0">class </span><span class="s1">NotAStream</span><span class="s2">:</span>
        <span class="s0">async def </span><span class="s1">wait_send_all_might_not_block</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">record</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ok&quot;</span><span class="s2">)</span>

    <span class="s1">ctx </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">()</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">NotAStream</span><span class="s2">(), </span><span class="s1">ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;x&quot;</span><span class="s2">)</span>
    <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">record </span><span class="s2">== [</span><span class="s4">&quot;ok&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span>
    <span class="s1">os</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;nt&quot; </span><span class="s0">and </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">version_info </span><span class="s2">&gt;= (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">10</span><span class="s2">),</span>
    <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;frequently fails on Windows + Python 3.10&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_checkpoints</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;xxx&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s3"># These receive_some's in theory could return immediately, because the</span>
        <span class="s3"># &quot;xxx&quot; was sent in a single record and after the first</span>
        <span class="s3"># receive_some(1) the rest are sitting inside the SSLObject's internal</span>
        <span class="s3"># buffers.</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>

    <span class="s0">async with </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_send_all_empty_string</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">) </span><span class="s0">as </span><span class="s1">s</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>

        <span class="s3"># underlying SSLObject interprets writing b&quot;&quot; as indicating an EOF,</span>
        <span class="s3"># for some reason. Make sure we don't inherit this.</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>

        <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">skip_on_broken_openssl</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">async def </span><span class="s1">test_SSLStream_generic</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">https_compatible</span><span class="s2">):</span>
    <span class="s0">async def </span><span class="s1">stream_maker</span><span class="s2">():</span>
        <span class="s0">return </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span>
            <span class="s1">client_ctx</span><span class="s2">,</span>
            <span class="s1">client_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s1">https_compatible</span><span class="s2">},</span>
            <span class="s1">server_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s1">https_compatible</span><span class="s2">},</span>
        <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">clogged_stream_maker</span><span class="s2">():</span>
        <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_lockstep_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
        <span class="s3"># If we don't do handshakes up front, then we run into a problem in</span>
        <span class="s3"># the following situation:</span>
        <span class="s3"># - server does wait_send_all_might_not_block</span>
        <span class="s3"># - client does receive_some to unclog it</span>
        <span class="s3"># Then the client's receive_some will actually send some data to start</span>
        <span class="s3"># the handshake, and itself get stuck.</span>
        <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
            <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">client</span><span class="s2">, </span><span class="s1">server</span>

    <span class="s0">await </span><span class="s1">check_two_way_stream</span><span class="s2">(</span><span class="s1">stream_maker</span><span class="s2">, </span><span class="s1">clogged_stream_maker</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_unwrap</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client_ssl</span><span class="s2">, </span><span class="s1">server_ssl </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s1">client_transport </span><span class="s2">= </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">transport_stream</span>
    <span class="s1">server_transport </span><span class="s2">= </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">transport_stream</span>

    <span class="s1">seq </span><span class="s2">= </span><span class="s1">Sequencer</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">client</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;y&quot;</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;z&quot;</span><span class="s2">)</span>

        <span class="s3"># After sending that, disable outgoing data from our end, to make</span>
        <span class="s3"># sure the server doesn't see our EOF until after we've sent some</span>
        <span class="s3"># trailing data</span>
        <span class="s0">async with </span><span class="s1">seq</span><span class="s2">(</span><span class="s5">0</span><span class="s2">):</span>
            <span class="s1">send_all_hook </span><span class="s2">= </span><span class="s1">client_transport</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook</span>
            <span class="s1">client_transport</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">assert await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">transport_stream </span><span class="s0">is </span><span class="s1">client_transport</span>
        <span class="s3"># We just received EOF. Unwrap the connection and send some more.</span>
        <span class="s1">raw</span><span class="s2">, </span><span class="s1">trailing </span><span class="s2">= </span><span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">raw </span><span class="s0">is </span><span class="s1">client_transport</span>
        <span class="s0">assert </span><span class="s1">trailing </span><span class="s2">== </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">assert </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">transport_stream </span><span class="s0">is None</span>
        <span class="s0">await </span><span class="s1">raw</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;trailing&quot;</span><span class="s2">)</span>

        <span class="s3"># Reconnect the streams. Now the server will receive both our shutdown</span>
        <span class="s3"># acknowledgement + the trailing data in a single lump.</span>
        <span class="s1">client_transport</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook </span><span class="s2">= </span><span class="s1">send_all_hook</span>
        <span class="s0">await </span><span class="s1">client_transport</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">server</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s0">assert await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;x&quot;</span>
        <span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;y&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) == </span><span class="s6">b&quot;z&quot;</span>
        <span class="s3"># Now client is blocked waiting for us to send something, but</span>
        <span class="s3"># instead we close the TLS connection (with sequencer to make sure</span>
        <span class="s3"># that the client won't see and automatically respond before we've had</span>
        <span class="s3"># a chance to disable the client-&gt;server transport)</span>
        <span class="s0">async with </span><span class="s1">seq</span><span class="s2">(</span><span class="s5">1</span><span class="s2">):</span>
            <span class="s1">raw</span><span class="s2">, </span><span class="s1">trailing </span><span class="s2">= </span><span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">raw </span><span class="s0">is </span><span class="s1">server_transport</span>
        <span class="s0">assert </span><span class="s1">trailing </span><span class="s2">== </span><span class="s6">b&quot;trailing&quot;</span>
        <span class="s0">assert </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">transport_stream </span><span class="s0">is None</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_closing_nice_case</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># the nice case: graceful closes all around</span>

    <span class="s1">client_ssl</span><span class="s2">, </span><span class="s1">server_ssl </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>
    <span class="s1">client_transport </span><span class="s2">= </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">transport_stream</span>

    <span class="s3"># Both the handshake and the close require back-and-forth discussion, so</span>
    <span class="s3"># we need to run them concurrently</span>
    <span class="s0">async def </span><span class="s1">client_closer</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">server_closer</span><span class="s2">():</span>
        <span class="s0">assert await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">assert await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client_closer</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server_closer</span><span class="s2">)</span>

    <span class="s3"># closing the SSLStream also closes its transport</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client_transport</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;123&quot;</span><span class="s2">)</span>

    <span class="s3"># once closed, it's OK to close again</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s3"># Trying to send more data does not work</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;123&quot;</span><span class="s2">)</span>

    <span class="s3"># And once the connection is has been closed *locally*, then instead of</span>
    <span class="s3"># getting empty bytestrings we get a proper error</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">unwrap</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ClosedResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>

    <span class="s3"># Check that a graceful close *before* handshaking gives a clean EOF on</span>
    <span class="s3"># the other side</span>
    <span class="s1">client_ssl</span><span class="s2">, </span><span class="s1">server_ssl </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">expect_eof_server</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">assert await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">server_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client_ssl</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">expect_eof_server</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_send_all_fails_in_the_middle</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">bad_hook</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">KeyError</span>

    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook </span><span class="s2">= </span><span class="s1">bad_hook</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">wait_send_all_might_not_block</span><span class="s2">()</span>

    <span class="s1">closed </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">close_hook</span><span class="s2">():</span>
        <span class="s0">nonlocal </span><span class="s1">closed</span>
        <span class="s1">closed </span><span class="s2">+= </span><span class="s5">1</span>

    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">close_hook </span><span class="s2">= </span><span class="s1">close_hook</span>
    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">receive_stream</span><span class="s2">.</span><span class="s1">close_hook </span><span class="s2">= </span><span class="s1">close_hook</span>
    <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">closed </span><span class="s2">== </span><span class="s5">2</span>


<span class="s0">async def </span><span class="s1">test_ssl_over_ssl</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client_0</span><span class="s2">, </span><span class="s1">server_0 </span><span class="s2">= </span><span class="s1">memory_stream_pair</span><span class="s2">()</span>

    <span class="s1">client_1 </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
        <span class="s1">client_0</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span>
    <span class="s2">)</span>
    <span class="s1">server_1 </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">server_0</span><span class="s2">, </span><span class="s1">SERVER_CTX</span><span class="s2">, </span><span class="s1">server_side</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">client_2 </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
        <span class="s1">client_1</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span>
    <span class="s2">)</span>
    <span class="s1">server_2 </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">server_1</span><span class="s2">, </span><span class="s1">SERVER_CTX</span><span class="s2">, </span><span class="s1">server_side</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">client</span><span class="s2">():</span>
        <span class="s0">await </span><span class="s1">client_2</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;hi&quot;</span><span class="s2">)</span>
        <span class="s0">assert await </span><span class="s1">client_2</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;bye&quot;</span>

    <span class="s0">async def </span><span class="s1">server</span><span class="s2">():</span>
        <span class="s0">assert await </span><span class="s1">server_2</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;hi&quot;</span>
        <span class="s0">await </span><span class="s1">server_2</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;bye&quot;</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_ssl_bad_shutdown</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">aclose_forcefully</span><span class="s2">(</span><span class="s1">client</span><span class="s2">)</span>
    <span class="s3"># now the server sees a broken stream</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot; </span><span class="s2">* </span><span class="s5">10</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">skip_on_broken_openssl</span>
<span class="s0">async def </span><span class="s1">test_ssl_bad_shutdown_but_its_ok</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span>
        <span class="s1">client_ctx</span><span class="s2">,</span>
        <span class="s1">server_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
        <span class="s1">client_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
    <span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">trio</span><span class="s2">.</span><span class="s1">aclose_forcefully</span><span class="s2">(</span><span class="s1">client</span><span class="s2">)</span>
    <span class="s3"># the server sees that as a clean shutdown</span>
    <span class="s0">assert await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">send_all</span><span class="s2">(</span><span class="s6">b&quot;x&quot; </span><span class="s2">* </span><span class="s5">10</span><span class="s2">)</span>

    <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_ssl_handshake_failure_during_aclose</span><span class="s2">():</span>
    <span class="s3"># Weird scenario: aclose() triggers an automatic handshake, and this</span>
    <span class="s3"># fails. This also exercises a bit of code in aclose() that was otherwise</span>
    <span class="s3"># uncovered, for re-raising exceptions after calling aclose_forcefully on</span>
    <span class="s3"># the underlying transport.</span>
    <span class="s0">async with </span><span class="s1">ssl_echo_server_raw</span><span class="s2">(</span><span class="s1">expect_fail</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sock</span><span class="s2">:</span>
        <span class="s3"># Don't configure trust correctly</span>
        <span class="s1">client_ctx </span><span class="s2">= </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">create_default_context</span><span class="s2">()</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span><span class="s1">sock</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">)</span>
        <span class="s3"># It's a little unclear here whether aclose should swallow the error</span>
        <span class="s3"># or let it escape. We *do* swallow the error if it arrives when we're</span>
        <span class="s3"># sending close_notify, because both sides closing the connection</span>
        <span class="s3"># simultaneously is allowed. But I guess when https_compatible=False</span>
        <span class="s3"># then it's bad if we can get through a whole connection with a peer</span>
        <span class="s3"># that has no valid certificate, and never raise an error.</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
            <span class="s0">await </span><span class="s1">s</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_ssl_only_closes_stream_once</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># We used to have a bug where if transport_stream.aclose() raised an</span>
    <span class="s3"># error, we would call it again. This checks that that's fixed.</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s1">client_orig_close_hook </span><span class="s2">= </span><span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">close_hook</span>
    <span class="s1">transport_close_count </span><span class="s2">= </span><span class="s5">0</span>

    <span class="s0">def </span><span class="s1">close_hook</span><span class="s2">():</span>
        <span class="s0">nonlocal </span><span class="s1">transport_close_count</span>
        <span class="s1">client_orig_close_hook</span><span class="s2">()</span>
        <span class="s1">transport_close_count </span><span class="s2">+= </span><span class="s5">1</span>
        <span class="s0">raise </span><span class="s1">KeyError</span>

    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">close_hook </span><span class="s2">= </span><span class="s1">close_hook</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">transport_close_count </span><span class="s2">== </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">skip_on_broken_openssl</span>
<span class="s0">async def </span><span class="s1">test_ssl_https_compatibility_disagreement</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span>
        <span class="s1">client_ctx</span><span class="s2">,</span>
        <span class="s1">server_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">},</span>
        <span class="s1">client_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
    <span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s3"># client is in HTTPS-mode, server is not</span>
    <span class="s3"># so client doing graceful_shutdown causes an error on server</span>
    <span class="s0">async def </span><span class="s1">receive_and_expect_error</span><span class="s2">():</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">) </span><span class="s0">as </span><span class="s1">excinfo</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">_is_eof</span><span class="s2">(</span><span class="s1">excinfo</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">__cause__</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">receive_and_expect_error</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">skip_on_broken_openssl</span>
<span class="s0">async def </span><span class="s1">test_https_mode_eof_before_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span>
        <span class="s1">client_ctx</span><span class="s2">,</span>
        <span class="s1">server_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
        <span class="s1">client_kwargs</span><span class="s2">={</span><span class="s4">&quot;https_compatible&quot;</span><span class="s2">: </span><span class="s0">True</span><span class="s2">},</span>
    <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">server_expect_clean_eof</span><span class="s2">():</span>
        <span class="s0">assert await </span><span class="s1">server</span><span class="s2">.</span><span class="s1">receive_some</span><span class="s2">(</span><span class="s5">10</span><span class="s2">) == </span><span class="s6">b&quot;&quot;</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server_expect_clean_eof</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">test_send_error_during_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">bad_hook</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">KeyError</span>

    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">send_stream</span><span class="s2">.</span><span class="s1">send_all_hook </span><span class="s2">= </span><span class="s1">bad_hook</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_receive_error_during_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">bad_hook</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">KeyError</span>

    <span class="s1">client</span><span class="s2">.</span><span class="s1">transport_stream</span><span class="s2">.</span><span class="s1">receive_stream</span><span class="s2">.</span><span class="s1">receive_some_hook </span><span class="s2">= </span><span class="s1">bad_hook</span>

    <span class="s0">async def </span><span class="s1">client_side</span><span class="s2">(</span><span class="s1">cancel_scope</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
                <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>
        <span class="s1">cancel_scope</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client_side</span><span class="s2">, </span><span class="s1">nursery</span><span class="s2">.</span><span class="s1">cancel_scope</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">BrokenResourceError</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_checkpoints</span><span class="s2">():</span>
            <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_selected_alpn_protocol_before_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">client</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">server</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_selected_alpn_protocol_when_not_set</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># ALPN protocol still returns None when it's not set,</span>
    <span class="s3"># instead of raising an exception</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">server</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">() == </span><span class="s1">server</span><span class="s2">.</span><span class="s1">selected_alpn_protocol</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_selected_npn_protocol_before_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">client</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">server</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s4">r&quot;ignore: ssl module. NPN is deprecated, use ALPN instead:UserWarning&quot;</span><span class="s2">,</span>
    <span class="s4">r&quot;ignore:ssl NPN is deprecated, use ALPN instead:DeprecationWarning&quot;</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">async def </span><span class="s1">test_selected_npn_protocol_when_not_set</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># NPN protocol still returns None when it's not set,</span>
    <span class="s3"># instead of raising an exception</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">server</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">() == </span><span class="s1">server</span><span class="s2">.</span><span class="s1">selected_npn_protocol</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_get_channel_binding_before_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">client</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NeedHandshakeError</span><span class="s2">):</span>
        <span class="s1">server</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_get_channel_binding_after_handshake</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">() </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">server</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">() </span><span class="s0">is not None</span>

    <span class="s0">assert </span><span class="s1">client</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">() == </span><span class="s1">server</span><span class="s2">.</span><span class="s1">get_channel_binding</span><span class="s2">()</span>


<span class="s0">async def </span><span class="s1">test_getpeercert</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s3"># Make sure we're not affected by https://bugs.python.org/issue29334</span>
    <span class="s1">client</span><span class="s2">, </span><span class="s1">server </span><span class="s2">= </span><span class="s1">ssl_memory_stream_pair</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">)</span>

    <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
        <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">server</span><span class="s2">.</span><span class="s1">getpeercert</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">client</span><span class="s2">.</span><span class="s1">getpeercert</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s4">&quot;DNS&quot;</span><span class="s2">, </span><span class="s4">&quot;trio-test-1.example.org&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">client</span><span class="s2">.</span><span class="s1">getpeercert</span><span class="s2">()[</span><span class="s4">&quot;subjectAltName&quot;</span><span class="s2">]</span>


<span class="s0">async def </span><span class="s1">test_SSLListener</span><span class="s2">(</span><span class="s1">client_ctx</span><span class="s2">):</span>
    <span class="s0">async def </span><span class="s1">setup</span><span class="s2">(**</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">listen_sock </span><span class="s2">= </span><span class="s1">tsocket</span><span class="s2">.</span><span class="s1">socket</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">listen_sock</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">((</span><span class="s4">&quot;127.0.0.1&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
        <span class="s1">listen_sock</span><span class="s2">.</span><span class="s1">listen</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
        <span class="s1">socket_listener </span><span class="s2">= </span><span class="s1">SocketListener</span><span class="s2">(</span><span class="s1">listen_sock</span><span class="s2">)</span>
        <span class="s1">ssl_listener </span><span class="s2">= </span><span class="s1">SSLListener</span><span class="s2">(</span><span class="s1">socket_listener</span><span class="s2">, </span><span class="s1">SERVER_CTX</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">transport_client </span><span class="s2">= </span><span class="s0">await </span><span class="s1">open_tcp_stream</span><span class="s2">(*</span><span class="s1">listen_sock</span><span class="s2">.</span><span class="s1">getsockname</span><span class="s2">())</span>
        <span class="s1">ssl_client </span><span class="s2">= </span><span class="s1">SSLStream</span><span class="s2">(</span>
            <span class="s1">transport_client</span><span class="s2">, </span><span class="s1">client_ctx</span><span class="s2">, </span><span class="s1">server_hostname</span><span class="s2">=</span><span class="s4">&quot;trio-test-1.example.org&quot;</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">listen_sock</span><span class="s2">, </span><span class="s1">ssl_listener</span><span class="s2">, </span><span class="s1">ssl_client</span>

    <span class="s1">listen_sock</span><span class="s2">, </span><span class="s1">ssl_listener</span><span class="s2">, </span><span class="s1">ssl_client </span><span class="s2">= </span><span class="s0">await </span><span class="s1">setup</span><span class="s2">()</span>

    <span class="s0">async with </span><span class="s1">ssl_client</span><span class="s2">:</span>
        <span class="s1">ssl_server </span><span class="s2">= </span><span class="s0">await </span><span class="s1">ssl_listener</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">()</span>

        <span class="s0">async with </span><span class="s1">ssl_server</span><span class="s2">:</span>
            <span class="s0">assert not </span><span class="s1">ssl_server</span><span class="s2">.</span><span class="s1">_https_compatible</span>

            <span class="s3"># Make sure the connection works</span>
            <span class="s0">async with </span><span class="s1">_core</span><span class="s2">.</span><span class="s1">open_nursery</span><span class="s2">() </span><span class="s0">as </span><span class="s1">nursery</span><span class="s2">:</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">ssl_client</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>
                <span class="s1">nursery</span><span class="s2">.</span><span class="s1">start_soon</span><span class="s2">(</span><span class="s1">ssl_server</span><span class="s2">.</span><span class="s1">do_handshake</span><span class="s2">)</span>

        <span class="s3"># Test SSLListener.aclose</span>
        <span class="s0">await </span><span class="s1">ssl_listener</span><span class="s2">.</span><span class="s1">aclose</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">listen_sock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">() == -</span><span class="s5">1</span>

    <span class="s3">################</span>

    <span class="s3"># Test https_compatible</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ssl_listener</span><span class="s2">, </span><span class="s1">ssl_client </span><span class="s2">= </span><span class="s0">await </span><span class="s1">setup</span><span class="s2">(</span><span class="s1">https_compatible</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">ssl_server </span><span class="s2">= </span><span class="s0">await </span><span class="s1">ssl_listener</span><span class="s2">.</span><span class="s1">accept</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">ssl_server</span><span class="s2">.</span><span class="s1">_https_compatible</span>

    <span class="s0">await </span><span class="s1">aclose_forcefully</span><span class="s2">(</span><span class="s1">ssl_listener</span><span class="s2">)</span>
    <span class="s0">await </span><span class="s1">aclose_forcefully</span><span class="s2">(</span><span class="s1">ssl_client</span><span class="s2">)</span>
    <span class="s0">await </span><span class="s1">aclose_forcefully</span><span class="s2">(</span><span class="s1">ssl_server</span><span class="s2">)</span>
</pre>
</body>
</html>